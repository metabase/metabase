name: '[pivot] Pipeline by stage'
display: pivot
query_type: query
database_id: <<db>>
dataset_query:
  database: <<db>>
  query:
    aggregation:
    - - count
    - - sum
      - - field
        - - <<db>>
          - <<destination_schema>>
          - <<target.opportunity>>
          - amount
        - base-type: type/Decimal
    - - aggregation-options
      - - sum
        - - /
          - - '*'
            - - field
              - - <<db>>
                - <<destination_schema>>
                - <<target.opportunity>>
                - amount
              - base-type: type/Decimal
            - - field
              - - <<db>>
                - <<destination_schema>>
                - <<target.opportunity>>
                - probability
              - base-type: type/Float
          - 100
      - name: Weighted Amount
        display-name: Weighted Amount
    - - aggregation-options
      - - /
        - - sum
          - - field
            - - <<db>>
              - <<destination_schema>>
              - <<target.opportunity>>
              - amount
            - base-type: type/Decimal
        - - count
      - name: ASP
        display-name: ASP
    breakout:
    - - field
      - - <<db>>
        - <<destination_schema>>
        - <<target.opportunity>>
        - stage_name
      - base-type: type/Text
    expressions:
      Close At Quarter:
      - case
      - - - - not-empty
            - - field
              - - <<db>>
                - <<destination_schema>>
                - <<target.opportunity>>
                - close_date
              - base-type: type/Date
          - - date
            - - concat
              - - get-year
                - - field
                  - - <<db>>
                    - <<destination_schema>>
                    - <<target.opportunity>>
                    - close_date
                  - base-type: type/Date
              - '-'
              - - case
                - - - - between
                      - - get-month
                        - - field
                          - - <<db>>
                            - <<destination_schema>>
                            - <<target.opportunity>>
                            - close_date
                          - base-type: type/Date
                      - 1
                      - 3
                    - 1
                - default:
                  - case
                  - - - - between
                        - - get-month
                          - - field
                            - - <<db>>
                              - <<destination_schema>>
                              - <<target.opportunity>>
                              - close_date
                            - base-type: type/Date
                        - 4
                        - 6
                      - 4
                  - default:
                    - case
                    - - - - between
                          - - get-month
                            - - field
                              - - <<db>>
                                - <<destination_schema>>
                                - <<target.opportunity>>
                                - close_date
                              - base-type: type/Date
                          - 7
                          - 9
                        - 7
                    - default:
                      - case
                      - - - - between
                            - - get-month
                              - - field
                                - - <<db>>
                                  - <<destination_schema>>
                                  - <<target.opportunity>>
                                  - close_date
                                - base-type: type/Date
                            - 10
                            - 12
                          - 10
              - '-01'
      Closed at day of quater:
      - datetime-diff
      - - expression
        - Close At Quarter
        - base-type: type/Date
      - - field
        - - <<db>>
          - <<destination_schema>>
          - <<target.opportunity>>
          - close_date
        - base-type: type/Date
      - day
      Days Since Begin of Q:
      - datetime-diff
      - - relative-datetime
        - 0
        - quarter
      - - now
      - day
    filter:
    - and
    - - =
      - - field
        - - <<db>>
          - <<destination_schema>>
          - <<target.opportunity>>
          - status
        - base-type: type/Text
      - open
    - - time-interval
      - - field
        - - <<db>>
          - <<destination_schema>>
          - <<target.opportunity>>
          - close_date
        - base-type: type/Date
      - 0
      - quarter
    source-table:
    - <<db>>
    - <<destination_schema>>
    - <<target.opportunity>>
  type: query
visualization_settings:
  column_settings:
    '["name","ASP"]':
      column_title: Pipeline ASP
      decimals: 0
      number_style: currency
    '["name","Weighted Amount"]':
      column_title: Weighted Pipeline Amount
      decimals: 0
      number_style: currency
    '["name","sum"]':
      column_title: Pipeline Amount
      decimals: 0
      number_style: currency
  pivot_table.column_split:
    columns: []
    rows:
    - stage_name
    values:
    - count
    - sum
    - Weighted Amount
    - ASP
  pivot_table.column_widths:
    leftHeaderWidths:
    - 123
    totalLeftHeaderWidths: 123
    valueHeaderWidths: {}
card_schema: 22
type: question
