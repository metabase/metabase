name: Cross-branch migration test

runs:
  using: "composite"
  steps:
    - name: Check out master request branch
      uses: actions/checkout@v4
      with:
        ref: master

    - name: Prepare backend environment
      uses: ./.github/actions/prepare-backend
      with:
        m2-cache-key: cross-branch-migrations

    - name: Run backend on master
      run: clojure -M:run:ee & echo $! > metabase_pid
      shell: bash

    - name: Wait for Metabase to start
      run: while ! curl 'http://localhost:3000/api/health' | grep '{"status":"ok"}'; do sleep 1; done
      shell: bash
      timeout-minutes: 3

    - name: Stop Metabase on master
      run: kill $(cat metabase_pid)
      shell: bash

    - name: Check out pull request branch
      uses: actions/checkout@v4
      with:
        ref: ${{ github.head_ref }}

    - name: Run backend on pull request branch
      run: clojure -M:run:ee & echo $! > metabase_pid
      shell: bash

    - name: Wait for Metabase to start
      run: while ! curl 'http://localhost:3000/api/health' | grep '{"status":"ok"}'; do sleep 1; done
      shell: bash
      timeout-minutes: 3

    - name: Stop Metabase on pull request branch
      run: kill $(cat metabase_pid)
      shell: bash
