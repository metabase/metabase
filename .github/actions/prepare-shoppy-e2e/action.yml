name: Prepare Shoppy E2E environment
description: Shared setup steps for Shoppy E2E tests (regular and synthetic)

inputs:
  commit:
    description: "Commit SHA for artifact retrieval"
    required: true
  sample-app-branch-name:
    description: "Branch name for the sample app"
    required: true
  sample-app-environment:
    description: "Environment (production/development)"
    required: true
  staging-mb-all-features-token:
    description: "Staging MB all features token"
    required: true
  shoppy-iam-role:
    description: "Shoppy IAM role for AWS credentials"
    required: true
  shoppy-metabase-app-db-s3-bucket:
    description: "S3 bucket for Shoppy app DB dump"
    required: true
  shoppy-metabase-app-db-s3-key:
    description: "S3 key for Shoppy app DB dump"
    required: true
  shoppy-metabase-app-db-user:
    description: "Shoppy Metabase app DB user"
    required: true
  shoppy-metabase-app-db-database:
    description: "Shoppy Metabase app DB database"
    required: true
  metastore-dev-server-url:
    description: "Metastore dev server URL"
    required: true
  shoppy-datadog-application-id:
    description: "Shoppy Datadog application ID"
    required: true
  shoppy-datadog-client-token:
    description: "Shoppy Datadog client token"
    required: true

outputs:
  chrome-path:
    description: "Path to Chrome executable"
    value: ${{ steps.cypress-prep.outputs.chrome-path }}
  sample_app_branch_exists:
    description: "Whether the sample app branch exists"
    value: ${{ steps.check-sample-app-branch.outputs.sample_app_branch_exists }}

runs:
  using: "composite"
  steps:
    - uses: actions/checkout@v4

    - uses: ./.github/actions/maximize-disk-space

    # We have to use the latest version that does not have this issue https://github.com/docker/compose/pull/12752
    - name: Set up Docker Compose
      uses: docker/setup-compose-action@v1
      with:
        version: latest

    - name: Retrieve uberjar artifact for ee
      uses: ./.github/actions/fetch-artifact
      with:
        commit: ${{ inputs.commit }}
        edition: ee
        extract-path: "target/uberjar"
        output-name: "metabase.jar"

    - name: Retrieve Embedding SDK dist artifact
      uses: actions/download-artifact@v4
      with:
        name: embedding-sdk-${{ inputs.commit }}
        path: ${{ github.workspace }}/resources/embedding-sdk

    - name: Prepare front-end environment
      uses: ./.github/actions/prepare-frontend

    - name: Prepare Cypress environment
      id: cypress-prep
      uses: ./.github/actions/prepare-cypress

    - name: Check if sample app branch exists
      id: check-sample-app-branch
      shell: bash
      env:
        SAMPLE_APP_BRANCH_NAME: ${{ inputs.sample-app-branch-name }}
      run: |
        REPO_URL="https://github.com/metabase/shoppy.git"
        echo "Checking if branch '${SAMPLE_APP_BRANCH_NAME}' exists in ${REPO_URL}..."
        if git ls-remote --exit-code --heads "$REPO_URL" "${SAMPLE_APP_BRANCH_NAME}"; then
          echo "sample_app_branch_exists=true" >> $GITHUB_OUTPUT
        else
          echo "sample_app_branch_exists=false" >> $GITHUB_OUTPUT
        fi

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ inputs.shoppy-iam-role }}
        role-session-name: GitHub_to_AWS_via_FederatedOIDC
        aws-region: us-east-1

    - name: Download Shoppy's App DB PostgreSQL dump from S3
      shell: bash
      run: |
        aws s3 cp s3://${{ inputs.shoppy-metabase-app-db-s3-bucket }}/${{ inputs.shoppy-metabase-app-db-s3-key }} ./e2e/tmp/db_dumps/shoppy_metabase_app_db_dump.sql

    - name: Prepare and launch Shoppy containers
      if: ${{ steps.check-sample-app-branch.outputs.sample_app_branch_exists == 'true' }}
      shell: bash
      env:
        SAMPLE_APP_BRANCH_NAME: ${{ inputs.sample-app-branch-name }}
        SAMPLE_APP_ENVIRONMENT: ${{ inputs.sample-app-environment }}
        CYPRESS_MB_ALL_FEATURES_TOKEN: ${{ inputs.staging-mb-all-features-token }}
        METASTORE_DEV_SERVER_URL: ${{ inputs.metastore-dev-server-url }}
        METABASE_APP_DB_USER: ${{ inputs.shoppy-metabase-app-db-user }}
        METABASE_APP_DB: ${{ inputs.shoppy-metabase-app-db-database }}
        SHOPPY_DATADOG_APPLICATION_ID: ${{ inputs.shoppy-datadog-application-id }}
        SHOPPY_DATADOG_CLIENT_TOKEN: ${{ inputs.shoppy-datadog-client-token }}
        SHOPPY_DATADOG_SITE: "us5.datadoghq.com"
        SHOPPY_DATADOG_ENV: "staging"
      run: npx tsx ./e2e/runner/embedding-sdk/sample-apps/start-ci.ts shoppy-e2e

    - name: Prune build cache
      shell: bash
      run: docker builder prune -af

    - name: Log free disk space
      shell: bash
      run: df -h /
