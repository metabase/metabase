databaseChangeLog:
  - objectQuotingStrategy: QUOTE_ALL_OBJECTS
  - changeSet:
      id: v58.2025-10-30T09:03:00
      author: sanex3339
      comment: Add embedding_type column to report_dashboard table
      changes:
        - addColumn:
            tableName: report_dashboard
            columns:
              - column:
                  name: embedding_type
                  type: varchar(50)
                  remarks: The type of embedding for this dashboard
                  constraints:
                    nullable: true
      rollback:
        - dropColumn:
            tableName: report_dashboard
            columnName: embedding_type

  - changeSet:
      id: v58.2025-10-30T09:03:01
      author: sanex3339
      comment: Add embedding_type column to report_card table
      changes:
        - addColumn:
            tableName: report_card
            columns:
              - column:
                  name: embedding_type
                  type: varchar(50)
                  remarks: The type of embedding for this card
                  constraints:
                    nullable: true
      rollback:
        - dropColumn:
            tableName: report_card
            columnName: embedding_type

  - changeSet:
      id: v58.2025-11-04T23:09:49
      author: edpaget
      comment: Create auth_identity table for multi-authentication support
      changes:
        - createTable:
            tableName: auth_identity
            remarks: Stores authentication credentials for users. A user can have multiple auth identities.
            columns:
              - column:
                  name: id
                  type: int
                  remarks: Integer primary key
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: user_id
                  type: int
                  remarks: Foreign key to core_user
                  constraints:
                    nullable: false
              - column:
                  name: provider
                  type: varchar(50)
                  remarks: Authentication provider type (password, google, ldap, saml, jwt, support)
                  constraints:
                    nullable: false
              - column:
                  name: credentials
                  type: ${text.type}
                  remarks: JSON object containing provider-specific credentials
                  constraints:
                    nullable: true
              - column:
                  name: metadata
                  type: ${text.type}
                  remarks: JSON object containing provider-specific metadata
                  constraints:
                    nullable: true
              - column:
                  name: provider_id
                  type: varchar(255)
                  remarks: Provider-specific identifier (email for password/Google, DN for LDAP, subject for SAML/JWT)
                  constraints:
                    nullable: true
              - column:
                  name: last_used_at
                  type: ${timestamp_type}
                  remarks: Timestamp of last successful authentication
                  constraints:
                    nullable: true
              - column:
                  name: expires_at
                  type: ${timestamp_type}
                  remarks: Timestamp when this authentication method expires (null = never expires)
                  constraints:
                    nullable: true
              - column:
                  name: created_at
                  type: ${timestamp_type}
                  remarks: Timestamp when this identity was created
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: ${timestamp_type}
                  remarks: Timestamp when this identity was last updated
                  constraints:
                    nullable: false
      rollback:
        - dropTable:
            tableName: auth_identity

  - changeSet:
      id: v58.2025-11-04T23:09:58
      author: edpaget
      comment: Add user_id index to auth_identity table
      changes:
        - createIndex:
            tableName: auth_identity
            indexName: idx_auth_identity_user_id
            columns:
              - column:
                  name: user_id
      rollback:
        - dropIndex:
            tableName: auth_identity
            indexName: idx_auth_identity_user_id

  - changeSet:
      id: v58.2025-11-04T23:10:00
      author: edpaget
      comment: Add provider index to auth_identity table
      changes:
        - createIndex:
            tableName: auth_identity
            indexName: idx_auth_identity_provider
            columns:
              - column:
                  name: provider
      rollback:
        - dropIndex:
            tableName: auth_identity
            indexName: idx_auth_identity_provider

  - changeSet:
      id: v58.2025-11-04T23:10:01
      author: edpaget
      comment: Add unique constraint to auth_identity table
      changes:
        - addUniqueConstraint:
            tableName: auth_identity
            columnNames: user_id, provider
            constraintName: unique_auth_identity_user_provider
      rollback:
        - dropUniqueConstraint:
            tableName: auth_identity
            constraintName: unique_auth_identity_user_provider

  - changeSet:
      id: v58.2025-11-12T00:00:00
      author: edpaget
      comment: Add index on provider_id for efficient lookups
      changes:
        - createIndex:
            tableName: auth_identity
            indexName: idx_auth_identity_provider_id
            columns:
              - column:
                  name: provider_id
      rollback:
        - dropIndex:
            tableName: auth_identity
            indexName: idx_auth_identity_provider_id

  - changeSet:
      id: v58.2025-11-12T00:00:01
      author: edpaget
      comment: Add composite index on (provider, provider_id) for efficient lookups
      changes:
        - createIndex:
            tableName: auth_identity
            indexName: idx_auth_identity_provider_provider_id
            columns:
              - column:
                  name: provider
              - column:
                  name: provider_id
      rollback:
        - dropIndex:
            tableName: auth_identity
            indexName: idx_auth_identity_provider_provider_id

  - changeSet:
      id: v58.2025-11-12T00:00:02
      author: edpaget
      comment: Add foreign key constraint from auth_identity to core_user
      changes:
        - addForeignKeyConstraint:
            baseTableName: auth_identity
            baseColumnNames: user_id
            constraintName: fk_auth_identity_core_user_id
            referencedTableName: core_user
            referencedColumnNames: id
            onDelete: CASCADE
      rollback:
        - dropForeignKeyConstraint:
            baseTableName: auth_identity
            constraintName: fk_auth_identity_core_user_id

  - changeSet:
      id: v58.2025-11-12T00:00:03
      author: edpaget
      comment: Migrate password authentication to auth_identity table
      changes:
        - sql:
            dbms: postgresql
            sql: >-
              INSERT INTO auth_identity (user_id, provider, provider_id, credentials, metadata, created_at, updated_at)
              SELECT
                id,
                'password',
                email,
                json_build_object('password_hash', password, 'password_salt', password_salt)::text,
                NULL,
                COALESCE(date_joined, now()),
                now()
              FROM core_user
              WHERE password IS NOT NULL
              ON CONFLICT (user_id, provider) DO NOTHING;
        - sql:
            dbms: mysql,mariadb
            sql: >-
              INSERT IGNORE INTO auth_identity (user_id, provider, provider_id, credentials, metadata, created_at, updated_at)
              SELECT
                id,
                'password',
                email,
                json_object('password_hash', password, 'password_salt', password_salt),
                NULL,
                COALESCE(date_joined, now()),
                now()
              FROM core_user
              WHERE password IS NOT NULL;
        - sql:
            dbms: h2
            sql: >-
              INSERT INTO auth_identity (user_id, provider, provider_id, credentials, metadata, created_at, updated_at)
              SELECT
                id,
                'password',
                email,
                CONCAT('{"password_hash":"', password, '","password_salt":"', password_salt, '"}'),
                NULL,
                COALESCE(date_joined, now()),
                now()
              FROM core_user
              WHERE password IS NOT NULL
                AND NOT EXISTS (
                  SELECT 1 FROM auth_identity ai
                  WHERE ai.user_id = core_user.id AND ai.provider = 'password'
                );
      rollback:
        - sql: DELETE FROM auth_identity WHERE provider = 'password';

  - changeSet:
      id: v58.2025-11-12T00:00:04
      author: edpaget
      comment: Migrate LDAP authentication to auth_identity table
      changes:
        - sql:
            dbms: postgresql
            sql: >-
              INSERT INTO auth_identity (user_id, provider, provider_id, credentials, metadata, created_at, updated_at)
              SELECT
                id,
                'ldap',
                email,
                NULL,
                json_build_object('login_attributes', login_attributes)::text,
                COALESCE(date_joined, now()),
                now()
              FROM core_user
              WHERE sso_source = 'ldap'
              ON CONFLICT (user_id, provider) DO NOTHING;
        - sql:
            dbms: mysql,mariadb
            sql: >-
              INSERT IGNORE INTO auth_identity (user_id, provider, provider_id, credentials, metadata, created_at, updated_at)
              SELECT
                id,
                'ldap',
                email,
                NULL,
                json_object('login_attributes', login_attributes),
                COALESCE(date_joined, now()),
                now()
              FROM core_user
              WHERE sso_source = 'ldap';
        - sql:
            dbms: h2
            sql: >-
              INSERT INTO auth_identity (user_id, provider, provider_id, credentials, metadata, created_at, updated_at)
              SELECT
                id,
                'ldap',
                email,
                NULL,
                CONCAT('{"login_attributes":', COALESCE(login_attributes, 'null'), '}'),
                COALESCE(date_joined, now()),
                now()
              FROM core_user
              WHERE sso_source = 'ldap'
                AND NOT EXISTS (
                  SELECT 1 FROM auth_identity ai
                  WHERE ai.user_id = core_user.id AND ai.provider = 'ldap'
                );
      rollback:
        - sql: DELETE FROM auth_identity WHERE provider = 'ldap';

  - changeSet:
      id: v58.2025-11-12T00:00:05
      author: edpaget
      comment: Migrate Google SSO authentication to auth_identity table
      changes:
        - sql:
            dbms: postgresql
            sql: >-
              INSERT INTO auth_identity (user_id, provider, provider_id, credentials, metadata, created_at, updated_at)
              SELECT
                id,
                'google',
                email,
                NULL,
                json_build_object('sso_source', 'google', 'login_attributes', login_attributes)::text,
                COALESCE(date_joined, now()),
                now()
              FROM core_user
              WHERE sso_source = 'google'
              ON CONFLICT (user_id, provider) DO NOTHING;
        - sql:
            dbms: mysql,mariadb
            sql: >-
              INSERT IGNORE INTO auth_identity (user_id, provider, provider_id, credentials, metadata, created_at, updated_at)
              SELECT
                id,
                'google',
                email,
                NULL,
                json_object('sso_source', 'google', 'login_attributes', login_attributes),
                COALESCE(date_joined, now()),
                now()
              FROM core_user
              WHERE sso_source = 'google';
        - sql:
            dbms: h2
            sql: >-
              INSERT INTO auth_identity (user_id, provider, provider_id, credentials, metadata, created_at, updated_at)
              SELECT
                id,
                'google',
                email,
                NULL,
                CONCAT('{"sso_source":"google","login_attributes":', COALESCE(login_attributes, 'null'), '}'),
                COALESCE(date_joined, now()),
                now()
              FROM core_user
              WHERE sso_source = 'google'
                AND NOT EXISTS (
                  SELECT 1 FROM auth_identity ai
                  WHERE ai.user_id = core_user.id AND ai.provider = 'google'
                );
      rollback:
        - sql: DELETE FROM auth_identity WHERE provider = 'google';

  - changeSet:
      id: v58.2025-11-12T00:00:06
      author: edpaget
      comment: Migrate SAML and JWT authentication to auth_identity table
      changes:
        - sql:
            dbms: postgresql
            sql: >-
              INSERT INTO auth_identity (user_id, provider, provider_id, credentials, metadata, created_at, updated_at)
              SELECT
                id,
                sso_source,
                email,
                NULL,
                json_build_object('sso_source', sso_source, 'login_attributes', login_attributes, 'jwt_attributes', jwt_attributes)::text,
                COALESCE(date_joined, now()),
                now()
              FROM core_user
              WHERE sso_source IN ('saml', 'jwt')
              ON CONFLICT (user_id, provider) DO NOTHING;
        - sql:
            dbms: mysql,mariadb
            sql: >-
              INSERT IGNORE INTO auth_identity (user_id, provider, provider_id, credentials, metadata, created_at, updated_at)
              SELECT
                id,
                sso_source,
                email,
                NULL,
                json_object('sso_source', sso_source, 'login_attributes', login_attributes, 'jwt_attributes', jwt_attributes),
                COALESCE(date_joined, now()),
                now()
              FROM core_user
              WHERE sso_source IN ('saml', 'jwt');
        - sql:
            dbms: h2
            sql: >-
              INSERT INTO auth_identity (user_id, provider, provider_id, credentials, metadata, created_at, updated_at)
              SELECT
                id,
                sso_source,
                email,
                NULL,
                CONCAT('{"sso_source":"', sso_source, '","login_attributes":', COALESCE(login_attributes, 'null'), ',"jwt_attributes":', COALESCE(jwt_attributes, 'null'), '}'),
                COALESCE(date_joined, now()),
                now()
              FROM core_user
              WHERE sso_source IN ('saml', 'jwt')
                AND NOT EXISTS (
                  SELECT 1 FROM auth_identity ai
                  WHERE ai.user_id = core_user.id AND ai.provider = core_user.sso_source
                );
      rollback:
        - sql: DELETE FROM auth_identity WHERE provider IN ('saml', 'jwt');

  - changeSet:
      id: v58.2025-11-12T00:00:07
      author: edpaget
      comment: Add auth_identity_id columns to core_session table
      changes:
        - addColumn:
            tableName: core_session
            columns:
              - column:
                  name: auth_identity_id
                  type: int
                  remarks: Foreign key to auth_identity - tracks which auth method was used for login
                  constraints:
                    nullable: true
      rollback:
        - dropColumn:
            tableName: core_session
            columnName: auth_identity_id

  - changeSet:
      id: v58.2025-11-12T00:00:08
      author: edpaget
      comment: Add expires_at columns to core_session table
      changes:
        - addColumn:
            tableName: core_session
            columns:
               - column:
                  name: expires_at
                  type: ${timestamp_type}
                  remarks: Timestamp when this session expires (from auth_identity or calculated)
                  constraints:
                    nullable: true
      rollback:
        - dropColumn:
            tableName: core_session
            columnName: expires_at

  - changeSet:
      id: v58.2025-11-12T00:00:09
      author: edpaget
      comment: Add index on core_session.auth_identity_id
      changes:
        - createIndex:
            tableName: core_session
            indexName: idx_core_session_auth_identity_id
            columns:
              - column:
                  name: auth_identity_id
      rollback:
        - dropIndex:
            tableName: core_session
            indexName: idx_core_session_auth_identity_id

  - changeSet:
      id: v58.2025-11-12T00:00:10
      author: edpaget
      comment: Add foreign key constraint from core_session to auth_identity
      changes:
        - addForeignKeyConstraint:
            baseTableName: core_session
            baseColumnNames: auth_identity_id
            constraintName: fk_session_auth_identity
            referencedTableName: auth_identity
            referencedColumnNames: id
            onDelete: CASCADE
      rollback:
        - dropForeignKeyConstraint:
            baseTableName: core_session
            constraintName: fk_session_auth_identity

  - changeSet:
      id: v58.2025-11-18T12:00:00
      author: piranha
      comment: Create workspace table
      changes:
        - createTable:
            tableName: workspace
            remarks: Internal Metabase container
            columns:
              - column:
                  name: id
                  type: int
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
                  remarks: Integer PK
              - column:
                  name: name
                  type: varchar(254)
                  remarks: Workspace name
              - column:
                  name: collection_id
                  type: int
                  constraints:
                    nullable: true
                  remarks: FK to workspace's collection
              - column:
                  name: creator_id
                  type: int
                  remarks: FK to owner
              - column:
                  name: api_key_id
                  type: int
                  remarks: FK to api key used by agent
              - column:
                  name: execution_user
                  type: int
                  remarks: FK to api key's user
              - column:
                  name: database_id
                  type: int
                  remarks: FK to db used for this workspace
              - column:
                  name: schema
                  type: varchar(254)
                  remarks: Isolated schema where work happens
                  constraints:
                    nullable: true
              - column:
                  name: graph
                  type: ${text.type}
                  remarks: Graph configuration serialized as JSON
              - column:
                  name: created_at
                  type: ${timestamp_type}
                  remarks: Timestamp when the workspace was created
                  defaultValueComputed: current_timestamp
              - column:
                  name: updated_at
                  type: ${timestamp_type}
                  remarks: Timestamp when the workspace was last updated
                  defaultValueComputed: current_timestamp
              - column:
                  name: archived_at
                  type: ${timestamp_type}
                  remarks: Timestamp when (and if) the workspace was archived
                  constraints:
                    nullable: true
      rollback:
        - dropTable:
            tableName: workspace

  - changeSet:
      id: v58.2025-11-18T12:00:01
      author: piranha
      comment: Add index on workspace.collection_id for quick lookups by collection
      changes:
        - createIndex:
            tableName: workspace
            indexName: idx_workspace_collection_id
            columns:
              - column:
                  name: collection_id
      rollback: # will be removed along the table

  - changeSet:
      id: v58.2025-11-18T12:00:02
      author: piranha
      comment: Add index on workspace.creator_id for quick lookups
      changes:
        - createIndex:
            tableName: workspace
            indexName: idx_workspace_creator_id
            columns:
              - column:
                  name: creator_id
      rollback: # will be removed along the table

  - changeSet:
      id: v58.2025-11-18T12:00:03
      author: piranha
      comment: Add index on workspace.api_key_id for quick lookups
      changes:
        - createIndex:
            tableName: workspace
            indexName: idx_workspace_api_key_id
            columns:
              - column:
                  name: api_key_id
      rollback: # will be removed along the table

  - changeSet:
      id: v58.2025-11-18T12:00:04
      author: piranha
      comment: Add index on workspace.execution_user for quick lookups
      changes:
        - createIndex:
            tableName: workspace
            indexName: idx_workspace_execution_user_id
            columns:
              - column:
                  name: execution_user
      rollback: # will be removed along the table

  - changeSet:
      id: v58.2025-11-18T12:00:07
      author: piranha
      comment: Add workspace_id column to metabase_table table
      changes:
        - addColumn:
            tableName: metabase_table
            columns:
              - column:
                  name: workspace_id
                  type: int
                  remarks: Workspace that owns schema with this table
                  constraints:
                    nullable: true
      rollback:
        - dropColumn:
            tableName: metabase_table
            columnName: workspace_id

  - changeSet:
      id: v58.2025-11-18T12:00:08
      author: piranha
      comment: Add foreign key constraint from metabase_table.workspace_id to workspace
      changes:
        - addForeignKeyConstraint:
            baseTableName: metabase_table
            baseColumnNames: workspace_id
            constraintName: fk_metabase_table_workspace_id
            referencedTableName: workspace
            referencedColumnNames: id
      rollback:
        - dropForeignKeyConstraint:
            baseTableName: metabase_table
            constraintName: fk_metabase_table_workspace_id

  - changeSet:
      id: v58.2025-11-18T12:00:09
      author: piranha
      comment: Add workspace_id column to metabase_field table
      changes:
        - addColumn:
            tableName: metabase_field
            columns:
              - column:
                  name: workspace_id
                  type: int
                  remarks: Workspace that owns schema with this field
                  constraints:
                    nullable: true
      rollback:
        - dropColumn:
            tableName: metabase_field
            columnName: workspace_id

  - changeSet:
      id: v58.2025-11-18T12:00:10
      author: piranha
      comment: Add foreign key constraint from metabase_field.workspace_id to workspace
      changes:
        - addForeignKeyConstraint:
            baseTableName: metabase_field
            baseColumnNames: workspace_id
            constraintName: fk_metabase_field_workspace_id
            referencedTableName: workspace
            referencedColumnNames: id
      rollback:
        - dropForeignKeyConstraint:
            baseTableName: metabase_field
            constraintName: fk_metabase_field_workspace_id

  - changeSet:
      id: v58.2025-11-18T12:00:11
      author: piranha
      comment: Add workspace_id column to collection table
      changes:
        - addColumn:
            tableName: collection
            columns:
              - column:
                  name: workspace_id
                  type: int
                  remarks: Workspace containing this collection
                  constraints:
                    nullable: true
      rollback:
        - dropColumn:
            tableName: collection
            columnName: workspace_id

  - changeSet:
      id: v58.2025-11-18T12:00:12
      author: piranha
      comment: Add foreign key constraint from collection.workspace_id to workspace
      changes:
        - addForeignKeyConstraint:
            baseTableName: collection
            baseColumnNames: workspace_id
            constraintName: fk_collection_workspace_id
            referencedTableName: workspace
            referencedColumnNames: id
      rollback:
        - dropForeignKeyConstraint:
            baseTableName: collection
            constraintName: fk_collection_workspace_id

  - changeSet:
      id: v58.2025-11-18T12:00:13
      author: piranha
      comment: Add workspace_id column to report_card table
      changes:
        - addColumn:
            tableName: report_card
            columns:
              - column:
                  name: workspace_id
                  type: int
                  remarks: Workspace containing this card
                  constraints:
                    nullable: true
      rollback:
        - dropColumn:
            tableName: report_card
            columnName: workspace_id

  - changeSet:
      id: v58.2025-11-18T12:00:14
      author: piranha
      comment: Add foreign key constraint from report_card.workspace_id to workspace
      changes:
        - addForeignKeyConstraint:
            baseTableName: report_card
            baseColumnNames: workspace_id
            constraintName: fk_report_card_workspace_id
            referencedTableName: workspace
            referencedColumnNames: id
      rollback:
        - dropForeignKeyConstraint:
            baseTableName: report_card
            constraintName: fk_report_card_workspace_id

  - changeSet:
      id: v58.2025-11-18T12:00:17
      author: piranha
      comment: Add workspace_id column to transform table
      changes:
        - addColumn:
            tableName: transform
            columns:
              - column:
                  name: workspace_id
                  type: int
                  remarks: Workspace containing this transform
                  constraints:
                    nullable: true
      rollback:
        - dropColumn:
            tableName: transform
            columnName: workspace_id

  - changeSet:
      id: v58.2025-11-18T12:00:18
      author: piranha
      comment: Add foreign key constraint from transform.workspace_id to workspace
      changes:
        - addForeignKeyConstraint:
            baseTableName: transform
            baseColumnNames: workspace_id
            constraintName: fk_transform_workspace_id
            referencedTableName: workspace
            referencedColumnNames: id
      rollback:
        - dropForeignKeyConstraint:
            baseTableName: transform
            constraintName: fk_transform_workspace_id

  - changeSet:
      id: v58.2025-11-20T08:34:41
      author: christruter
      comment: Create workspace_mapping_table for mirroring tables in workspaces
      changes:
        - createTable:
            tableName: workspace_mapping_table
            remarks: Maps upstream tables to downstream tables within a workspace
            columns:
              - column:
                  name: upstream_id
                  type: int
                  remarks: ID of the source table outside the workspace
                  constraints:
                    nullable: false
              - column:
                  name: downstream_id
                  type: int
                  remarks: ID of the mirrored table inside the workspace
                  constraints:
                    nullable: false
              - column:
                  name: workspace_id
                  type: int
                  remarks: ID of the workspace containing the mapping
                  constraints:
                    nullable: false
      rollback:
        - dropTable:
            tableName: workspace_mapping_table

  - changeSet:
      id: v58.2025-11-20T08:34:42
      author: christruter
      comment: Add primary key constraint to workspace_mapping_table
      changes:
        - addPrimaryKey:
            tableName: workspace_mapping_table
            columnNames: upstream_id, downstream_id
            constraintName: pk_workspace_mapping_table
      rollback:
        - dropPrimaryKey:
            tableName: workspace_mapping_table
            constraintName: pk_workspace_mapping_table

  - changeSet:
      id: v58.2025-11-20T08:34:44
      author: christruter
      comment: Add index on upstream_id for workspace_mapping_table
      changes:
        - createIndex:
            tableName: workspace_mapping_table
            indexName: idx_workspace_mapping_table_upstream_id
            columns:
              - column:
                  name: upstream_id
      rollback:
        - dropIndex:
            tableName: workspace_mapping_table
            indexName: idx_workspace_mapping_table_upstream_id

  - changeSet:
      id: v58.2025-11-20T08:34:45
      author: christruter
      comment: Add index on downstream_id for workspace_mapping_table
      changes:
        - createIndex:
            tableName: workspace_mapping_table
            indexName: idx_workspace_mapping_table_downstream_id
            columns:
              - column:
                  name: downstream_id
      rollback:
        - dropIndex:
            tableName: workspace_mapping_table
            indexName: idx_workspace_mapping_table_downstream_id

  - changeSet:
      id: v58.2025-11-20T08:34:46
      author: christruter
      comment: Add index on workspace_id for workspace_mapping_table
      changes:
        - createIndex:
            tableName: workspace_mapping_table
            indexName: idx_workspace_mapping_table_workspace_id
            columns:
              - column:
                  name: workspace_id
      rollback:
        - dropIndex:
            tableName: workspace_mapping_table
            indexName: idx_workspace_mapping_table_workspace_id

  - changeSet:
      id: v58.2025-11-20T08:34:47
      author: christruter
      comment: Add foreign key constraint from workspace_mapping_table.upstream_id to metabase_table
      changes:
        - addForeignKeyConstraint:
            baseTableName: workspace_mapping_table
            baseColumnNames: upstream_id
            constraintName: fk_workspace_mapping_table_upstream_id
            referencedTableName: metabase_table
            referencedColumnNames: id
            onDelete: CASCADE
      rollback:
        - dropForeignKeyConstraint:
            baseTableName: workspace_mapping_table
            constraintName: fk_workspace_mapping_table_upstream_id

  - changeSet:
      id: v58.2025-11-20T08:34:48
      author: christruter
      comment: Add foreign key constraint from workspace_mapping_table.downstream_id to metabase_table
      changes:
        - addForeignKeyConstraint:
            baseTableName: workspace_mapping_table
            baseColumnNames: downstream_id
            constraintName: fk_workspace_mapping_table_downstream_id
            referencedTableName: metabase_table
            referencedColumnNames: id
            onDelete: CASCADE
      rollback:
        - dropForeignKeyConstraint:
            baseTableName: workspace_mapping_table
            constraintName: fk_workspace_mapping_table_downstream_id

  - changeSet:
      id: v58.2025-11-20T08:34:49
      author: christruter
      comment: Add foreign key constraint from workspace_mapping_table.workspace_id to workspace
      changes:
        - addForeignKeyConstraint:
            baseTableName: workspace_mapping_table
            baseColumnNames: workspace_id
            constraintName: fk_workspace_mapping_table_workspace_id
            referencedTableName: workspace
            referencedColumnNames: id
            onDelete: CASCADE
      rollback:
        - dropForeignKeyConstraint:
            baseTableName: workspace_mapping_table
            constraintName: fk_workspace_mapping_table_workspace_id

  - changeSet:
      id: v58.2025-11-20T08:34:50
      author: christruter
      comment: Create workspace_mapping_transform for mirroring transforms in workspaces
      changes:
        - createTable:
            tableName: workspace_mapping_transform
            remarks: Maps upstream transforms to downstream transforms within a workspace
            columns:
              - column:
                  name: upstream_id
                  type: int
                  remarks: ID of the source transform outside the workspace
                  constraints:
                    nullable: false
              - column:
                  name: downstream_id
                  type: int
                  remarks: ID of the mirrored transform inside the workspace
                  constraints:
                    nullable: false
              - column:
                  name: workspace_id
                  type: int
                  remarks: ID of the workspace containing the mapping
                  constraints:
                    nullable: false
      rollback:
        - dropTable:
            tableName: workspace_mapping_transform

  - changeSet:
      id: v58.2025-11-20T08:34:51
      author: christruter
      comment: Add primary key constraint to workspace_mapping_transform
      changes:
        - addPrimaryKey:
            tableName: workspace_mapping_transform
            columnNames: upstream_id, downstream_id
            constraintName: pk_workspace_mapping_transform
      rollback:
        - dropPrimaryKey:
            tableName: workspace_mapping_transform
            constraintName: pk_workspace_mapping_transform

  - changeSet:
      id: v58.2025-11-20T08:34:53
      author: christruter
      comment: Add index on upstream_id for workspace_mapping_transform
      changes:
        - createIndex:
            tableName: workspace_mapping_transform
            indexName: idx_workspace_mapping_transform_upstream_id
            columns:
              - column:
                  name: upstream_id
      rollback:
        - dropIndex:
            tableName: workspace_mapping_transform
            indexName: idx_workspace_mapping_transform_upstream_id

  - changeSet:
      id: v58.2025-11-20T08:34:54
      author: christruter
      comment: Add index on downstream_id for workspace_mapping_transform
      changes:
        - createIndex:
            tableName: workspace_mapping_transform
            indexName: idx_workspace_mapping_transform_downstream_id
            columns:
              - column:
                  name: downstream_id
      rollback:
        - dropIndex:
            tableName: workspace_mapping_transform
            indexName: idx_workspace_mapping_transform_downstream_id

  - changeSet:
      id: v58.2025-11-20T08:34:55
      author: christruter
      comment: Add index on workspace_id for workspace_mapping_transform
      changes:
        - createIndex:
            tableName: workspace_mapping_transform
            indexName: idx_workspace_mapping_transform_workspace_id
            columns:
              - column:
                  name: workspace_id
      rollback:
        - dropIndex:
            tableName: workspace_mapping_transform
            indexName: idx_workspace_mapping_transform_workspace_id

  - changeSet:
      id: v58.2025-11-20T08:34:56
      author: christruter
      comment: Add foreign key constraint from workspace_mapping_transform.upstream_id to transform
      changes:
        - addForeignKeyConstraint:
            baseTableName: workspace_mapping_transform
            baseColumnNames: upstream_id
            constraintName: fk_workspace_mapping_transform_upstream_id
            referencedTableName: transform
            referencedColumnNames: id
            onDelete: CASCADE
      rollback:
        - dropForeignKeyConstraint:
            baseTableName: workspace_mapping_transform
            constraintName: fk_workspace_mapping_transform_upstream_id

  - changeSet:
      id: v58.2025-11-20T08:34:57
      author: christruter
      comment: Add foreign key constraint from workspace_mapping_transform.downstream_id to transform
      changes:
        - addForeignKeyConstraint:
            baseTableName: workspace_mapping_transform
            baseColumnNames: downstream_id
            constraintName: fk_workspace_mapping_transform_downstream_id
            referencedTableName: transform
            referencedColumnNames: id
            onDelete: CASCADE
      rollback:
        - dropForeignKeyConstraint:
            baseTableName: workspace_mapping_transform
            constraintName: fk_workspace_mapping_transform_downstream_id

  - changeSet:
      id: v58.2025-11-20T08:34:58
      author: christruter
      comment: Add foreign key constraint from workspace_mapping_transform.workspace_id to workspace
      changes:
        - addForeignKeyConstraint:
            baseTableName: workspace_mapping_transform
            baseColumnNames: workspace_id
            constraintName: fk_workspace_mapping_transform_workspace_id
            referencedTableName: workspace
            referencedColumnNames: id
            onDelete: CASCADE
      rollback:
        - dropForeignKeyConstraint:
            baseTableName: workspace_mapping_transform
            constraintName: fk_workspace_mapping_transform_workspace_id

  - changeSet:
      id: v58.2025-11-20T08:34:59
      author: christruter
      comment: Add index on collection.workspace_id
      changes:
        - createIndex:
            tableName: collection
            indexName: idx_collection_workspace_id
            columns:
              - column:
                  name: workspace_id
      rollback:
        - dropIndex:
            tableName: collection
            indexName: idx_collection_workspace_id

  - changeSet:
      id: v58.2025-11-20T08:35:02
      author: christruter
      comment: Drop collection.workspace_id FK for update
      changes:
        - dropForeignKeyConstraint:
            baseTableName: collection
            constraintName: fk_collection_workspace_id
      rollback:
        - addForeignKeyConstraint:
            baseTableName: collection
            baseColumnNames: workspace_id
            constraintName: fk_collection_workspace_id
            referencedTableName: workspace
            referencedColumnNames: id

  - changeSet:
      id: v58.2025-11-20T08:35:03
      author: christruter
      comment: Add collection.workspace_id FK with CASCADE on delete
      changes:
        - addForeignKeyConstraint:
            baseTableName: collection
            baseColumnNames: workspace_id
            constraintName: fk_collection_workspace_id
            referencedTableName: workspace
            referencedColumnNames: id
            onDelete: CASCADE
      rollback:
        - dropForeignKeyConstraint:
            baseTableName: collection
            constraintName: fk_collection_workspace_id

  - changeSet:
      id: v58.2025-11-20T08:35:04
      author: christruter
      comment: Drop transform.workspace_id FK for update
      changes:
        - dropForeignKeyConstraint:
            baseTableName: transform
            constraintName: fk_transform_workspace_id
      rollback:
        - addForeignKeyConstraint:
            baseTableName: transform
            baseColumnNames: workspace_id
            constraintName: fk_transform_workspace_id
            referencedTableName: workspace
            referencedColumnNames: id

  - changeSet:
      id: v58.2025-11-20T08:35:05
      author: christruter
      comment: Add transform.workspace_id FK with CASCADE on delete
      changes:
        - addForeignKeyConstraint:
            baseTableName: transform
            baseColumnNames: workspace_id
            constraintName: fk_transform_workspace_id
            referencedTableName: workspace
            referencedColumnNames: id
            onDelete: CASCADE
      rollback:
        - dropForeignKeyConstraint:
            baseTableName: transform
            constraintName: fk_transform_workspace_id

  - changeSet:
      id: v58.2025-11-20T08:35:06
      author: christruter
      comment: Drop report_card.workspace_id FK for update
      changes:
        - dropForeignKeyConstraint:
            baseTableName: report_card
            constraintName: fk_report_card_workspace_id
      rollback:
        - addForeignKeyConstraint:
            baseTableName: report_card
            baseColumnNames: workspace_id
            constraintName: fk_report_card_workspace_id
            referencedTableName: workspace
            referencedColumnNames: id

  - changeSet:
      id: v58.2025-11-20T08:35:07
      author: christruter
      comment: Add report_card.workspace_id FK with CASCADE on delete
      changes:
        - addForeignKeyConstraint:
            baseTableName: report_card
            baseColumnNames: workspace_id
            constraintName: fk_report_card_workspace_id
            referencedTableName: workspace
            referencedColumnNames: id
            onDelete: CASCADE
      rollback:
        - dropForeignKeyConstraint:
            baseTableName: report_card
            constraintName: fk_report_card_workspace_id

  - changeSet:
      id: v58.2025-11-20T08:35:08
      author: christruter
      comment: Drop metabase_table.workspace_id FK for update
      changes:
        - dropForeignKeyConstraint:
            baseTableName: metabase_table
            constraintName: fk_metabase_table_workspace_id
      rollback:
        - addForeignKeyConstraint:
            baseTableName: metabase_table
            baseColumnNames: workspace_id
            constraintName: fk_metabase_table_workspace_id
            referencedTableName: workspace
            referencedColumnNames: id

  - changeSet:
      id: v58.2025-11-20T08:35:09
      author: christruter
      comment: Add metabase_table.workspace_id FK with SET NULL on delete
      changes:
        - addForeignKeyConstraint:
            baseTableName: metabase_table
            baseColumnNames: workspace_id
            constraintName: fk_metabase_table_workspace_id
            referencedTableName: workspace
            referencedColumnNames: id
            onDelete: SET NULL
      rollback:
        - dropForeignKeyConstraint:
            baseTableName: metabase_table
            constraintName: fk_metabase_table_workspace_id

  - changeSet:
      id: v58.2025-11-20T08:35:10
      author: christruter
      comment: Drop metabase_field.workspace_id FK for update
      changes:
        - dropForeignKeyConstraint:
            baseTableName: metabase_field
            constraintName: fk_metabase_field_workspace_id
      rollback:
        - addForeignKeyConstraint:
            baseTableName: metabase_field
            baseColumnNames: workspace_id
            constraintName: fk_metabase_field_workspace_id
            referencedTableName: workspace
            referencedColumnNames: id

  - changeSet:
      id: v58.2025-11-20T08:35:11
      author: christruter
      comment: Add metabase_field.workspace_id FK with SET NULL on delete
      changes:
        - addForeignKeyConstraint:
            baseTableName: metabase_field
            baseColumnNames: workspace_id
            constraintName: fk_metabase_field_workspace_id
            referencedTableName: workspace
            referencedColumnNames: id
            onDelete: SET NULL
      rollback:
        - dropForeignKeyConstraint:
            baseTableName: metabase_field
            constraintName: fk_metabase_field_workspace_id

  - changeSet:
      id: v58.2025-11-20T08:35:12
      author: christruter
      comment: Add index on metabase_field.workspace_id
      changes:
        - createIndex:
            tableName: metabase_field
            indexName: idx_metabase_field_workspace_id
            columns:
              - column:
                  name: workspace_id
      rollback:
        - dropIndex:
            tableName: metabase_field
            indexName: idx_metabase_field_workspace_id

  - changeSet:
      id: v58.2025-11-20T08:35:13
      author: christruter
      comment: Add index on metabase_table.workspace_id
      changes:
        - createIndex:
            tableName: metabase_table
            indexName: idx_metabase_table_workspace_id
            columns:
              - column:
                  name: workspace_id
      rollback:
        - dropIndex:
            tableName: metabase_table
            indexName: idx_metabase_table_workspace_id

# >>>>>>>>>> DO NOT ADD NEW MIGRATIONS BELOW THIS LINE! ADD THEM ABOVE <<<<<<<<<<

########################################################################################################################
#
# ADVICE:
#
# 1) Think through some of these points when writing a migration, learn from our past mistakes:
#    - Do you really need a migration? Could the feature work without it? Prefer not to if possible.
#      Data in the wild can be vastly different from what you expect, and it's hard to get right.
#    - Make sure your migration is backward compatible: it might not be possible to add a constraint back
#      if you drop it in a migration.
#    - Postgres, MySQL and H2 have their differences. Make sure your migration works for all.
#    - Database encryption is a major issue:
#      - Fields like `metabase_database.details` or `setting.value` can be encrypted, so you need to decrypt them in
#        your migration. See #42617, #44048.
#      - Database could be partially encrypted, see https://www.notion.so/72575933ef2a446bafd16909e05a7387
#    - Custom migrations:
#      - Prefer SQL migrations when possible.
#      - Never use application code: it can change and *will* break your migration.
#      - Do not use Toucan models - refer table names directly.
#      - If it's a big change, consider using Quartz, see #42279
#      - More in `metabase.app_db.custom_migrations` namespace doc.
#    - Never delete a migration: users won't be able to downgrade. If you really need to, see #44908
#    - Migration id (`vXX.<date>`) must match its earliest released version:
#      - Do not backport `v51....` to version 50, Metabase will try to downgrade it.
#      - Instead, write a migration with an oldest target you plan to backport to in mind.
#
# 2) Migrations should go in the ###_update_migrations.yaml file for the target version.
#
# 3) Run mage lint-migrations to run core.spec checks against any changes you make here. Liquibase is pretty
#    forgiving and won't complain if you accidentally mix up things like deleteCascade and onDelete: CASCADE. CI runs
#    this check but it's nicer to know now instead of waiting for CI.
#
# 3) Migration IDs should follow the format
#
#    vMM.TIMESTAMP
#
#    Where
#
#    M         = major version
#    TIMESTAMP = the current timestamp with format `yyyy-MM-dd'T'HH:mm:ss`
#                To get this timestamp, evaluate this in your REPL: `(dev/migration-timestamp)`
#
#    E.g: You're adding a new migration for version 49, And it's 10:30:00AM on April 1, 2023 (UTC),
#    your migration id should be: `v49.2023-04-01T10:30:00`.
#
# PLEASE KEEP THIS MESSAGE AT THE BOTTOM OF THIS FILE!!!!! Add new migrations above the message.
#
########################################################################################################################
