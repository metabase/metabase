databaseChangeLog:
  - objectQuotingStrategy: QUOTE_ALL_OBJECTS

  - changeSet:
      id: v58.2025-10-30T09:03:00
      author: sanex3339
      comment: Add embedding_type column to report_dashboard table
      changes:
        - addColumn:
            tableName: report_dashboard
            columns:
              - column:
                  name: embedding_type
                  type: varchar(50)
                  remarks: The type of embedding for this dashboard
                  constraints:
                    nullable: true
      rollback:
        - dropColumn:
            tableName: report_dashboard
            columnName: embedding_type

  - changeSet:
      id: v58.2025-10-30T09:03:01
      author: sanex3339
      comment: Add embedding_type column to report_card table
      changes:
        - addColumn:
            tableName: report_card
            columns:
              - column:
                  name: embedding_type
                  type: varchar(50)
                  remarks: The type of embedding for this card
                  constraints:
                    nullable: true
      rollback:
        - dropColumn:
            tableName: report_card
            columnName: embedding_type

  - changeSet:
      id: v58.2025-11-04T23:09:49
      author: edpaget
      comment: Create auth_identity table for multi-authentication support
      changes:
        - createTable:
            tableName: auth_identity
            remarks: Stores authentication credentials for users. A user can have multiple auth identities.
            columns:
              - column:
                  name: id
                  type: int
                  remarks: Integer primary key
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: user_id
                  type: int
                  remarks: Foreign key to core_user
                  constraints:
                    nullable: false
              - column:
                  name: provider
                  type: varchar(50)
                  remarks: Authentication provider type (password, google, ldap, saml, jwt, support)
                  constraints:
                    nullable: false
              - column:
                  name: credentials
                  type: ${text.type}
                  remarks: JSON object containing provider-specific credentials
                  constraints:
                    nullable: true
              - column:
                  name: metadata
                  type: ${text.type}
                  remarks: JSON object containing provider-specific metadata
                  constraints:
                    nullable: true
              - column:
                  name: provider_id
                  type: varchar(255)
                  remarks: Provider-specific identifier (email for password/Google, DN for LDAP, subject for SAML/JWT)
                  constraints:
                    nullable: true
              - column:
                  name: last_used_at
                  type: ${timestamp_type}
                  remarks: Timestamp of last successful authentication
                  constraints:
                    nullable: true
              - column:
                  name: expires_at
                  type: ${timestamp_type}
                  remarks: Timestamp when this authentication method expires (null = never expires)
                  constraints:
                    nullable: true
              - column:
                  name: created_at
                  type: ${timestamp_type}
                  remarks: Timestamp when this identity was created
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: ${timestamp_type}
                  remarks: Timestamp when this identity was last updated
                  constraints:
                    nullable: false
      rollback:
        - dropTable:
            tableName: auth_identity

  - changeSet:
      id: v58.2025-11-04T23:09:58
      author: edpaget
      comment: Add user_id index to auth_identity table
      changes:
        - createIndex:
            tableName: auth_identity
            indexName: idx_auth_identity_user_id
            columns:
              - column:
                  name: user_id
      rollback:
        - dropIndex:
            tableName: auth_identity
            indexName: idx_auth_identity_user_id

  - changeSet:
      id: v58.2025-11-04T23:10:00
      author: edpaget
      comment: Add provider index to auth_identity table
      changes:
        - createIndex:
            tableName: auth_identity
            indexName: idx_auth_identity_provider
            columns:
              - column:
                  name: provider
      rollback:
        - dropIndex:
            tableName: auth_identity
            indexName: idx_auth_identity_provider

  - changeSet:
      id: v58.2025-11-04T23:10:01
      author: edpaget
      comment: Add unique constraint to auth_identity table
      changes:
        - addUniqueConstraint:
            tableName: auth_identity
            columnNames: user_id, provider
            constraintName: unique_auth_identity_user_provider
      rollback:
        - dropUniqueConstraint:
            tableName: auth_identity
            constraintName: unique_auth_identity_user_provider

  - changeSet:
      id: v58.2025-11-06T15:00:43
      author: edpaget
      comment: Create support_access_grant_log table for tracking support access grants
      changes:
        - createTable:
            tableName: support_access_grant_log
            remarks: Store support access grant requests and their lifecycle for audit purposes
            columns:
              - column:
                  name: id
                  type: int
                  autoIncrement: true
                  remarks: Unique identifier for the grant
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: user_id
                  type: int
                  remarks: ID of the admin user who created this grant
                  constraints:
                    nullable: true
              - column:
                  name: ticket_number
                  type: varchar(100)
                  remarks: Support ticket number associated with this grant
                  constraints:
                    nullable: true
              - column:
                  name: notes
                  type: varchar(255)
                  remarks: Additional notes associated with this grant
                  constraints:
                    nullable: true
              - column:
                  name: grant_start_timestamp
                  type: ${timestamp_type}
                  remarks: When the grant becomes active (UTC)
                  constraints:
                    nullable: false
              - column:
                  name: grant_end_timestamp
                  type: ${timestamp_type}
                  remarks: When the grant expires (UTC)
                  constraints:
                    nullable: false
              - column:
                  name: revoked_at
                  type: ${timestamp_type}
                  remarks: When the grant was manually revoked (UTC), null if not revoked
                  constraints:
                    nullable: true
              - column:
                  name: revoked_by_user_id
                  type: int
                  remarks: ID of the admin user who revoked this grant
                  constraints:
                    nullable: true
              - column:
                  name: created_at
                  type: ${timestamp_type}
                  defaultValueComputed: current_timestamp
                  remarks: When this record was created (UTC)
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: ${timestamp_type}
                  defaultValueComputed: current_timestamp
                  remarks: When this record was last updated (UTC)
                  constraints:
                    nullable: false
      rollback:
        - dropTable:
            tableName: support_access_grant_log

  - changeSet:
      id: v58.2025-11-06T15:01:00
      author: edpaget
      comment: Add index for finding support access grants by user
      changes:
        - createIndex:
            indexName: idx_support_access_grant_log_user_id
            tableName: support_access_grant_log
            columns:
              - column:
                  name: user_id

  - changeSet:
      id: v58.2025-11-06T15:01:01
      author: edpaget
      comment: Add index for finding support access grants by revoked_by_user_id
      changes:
        - createIndex:
            indexName: idx_support_access_grant_log_revoked_by_user_id
            tableName: support_access_grant_log
            columns:
              - column:
                  name: revoked_by_user_id

  - changeSet:
      id: v58.2025-11-06T15:01:02
      author: edpaget
      comment: Add foreign key constraint from support_access_grant_log.user_id to core_user with SET NULL on delete
      changes:
        - addForeignKeyConstraint:
            baseTableName: support_access_grant_log
            baseColumnNames: user_id
            constraintName: fk_support_access_grant_log_user_id
            referencedTableName: core_user
            referencedColumnNames: id
            onDelete: SET NULL
      rollback:
        - dropForeignKeyConstraint:
            baseTableName: support_access_grant_log
            constraintName: fk_support_access_grant_log_user_id

  - changeSet:
      id: v58.2025-11-06T15:01:03
      author: edpaget
      comment: Add foreign key constraint from support_access_grant_log.revoked_by_user_id to core_user with SET NULL on delete
      changes:
        - addForeignKeyConstraint:
            baseTableName: support_access_grant_log
            baseColumnNames: revoked_by_user_id
            constraintName: fk_support_access_grant_log_revoked_by_user_id
            referencedTableName: core_user
            referencedColumnNames: id
            onDelete: SET NULL
      rollback:
        - dropForeignKeyConstraint:
            baseTableName: support_access_grant_log
            constraintName: fk_support_access_grant_log_revoked_by_user_id

  - changeSet:
      id: v58.2025-11-06T15:01:04
      author: edpaget
      comment: Add index for finding active support access grants
      changes:
        - createIndex:
            indexName: idx_support_access_grant_log_active
            tableName: support_access_grant_log
            columns:
              - column:
                  name: grant_end_timestamp
              - column:
                  name: revoked_at
            where: revoked_at IS NULL

  - changeSet:
      id: v58.2025-11-10T14:39:00
      author: wotbrew
      comment: Add published_table_id to report_card
      changes:
        - addColumn:
            tableName: report_card
            columns:
              - column:
                  name: published_table_id
                  type: int
                  remarks: The table id that is 'published' by this model
                  constraints:
                    nullable: true

  - changeSet:
      id: v58.2025-11-10T14:39:01
      author: wotbrew
      comment: Add index for report_card.published_table_id
      changes:
        - createIndex:
            tableName: report_card
            indexName: idx_report_card_published_table_id
            columns:
              - column:
                  name: published_table_id

  - changeSet:
      id: v58.2025-11-10T14:39:02
      author: wotbrew
      comment: Add foreign key report_card(published_table_id) to metabase_table(id)
      changes:
        - addForeignKeyConstraint:
            baseTableName: report_card
            baseColumnNames: published_table_id
            referencedTableName: metabase_table
            referencedColumnNames: id
            constraintName: fk_report_card_published_table
            onDelete: SET NULL

  - changeSet:
      id: v58.2025-11-12T00:00:00
      author: edpaget
      comment: Add index on provider_id for efficient lookups
      changes:
        - createIndex:
            tableName: auth_identity
            indexName: idx_auth_identity_provider_id
            columns:
              - column:
                  name: provider_id
      rollback:
        - dropIndex:
            tableName: auth_identity
            indexName: idx_auth_identity_provider_id

  - changeSet:
      id: v58.2025-11-12T00:00:01
      author: edpaget
      comment: Add composite index on (provider, provider_id) for efficient lookups
      changes:
        - createIndex:
            tableName: auth_identity
            indexName: idx_auth_identity_provider_provider_id
            columns:
              - column:
                  name: provider
              - column:
                  name: provider_id
      rollback:
        - dropIndex:
            tableName: auth_identity
            indexName: idx_auth_identity_provider_provider_id

  - changeSet:
      id: v58.2025-11-12T00:00:02
      author: edpaget
      comment: Add foreign key constraint from auth_identity to core_user
      changes:
        - addForeignKeyConstraint:
            baseTableName: auth_identity
            baseColumnNames: user_id
            constraintName: fk_auth_identity_core_user_id
            referencedTableName: core_user
            referencedColumnNames: id
            onDelete: CASCADE
      rollback:
        - dropForeignKeyConstraint:
            baseTableName: auth_identity
            constraintName: fk_auth_identity_core_user_id

  - changeSet:
      id: v58.2025-11-12T00:00:07
      author: edpaget
      comment: Add auth_identity_id columns to core_session table
      changes:
        - addColumn:
            tableName: core_session
            columns:
              - column:
                  name: auth_identity_id
                  type: int
                  remarks: Foreign key to auth_identity - tracks which auth method was used for login
                  constraints:
                    nullable: true
      rollback:
        - dropColumn:
            tableName: core_session
            columnName: auth_identity_id

  - changeSet:
      id: v58.2025-11-12T00:00:08
      author: edpaget
      comment: Add expires_at columns to core_session table
      changes:
        - addColumn:
            tableName: core_session
            columns:
              - column:
                  name: expires_at
                  type: ${timestamp_type}
                  remarks: Timestamp when this session expires (from auth_identity or calculated)
                  constraints:
                    nullable: true
      rollback:
        - dropColumn:
            tableName: core_session
            columnName: expires_at

  - changeSet:
      id: v58.2025-11-12T00:00:09
      author: edpaget
      comment: Add index on core_session.auth_identity_id
      changes:
        - createIndex:
            tableName: core_session
            indexName: idx_core_session_auth_identity_id
            columns:
              - column:
                  name: auth_identity_id
      rollback:
        - dropIndex:
            tableName: core_session
            indexName: idx_core_session_auth_identity_id

  - changeSet:
      id: v58.2025-11-12T00:00:10
      author: edpaget
      comment: Add foreign key constraint from core_session to auth_identity
      changes:
        - addForeignKeyConstraint:
            baseTableName: core_session
            baseColumnNames: auth_identity_id
            constraintName: fk_session_auth_identity
            referencedTableName: auth_identity
            referencedColumnNames: id
            onDelete: CASCADE
      rollback:
        - dropForeignKeyConstraint:
            baseTableName: core_session
            constraintName: fk_session_auth_identity

  - changeSet:
      id: v58.2025-11-12T00:00:11
      author: edpaget
      comment: Migrate password authentication to auth_identity table
      changes:
        - sql:
            dbms: postgresql
            sql: >-
              INSERT INTO auth_identity (user_id, provider, provider_id, credentials, metadata, created_at, updated_at)
              SELECT
                id,
                'password',
                LEFT(email, 255),
                json_build_object('password_hash', password, 'password_salt', password_salt)::text,
                NULL,
                COALESCE(date_joined, now()),
                now()
              FROM core_user
              WHERE password IS NOT NULL
              ON CONFLICT (user_id, provider) DO NOTHING;
        - sql:
            dbms: mysql,mariadb
            sql: >-
              INSERT IGNORE INTO auth_identity (user_id, provider, provider_id, credentials, metadata, created_at, updated_at)
              SELECT
                id,
                'password',
                LEFT(email, 255),
                json_object('password_hash', password, 'password_salt', password_salt),
                NULL,
                COALESCE(date_joined, now()),
                now()
              FROM core_user
              WHERE password IS NOT NULL;
        - sql:
            dbms: h2
            sql: >-
              INSERT INTO auth_identity (user_id, provider, provider_id, credentials, metadata, created_at, updated_at)
              SELECT
                id,
                'password',
                LEFT(email, 255),
                CONCAT('{"password_hash":"', password, '","password_salt":"', password_salt, '"}'),
                NULL,
                COALESCE(date_joined, now()),
                now()
              FROM core_user
              WHERE password IS NOT NULL
                AND NOT EXISTS (
                  SELECT 1 FROM auth_identity ai
                  WHERE ai.user_id = core_user.id AND ai.provider = 'password'
                );
      rollback:
        - sql: DELETE FROM auth_identity WHERE provider = 'password';

  - changeSet:
      id: v58.2025-11-12T00:00:12
      author: edpaget
      comment: Migrate LDAP authentication to auth_identity table
      changes:
        - sql:
            dbms: postgresql
            sql: >-
              INSERT INTO auth_identity (user_id, provider, provider_id, credentials, metadata, created_at, updated_at)
              SELECT
                id,
                'ldap',
                LEFT(email, 255),
                NULL,
                json_build_object('login_attributes', login_attributes)::text,
                COALESCE(date_joined, now()),
                now()
              FROM core_user
              WHERE sso_source = 'ldap'
              ON CONFLICT (user_id, provider) DO NOTHING;
        - sql:
            dbms: mysql,mariadb
            sql: >-
              INSERT IGNORE INTO auth_identity (user_id, provider, provider_id, credentials, metadata, created_at, updated_at)
              SELECT
                id,
                'ldap',
                LEFT(email, 255),
                NULL,
                json_object('login_attributes', login_attributes),
                COALESCE(date_joined, now()),
                now()
              FROM core_user
              WHERE sso_source = 'ldap';
        - sql:
            dbms: h2
            sql: >-
              INSERT INTO auth_identity (user_id, provider, provider_id, credentials, metadata, created_at, updated_at)
              SELECT
                id,
                'ldap',
                LEFT(email, 255),
                NULL,
                CONCAT('{"login_attributes":', COALESCE(login_attributes, 'null'), '}'),
                COALESCE(date_joined, now()),
                now()
              FROM core_user
              WHERE sso_source = 'ldap'
                AND NOT EXISTS (
                  SELECT 1 FROM auth_identity ai
                  WHERE ai.user_id = core_user.id AND ai.provider = 'ldap'
                );
      rollback:
        - sql: DELETE FROM auth_identity WHERE provider = 'ldap';

  - changeSet:
      id: v58.2025-11-12T00:00:13
      author: edpaget
      comment: Migrate Google SSO authentication to auth_identity table
      changes:
        - sql:
            dbms: postgresql
            sql: >-
              INSERT INTO auth_identity (user_id, provider, provider_id, credentials, metadata, created_at, updated_at)
              SELECT
                id,
                'google',
                LEFT(email, 255),
                NULL,
                json_build_object('sso_source', 'google', 'login_attributes', login_attributes)::text,
                COALESCE(date_joined, now()),
                now()
              FROM core_user
              WHERE sso_source = 'google'
              ON CONFLICT (user_id, provider) DO NOTHING;
        - sql:
            dbms: mysql,mariadb
            sql: >-
              INSERT IGNORE INTO auth_identity (user_id, provider, provider_id, credentials, metadata, created_at, updated_at)
              SELECT
                id,
                'google',
                LEFT(email, 255),
                NULL,
                json_object('sso_source', 'google', 'login_attributes', login_attributes),
                COALESCE(date_joined, now()),
                now()
              FROM core_user
              WHERE sso_source = 'google';
        - sql:
            dbms: h2
            sql: >-
              INSERT INTO auth_identity (user_id, provider, provider_id, credentials, metadata, created_at, updated_at)
              SELECT
                id,
                'google',
                LEFT(email, 255),
                NULL,
                CONCAT('{"sso_source":"google","login_attributes":', COALESCE(login_attributes, 'null'), '}'),
                COALESCE(date_joined, now()),
                now()
              FROM core_user
              WHERE sso_source = 'google'
                AND NOT EXISTS (
                  SELECT 1 FROM auth_identity ai
                  WHERE ai.user_id = core_user.id AND ai.provider = 'google'
                );
      rollback:
        - sql: DELETE FROM auth_identity WHERE provider = 'google';

  - changeSet:
      id: v58.2025-11-12T00:00:14
      author: edpaget
      comment: Migrate SAML and JWT authentication to auth_identity table
      changes:
        - sql:
            dbms: postgresql
            sql: >-
              INSERT INTO auth_identity (user_id, provider, provider_id, credentials, metadata, created_at, updated_at)
              SELECT
                id,
                sso_source,
                LEFT(email, 255),
                NULL,
                json_build_object('sso_source', sso_source, 'login_attributes', login_attributes, 'jwt_attributes', jwt_attributes)::text,
                COALESCE(date_joined, now()),
                now()
              FROM core_user
              WHERE sso_source IN ('saml', 'jwt')
              ON CONFLICT (user_id, provider) DO NOTHING;
        - sql:
            dbms: mysql,mariadb
            sql: >-
              INSERT IGNORE INTO auth_identity (user_id, provider, provider_id, credentials, metadata, created_at, updated_at)
              SELECT
                id,
                sso_source,
                LEFT(email, 255),
                NULL,
                json_object('sso_source', sso_source, 'login_attributes', login_attributes, 'jwt_attributes', jwt_attributes),
                COALESCE(date_joined, now()),
                now()
              FROM core_user
              WHERE sso_source IN ('saml', 'jwt');
        - sql:
            dbms: h2
            sql: >-
              INSERT INTO auth_identity (user_id, provider, provider_id, credentials, metadata, created_at, updated_at)
              SELECT
                id,
                sso_source,
                LEFT(email, 255),
                NULL,
                CONCAT('{"sso_source":"', sso_source, '","login_attributes":', COALESCE(login_attributes, 'null'), ',"jwt_attributes":', COALESCE(jwt_attributes, 'null'), '}'),
                COALESCE(date_joined, now()),
                now()
              FROM core_user
              WHERE sso_source IN ('saml', 'jwt')
                AND NOT EXISTS (
                  SELECT 1 FROM auth_identity ai
                  WHERE ai.user_id = core_user.id AND ai.provider = core_user.sso_source
                );
      rollback:
        - sql: DELETE FROM auth_identity WHERE provider IN ('saml', 'jwt');

  - changeSet:
      id: v58.2025-11-12T11:57:00
      author: wotbrew
      comment: Add data_source column to metabase_table
      changes:
        - addColumn:
            tableName: metabase_table
            columns:
              - column:
                  name: data_source
                  type: varchar(254)
                  remarks: The origin type of the data (e.g. metabase-transform)
                  constraints:
                    nullable: true

  - changeSet:
      id: v58.2025-11-12T11:57:02
      author: wotbrew
      comment: Add data_layer column to metabase_table
      changes:
        - addColumn:
            tableName: metabase_table
            columns:
              - column:
                  name: data_layer
                  type: varchar(254)
                  remarks: The (new) enum for visibility class
                  constraints:
                    nullable: true

  - changeSet:
      id: v58.2025-11-12T11:57:03
      author: wotbrew
      comment: Add owner_email column to metabase_table
      changes:
        - addColumn:
            tableName: metabase_table
            columns:
              - column:
                  name: owner_email
                  type: ${text.type}
                  remarks: An optional email address of the 'owner' of this table, exclusive with owner_user_id.
                  constraints:
                    nullable: true

  - changeSet:
      id: v58.2025-11-12T11:57:04
      author: wotbrew
      comment: Add owner_user_id column to metabase_table
      changes:
        - addColumn:
            tableName: metabase_table
            columns:
              - column:
                  name: owner_user_id
                  type: int
                  remarks: An (metabase) user id of the 'owner' of this table, exclusive with owner_email.
                  constraints:
                    nullable: true

  - changeSet:
      id: v58.2025-11-13T10:00:00
      author: qnkhuat
      comment: Backfill data_layer from visibility_type
      changes:
        - sql: >-
            UPDATE metabase_table
            SET data_layer = CASE
              WHEN visibility_type IN ('hidden', 'retired', 'sensitive', 'technical', 'cruft') THEN 'copper'
              ELSE 'bronze'
            END
      rollback:
        - sql: >-
            UPDATE metabase_table
            SET visibility_type = CASE
              WHEN data_layer = 'copper' THEN 'hidden'
              ELSE NULL
            END
        - sql: >-
            UPDATE metabase_table
            SET data_layer = NULL

  - changeSet:
      id: v58.2025-11-18T12:31:27
      author: johnswanson
      comment: Create `tenant` table
      preConditions: # not needed
      changes:
        - createTable:
            tableName: tenant
            remarks: |
              Tenants (collections of external users). A user can be in exactly zero or one tenants.
            columns:
              - column:
                  name: id
                  type: int
                  autoIncrement: true
                  remarks: the ID of the tenant
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: "name"
                  type: varchar(254)
                  remarks: the unique name of the tenant
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: "slug"
                  type: varchar(254)
                  remarks: "the slugified version of this tenant's name"
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: "is_active"
                  type: ${boolean.type}
                  remarks: Whether the tenant is active or not
                  defaultValueBoolean: true
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: ${timestamp_type}
                  remarks: The timestamp of when the tenant was updated
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: ${timestamp_type}
                  remarks: The timestamp of when the tenant was created
                  constraints:
                    nullable: false

  - changeSet:
      id: v58.2025-11-18T12:31:44
      author: johnswanson
      comment: add an index for `core_user.tenant_id`
      changes:
        - createIndex:
            tableName: core_user
            indexName: idx_core_user_tenant_id
            columns:
              - column:
                  name: tenant_id

  - changeSet:
      id: v58.2025-11-18T12:31:47
      author: johnswanson
      comment: Add foreign key for `core_user.tenant_id`
      preConditions: # not needed
      changes:
        - addForeignKeyConstraint:
            baseTableName: core_user
            baseColumnNames: tenant_id
            referencedTableName: tenant
            referencedColumnNames: id
            constraintName: fk_core_user_tenant_id
            onDelete: RESTRICT

  - changeSet:
      id: v58.2025-11-18T12:31:49
      author: johnswanson
      comment: Rename any existing `@.+` user attributes to add a preceding underscore
      changes:
        - customChange:
            class: "metabase.app_db.custom_migrations.MoveExistingAtSymbolUserAttributes"

  - changeSet:
      id: v58.2025-11-18T12:31:51
      author: johnswanson
      comment: Mark users with `deactivated_with_tenant`
      changes:
        - addColumn:
            tableName: core_user
            columns:
              - column:
                  name: deactivated_with_tenant
                  remarks: |
                    if this user and its tenant are both deactivated, represents whether the user was deactivated
                    *with* the tenant (in which case it should be reactivated when the tenant is reactivated)
                    or was deactivated independently.
                  type: ${boolean.type}
                  constraints:
                    nullable: true

  - changeSet:
      id: v58.2025-11-18T12:31:53
      author: edpaget
      comment: add column for tenant attributes
      preConditions: # not needed
      changes:
        - addColumn:
            tableName: tenant
            columns:
              - column:
                  name: attributes
                  type: ${text.type}
                  remarks: JSON object containing custom tenant attributes
                  constraints:
                    nullable: true

  - changeSet:
      id: v58.2025-11-18T12:31:54
      author: johnswanson
      comment: External Users groups
      rollback:
        - sql:
            sql: >-
              DELETE FROM permissions_group WHERE magic_group_type IN ('all-external-users', 'read-external-users', 'write-external-users');
      changes:
        - sql:
            sql: >-
              INSERT INTO permissions_group (name, magic_group_type, is_tenant_group)
              VALUES
              ('All tenant users', 'all-external-users', true);

  - changeSet:
      id: v58.2025-11-19T00:00:00
      author: edpaget
      comment: Add is_remote_synced boolean column to collection table
      changes:
        - addColumn:
            tableName: collection
            columns:
              - column:
                  name: is_remote_synced
                  type: ${boolean.type}
                  remarks: Indicates if this collection is synced from a remote source
                  defaultValueBoolean: false
                  constraints:
                    nullable: true
      rollback:
        - dropColumn:
            tableName: collection
            columnName: is_remote_synced

  - changeSet:
      id: v58.2025-11-19T00:00:01
      author: edpaget
      comment: Migrate existing remote-synced collections to use is_remote_synced column
      changes:
        - sql:
            sql: UPDATE collection SET is_remote_synced = true WHERE type = 'remote-synced'
      rollback:
        - sql:
            sql: UPDATE collection SET is_remote_synced = false WHERE type = 'remote-synced'

  - changeSet:
      id: v58.2025-11-19T00:00:02
      author: edpaget
      comment: Clear remote-synced type value (replaced by is_remote_synced column)
      changes:
        - sql:
            sql: UPDATE collection SET type = NULL WHERE type = 'remote-synced'
      rollback:
        - sql:
            sql: UPDATE collection SET type = 'remote-synced' WHERE is_remote_synced = true

  - changeSet:
      id: v58.2025-11-25T00:00:00
      author: edpaget
      comment: Add default read permissions for All Users group on shared-tenant-collection root
      changes:
        - sql:
            sql: >-
              INSERT INTO permissions (group_id, object)
              SELECT pg.id, '/collection/namespace/shared-tenant-collection/root/read/'
              FROM permissions_group pg
              WHERE pg.magic_group_type = 'all-internal-users'
                AND NOT EXISTS (
                  SELECT 1 FROM permissions p
                  WHERE p.group_id = pg.id
                    AND p.object = '/collection/namespace/shared-tenant-collection/root/read/'
                );
      rollback:
        - sql:
            sql: >-
              DELETE FROM permissions
              WHERE object = '/collection/namespace/shared-tenant-collection/root/read/'
                AND group_id IN (SELECT id FROM permissions_group WHERE magic_group_type = 'all-internal-users');

  - changeSet:
      id: v58.2025-11-25T00:00:01
      author: edpaget
      comment: Add default read permissions for All External Users group on shared-tenant-collection root
      changes:
        - sql:
            sql: >-
              INSERT INTO permissions (group_id, object)
              SELECT pg.id, '/collection/namespace/shared-tenant-collection/root/read/'
              FROM permissions_group pg
              WHERE pg.magic_group_type = 'all-external-users'
                AND NOT EXISTS (
                  SELECT 1 FROM permissions p
                  WHERE p.group_id = pg.id
                    AND p.object = '/collection/namespace/shared-tenant-collection/root/read/'
                );
      rollback:
        - sql:
            sql: >-
              DELETE FROM permissions
              WHERE object = '/collection/namespace/shared-tenant-collection/root/read/'
                AND group_id IN (SELECT id FROM permissions_group WHERE magic_group_type = 'all-external-users');

  - changeSet:
      id: v58.2025-11-25T17:04:00
      author: dependencies
      comment: Add dependency_analysis_version to segment table for tracking dependency changes
      preConditions:
        - onFail: MARK_RAN
        - not:
            changeSetExecuted:
              id: v57.2025-11-25T17:04:00
              author: dependencies
              changeLogFile: migrations/057_update_migrations.yaml
      changes:
        - addColumn:
            tableName: segment
            columns:
              - column:
                  name: dependency_analysis_version
                  type: integer
                  defaultValueNumeric: 0
                  remarks: Version number for dependency analysis to track when dependencies need recalculation
                  constraints:
                    nullable: false
      rollback:
        - dropColumn:
            tableName: segment
            columnName: dependency_analysis_version

  - changeSet:
      id: v58.2025-11-25T17:41:50
      author: metamben
      comment: Add collection_id column to metabase_table for publishing tables to collections
      changes:
        - addColumn:
            tableName: metabase_table
            columns:
              - column:
                  name: collection_id
                  type: int
                  remarks: The collection this table is published to (null if not published or published to root)
                  constraints:
                    nullable: true

  - changeSet:
      id: v58.2025-11-25T17:41:51
      author: metamben
      comment: Add index on metabase_table.collection_id
      changes:
        - createIndex:
            tableName: metabase_table
            indexName: idx_metabase_table_collection_id
            columns:
              - column:
                  name: collection_id

  - changeSet:
      id: v58.2025-11-25T17:41:52
      author: metamben
      comment: Add foreign key constraint from metabase_table.collection_id to collection.id
      changes:
        - addForeignKeyConstraint:
            baseTableName: metabase_table
            baseColumnNames: collection_id
            constraintName: fk_metabase_table_collection_id
            referencedTableName: collection
            referencedColumnNames: id

  - changeSet:
      id: v58.2025-11-25T17:41:53
      author: metamben
      comment: Add is_published column to metabase_table
      changes:
        - addColumn:
            tableName: metabase_table
            columns:
              - column:
                  name: is_published
                  type: ${boolean.type}
                  remarks: Whether this table is published
                  defaultValueBoolean: false
                  constraints:
                    nullable: false

  - changeSet:
      id: v58.2025-11-26T12:00:00
      author: piranha
      comment: Create workspace table
      validCheckSum: ANY
      preConditions:
        - onFail: MARK_RAN
        - not:
            - tableExists:
                tableName: workspace
      changes:
        - createTable:
            tableName: workspace
            remarks: Internal Metabase container
            columns:
              - column:
                  name: id
                  type: int
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
                  remarks: Integer PK
              - column:
                  name: name
                  type: varchar(254)
                  remarks: Workspace name
              - column:
                  name: collection_id
                  type: int
                  constraints:
                    nullable: true
                  remarks: FK to workspace's collection
              - column:
                  name: creator_id
                  type: int
                  remarks: FK to owner
              - column:
                  name: api_key_id
                  type: int
                  remarks: FK to api key used by agent
              - column:
                  name: execution_user
                  type: int
                  remarks: FK to api key's user
              - column:
                  name: database_id
                  type: int
                  remarks: FK to db used for this workspace
              - column:
                  name: schema
                  type: varchar(254)
                  remarks: Isolated schema where work happens
                  constraints:
                    nullable: true
              - column:
                  name: created_at
                  type: ${timestamp_type}
                  remarks: Timestamp when the workspace was created
                  defaultValueComputed: current_timestamp
              - column:
                  name: updated_at
                  type: ${timestamp_type}
                  remarks: Timestamp when the workspace was last updated
                  defaultValueComputed: current_timestamp
              - column:
                  name: archived_at
                  type: ${timestamp_type}
                  remarks: Timestamp when (and if) the workspace was archived
                  constraints:
                    nullable: true
      rollback:
        - dropTable:
            tableName: workspace

  - changeSet:
      id: v58.2025-11-26T12:00:01
      validCheckSum: ANY
      author: piranha
      comment: Add index on workspace.collection_id for quick lookups by collection
      preConditions:
        - onFail: MARK_RAN
        - not:
            - indexExists:
                indexName: idx_workspace_collection_id
      changes:
        - createIndex:
            tableName: workspace
            indexName: idx_workspace_collection_id
            columns:
              - column:
                  name: collection_id
      rollback: # will be removed along the table

  - changeSet:
      id: v58.2025-11-26T12:00:02
      validCheckSum: ANY
      author: piranha
      comment: Add index on workspace.creator_id for quick lookups
      preConditions:
        - onFail: MARK_RAN
        - not:
            - indexExists:
                indexName: idx_workspace_creator_id
      changes:
        - createIndex:
            tableName: workspace
            indexName: idx_workspace_creator_id
            columns:
              - column:
                  name: creator_id
      rollback: # will be removed along the table

  - changeSet:
      id: v58.2025-11-26T12:00:03
      validCheckSum: ANY
      author: piranha
      comment: Add index on workspace.api_key_id for quick lookups
      preConditions:
        - onFail: MARK_RAN
        - not:
            - indexExists:
                indexName: idx_workspace_api_key_id
      changes:
        - createIndex:
            tableName: workspace
            indexName: idx_workspace_api_key_id
            columns:
              - column:
                  name: api_key_id
      rollback: # will be removed along the table

  - changeSet:
      id: v58.2025-11-26T12:00:04
      validCheckSum: ANY
      author: piranha
      comment: Add index on workspace.execution_user for quick lookups
      preConditions:
        - onFail: MARK_RAN
        - not:
            - indexExists:
                indexName: idx_workspace_execution_user_id
      changes:
        - createIndex:
            tableName: workspace
            indexName: idx_workspace_execution_user_id
            columns:
              - column:
                  name: execution_user
      rollback: # will be removed along the table

  - changeSet:
      id: v58.2025-11-26T12:00:07
      validCheckSum: ANY
      author: piranha
      comment: Add workspace_id column to metabase_table table
      preConditions:
        - onFail: MARK_RAN
        - not:
            - columnExists:
                tableName: metabase_table
                columnName: workspace_id
      changes:
        - addColumn:
            tableName: metabase_table
            columns:
              - column:
                  name: workspace_id
                  type: int
                  remarks: Workspace that owns schema with this table
                  constraints:
                    nullable: true
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-11-26T12:00:08
      validCheckSum: ANY
      author: piranha
      comment: Add foreign key constraint from metabase_table.workspace_id to workspace
      preConditions:
        - onFail: MARK_RAN
        - not:
            - foreignKeyConstraintExists:
                foreignKeyName: fk_metabase_table_workspace_id
      changes:
        - addForeignKeyConstraint:
            baseTableName: metabase_table
            baseColumnNames: workspace_id
            constraintName: fk_metabase_table_workspace_id
            referencedTableName: workspace
            referencedColumnNames: id
      rollback:
        - dropForeignKeyConstraint:
            baseTableName: metabase_table
            constraintName: fk_metabase_table_workspace_id

  - changeSet:
      id: v58.2025-11-26T12:00:09
      validCheckSum: ANY
      author: piranha
      comment: Add workspace_id column to metabase_field table
      preConditions:
        - onFail: MARK_RAN
        - not:
            - columnExists:
                tableName: metabase_field
                columnName: workspace_id
      changes:
        - addColumn:
            tableName: metabase_field
            columns:
              - column:
                  name: workspace_id
                  type: int
                  remarks: Workspace that owns schema with this field
                  constraints:
                    nullable: true
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-11-26T12:00:10
      validCheckSum: ANY
      author: piranha
      comment: Add foreign key constraint from metabase_field.workspace_id to workspace
      preConditions:
        - onFail: MARK_RAN
        - not:
            - foreignKeyConstraintExists:
                foreignKeyName: fk_metabase_field_workspace_id
      changes:
        - addForeignKeyConstraint:
            baseTableName: metabase_field
            baseColumnNames: workspace_id
            constraintName: fk_metabase_field_workspace_id
            referencedTableName: workspace
            referencedColumnNames: id
      rollback:
        - dropForeignKeyConstraint:
            baseTableName: metabase_field
            constraintName: fk_metabase_field_workspace_id

  - changeSet:
      id: v58.2025-11-26T12:00:11
      validCheckSum: ANY
      author: piranha
      comment: Add workspace_id column to collection table
      preConditions:
        - onFail: MARK_RAN
        - not:
            - columnExists:
                tableName: collection
                columnName: workspace_id
      changes:
        - addColumn:
            tableName: collection
            columns:
              - column:
                  name: workspace_id
                  type: int
                  remarks: Workspace containing this collection
                  constraints:
                    nullable: true
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-11-26T12:00:13
      validCheckSum: ANY
      author: piranha
      comment: Add workspace_id column to report_card table
      preConditions:
        - onFail: MARK_RAN
        - not:
            - columnExists:
                tableName: report_card
                columnName: workspace_id
      changes:
        - addColumn:
            tableName: report_card
            columns:
              - column:
                  name: workspace_id
                  type: int
                  remarks: Workspace containing this card
                  constraints:
                    nullable: true
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-11-26T12:00:14
      validCheckSum: ANY
      author: piranha
      comment: Add foreign key constraint from report_card.workspace_id to workspace
      preConditions:
        - onFail: MARK_RAN
        - not:
            - foreignKeyConstraintExists:
                foreignKeyName: fk_report_card_workspace_id
      changes:
        - addForeignKeyConstraint:
            baseTableName: report_card
            baseColumnNames: workspace_id
            constraintName: fk_report_card_workspace_id
            referencedTableName: workspace
            referencedColumnNames: id
      rollback:
        - dropForeignKeyConstraint:
            baseTableName: report_card
            constraintName: fk_report_card_workspace_id

  - changeSet:
      id: v58.2025-11-26T12:00:17
      validCheckSum: ANY
      author: piranha
      comment: Add workspace_id column to transform table
      preConditions:
        - onFail: MARK_RAN
        - not:
            - columnExists:
                tableName: transform
                columnName: workspace_id
      changes:
        - addColumn:
            tableName: transform
            columns:
              - column:
                  name: workspace_id
                  type: int
                  remarks: Workspace containing this transform
                  constraints:
                    nullable: true
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-11-26T12:00:18
      validCheckSum: ANY
      author: piranha
      comment: Add foreign key constraint from transform.workspace_id to workspace
      preConditions:
        - onFail: MARK_RAN
        - not:
            - foreignKeyConstraintExists:
                foreignKeyName: fk_transform_workspace_id
      changes:
        - addForeignKeyConstraint:
            baseTableName: transform
            baseColumnNames: workspace_id
            constraintName: fk_transform_workspace_id
            referencedTableName: workspace
            referencedColumnNames: id
      rollback:
        - dropForeignKeyConstraint:
            baseTableName: transform
            constraintName: fk_transform_workspace_id

  - changeSet:
      id: v58.2025-11-26T13:34:41
      validCheckSum: ANY
      author: christruter
      comment: Create workspace_mapping_table for mirroring tables in workspaces
      preConditions:
        - onFail: MARK_RAN
        - not:
            - tableExists:
                tableName: workspace_mapping_table
      changes:
        - createTable:
            tableName: workspace_mapping_table
            remarks: Maps upstream tables to downstream tables within a workspace
            columns:
              - column:
                  name: upstream_id
                  type: int
                  remarks: ID of the source table outside the workspace
                  constraints:
                    nullable: false
              - column:
                  name: downstream_id
                  type: int
                  remarks: ID of the mirrored table inside the workspace
                  constraints:
                    nullable: false
              - column:
                  name: workspace_id
                  type: int
                  remarks: ID of the workspace containing the mapping
                  constraints:
                    nullable: false
      rollback:
        - dropTable:
            tableName: workspace_mapping_table

  - changeSet:
      id: v58.2025-11-26T13:34:42
      validCheckSum: ANY
      author: christruter
      comment: Add primary key constraint to workspace_mapping_table
      preConditions:
        - onFail: MARK_RAN
        - not:
            - primaryKeyExists:
                tableName: workspace_mapping_table
                primaryKeyName: pk_workspace_mapping_table
      changes:
        - addPrimaryKey:
            tableName: workspace_mapping_table
            columnNames: upstream_id, downstream_id
            constraintName: pk_workspace_mapping_table
      rollback:
        - dropPrimaryKey:
            tableName: workspace_mapping_table
            constraintName: pk_workspace_mapping_table

  - changeSet:
      id: v58.2025-11-26T13:34:44
      validCheckSum: ANY
      author: christruter
      comment: Add index on upstream_id for workspace_mapping_table
      preConditions:
        - onFail: MARK_RAN
        - not:
            - indexExists:
                indexName: idx_workspace_mapping_table_upstream_id
      changes:
        - createIndex:
            tableName: workspace_mapping_table
            indexName: idx_workspace_mapping_table_upstream_id
            columns:
              - column:
                  name: upstream_id
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-11-26T13:34:45
      validCheckSum: ANY
      author: christruter
      comment: Add index on downstream_id for workspace_mapping_table
      preConditions:
        - onFail: MARK_RAN
        - not:
            - indexExists:
                indexName: idx_workspace_mapping_table_downstream_id
      changes:
        - createIndex:
            tableName: workspace_mapping_table
            indexName: idx_workspace_mapping_table_downstream_id
            columns:
              - column:
                  name: downstream_id
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-11-26T13:34:46
      validCheckSum: ANY
      author: christruter
      comment: Add index on workspace_id for workspace_mapping_table
      preConditions:
        - onFail: MARK_RAN
        - not:
            - indexExists:
                indexName: idx_workspace_mapping_table_workspace_id
      changes:
        - createIndex:
            tableName: workspace_mapping_table
            indexName: idx_workspace_mapping_table_workspace_id
            columns:
              - column:
                  name: workspace_id
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-11-26T13:34:47
      validCheckSum: ANY
      author: christruter
      comment: Add foreign key constraint from workspace_mapping_table.upstream_id to metabase_table
      preConditions:
        - onFail: MARK_RAN
        - not:
            - foreignKeyConstraintExists:
                foreignKeyName: fk_workspace_mapping_table_upstream_id
      changes:
        - addForeignKeyConstraint:
            baseTableName: workspace_mapping_table
            baseColumnNames: upstream_id
            constraintName: fk_workspace_mapping_table_upstream_id
            referencedTableName: metabase_table
            referencedColumnNames: id
            onDelete: CASCADE
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-11-26T13:34:48
      validCheckSum: ANY
      author: christruter
      comment: Add foreign key constraint from workspace_mapping_table.downstream_id to metabase_table
      preConditions:
        - onFail: MARK_RAN
        - not:
            - foreignKeyConstraintExists:
                foreignKeyName: fk_workspace_mapping_table_downstream_id
      changes:
        - addForeignKeyConstraint:
            baseTableName: workspace_mapping_table
            baseColumnNames: downstream_id
            constraintName: fk_workspace_mapping_table_downstream_id
            referencedTableName: metabase_table
            referencedColumnNames: id
            onDelete: CASCADE
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-11-26T13:34:49
      validCheckSum: ANY
      author: christruter
      comment: Add foreign key constraint from workspace_mapping_table.workspace_id to workspace
      preConditions:
        - onFail: MARK_RAN
        - not:
            - foreignKeyConstraintExists:
                foreignKeyName: fk_workspace_mapping_table_workspace_id
      changes:
        - addForeignKeyConstraint:
            baseTableName: workspace_mapping_table
            baseColumnNames: workspace_id
            constraintName: fk_workspace_mapping_table_workspace_id
            referencedTableName: workspace
            referencedColumnNames: id
            onDelete: CASCADE
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-11-26T13:34:50
      validCheckSum: ANY
      author: christruter
      comment: Create workspace_mapping_transform for mirroring transforms in workspaces
      preConditions:
        - onFail: MARK_RAN
        - not:
            - tableExists:
                tableName: workspace_mapping_transform
      changes:
        - createTable:
            tableName: workspace_mapping_transform
            remarks: Maps upstream transforms to downstream transforms within a workspace
            columns:
              - column:
                  name: upstream_id
                  type: int
                  remarks: ID of the source transform outside the workspace
                  constraints:
                    nullable: false
              - column:
                  name: downstream_id
                  type: int
                  remarks: ID of the mirrored transform inside the workspace
                  constraints:
                    nullable: false
              - column:
                  name: workspace_id
                  type: int
                  remarks: ID of the workspace containing the mapping
                  constraints:
                    nullable: false
      rollback:
        - dropTable:
            tableName: workspace_mapping_transform

  - changeSet:
      id: v58.2025-11-26T13:34:51
      validCheckSum: ANY
      author: christruter
      comment: Add primary key constraint to workspace_mapping_transform
      preConditions:
        - onFail: MARK_RAN
        - not:
            - primaryKeyExists:
                tableName: workspace_mapping_transform
                primaryKeyName: pk_workspace_mapping_transform
      changes:
        - addPrimaryKey:
            tableName: workspace_mapping_transform
            columnNames: upstream_id, downstream_id
            constraintName: pk_workspace_mapping_transform
      rollback:
        - dropPrimaryKey:
            tableName: workspace_mapping_transform
            constraintName: pk_workspace_mapping_transform

  - changeSet:
      id: v58.2025-11-26T13:34:53
      validCheckSum: ANY
      author: christruter
      comment: Add index on upstream_id for workspace_mapping_transform
      preConditions:
        - onFail: MARK_RAN
        - not:
            - indexExists:
                indexName: idx_workspace_mapping_transform_upstream_id
      changes:
        - createIndex:
            tableName: workspace_mapping_transform
            indexName: idx_workspace_mapping_transform_upstream_id
            columns:
              - column:
                  name: upstream_id
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-11-26T13:34:54
      validCheckSum: ANY
      author: christruter
      comment: Add index on downstream_id for workspace_mapping_transform
      preConditions:
        - onFail: MARK_RAN
        - not:
            - indexExists:
                indexName: idx_workspace_mapping_transform_downstream_id
      changes:
        - createIndex:
            tableName: workspace_mapping_transform
            indexName: idx_workspace_mapping_transform_downstream_id
            columns:
              - column:
                  name: downstream_id
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-11-26T13:34:55
      validCheckSum: ANY
      author: christruter
      comment: Add index on workspace_id for workspace_mapping_transform
      preConditions:
        - onFail: MARK_RAN
        - not:
            - indexExists:
                indexName: idx_workspace_mapping_transform_workspace_id
      changes:
        - createIndex:
            tableName: workspace_mapping_transform
            indexName: idx_workspace_mapping_transform_workspace_id
            columns:
              - column:
                  name: workspace_id
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-11-26T13:34:56
      validCheckSum: ANY
      author: christruter
      comment: Add foreign key constraint from workspace_mapping_transform.upstream_id to transform
      preConditions:
        - onFail: MARK_RAN
        - not:
            - foreignKeyConstraintExists:
                foreignKeyName: fk_workspace_mapping_transform_upstream_id
      changes:
        - addForeignKeyConstraint:
            baseTableName: workspace_mapping_transform
            baseColumnNames: upstream_id
            constraintName: fk_workspace_mapping_transform_upstream_id
            referencedTableName: transform
            referencedColumnNames: id
            onDelete: CASCADE
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-11-26T13:34:57
      validCheckSum: ANY
      author: christruter
      comment: Add foreign key constraint from workspace_mapping_transform.downstream_id to transform
      preConditions:
        - onFail: MARK_RAN
        - not:
            - foreignKeyConstraintExists:
                foreignKeyName: fk_workspace_mapping_transform_downstream_id
      changes:
        - addForeignKeyConstraint:
            baseTableName: workspace_mapping_transform
            baseColumnNames: downstream_id
            constraintName: fk_workspace_mapping_transform_downstream_id
            referencedTableName: transform
            referencedColumnNames: id
            onDelete: CASCADE
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-11-26T13:34:58
      validCheckSum: ANY
      author: christruter
      comment: Add foreign key constraint from workspace_mapping_transform.workspace_id to workspace
      preConditions:
        - onFail: MARK_RAN
        - not:
            - foreignKeyConstraintExists:
                foreignKeyName: fk_workspace_mapping_transform_workspace_id
      changes:
        - addForeignKeyConstraint:
            baseTableName: workspace_mapping_transform
            baseColumnNames: workspace_id
            constraintName: fk_workspace_mapping_transform_workspace_id
            referencedTableName: workspace
            referencedColumnNames: id
            onDelete: CASCADE
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-11-26T13:34:59
      validCheckSum: ANY
      author: christruter
      comment: Add index on collection.workspace_id
      preConditions:
        - onFail: MARK_RAN
        - not:
            - indexExists:
                indexName: idx_collection_workspace_id
      changes:
        - createIndex:
            tableName: collection
            indexName: idx_collection_workspace_id
            columns:
              - column:
                  name: workspace_id

  - changeSet:
      id: v58.2025-11-26T13:35:03
      validCheckSum: ANY
      author: christruter
      comment: Add collection.workspace_id FK with CASCADE
      validCheckSum: ANY
      preConditions:
        - onFail: MARK_RAN
        - not:
            - foreignKeyConstraintExists:
                foreignKeyName: fk_collection_workspace_id
      changes:
        - addForeignKeyConstraint:
            baseTableName: collection
            baseColumnNames: workspace_id
            constraintName: fk_collection_workspace_id
            referencedTableName: workspace
            referencedColumnNames: id
            onDelete: CASCADE
      rollback:
        - dropForeignKeyConstraint:
            baseTableName: collection
            constraintName: fk_collection_workspace_id

  - changeSet:
      id: v58.2025-11-26T13:35:04
      validCheckSum: ANY
      author: christruter
      comment: Drop transform.workspace_id FK for cascade update
      validCheckSum: ANY
      preConditions:
        - onFail: MARK_RAN
        - foreignKeyConstraintExists:
            foreignKeyName: fk_transform_workspace_id
      changes:
        - dropForeignKeyConstraint:
            baseTableName: transform
            constraintName: fk_transform_workspace_id
      rollback:
        - addForeignKeyConstraint:
            baseTableName: transform
            baseColumnNames: workspace_id
            constraintName: fk_transform_workspace_id
            referencedTableName: workspace
            referencedColumnNames: id

  - changeSet:
      id: v58.2025-11-26T13:35:05
      validCheckSum: ANY
      author: christruter
      comment: Add transform.workspace_id FK with CASCADE
      validCheckSum: ANY
      preConditions:
        - onFail: MARK_RAN
        - not:
            - foreignKeyConstraintExists:
                foreignKeyName: fk_transform_workspace_id
      changes:
        - addForeignKeyConstraint:
            baseTableName: transform
            baseColumnNames: workspace_id
            constraintName: fk_transform_workspace_id
            referencedTableName: workspace
            referencedColumnNames: id
            onDelete: CASCADE
      rollback:
        - dropForeignKeyConstraint:
            baseTableName: transform
            constraintName: fk_transform_workspace_id

  - changeSet:
      id: v58.2025-11-26T13:35:06
      validCheckSum: ANY
      author: christruter
      comment: Drop report_card.workspace_id FK for cascade update
      validCheckSum: ANY
      preConditions:
        - onFail: MARK_RAN
        - foreignKeyConstraintExists:
            foreignKeyName: fk_report_card_workspace_id
      changes:
        - dropForeignKeyConstraint:
            baseTableName: report_card
            constraintName: fk_report_card_workspace_id
      rollback:
        - addForeignKeyConstraint:
            baseTableName: report_card
            baseColumnNames: workspace_id
            constraintName: fk_report_card_workspace_id
            referencedTableName: workspace
            referencedColumnNames: id

  - changeSet:
      id: v58.2025-11-26T13:35:09
      validCheckSum: ANY
      author: christruter
      comment: Add report_card.workspace_id FK with CASCADE
      preConditions:
        - onFail: MARK_RAN
        - not:
            - foreignKeyConstraintExists:
                foreignKeyName: fk_report_card_workspace_id
      changes:
        - addForeignKeyConstraint:
            baseTableName: report_card
            baseColumnNames: workspace_id
            constraintName: fk_report_card_workspace_id
            referencedTableName: workspace
            referencedColumnNames: id
            onDelete: CASCADE
      rollback:
        - dropForeignKeyConstraint:
            baseTableName: report_card
            constraintName: fk_report_card_workspace_id

  - changeSet:
      id: v58.2025-11-26T13:35:10
      validCheckSum: ANY
      author: christruter
      comment: Drop metabase_table.workspace_id FK for cascade update
      preConditions:
        - onFail: MARK_RAN
        - foreignKeyConstraintExists:
            foreignKeyName: fk_metabase_table_workspace_id
      changes:
        - dropForeignKeyConstraint:
            baseTableName: metabase_table
            constraintName: fk_metabase_table_workspace_id
      rollback:
        - addForeignKeyConstraint:
            baseTableName: metabase_table
            baseColumnNames: workspace_id
            constraintName: fk_metabase_table_workspace_id
            referencedTableName: workspace
            referencedColumnNames: id

  - changeSet:
      id: v58.2025-11-26T13:35:11
      validCheckSum: ANY
      author: christruter
      comment: Add metabase_table.workspace_id FK with SET NULL
      preConditions:
        - onFail: MARK_RAN
        - not:
            - foreignKeyConstraintExists:
                foreignKeyName: fk_metabase_table_workspace_id
      changes:
        - addForeignKeyConstraint:
            baseTableName: metabase_table
            baseColumnNames: workspace_id
            constraintName: fk_metabase_table_workspace_id
            referencedTableName: workspace
            referencedColumnNames: id
            onDelete: SET NULL
      rollback:
        - dropForeignKeyConstraint:
            baseTableName: metabase_table
            constraintName: fk_metabase_table_workspace_id

  - changeSet:
      id: v58.2025-11-26T13:35:12
      validCheckSum: ANY
      author: christruter
      comment: Drop metabase_field.workspace_id FK for cascade update
      preConditions:
        - onFail: MARK_RAN
        - foreignKeyConstraintExists:
            foreignKeyName: fk_metabase_field_workspace_id
      changes:
        - dropForeignKeyConstraint:
            baseTableName: metabase_field
            constraintName: fk_metabase_field_workspace_id
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-11-26T13:35:13
      validCheckSum: ANY
      author: christruter
      comment: Add metabase_field.workspace_id FK with SET NULL
      preConditions:
        - onFail: MARK_RAN
        - not:
            - foreignKeyConstraintExists:
                foreignKeyName: fk_metabase_field_workspace_id
      changes:
        - addForeignKeyConstraint:
            baseTableName: metabase_field
            baseColumnNames: workspace_id
            constraintName: fk_metabase_field_workspace_id
            referencedTableName: workspace
            referencedColumnNames: id
            onDelete: SET NULL
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-11-26T13:35:14
      validCheckSum: ANY
      author: christruter
      comment: Add index on metabase_field.workspace_id
      validCheckSum: ANY
      preConditions:
        - onFail: MARK_RAN
        - not:
            - indexExists:
                indexName: idx_metabase_field_workspace_id
      changes:
        - createIndex:
            tableName: metabase_field
            indexName: idx_metabase_field_workspace_id
            columns:
              - column:
                  name: workspace_id
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-11-26T13:35:15
      validCheckSum: ANY
      author: christruter
      comment: Add index on metabase_table.workspace_id
      validCheckSum: ANY
      preConditions:
        - onFail: MARK_RAN
        - not:
            - indexExists:
                indexName: idx_metabase_table_workspace_id
      changes:
        - createIndex:
            tableName: metabase_table
            indexName: idx_metabase_table_workspace_id
            columns:
              - column:
                  name: workspace_id
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-11-26T14:50:00
      validCheckSum: ANY
      author: christruter
      comment: Add unique constraint on workspace_mapping_table.downstream_id
      preConditions:
        - onFail: MARK_RAN
        - not:
            - uniqueConstraintExists:
                tableName: workspace_mapping_table
                constraintName: uq_workspace_mapping_table_downstream_id
      changes:
        - addUniqueConstraint:
            tableName: workspace_mapping_table
            columnNames: downstream_id
            constraintName: uq_workspace_mapping_table_downstream_id
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-11-26T14:50:01
      validCheckSum: ANY
      author: christruter
      comment: Add unique constraint on workspace_mapping_transform.downstream_id
      preConditions:
        - onFail: MARK_RAN
        - not:
            - uniqueConstraintExists:
                tableName: workspace_mapping_transform
                constraintName: uq_workspace_mapping_transform_downstream_id
      changes:
        - addUniqueConstraint:
            tableName: workspace_mapping_transform
            columnNames: downstream_id
            constraintName: uq_workspace_mapping_transform_downstream_id
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-11-26T14:50:02
      author: qnkhuat
      comment: Add workspace.database_details to keep db specifc details used for isolation
      changes:
        - addColumn:
            tableName: workspace
            columns:
              - column:
                  name: database_details
                  type: ${text.type}
                  remarks: Database details used for isolation of this workspace
                  constraints:
                    nullable: true
      rollback:
        # will be deleted with the table

# TODO: Empty in favor of v58.2025-12-03T17:08:36 and following, will be removed with migrations cleanup in WS
  - changeSet:
      id: v58.2025-11-27T10:00:00
      author: christruter
      validCheckSum: ANY
      comment: Add collection_id column to transform table
      validCheckSum: ANY
      changes:
        - sql:
            sql: select 1;
      rollback:

# TODO: Empty in favor of v58.2025-12-03T17:08:36 and following, will be removed with migrations cleanup in WS
  - changeSet:
      id: v58.2025-11-27T10:00:01
      author: christruter
      validCheckSum: ANY
      comment: Add index on transform.collection_id
      validCheckSum: ANY
      changes:
        - sql:
            sql: select 1;
      rollback:

# TODO: Empty in favor of v58.2025-12-03T17:08:36 and following, will be removed with migrations cleanup in WS
  - changeSet:
      id: v58.2025-11-27T10:00:02
      author: christruter
      validCheckSum: ANY
      comment: Add foreign key constraint from transform.collection_id to collection
      validCheckSum: ANY
      changes:
        - sql:
            sql: select 1;
      rollback:

  - changeSet:
      id: v58.2025-12-01T05:21:37
      author: johnswanson
      comment: Add a tenant_collection_id to tenants
      changes:
        - addColumn:
            tableName: tenant
            columns:
              - column:
                  name: tenant_collection_id
                  type: int
                  remarks: The ID of the collection
                  constraints:
                    nullable: false

  - changeSet:
      id: v58.2025-12-03T17:08:36
      author: nvoxland
      comment: Add collection_id column to transform table
      validCheckSum: ANY
      preConditions:
        - onFail: MARK_RAN
        - not:
            - columnExists:
                tableName: transform
                columnName: collection_id
      changes:
        - addColumn:
            tableName: transform
            columns:
              - column:
                  name: collection_id
                  type: int
                  remarks: The collection the transform is in

  - changeSet:
      id: v58.2025-12-03T17:08:37
      author: nvoxland
      comment: Add index on transform.collection_id
      validCheckSum: ANY
      preConditions:
        - onFail: MARK_RAN
        - not:
            - indexExists:
                indexName: idx_transform_collection_id
      changes:
        - createIndex:
            tableName: transform
            indexName: idx_transform_collection_id
            columns:
              - column:
                  name: collection_id

  - changeSet:
      id: v58.2025-12-03T17:08:38
      author: nvoxland
      comment: Add fk_transform_collection_id
      validCheckSum: ANY
      preConditions:
        - onFail: MARK_RAN
        - not:
            - foreignKeyConstraintExists:
                foreignKeyName: fk_transform_collection_id
      changes:
        - addForeignKeyConstraint:
            baseTableName: transform
            baseColumnNames: collection_id
            referencedTableName: collection
            referencedColumnNames: id
            constraintName: fk_transform_collection_id

  - changeSet:
      id: v58.2025-12-04T10:00:00
      author: piranha
      comment: Add status column to workspace table for async creation tracking
      changes:
        - addColumn:
            tableName: workspace
            columns:
              - column:
                  name: status
                  type: varchar(20)
                  remarks: Status of workspace setup
                  defaultValue: "ready"
                  constraints:
                    nullable: false
      rollback:
        - dropColumn:
            tableName: workspace
            columnName: status

  - changeSet:
      id: v58.2025-12-04T10:00:01
      author: piranha
      comment: Create workspace_log table for tracking async workspace setup progress
      changes:
        - createTable:
            tableName: workspace_log
            remarks: Log entries for async workspace setup progress
            columns:
              - column:
                  name: id
                  type: int
                  autoIncrement: true
                  remarks: Primary key
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: workspace_id
                  type: int
                  remarks: FK to workspace being set up
                  constraints:
                    nullable: false
              - column:
                  name: task
                  type: varchar(255)
                  remarks: Name of the setup task
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: ${timestamp_type}
                  remarks: When the task was created
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: ${timestamp_type}
                  remarks: When the task was updated
                  constraints:
                    nullable: false
              - column:
                  name: started_at
                  type: ${timestamp_type}
                  remarks: When the task started
                  constraints:
                    nullable: false
              - column:
                  name: completed_at
                  type: ${timestamp_type}
                  remarks: When the task completed
              - column:
                  name: status
                  type: varchar(20)
                  remarks: Task status (started, success, failed)
              - column:
                  name: message
                  type: ${text.type}
                  remarks: Details on the task result if any
      rollback:
        - dropTable:
            tableName: workspace_log

  - changeSet:
      id: v58.2025-12-04T10:00:02
      author: piranha
      comment: Add index on workspace_log.workspace_id
      changes:
        - createIndex:
            tableName: workspace_log
            indexName: idx_workspace_log_workspace_id
            columns:
              - column:
                  name: workspace_id
      rollback:
        - dropIndex:
            tableName: workspace_log
            indexName: idx_workspace_log_workspace_id

  - changeSet:
      id: v58.2025-12-04T10:00:03
      author: piranha
      comment: Add foreign key constraint from workspace_log.workspace_id to workspace
      changes:
        - addForeignKeyConstraint:
            baseTableName: workspace_log
            baseColumnNames: workspace_id
            constraintName: fk_workspace_log_workspace_id
            referencedTableName: workspace
            referencedColumnNames: id
            onDelete: CASCADE
      rollback:
        - dropForeignKeyConstraint:
            baseTableName: workspace_log
            constraintName: fk_workspace_log_workspace_id

  - changeSet:
      id: v58.2025-12-05T17:41:51
      author: ranquild
      comment: Drop fk_report_card_published_table
      changes:
        - dropForeignKeyConstraint:
            baseTableName: report_card
            constraintName: fk_report_card_published_table
      rollback:
        - addForeignKeyConstraint:
            baseTableName: report_card
            baseColumnNames: published_table_id
            referencedTableName: metabase_table
            referencedColumnNames: id
            constraintName: fk_report_card_published_table
            onDelete: SET NULL

  - changeSet:
      id: v58.2025-12-05T17:41:52
      author: ranquild
      comment: Drop idx_report_card_published_table_id
      changes:
        - dropIndex:
            tableName: report_card
            indexName: idx_report_card_published_table_id
      rollback:
        - createIndex:
            tableName: report_card
            indexName: idx_report_card_published_table_id
            columns:
              - column:
                  name: published_table_id

  - changeSet:
      id: v58.2025-12-05T17:41:53
      author: ranquild
      comment: Drop report_card.published_table_id
      changes:
        - dropColumn:
            tableName: report_card
            columnName: published_table_id
      rollback:
        - addColumn:
            tableName: report_card
            columns:
              - column:
                  name: published_table_id
                  type: int
                  remarks: The table id that is 'published' by this model
                  constraints:
                    nullable: true

  - changeSet:
      id: v58.2025-12-05T17:41:54
      author: ranquild
      comment: Rename collection.type 'library-models' to 'library-data'
      changes:
        - update:
            tableName: collection
            columns:
              - column:
                  name: type
                  value: 'library-data'
            where: type = 'library-models'
      rollback:
        - update:
            tableName: collection
            columns:
              - column:
                  name: type
                  value: 'library-models'
            where: type = 'library-data'

  - changeSet:
      id: v58.2025-12-09T00:00:00
      author: nmezzopera
      comment: Usage analytics; Add entity_type, visibility_type, estimated_row_count, view_count, owner_email, owner_user_id to tables
      changes:
        - sqlFile:
            dbms: postgresql
            path: instance_analytics_views/tables/v3/postgres-tables.sql
            relativeToChangelogFile: true
        - sqlFile:
            dbms: mysql,mariadb
            path: instance_analytics_views/tables/v3/mysql-tables.sql
            relativeToChangelogFile: true
        - sqlFile:
            dbms: h2
            path: instance_analytics_views/tables/v3/h2-tables.sql
            relativeToChangelogFile: true
      rollback:
        - sqlFile:
            dbms: postgresql
            path: instance_analytics_views/tables/v1/postgres-tables.sql
            relativeToChangelogFile: true
        - sqlFile:
            dbms: mysql,mariadb
            path: instance_analytics_views/tables/v2/mysql-tables.sql
            relativeToChangelogFile: true
        - sqlFile:
            dbms: h2
            path: instance_analytics_views/tables/v1/h2-tables.sql
            relativeToChangelogFile: true

  # Workspaces feature is still in early development - clear existing workspace data
  # to prevent migration issues with schema changes

  - changeSet:
      id: v58.2025-12-09T09:59:59
      validCheckSum: ANY
      author: christruter
      comment: Delete workspace table contents before schema changes (feature in early development)
      preConditions:
        - onFail: MARK_RAN
        - tableExists:
            tableName: workspace
      changes:
        - sql:
            sql: DELETE FROM workspace
      rollback:
        # No rollback - data cannot be restored

  - changeSet:
      id: v58.2025-12-09T10:00:00
      author: christruter
      comment: Create workspace_transform table for holding transform changesets in workspaces
      preConditions:
        - onFail: MARK_RAN
        - not:
            - tableExists:
                tableName: workspace_transform
      changes:
        - createTable:
            tableName: workspace_transform
            remarks: Holds the changeset of transforms being created and edited within a workspace
            columns:
              - column:
                  name: ref_id
                  type: char(36)
                  remarks: Unique UUID identifier for the workspace transform
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: workspace_id
                  type: int
                  remarks: FK to workspace containing this transform
                  constraints:
                    nullable: false
              - column:
                  name: global_id
                  type: int
                  remarks: FK to transform table if checked out from global
                  constraints:
                    nullable: true
              - column:
                  name: collection_id
                  type: int
                  remarks: FK to collection containing this transform
                  constraints:
                    nullable: true
              - column:
                  name: name
                  type: ${text.type}
                  remarks: Name of the transform
                  constraints:
                    nullable: false
              - column:
                  name: description
                  type: ${text.type}
                  remarks: Description of the transform
                  constraints:
                    nullable: true
              - column:
                  name: source
                  type: ${text.type}
                  remarks: JSON of source configuration
                  constraints:
                    nullable: false
              - column:
                  name: target
                  type: ${text.type}
                  remarks: JSON of target configuration
                  constraints:
                    nullable: false
              - column:
                  name: entity_id
                  type: char(21)
                  remarks: Random NanoID tag for unique identity of this changeset entry only, not used when merging to global
                  constraints:
                    nullable: true
                    unique: true
              - column:
                  name: checked_out_at
                  type: ${timestamp_type}
                  remarks: Timestamp when the transform was checked out
                  constraints:
                    nullable: true
              - column:
                  name: archived_at
                  type: ${timestamp_type}
                  remarks: If set, marks that the global transform should be archived when merging
                  constraints:
                    nullable: true
              - column:
                  name: created_at
                  type: ${timestamp_type}
                  remarks: Timestamp when the workspace transform was created
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: ${timestamp_type}
                  remarks: Timestamp when the workspace transform was last updated
                  constraints:
                    nullable: false
      rollback:
        - dropTable:
            tableName: workspace_transform

  - changeSet:
      id: v58.2025-12-09T10:00:01
      validCheckSum: ANY
      author: christruter
      comment: Add index on workspace_transform.workspace_id
      preConditions:
        - onFail: MARK_RAN
        - not:
            - indexExists:
                indexName: idx_workspace_transform_workspace_id
      changes:
        - createIndex:
            tableName: workspace_transform
            indexName: idx_workspace_transform_workspace_id
            columns:
              - column:
                  name: workspace_id
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-12-09T10:00:02
      validCheckSum: ANY
      author: christruter
      comment: Add index on workspace_transform.global_id
      preConditions:
        - onFail: MARK_RAN
        - not:
            - indexExists:
                indexName: idx_workspace_transform_global_id
      changes:
        - createIndex:
            tableName: workspace_transform
            indexName: idx_workspace_transform_global_id
            columns:
              - column:
                  name: global_id
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-12-09T10:00:03
      validCheckSum: ANY
      author: christruter
      comment: Add index on workspace_transform.collection_id
      preConditions:
        - onFail: MARK_RAN
        - not:
            - indexExists:
                indexName: idx_workspace_transform_collection_id
      changes:
        - createIndex:
            tableName: workspace_transform
            indexName: idx_workspace_transform_collection_id
            columns:
              - column:
                  name: collection_id
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-12-09T10:00:04
      validCheckSum: ANY
      author: christruter
      comment: Add foreign key constraint from workspace_transform.workspace_id to workspace
      preConditions:
        - onFail: MARK_RAN
        - not:
            - foreignKeyConstraintExists:
                foreignKeyName: fk_workspace_transform_workspace_id
      changes:
        - addForeignKeyConstraint:
            baseTableName: workspace_transform
            baseColumnNames: workspace_id
            constraintName: fk_workspace_transform_workspace_id
            referencedTableName: workspace
            referencedColumnNames: id
            onDelete: CASCADE
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-12-09T10:00:05
      validCheckSum: ANY
      author: christruter
      comment: Add foreign key constraint from workspace_transform.global_id to transform with SET NULL on delete
      preConditions:
        - onFail: MARK_RAN
        - not:
            - foreignKeyConstraintExists:
                foreignKeyName: fk_workspace_transform_global_id
      changes:
        - addForeignKeyConstraint:
            baseTableName: workspace_transform
            baseColumnNames: global_id
            constraintName: fk_workspace_transform_global_id
            referencedTableName: transform
            referencedColumnNames: id
            onDelete: SET NULL
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-12-09T10:00:06
      validCheckSum: ANY
      author: christruter
      comment: Add foreign key constraint from workspace_transform.collection_id to collection with SET NULL on delete
      preConditions:
        - onFail: MARK_RAN
        - not:
            - foreignKeyConstraintExists:
                foreignKeyName: fk_workspace_transform_collection_id
      changes:
        - addForeignKeyConstraint:
            baseTableName: workspace_transform
            baseColumnNames: collection_id
            constraintName: fk_workspace_transform_collection_id
            referencedTableName: collection
            referencedColumnNames: id
            onDelete: SET NULL
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-12-09T10:00:07
      validCheckSum: ANY
      author: christruter
      comment: Add partial unique index on workspace_transform (workspace_id, global_id) where global_id is not null
      preConditions:
        - onFail: MARK_RAN
        - not:
            - indexExists:
                indexName: idx_workspace_transform_workspace_global_unique
      changes:
        # PostgreSQL supports partial indexes for smaller index size
        - sql:
            dbms: postgresql
            sql: CREATE UNIQUE INDEX idx_workspace_transform_workspace_global_unique ON workspace_transform (workspace_id, global_id) WHERE global_id IS NOT NULL
        # H2/MySQL/MariaDB don't support partial indexes, but all databases treat NULLs as distinct
        # in unique indexes, so a regular unique index is functionally equivalent
        - sql:
            dbms: h2,mysql,mariadb
            sql: CREATE UNIQUE INDEX idx_workspace_transform_workspace_global_unique ON workspace_transform (workspace_id, global_id)
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-12-09T10:00:08
      validCheckSum: ANY
      author: christruter
      comment: Add unique constraint on workspace.name
      preConditions:
        - onFail: MARK_RAN
        - not:
            - indexExists:
                indexName: idx_workspace_name_unique
      changes:
        - addUniqueConstraint:
            tableName: workspace
            columnNames: name
            constraintName: idx_workspace_name_unique
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-12-10T10:00:00
      author: qnkhuat
      comment: Create workspace_input table for tracking external table dependencies
      preConditions:
        - onFail: MARK_RAN
        - not:
            - tableExists:
                tableName: workspace_input
      changes:
        - createTable:
            tableName: workspace_input
            remarks: External tables that workspace transforms consume from source databases
            columns:
              - column:
                  name: id
                  type: int
                  autoIncrement: true
                  remarks: Primary key
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: workspace_id
                  type: int
                  remarks: FK to workspace
                  constraints:
                    nullable: false
              - column:
                  name: db_id
                  type: int
                  remarks: Database containing the source table
                  constraints:
                    nullable: false
              - column:
                  name: schema
                  type: varchar(254)
                  remarks: Schema of the source table (nullable for DBs without schemas)
                  constraints:
                    nullable: true
              - column:
                  name: table
                  type: varchar(254)
                  remarks: Name of the source table
                  constraints:
                    nullable: false
              - column:
                  name: table_id
                  type: int
                  remarks: FK to metabase_table if table exists and is synced
                  constraints:
                    nullable: true
              - column:
                  name: created_at
                  type: ${timestamp_type}
                  remarks: Timestamp when the input was created
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: ${timestamp_type}
                  remarks: Timestamp when the input was last updated
                  constraints:
                    nullable: false
      rollback:
        - dropTable:
            tableName: workspace_input

  - changeSet:
      id: v58.2025-12-10T10:00:01
      validCheckSum: ANY
      author: qnkhuat
      comment: Add index on workspace_input.workspace_id
      preConditions:
        - onFail: MARK_RAN
        - not:
            - indexExists:
                indexName: idx_workspace_input_workspace_id
      changes:
        - createIndex:
            tableName: workspace_input
            indexName: idx_workspace_input_workspace_id
            columns:
              - column:
                  name: workspace_id
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-12-10T10:00:02
      validCheckSum: ANY
      author: qnkhuat
      comment: Add foreign key constraint from workspace_input.workspace_id to workspace
      preConditions:
        - onFail: MARK_RAN
        - not:
            - foreignKeyConstraintExists:
                foreignKeyName: fk_workspace_input_workspace_id
      changes:
        - addForeignKeyConstraint:
            baseTableName: workspace_input
            baseColumnNames: workspace_id
            constraintName: fk_workspace_input_workspace_id
            referencedTableName: workspace
            referencedColumnNames: id
            onDelete: CASCADE
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-12-10T10:00:04
      validCheckSum: ANY
      author: qnkhuat
      comment: Add unique constraint on workspace_input (workspace_id, db_id, schema, table)
      preConditions:
        - onFail: MARK_RAN
        - not:
            - uniqueConstraintExists:
                tableName: workspace_input
                constraintName: uq_workspace_input_logical_table
      changes:
        - addUniqueConstraint:
            tableName: workspace_input
            columnNames: workspace_id, db_id, schema, table
            constraintName: uq_workspace_input_logical_table
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-12-10T10:00:05
      author: qnkhuat
      comment: Create workspace_output table for tracking tables produced by workspace transforms
      preConditions:
        - onFail: MARK_RAN
        - not:
            - tableExists:
                tableName: workspace_output
      changes:
        - createTable:
            tableName: workspace_output
            remarks: Tables that workspace transforms produce
            columns:
              - column:
                  name: id
                  type: int
                  autoIncrement: true
                  remarks: Primary key
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: workspace_id
                  type: int
                  remarks: FK to workspace
                  constraints:
                    nullable: false
              - column:
                  name: ref_id
                  type: char(36)
                  remarks: FK to workspace_transform.ref_id (producer)
                  constraints:
                    nullable: false
              - column:
                  name: db_id
                  type: int
                  remarks: Database where the output table is created
                  constraints:
                    nullable: false
              - column:
                  name: schema
                  type: varchar(254)
                  remarks: Schema of the output table
                  constraints:
                    nullable: true
              - column:
                  name: table
                  type: varchar(254)
                  remarks: Name of the output table
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: ${timestamp_type}
                  remarks: Timestamp when the output was created
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: ${timestamp_type}
                  remarks: Timestamp when the output was last updated
                  constraints:
                    nullable: false
      rollback:
        - dropTable:
            tableName: workspace_output

  - changeSet:
      id: v58.2025-12-10T10:00:06
      validCheckSum: ANY
      author: qnkhuat
      comment: Add index on workspace_output.workspace_id
      preConditions:
        - onFail: MARK_RAN
        - not:
            - indexExists:
                indexName: idx_workspace_output_workspace_id
      changes:
        - createIndex:
            tableName: workspace_output
            indexName: idx_workspace_output_workspace_id
            columns:
              - column:
                  name: workspace_id
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-12-10T10:00:07
      validCheckSum: ANY
      author: qnkhuat
      comment: Add index on workspace_output.ref_id
      preConditions:
        - onFail: MARK_RAN
        - not:
            - indexExists:
                indexName: idx_workspace_output_ref_id
      changes:
        - createIndex:
            tableName: workspace_output
            indexName: idx_workspace_output_ref_id
            columns:
              - column:
                  name: ref_id
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-12-10T10:00:08
      validCheckSum: ANY
      author: qnkhuat
      comment: Add foreign key constraint from workspace_output.workspace_id to workspace
      preConditions:
        - onFail: MARK_RAN
        - not:
            - foreignKeyConstraintExists:
                foreignKeyName: fk_workspace_output_workspace_id
      changes:
        - addForeignKeyConstraint:
            baseTableName: workspace_output
            baseColumnNames: workspace_id
            constraintName: fk_workspace_output_workspace_id
            referencedTableName: workspace
            referencedColumnNames: id
            onDelete: CASCADE
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-12-10T10:00:09
      validCheckSum: ANY
      author: qnkhuat
      comment: Add foreign key constraint from workspace_output.ref_id to workspace_transform
      preConditions:
        - onFail: MARK_RAN
        - not:
            - foreignKeyConstraintExists:
                foreignKeyName: fk_workspace_output_ref_id
      changes:
        - addForeignKeyConstraint:
            baseTableName: workspace_output
            baseColumnNames: ref_id
            constraintName: fk_workspace_output_ref_id
            referencedTableName: workspace_transform
            referencedColumnNames: ref_id
            onDelete: CASCADE
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-12-10T10:00:10
      validCheckSum: ANY
      author: qnkhuat
      comment: Add unique constraint on workspace_output (workspace_id, ref_id)
      preConditions:
        - onFail: MARK_RAN
        - not:
            - uniqueConstraintExists:
                tableName: workspace_output
                constraintName: uq_workspace_output_workspace_ref
      changes:
        - addUniqueConstraint:
            tableName: workspace_output
            columnNames: workspace_id, ref_id
            constraintName: uq_workspace_output_workspace_ref
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-12-10T10:00:11
      author: qnkhuat
      comment: Create workspace_dependency table for tracking dependency edges
      preConditions:
        - onFail: MARK_RAN
        - not:
            - tableExists:
                tableName: workspace_dependency
      changes:
        - createTable:
            tableName: workspace_dependency
            remarks: Edges between workspace transforms and their dependencies
            columns:
              - column:
                  name: id
                  type: int
                  autoIncrement: true
                  remarks: Primary key
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: workspace_id
                  type: int
                  remarks: FK to workspace
                  constraints:
                    nullable: false
              - column:
                  name: from_entity_type
                  type: varchar(20)
                  remarks: Type of the dependent entity (e.g. transform)
                  constraints:
                    nullable: false
              - column:
                  name: from_entity_id
                  type: varchar(36)
                  remarks: ID of the dependent entity (ref_id for transforms)
                  constraints:
                    nullable: false
              - column:
                  name: to_entity_type
                  type: varchar(20)
                  remarks: Type of the dependency (input or output)
                  constraints:
                    nullable: false
              - column:
                  name: to_entity_id
                  type: int
                  remarks: ID of the dependency (workspace_input.id or workspace_output.id)
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: ${timestamp_type}
                  remarks: Timestamp when the dependency was created
                  constraints:
                    nullable: false
      rollback:
        - dropTable:
            tableName: workspace_dependency

  - changeSet:
      id: v58.2025-12-10T10:00:12
      validCheckSum: ANY
      author: qnkhuat
      comment: Add index on workspace_dependency.workspace_id
      preConditions:
        - onFail: MARK_RAN
        - not:
            - indexExists:
                indexName: idx_workspace_dependency_workspace_id
      changes:
        - createIndex:
            tableName: workspace_dependency
            indexName: idx_workspace_dependency_workspace_id
            columns:
              - column:
                  name: workspace_id
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-12-10T10:00:13
      validCheckSum: ANY
      author: qnkhuat
      comment: Add foreign key constraint from workspace_dependency.workspace_id to workspace
      preConditions:
        - onFail: MARK_RAN
        - not:
            - foreignKeyConstraintExists:
                foreignKeyName: fk_workspace_dependency_workspace_id
      changes:
        - addForeignKeyConstraint:
            baseTableName: workspace_dependency
            baseColumnNames: workspace_id
            constraintName: fk_workspace_dependency_workspace_id
            referencedTableName: workspace
            referencedColumnNames: id
            onDelete: CASCADE
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-12-10T10:00:14
      validCheckSum: ANY
      author: qnkhuat
      comment: Add unique constraint on workspace_dependency edges
      preConditions:
        - onFail: MARK_RAN
        - not:
            - uniqueConstraintExists:
                tableName: workspace_dependency
                constraintName: uq_workspace_dependency_edge
      changes:
        - addUniqueConstraint:
            tableName: workspace_dependency
            columnNames: workspace_id, from_entity_type, from_entity_id, to_entity_type, to_entity_id
            constraintName: uq_workspace_dependency_edge
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-12-10T10:00:15
      validCheckSum: ANY
      author: qnkhuat
      comment: Add index on workspace_dependency from entity
      preConditions:
        - onFail: MARK_RAN
        - not:
            - indexExists:
                indexName: idx_workspace_dependency_from
      changes:
        - createIndex:
            tableName: workspace_dependency
            indexName: idx_workspace_dependency_from
            columns:
              - column:
                  name: from_entity_type
              - column:
                  name: from_entity_id
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-12-10T10:00:16
      validCheckSum: ANY
      author: qnkhuat
      comment: Add index on workspace_dependency to entity
      preConditions:
        - onFail: MARK_RAN
        - not:
            - indexExists:
                indexName: idx_workspace_dependency_to
      changes:
        - createIndex:
            tableName: workspace_dependency
            indexName: idx_workspace_dependency_to
            columns:
              - column:
                  name: to_entity_type
              - column:
                  name: to_entity_id
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-12-10T10:30:00
      author: lbrdnk
      comment: Add idx_workspace_input_table_id
      preConditions:
        - onFail: MARK_RAN
        - not:
            - indexExists:
                indexName: idx_workspace_input_table_id
      changes:
        - createIndex:
            tableName: workspace_input
            indexName: idx_workspace_input_table_id
            columns:
              - column:
                  name: table_id
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-12-10T10:30:05
      validCheckSum: ANY
      author: qnkhuat
      comment: Add foreign key constraint from workspace_input.table_id to metabase_table with SET NULL
      preConditions:
        - onFail: MARK_RAN
        - not:
            - foreignKeyConstraintExists:
                foreignKeyName: fk_workspace_input_table_id
      changes:
        - addForeignKeyConstraint:
            baseTableName: workspace_input
            baseColumnNames: table_id
            constraintName: fk_workspace_input_table_id
            referencedTableName: metabase_table
            referencedColumnNames: id
            onDelete: SET NULL
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-12-11T10:00:00
      author: christruter
      comment: Add stale column to workspace_transform
      preConditions:
        - onFail: MARK_RAN
        - not:
            - columnExists:
                tableName: workspace_transform
                columnName: stale
      changes:
        - addColumn:
            tableName: workspace_transform
            columns:
              - column:
                  name: stale
                  type: ${boolean.type}
                  defaultValueBoolean: true
                  remarks: Indicates if the target configuration needs to be refreshed
                  constraints:
                    nullable: false
      rollback:
        - dropColumn:
            tableName: workspace_transform
            columnName: stale

  - changeSet:
      id: v58.2025-12-12T10:00:00
      author: piranha
      comment: Add last_run_at column to workspace_transform
      preConditions:
        - onFail: MARK_RAN
        - not:
            - columnExists:
                tableName: workspace_transform
                columnName: last_run_at
      changes:
        - addColumn:
            tableName: workspace_transform
            columns:
              - column:
                  name: last_run_at
                  type: ${timestamp_type}
                  remarks: Timestamp when this transform was last run
                  constraints:
                    nullable: true
      rollback:
        - dropColumn:
            tableName: workspace_transform
            columnName: last_run_at

  - changeSet:
      id: v58.2025-12-12T11:00:00
      author: sansolo
      comment: Rename workspace_output.schema to global_schema
      preConditions:
        - onFail: MARK_RAN
        - columnExists:
            tableName: workspace_output
            columnName: schema
      changes:
        - renameColumn:
            tableName: workspace_output
            oldColumnName: schema
            newColumnName: global_schema
            columnDataType: varchar(254)
      rollback:
        - renameColumn:
            tableName: workspace_output
            oldColumnName: global_schema
            newColumnName: schema
            columnDataType: varchar(254)

  - changeSet:
      id: v58.2025-12-12T11:00:01
      author: sansolo
      comment: Rename workspace_output.table to global_table
      preConditions:
        - onFail: MARK_RAN
        - columnExists:
            tableName: workspace_output
            columnName: table
      changes:
        - renameColumn:
            tableName: workspace_output
            oldColumnName: table
            newColumnName: global_table
            columnDataType: varchar(254)
      rollback:
        - renameColumn:
            tableName: workspace_output
            oldColumnName: global_table
            newColumnName: table
            columnDataType: varchar(254)

  - changeSet:
      id: v58.2025-12-12T11:00:02
      author: sansolo
      comment: Add global_table_id column to workspace_output
      preConditions:
        - onFail: MARK_RAN
        - not:
            - columnExists:
                tableName: workspace_output
                columnName: global_table_id
      changes:
        - addColumn:
            tableName: workspace_output
            columns:
              - column:
                  name: global_table_id
                  type: int
                  remarks: FK to metabase table for the global output table
                  constraints:
                    nullable: true
      rollback:
        - dropColumn:
            tableName: workspace_output
            columnName: global_table_id

  - changeSet:
      id: v58.2025-12-12T11:00:03
      author: sansolo
      comment: Add isolated_schema column to workspace_output
      preConditions:
        - onFail: MARK_RAN
        - not:
            - columnExists:
                tableName: workspace_output
                columnName: isolated_schema
      changes:
        - addColumn:
            tableName: workspace_output
            columns:
              - column:
                  name: isolated_schema
                  type: varchar(254)
                  remarks: Schema name in the isolated workspace namespace
                  constraints:
                    nullable: true
      rollback:
        - dropColumn:
            tableName: workspace_output
            columnName: isolated_schema

  - changeSet:
      id: v58.2025-12-12T11:00:04
      author: sansolo
      comment: Add isolated_table column to workspace_output
      preConditions:
        - onFail: MARK_RAN
        - not:
            - columnExists:
                tableName: workspace_output
                columnName: isolated_table
      changes:
        - addColumn:
            tableName: workspace_output
            columns:
              - column:
                  name: isolated_table
                  type: varchar(254)
                  remarks: Table name in the isolated workspace namespace
                  constraints:
                    nullable: true
      rollback:
        - dropColumn:
            tableName: workspace_output
            columnName: isolated_table

  - changeSet:
      id: v58.2025-12-12T11:00:05
      author: sansolo
      comment: Add isolated_table_id column to workspace_output
      preConditions:
        - onFail: MARK_RAN
        - not:
            - columnExists:
                tableName: workspace_output
                columnName: isolated_table_id
      changes:
        - addColumn:
            tableName: workspace_output
            columns:
              - column:
                  name: isolated_table_id
                  type: int
                  remarks: FK to metabase table for the isolated output table
                  constraints:
                    nullable: true
      rollback:
        - dropColumn:
            tableName: workspace_output
            columnName: isolated_table_id

  - changeSet:
      id: v58.2025-12-17T11:00:00
      author: qnkhuat
      comment: Create workspace_merge table to track batch merge events
      changes:
        - createTable:
            tableName: workspace_merge
            remarks: Tracks batch merge events with commit messages. Survives workspace deletion.
            columns:
              - column:
                  name: id
                  type: int
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: workspace_id
                  type: int
                  remarks: Foreign key to workspace, SET NULL on delete
                  constraints:
                    nullable: true
              - column:
                  name: workspace_name
                  type: ${text.type}
                  remarks: Inlined copy of workspace name (survives deletion)
                  constraints:
                    nullable: false
              - column:
                  name: commit_message
                  type: ${text.type}
                  remarks: Description of the merge operation
                  constraints:
                    nullable: false
              - column:
                  name: creator_id
                  type: int
                  remarks: User who performed the merge
                  constraints:
                    nullable: false
                    references: core_user(id)
                    foreignKeyName: fk_workspace_merge_creator_id
              - column:
                  name: created_at
                  type: ${timestamp_type}
                  remarks: Timestamp when the merge was performed
                  defaultValueComputed: current_timestamp
                  constraints:
                    nullable: false
      rollback:
        - dropTable:
            tableName: workspace_merge

  - changeSet:
      id: v58.2025-12-17T11:00:01
      author: qnkhuat
      comment: Add FK workspace_merge.workspace_id with SET NULL on delete
      changes:
        - addForeignKeyConstraint:
            baseTableName: workspace_merge
            baseColumnNames: workspace_id
            constraintName: fk_workspace_merge_workspace_id
            referencedTableName: workspace
            referencedColumnNames: id
            onDelete: SET NULL
      rollback:
        - dropForeignKeyConstraint:
            baseTableName: workspace_merge
            constraintName: fk_workspace_merge_workspace_id

  - changeSet:
      id: v58.2025-12-17T11:00:02
      author: qnkhuat
      comment: Add index on workspace_merge.workspace_id
      changes:
        - createIndex:
            tableName: workspace_merge
            indexName: idx_workspace_merge_workspace_id
            columns:
              - column:
                  name: workspace_id
      rollback: # will be deleted with the table

  - changeSet:
      id: v58.2025-12-17T11:00:03
      author: qnkhuat
      comment: Add index on workspace_merge.creator_id
      changes:
        - createIndex:
            tableName: workspace_merge
            indexName: idx_workspace_merge_creator_id
            columns:
              - column:
                  name: creator_id
      rollback: # will be deleted with the table

  - changeSet:
      id: v58.2025-12-17T11:00:04
      author: qnkhuat
      comment: Create workspace_merge_transform table to track individual transform merges
      changes:
        - createTable:
            tableName: workspace_merge_transform
            remarks: Tracks individual transform merges. Linked to workspace_merge for batch merges, standalone for single-transform merges.
            columns:
              - column:
                  name: id
                  type: int
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: workspace_merge_id
                  type: int
                  remarks: Foreign key to workspace_merge, CASCADE on delete
                  constraints:
                    nullable: false
                    references: workspace_merge(id)
                    foreignKeyName: fk_workspace_merge_transform_workspace_merge_id
                    deleteCascade: true
              - column:
                  name: workspace_id
                  type: int
                  remarks: Foreign key to workspace, SET NULL on delete
                  constraints:
                    nullable: true
              - column:
                  name: workspace_name
                  type: ${text.type}
                  remarks: Inlined copy of workspace name (survives deletion)
                  constraints:
                    nullable: false
              - column:
                  name: transform_id
                  type: int
                  remarks: Foreign key to transform
                  constraints:
                    nullable: true
                    references: transform(id)
                    foreignKeyName: fk_workspace_merge_transform_transform_id
                    deleteCascade: true
              - column:
                  name: commit_message
                  type: ${text.type}
                  remarks: Description of the merge operation
                  constraints:
                    nullable: false
              - column:
                  name: merging_user_id
                  type: int
                  remarks: User who performed the merge
                  constraints:
                    nullable: false
                    references: core_user(id)
                    foreignKeyName: fk_workspace_merge_transform_merging_user_id
              - column:
                  name: created_at
                  type: ${timestamp_type}
                  remarks: Timestamp when the merge was performed
                  defaultValueComputed: current_timestamp
                  constraints:
                    nullable: false
      rollback:
        - dropTable:
            tableName: workspace_merge_transform

  - changeSet:
      id: v58.2025-12-17T11:00:05
      author: qnkhuat
      comment: Add FK workspace_merge_transform.workspace_id with SET NULL on delete
      changes:
        - addForeignKeyConstraint:
            baseTableName: workspace_merge_transform
            baseColumnNames: workspace_id
            constraintName: fk_workspace_merge_transform_workspace_id
            referencedTableName: workspace
            referencedColumnNames: id
            onDelete: SET NULL
      rollback:
        - dropForeignKeyConstraint:
            baseTableName: workspace_merge_transform
            constraintName: fk_workspace_merge_transform_workspace_id

  - changeSet:
      id: v58.2025-12-17T11:00:07
      author: qnkhuat
      comment: Add index on workspace_merge_transform.workspace_merge_id
      changes:
        - createIndex:
            tableName: workspace_merge_transform
            indexName: idx_workspace_merge_transform_workspace_merge_id
            columns:
              - column:
                  name: workspace_merge_id
      rollback: # will be deleted with the table

  - changeSet:
      id: v58.2025-12-17T11:00:08
      author: qnkhuat
      comment: Add index on workspace_merge_transform.workspace_id
      changes:
        - createIndex:
            tableName: workspace_merge_transform
            indexName: idx_workspace_merge_transform_workspace_id
            columns:
              - column:
                  name: workspace_id
      rollback: # will be deleted with the table

  - changeSet:
      id: v58.2025-12-17T11:00:09
      author: qnkhuat
      comment: Add index on workspace_merge_transform.transform_id
      changes:
        - createIndex:
            tableName: workspace_merge_transform
            indexName: idx_workspace_merge_transform_transform_id
            columns:
              - column:
                  name: transform_id
      rollback: # will be deleted with the table

  - changeSet:
      id: v58.2025-12-17T11:00:10
      author: qnkhuat
      comment: Add index on workspace_merge_transform.merging_user_id
      changes:
        - createIndex:
            tableName: workspace_merge_transform
            indexName: idx_workspace_merge_transform_merging_user_id
            columns:
              - column:
                  name: merging_user_id
      rollback: # will be deleted with the table

  - changeSet:
      id: v58.2025-12-17T17:54:00
      author: christruter
      comment: Drop foreign key constraint from transform.workspace_id to workspace
      preConditions:
        - onFail: MARK_RAN
        - foreignKeyConstraintExists:
            foreignKeyName: fk_transform_workspace_id
      changes:
        - dropForeignKeyConstraint:
            baseTableName: transform
            constraintName: fk_transform_workspace_id
      rollback:
        - addForeignKeyConstraint:
            baseTableName: transform
            baseColumnNames: workspace_id
            constraintName: fk_transform_workspace_id
            referencedTableName: workspace
            referencedColumnNames: id

  - changeSet:
      id: v58.2025-12-17T17:54:01
      author: christruter
      comment: Drop workspace_id column from transform table
      preConditions:
        - onFail: MARK_RAN
        - columnExists:
            tableName: transform
            columnName: workspace_id
      changes:
        - dropColumn:
            tableName: transform
            columnName: workspace_id
      rollback:
        - addColumn:
            tableName: transform
            columns:
              - column:
                  name: workspace_id
                  type: int
                  remarks: Workspace containing this transform
                  constraints:
                    nullable: true

  - changeSet:
      id: v58.2025-12-17T17:54:02
      author: christruter
      comment: Drop foreign key constraint from metabase_field.workspace_id to workspace
      preConditions:
        - onFail: MARK_RAN
        - foreignKeyConstraintExists:
            foreignKeyName: fk_metabase_field_workspace_id
      changes:
        - dropForeignKeyConstraint:
            baseTableName: metabase_field
            constraintName: fk_metabase_field_workspace_id
      rollback:
        - createIndex:
            tableName: metabase_field
            indexName: idx_metabase_field_workspace_id
            columns:
              - column:
                  name: workspace_id
        - addForeignKeyConstraint:
            baseTableName: metabase_field
            baseColumnNames: workspace_id
            constraintName: fk_metabase_field_workspace_id
            referencedTableName: workspace
            referencedColumnNames: id

  - changeSet:
      id: v58.2025-12-17T17:54:03
      author: christruter
      comment: Drop workspace_id column from metabase_field table
      preConditions:
        - onFail: MARK_RAN
        - columnExists:
            tableName: metabase_field
            columnName: workspace_id
      changes:
        - dropColumn:
            tableName: metabase_field
            columnName: workspace_id
      rollback:
        - addColumn:
            tableName: metabase_field
            columns:
              - column:
                  name: workspace_id
                  type: int
                  remarks: Workspace containing this field
                  constraints:
                    nullable: true

  - changeSet:
      id: v58.2025-12-17T17:54:04
      author: christruter
      comment: Drop foreign key constraint from report_card.workspace_id to workspace
      preConditions:
        - onFail: MARK_RAN
        - foreignKeyConstraintExists:
            foreignKeyName: fk_report_card_workspace_id
      changes:
        - dropForeignKeyConstraint:
            baseTableName: report_card
            constraintName: fk_report_card_workspace_id
      rollback:
        - addForeignKeyConstraint:
            baseTableName: report_card
            baseColumnNames: workspace_id
            constraintName: fk_report_card_workspace_id
            referencedTableName: workspace
            referencedColumnNames: id

  - changeSet:
      id: v58.2025-12-17T17:54:05
      author: christruter
      comment: Drop workspace_id column from report_card table
      preConditions:
        - onFail: MARK_RAN
        - columnExists:
            tableName: report_card
            columnName: workspace_id
      changes:
        - dropColumn:
            tableName: report_card
            columnName: workspace_id
      rollback:
        - addColumn:
            tableName: report_card
            columns:
              - column:
                  name: workspace_id
                  type: int
                  remarks: Workspace containing this card
                  constraints:
                    nullable: true

  - changeSet:
      id: v58.2025-12-17T17:54:06
      author: christruter
      comment: Drop foreign key constraint from metabase_table.workspace_id to workspace
      validCheckSum: ANY
      preConditions:
        - onFail: MARK_RAN
        - foreignKeyConstraintExists:
            foreignKeyName: fk_metabase_table_workspace_id
      changes:
        - dropForeignKeyConstraint:
            baseTableName: metabase_table
            constraintName: fk_metabase_table_workspace_id
      rollback:
        - addForeignKeyConstraint:
            baseTableName: metabase_table
            baseColumnNames: workspace_id
            constraintName: fk_metabase_table_workspace_id
            referencedTableName: workspace
            referencedColumnNames: id

  - changeSet:
      id: v58.2025-12-17T17:54:07
      author: christruter
      comment: Drop index on metabase_table.workspace_id
      validCheckSum: ANY
      preConditions:
        - onFail: MARK_RAN
        - indexExists:
            indexName: idx_metabase_table_workspace_id
      changes:
        - dropIndex:
            tableName: metabase_table
            indexName: idx_metabase_table_workspace_id
      rollback:
        - createIndex:
            tableName: metabase_table
            indexName: idx_metabase_table_workspace_id
            columns:
              - column:
                  name: workspace_id

  - changeSet:
      id: v58.2025-12-17T17:54:08
      author: christruter
      comment: Drop workspace_id column from metabase_table table
      preConditions:
        - onFail: MARK_RAN
        - columnExists:
            tableName: metabase_table
            columnName: workspace_id
      changes:
        - dropColumn:
            tableName: metabase_table
            columnName: workspace_id
      rollback:
        - addColumn:
            tableName: metabase_table
            columns:
              - column:
                  name: workspace_id
                  type: int
                  remarks: Workspace containing this table
                  constraints:
                    nullable: true

  - changeSet:
      id: v58.2025-12-18T16:14:03
      author: winlost
      comment: Add disable_links column to pulse table
      changes:
        - addColumn:
            tableName: pulse
            columns:
              - column:
                  name: disable_links
                  type: ${boolean.type}
                  remarks: "Whether to disable email subscription links"
                  defaultValueBoolean: false
                  constraints:
                    nullable: true
      rollback:
        - dropColumn:
            tableName: pulse
            columnName: disable_links

  - changeSet:
      id: v58.2025-12-19T10:00:00
      author: christruter
      comment: Create workspace_output_external table for tracking outputs of enclosed external transforms
      preConditions:
        - onFail: MARK_RAN
        - not:
            - tableExists:
                tableName: workspace_output_external
      changes:
        - createTable:
            tableName: workspace_output_external
            remarks: Output tables produced by external transforms enclosed in a workspace
            columns:
              - column:
                  name: id
                  type: int
                  autoIncrement: true
                  remarks: Primary key
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: workspace_id
                  type: int
                  remarks: FK to workspace
                  constraints:
                    nullable: false
              - column:
                  name: transform_id
                  type: int
                  remarks: FK to transform (the external transform)
                  constraints:
                    nullable: false
              - column:
                  name: db_id
                  type: int
                  remarks: Database where the output table is created
                  constraints:
                    nullable: false
              - column:
                  name: global_schema
                  type: varchar(254)
                  remarks: Schema of the original output table
                  constraints:
                    nullable: true
              - column:
                  name: global_table
                  type: varchar(254)
                  remarks: Name of the original output table
                  constraints:
                    nullable: false
              - column:
                  name: global_table_id
                  type: int
                  remarks: FK to metabase_table for the global output table
                  constraints:
                    nullable: true
              - column:
                  name: isolated_schema
                  type: varchar(254)
                  remarks: Schema name in the isolated workspace namespace
                  constraints:
                    nullable: true
              - column:
                  name: isolated_table
                  type: varchar(254)
                  remarks: Table name in the isolated workspace namespace
                  constraints:
                    nullable: false
              - column:
                  name: isolated_table_id
                  type: int
                  remarks: FK to metabase_table for the isolated output table
                  constraints:
                    nullable: true
              - column:
                  name: created_at
                  type: ${timestamp_type}
                  remarks: Timestamp when the output was created
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: ${timestamp_type}
                  remarks: Timestamp when the output was last updated
                  constraints:
                    nullable: false
      rollback:
        - dropTable:
            tableName: workspace_output_external

  - changeSet:
      id: v58.2025-12-19T10:00:01
      validCheckSum: ANY
      author: christruter
      comment: Add index on workspace_output_external.workspace_id
      preConditions:
        - onFail: MARK_RAN
        - not:
            - indexExists:
                indexName: idx_workspace_output_external_workspace_id
      changes:
        - createIndex:
            tableName: workspace_output_external
            indexName: idx_workspace_output_external_workspace_id
            columns:
              - column:
                  name: workspace_id
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-12-19T10:00:02
      validCheckSum: ANY
      author: christruter
      comment: Add index on workspace_output_external.transform_id
      preConditions:
        - onFail: MARK_RAN
        - not:
            - indexExists:
                indexName: idx_workspace_output_external_transform_id
      changes:
        - createIndex:
            tableName: workspace_output_external
            indexName: idx_workspace_output_external_transform_id
            columns:
              - column:
                  name: transform_id
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-12-19T10:00:03
      validCheckSum: ANY
      author: christruter
      comment: Add foreign key constraint from workspace_output_external.workspace_id to workspace
      preConditions:
        - onFail: MARK_RAN
        - not:
            - foreignKeyConstraintExists:
                foreignKeyName: fk_workspace_output_external_workspace_id
      changes:
        - addForeignKeyConstraint:
            baseTableName: workspace_output_external
            baseColumnNames: workspace_id
            constraintName: fk_workspace_output_external_workspace_id
            referencedTableName: workspace
            referencedColumnNames: id
            onDelete: CASCADE
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-12-19T10:00:04
      validCheckSum: ANY
      author: christruter
      comment: Add foreign key constraint from workspace_output_external.transform_id to transform
      preConditions:
        - onFail: MARK_RAN
        - not:
            - foreignKeyConstraintExists:
                foreignKeyName: fk_workspace_output_external_transform_id
      changes:
        - addForeignKeyConstraint:
            baseTableName: workspace_output_external
            baseColumnNames: transform_id
            constraintName: fk_workspace_output_external_transform_id
            referencedTableName: transform
            referencedColumnNames: id
            onDelete: CASCADE
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-12-19T10:00:05
      validCheckSum: ANY
      author: christruter
      comment: Add unique constraint on workspace_output_external (workspace_id, transform_id)
      preConditions:
        - onFail: MARK_RAN
        - not:
            - uniqueConstraintExists:
                tableName: workspace_output_external
                constraintName: uq_workspace_output_external_workspace_transform
      changes:
        - addUniqueConstraint:
            tableName: workspace_output_external
            columnNames: workspace_id, transform_id
            constraintName: uq_workspace_output_external_workspace_transform
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-12-19T10:00:06
      author: christruter
      comment: Create workspace_input_external table for tracking inputs of enclosed external transforms
      preConditions:
        - onFail: MARK_RAN
        - not:
            - tableExists:
                tableName: workspace_input_external
      changes:
        - createTable:
            tableName: workspace_input_external
            remarks: External tables consumed by external transforms enclosed in a workspace (deduplicated per workspace)
            columns:
              - column:
                  name: id
                  type: int
                  autoIncrement: true
                  remarks: Primary key
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: workspace_id
                  type: int
                  remarks: FK to workspace
                  constraints:
                    nullable: false
              - column:
                  name: db_id
                  type: int
                  remarks: Database containing the source table
                  constraints:
                    nullable: false
              - column:
                  name: schema
                  type: varchar(254)
                  remarks: Schema of the source table (nullable for DBs without schemas)
                  constraints:
                    nullable: true
              - column:
                  name: table
                  type: varchar(254)
                  remarks: Name of the source table
                  constraints:
                    nullable: false
              - column:
                  name: table_id
                  type: int
                  remarks: FK to metabase_table if table exists and is synced
                  constraints:
                    nullable: true
              - column:
                  name: access_granted
                  type: ${boolean.type}
                  remarks: Whether read access has been granted to the workspace user
                  defaultValueBoolean: false
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: ${timestamp_type}
                  remarks: Timestamp when the input was created
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: ${timestamp_type}
                  remarks: Timestamp when the input was last updated
                  constraints:
                    nullable: false
      rollback:
        - dropTable:
            tableName: workspace_input_external

  - changeSet:
      id: v58.2025-12-19T10:00:07
      validCheckSum: ANY
      author: christruter
      comment: Add index on workspace_input_external.workspace_id
      preConditions:
        - onFail: MARK_RAN
        - not:
            - indexExists:
                indexName: idx_workspace_input_external_workspace_id
      changes:
        - createIndex:
            tableName: workspace_input_external
            indexName: idx_workspace_input_external_workspace_id
            columns:
              - column:
                  name: workspace_id
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-12-19T10:00:08
      validCheckSum: ANY
      author: christruter
      comment: Add foreign key constraint from workspace_input_external.workspace_id to workspace
      preConditions:
        - onFail: MARK_RAN
        - not:
            - foreignKeyConstraintExists:
                foreignKeyName: fk_workspace_input_external_workspace_id
      changes:
        - addForeignKeyConstraint:
            baseTableName: workspace_input_external
            baseColumnNames: workspace_id
            constraintName: fk_workspace_input_external_workspace_id
            referencedTableName: workspace
            referencedColumnNames: id
            onDelete: CASCADE
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-12-19T10:00:09
      validCheckSum: ANY
      author: christruter
      comment: Add unique constraint on workspace_input_external (workspace_id, db_id, schema, table)
      preConditions:
        - onFail: MARK_RAN
        - not:
            - uniqueConstraintExists:
                tableName: workspace_input_external
                constraintName: uq_workspace_input_external_logical_table
      changes:
        - addUniqueConstraint:
            tableName: workspace_input_external
            columnNames: workspace_id, db_id, schema, table
            constraintName: uq_workspace_input_external_logical_table
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-12-22T10:00:00
      validCheckSum: ANY
      author: piranha
      comment: Add creator_id column to workspace_transform
      preConditions:
        - onFail: MARK_RAN
        - not:
            - columnExists:
                tableName: workspace_transform
                columnName: creator_id
      changes:
        - addColumn:
            tableName: workspace_transform
            columns:
              - column:
                  name: creator_id
                  type: int
                  remarks: FK to core_user who created this workspace transform
                  constraints:
                    nullable: true
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-12-22T10:00:01
      validCheckSum: ANY
      author: piranha
      comment: Add index on workspace_transform.creator_id
      preConditions:
        - onFail: MARK_RAN
        - not:
            - indexExists:
                indexName: idx_workspace_transform_creator_id
      changes:
        - createIndex:
            tableName: workspace_transform
            indexName: idx_workspace_transform_creator_id
            columns:
              - column:
                  name: creator_id
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-12-22T10:00:02
      validCheckSum: ANY
      author: piranha
      comment: Add foreign key constraint from workspace_transform.creator_id to core_user
      preConditions:
        - onFail: MARK_RAN
        - not:
            - foreignKeyConstraintExists:
                foreignKeyName: fk_workspace_transform_creator_id
      changes:
        - addForeignKeyConstraint:
            baseTableName: workspace_transform
            baseColumnNames: creator_id
            constraintName: fk_workspace_transform_creator_id
            referencedTableName: core_user
            referencedColumnNames: id
            onDelete: SET NULL
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-12-23T10:00:00
      validCheckSum: ANY
      author: piranha
      comment: Add last_run_message column to workspace_transform
      preConditions:
        - onFail: MARK_RAN
        - not:
            - columnExists:
                tableName: workspace_transform
                columnName: last_run_message
      changes:
        - addColumn:
            tableName: workspace_transform
            columns:
              - column:
                  name: last_run_message
                  type: ${text.type}
                  remarks: Message from the last transform run (success or failure message)
                  constraints:
                    nullable: true
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-12-29T18:30:00
      author: qnkhuat
      comment: Mark archived workspaces with archived status
      changes:
        - sql:
            sql: UPDATE workspace SET status = 'archived' WHERE archived_at IS NOT NULL
            splitStatements: false
      rollback:
        - sql:
            sql: UPDATE workspace SET status = 'ready' WHERE status = 'archived'
            splitStatements: false

  - changeSet:
      id: v58.2025-12-29T18:31:00
      author: qnkhuat
      comment: Drop archived_at column from workspace
      changes:
        - dropColumn:
            tableName: workspace
            columnName: archived_at
      rollback:
        - addColumn:
            tableName: workspace
            columns:
              - column:
                  name: archived_at
                  type: ${timestamp_type}
                  remarks: Timestamp when (and if) the workspace was archived
                  constraints:
                    nullable: true
        - sql:
            sql: UPDATE workspace SET archived_at = current_timestamp WHERE status = 'archived'
            splitStatements: false

  - changeSet:
      id: v58.2025-12-29T19:00:00
      validCheckSum: ANY
      author: christruter
      comment: Add db_status column for tracking database isolation state
      changes:
        - addColumn:
            tableName: workspace
            columns:
              - column:
                  name: db_status
                  type: varchar(20)
                  remarks: Status of the database isolation resources (uninitialized, pending, ready, broken)
                  defaultValue: "uninitialized"
                  constraints:
                    nullable: false
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-12-29T19:00:01
      validCheckSum: ANY
      author: christruter
      comment: Add base_status column for tracking workspace lifecycle
      changes:
        - addColumn:
            tableName: workspace
            columns:
              - column:
                  name: base_status
                  type: varchar(20)
                  remarks: Workspace lifecycle status (empty, active, archived)
                  defaultValue: "empty"
                  constraints:
                    nullable: false
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-12-29T19:00:02
      author: christruter
      comment: Copy status to db_status for non-archived workspaces
      rollback: empty
      changes:
        - sql:
            sql: |
              UPDATE workspace SET db_status = status
              WHERE status IN ('uninitialized', 'pending', 'ready', 'broken')
            splitStatements: false

  - changeSet:
      id: v58.2025-12-29T19:00:03
      author: christruter
      comment: Set base_status to active for initialized workspaces
      rollback: empty
      changes:
        - sql:
            sql: |
              UPDATE workspace SET base_status = 'active'
              WHERE status IN ('pending', 'ready', 'broken')
            splitStatements: false

  - changeSet:
      id: v58.2025-12-29T19:00:04
      author: christruter
      comment: Set base_status to archived for archived workspaces
      rollback: empty
      changes:
        - sql:
            sql: |
              UPDATE workspace SET base_status = 'archived'
              WHERE status = 'archived'
            splitStatements: false

  - changeSet:
      id: v58.2025-12-29T19:00:05
      author: christruter
      comment: Drop legacy status column
      changes:
        - dropColumn:
            tableName: workspace
            columnName: status
      rollback:
        - addColumn:
            tableName: workspace
            columns:
              - column:
                  name: status
                  type: varchar(20)
                  remarks: Status of workspace setup
                  defaultValue: "ready"
                  constraints:
                    nullable: false

  - changeSet:
      id: v58.2025-12-30T10:00:00
      validCheckSum: ANY
      author: christruter
      comment: Add analysis_stale column to workspace_transform for lazy analysis
      changes:
        - addColumn:
            tableName: workspace_transform
            columns:
              - column:
                  name: analysis_stale
                  type: ${boolean.type}
                  defaultValueBoolean: true
                  remarks: Whether dependency analysis needs to be recalculated
                  constraints:
                    nullable: false
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-12-30T10:00:01
      validCheckSum: ANY
      author: christruter
      comment: Add analysis_stale column to workspace for lazy graph caching
      changes:
        - addColumn:
            tableName: workspace
            columns:
              - column:
                  name: analysis_stale
                  type: ${boolean.type}
                  defaultValueBoolean: true
                  remarks: Whether the graph needs to be recalculated
                  constraints:
                    nullable: false
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2025-12-30T10:00:02
      author: christruter
      comment: Create workspace_graph table for cached dependency graphs
      changes:
        - createTable:
            tableName: workspace_graph
            remarks: Stores cached dependency graph for each workspace
            columns:
              - column:
                  name: id
                  type: int
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: workspace_id
                  type: int
                  remarks: Reference to the workspace this graph belongs to
                  constraints:
                    nullable: false
                    references: workspace(id)
                    foreignKeyName: fk_workspace_graph_workspace_id
                    deleteCascade: true
              - column:
                  name: graph
                  type: ${text.type}
                  remarks: JSON representation of the dependency graph
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: ${timestamp_type}
                  remarks: Timestamp when the cached graph was created
                  defaultValueComputed: current_timestamp
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: ${timestamp_type}
                  remarks: Timestamp when the cached graph was last updated
                  defaultValueComputed: current_timestamp
                  constraints:
                    nullable: false
      rollback:
        - dropTable:
            tableName: workspace_graph

  - changeSet:
      id: v58.2025-12-30T10:00:03
      author: christruter
      comment: Add unique index on workspace_graph.workspace_id
      changes:
        - createIndex:
            tableName: workspace_graph
            indexName: idx_workspace_graph_workspace_id
            unique: true
            columns:
              - column:
                  name: workspace_id
      rollback: # will be removed along the table

  - changeSet:
      id: v58.2025-12-30T22:48:02
      author: edpaget
      comment: Add remote_sync_object.model_table_id for parent table reference
      changes:
        - addColumn:
            tableName: remote_sync_object
            columns:
              - column:
                  name: model_table_id
                  type: int
                  remarks: Parent table ID for Field/Segment/Table models
                  constraints:
                    nullable: true

  - changeSet:
      id: v58.2025-12-30T22:48:03
      author: edpaget
      comment: Add remote_sync_object.model_table_name for parent table name
      changes:
        - addColumn:
            tableName: remote_sync_object
            columns:
              - column:
                  name: model_table_name
                  type: varchar(255)
                  remarks: Parent table name for Field/Segment/Table models
                  constraints:
                    nullable: true

  - changeSet:
      id: v58.2026-01-05T12:00:00
      author: metasasha
      comment: Add is_data_analyst column to core_user table for analyst role
      changes:
        - addColumn:
            tableName: core_user
            columns:
              - column:
                  name: is_data_analyst
                  type: ${boolean.type}
                  defaultValueBoolean: false
                  remarks: Indicates if the user has data analyst privileges for Data Studio
                  constraints:
                    nullable: false

  # Denormalize workspace_dependency into workspace_input by adding ref_id column
  # This allows direct lookup of inputs per transform without a join table

  - changeSet:
      id: v58.2026-01-09T07:51:00
      author: christruter
      comment: Delete existing workspace_input rows (will be recreated when transforms marked stale)
      changes:
        - sql:
            sql: DELETE FROM workspace_input
      rollback: empty

  - changeSet:
      id: v58.2026-01-09T07:51:01
      validCheckSum: ANY
      author: christruter
      comment: Add ref_id column to workspace_input
      changes:
        - addColumn:
            tableName: workspace_input
            columns:
              - column:
                  name: ref_id
                  type: char(36)
                  remarks: ref_id of the workspace_transform that depends on this input
                  constraints:
                    nullable: false
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2026-01-09T07:51:02
      author: christruter
      comment: Add access_granted column to workspace_input
      validCheckSum: ANY
      preConditions:
        - onFail: MARK_RAN
        - not:
            - columnExists:
                tableName: workspace_input
                columnName: access_granted
      changes:
        - addColumn:
            tableName: workspace_input
            columns:
              - column:
                  name: access_granted
                  type: ${boolean.type}
                  remarks: Whether read access has been granted to the workspace user
                  defaultValueBoolean: false
                  constraints:
                    nullable: false
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2026-01-09T07:51:03
      validCheckSum: ANY
      author: christruter
      comment: Drop old unique constraint on workspace_input (workspace_id, db_id, schema, table)
      changes:
        - dropUniqueConstraint:
            tableName: workspace_input
            constraintName: uq_workspace_input_logical_table
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2026-01-09T07:51:04
      validCheckSum: ANY
      author: christruter
      comment: Add new unique constraint on workspace_input including ref_id
      changes:
        - addUniqueConstraint:
            tableName: workspace_input
            columnNames: workspace_id, ref_id, db_id, schema, table
            constraintName: uq_workspace_input_transform_table
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2026-01-09T07:51:05
      validCheckSum: ANY
      author: christruter
      comment: Add index on workspace_input (workspace_id, ref_id) for DAG queries
      changes:
        - createIndex:
            tableName: workspace_input
            indexName: idx_workspace_input_ref_id
            columns:
              - column:
                  name: workspace_id
              - column:
                  name: ref_id
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2026-01-09T07:51:06
      author: christruter
      comment: Mark all workspace transforms as stale so inputs get recreated
      changes:
        - sql:
            sql: UPDATE workspace_transform SET stale = true
      rollback: empty

  - changeSet:
      id: v58.2026-01-09T07:51:07
      author: christruter
      comment: Drop workspace_dependency table (no longer needed after denormalization)
      changes:
        - dropTable:
            tableName: workspace_dependency
      rollback:
        - createTable:
            tableName: workspace_dependency
            remarks: Edges between workspace transforms and their dependencies
            columns:
              - column:
                  name: id
                  type: int
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: workspace_id
                  type: int
                  constraints:
                    nullable: false
              - column:
                  name: from_entity_type
                  type: varchar(20)
                  constraints:
                    nullable: false
              - column:
                  name: from_entity_id
                  type: varchar(36)
                  constraints:
                    nullable: false
              - column:
                  name: to_entity_type
                  type: varchar(20)
                  constraints:
                    nullable: false
              - column:
                  name: to_entity_id
                  type: int
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: ${timestamp_type}
                  defaultValueComputed: current_timestamp
                  constraints:
                    nullable: false

  - changeSet:
      id: v58.2026-01-09T09:28:40
      validCheckSum: ANY
      author: piranha
      comment: Add target_db_id column to transform table
      preConditions:
        - onFail: MARK_RAN
        - not:
            - columnExists:
                tableName: transform
                columnName: target_db_id
      changes:
        - addColumn:
            tableName: transform
            columns:
              - column:
                  name: target_db_id
                  type: int
                  remarks: Target database ID for the transform output
                  constraints:
                    nullable: true
      rollback: # will be removed along with the table

  - changeSet:
      id: v58.2026-01-09T10:00:00
      author: qnkhuat
      comment: Drop stale column from workspace_transform
      changes:
        - dropColumn:
            tableName: workspace_transform
            columnName: stale
      rollback:
        - addColumn:
            tableName: workspace_transform
            columns:
              - column:
                  name: stale
                  type: ${boolean.type}
                  defaultValueBoolean: true
                  remarks: Indicates if the target configuration needs to be refreshed
                  constraints:
                    nullable: false

  - changeSet:
      id: v58.2026-01-09T10:00:02
      author: qnkhuat
      comment: Add definition_changed column to workspace_transform table
      changes:
        - addColumn:
            tableName: workspace_transform
            columns:
              - column:
                  name: definition_changed
                  type: ${boolean.type}
                  defaultValueBoolean: true
                  remarks: Indicates if the transform definition has changed and needs re-execution
                  constraints:
                    nullable: false
      rollback:
        - dropColumn:
            tableName: workspace_transform
            columnName: definition_changed

  - changeSet:
      id: v58.2026-01-09T12:00:00
      author: johnswanson
      comment: Create data-analyst magic permissions group
      changes:
        - sql:
            sql: INSERT INTO permissions_group (name, magic_group_type) VALUES ('Data Analysts', 'data-analyst')
      rollback:
        - sql:
            sql: DELETE FROM permissions_group WHERE magic_group_type = 'data-analyst';

  - changeSet:
      id: v58.2026-01-09T12:00:01
      author: johnswanson
      comment: Grant read permissions on existing Library collections to Data Analysts group
      changes:
        - sql:
            sql: >-
              INSERT INTO permissions (group_id, object)
              SELECT pg.id, '/collection/' || c.id || '/'
              FROM permissions_group pg, collection c
              WHERE pg.magic_group_type = 'data-analyst'
                AND c.type IN ('library', 'library-data', 'library-metrics')
      rollback:
        - sql:
            # We can safely delete ALL permissions for this group because it will be deleted in the rollback above
            sql: >-
              DELETE FROM permissions
              WHERE group_id IN (SELECT id FROM permissions_group WHERE magic_group_type = 'data-analyst');

  - changeSet:
      id: v58.2026-01-12T10:47:48
      validCheckSum: ANY
      author: christruter
      comment: Add last_run_status column to workspace_transform
      preConditions:
        - onFail: MARK_RAN
        - not:
            - columnExists:
                tableName: workspace_transform
                columnName: last_run_status
      changes:
        - addColumn:
            tableName: workspace_transform
            columns:
              - column:
                  name: last_run_status
                  type: varchar(20)
                  remarks: Status of the last transform run (succeeded or failed)
                  constraints:
                    nullable: true
      rollback: # will be removed along with the table

  # ===== Epochal Versioning for Thread-Safe Graph Calculation =====
  # Replace boolean analysis_stale flags with incrementing version numbers.
  # Two-level versioning:
  # - Transform level: analysis_version on workspace_transform, transform_version on workspace_input/workspace_output
  # - Graph level: graph_version on workspace, workspace_graph, workspace_input_external, workspace_output_external

  - changeSet:
      id: v58.2026-01-12T14:00:00
      author: christruter
      comment: Add graph_version column to workspace for epochal versioning
      changes:
        - addColumn:
            tableName: workspace
            columns:
              - column:
                  name: graph_version
                  type: bigint
                  defaultValueNumeric: 1
                  remarks: Incremented when graph structure changes (transform add/remove, global transform changes)
                  constraints:
                    nullable: false

  - changeSet:
      id: v58.2026-01-12T14:00:02
      author: christruter
      comment: Add analysis_version column to workspace_transform for transform-level versioning
      changes:
        - addColumn:
            tableName: workspace_transform
            columns:
              - column:
                  name: analysis_version
                  type: bigint
                  defaultValueNumeric: 1
                  remarks: Incremented when transform source/target changes, triggers re-analysis
                  constraints:
                    nullable: false

  - changeSet:
      id: v58.2026-01-12T14:00:03
      author: christruter
      comment: Add transform_version column to workspace_input
      changes:
        - addColumn:
            tableName: workspace_input
            columns:
              - column:
                  name: transform_version
                  type: bigint
                  defaultValueNumeric: 0
                  remarks: The analysis_version of the transform when this row was created
                  constraints:
                    nullable: false

  - changeSet:
      id: v58.2026-01-12T14:00:04
      author: christruter
      comment: Add transform_version column to workspace_output
      changes:
        - addColumn:
            tableName: workspace_output
            columns:
              - column:
                  name: transform_version
                  type: bigint
                  defaultValueNumeric: 0
                  remarks: The analysis_version of the transform when this row was created
                  constraints:
                    nullable: false

  - changeSet:
      id: v58.2026-01-12T14:00:05
      author: christruter
      comment: Add graph_version column to workspace_graph
      changes:
        - addColumn:
            tableName: workspace_graph
            columns:
              - column:
                  name: graph_version
                  type: bigint
                  defaultValueNumeric: 0
                  remarks: The graph_version this cached graph was calculated for
                  constraints:
                    nullable: false

  - changeSet:
      id: v58.2026-01-12T14:00:06
      author: christruter
      comment: Add graph_version column to workspace_input_external
      changes:
        - addColumn:
            tableName: workspace_input_external
            columns:
              - column:
                  name: graph_version
                  type: bigint
                  defaultValueNumeric: 0
                  remarks: The graph_version this row was calculated for
                  constraints:
                    nullable: false

  - changeSet:
      id: v58.2026-01-12T14:00:07
      author: christruter
      comment: Add graph_version column to workspace_output_external
      changes:
        - addColumn:
            tableName: workspace_output_external
            columns:
              - column:
                  name: graph_version
                  type: bigint
                  defaultValueNumeric: 0
                  remarks: The graph_version this row was calculated for
                  constraints:
                    nullable: false

  # Clear existing data from versioned tables - will be recalculated on first access
  - changeSet:
      id: v58.2026-01-12T14:00:10
      author: christruter
      comment: Clear workspace_graph data for epochal versioning migration
      changes:
        - delete:
            tableName: workspace_graph
      rollback: empty

  - changeSet:
      id: v58.2026-01-12T14:00:11
      author: christruter
      comment: Clear workspace_input data for epochal versioning migration
      changes:
        - delete:
            tableName: workspace_input
      rollback: empty

  - changeSet:
      id: v58.2026-01-12T14:00:12
      author: christruter
      comment: Clear workspace_output data for epochal versioning migration
      changes:
        - delete:
            tableName: workspace_output
      rollback: empty

  - changeSet:
      id: v58.2026-01-12T14:00:13
      author: christruter
      comment: Clear workspace_input_external data for epochal versioning migration
      changes:
        - delete:
            tableName: workspace_input_external
      rollback: empty

  - changeSet:
      id: v58.2026-01-12T14:00:14
      author: christruter
      comment: Clear workspace_output_external data for epochal versioning migration
      changes:
        - delete:
            tableName: workspace_output_external
      rollback: empty

  # Update unique constraints to include version columns
  - changeSet:
      id: v58.2026-01-12T14:00:19
      author: christruter
      comment: Drop FK constraint on workspace_graph.workspace_id (required before dropping index in H2)
      changes:
        - dropForeignKeyConstraint:
            baseTableName: workspace_graph
            constraintName: fk_workspace_graph_workspace_id
      rollback:
        - addForeignKeyConstraint:
            baseTableName: workspace_graph
            baseColumnNames: workspace_id
            referencedTableName: workspace
            referencedColumnNames: id
            constraintName: fk_workspace_graph_workspace_id
            onDelete: CASCADE

  - changeSet:
      id: v58.2026-01-12T14:00:20
      author: christruter
      comment: Drop old unique index on workspace_graph.workspace_id
      changes:
        - dropIndex:
            tableName: workspace_graph
            indexName: idx_workspace_graph_workspace_id
      rollback:
        - createIndex:
            tableName: workspace_graph
            indexName: idx_workspace_graph_workspace_id
            unique: true
            columns:
              - column:
                  name: workspace_id

  - changeSet:
      id: v58.2026-01-12T14:00:21
      author: christruter
      comment: Add unique index on workspace_graph (workspace_id, graph_version)
      changes:
        - createIndex:
            tableName: workspace_graph
            indexName: idx_workspace_graph_workspace_version
            unique: true
            columns:
              - column:
                  name: workspace_id
              - column:
                  name: graph_version
      rollback:
        - dropIndex:
            tableName: workspace_graph
            indexName: idx_workspace_graph_workspace_version

  - changeSet:
      id: v58.2026-01-12T14:00:22
      author: christruter
      comment: Recreate FK constraint on workspace_graph.workspace_id
      changes:
        - addForeignKeyConstraint:
            baseTableName: workspace_graph
            baseColumnNames: workspace_id
            referencedTableName: workspace
            referencedColumnNames: id
            constraintName: fk_workspace_graph_workspace_id
            onDelete: CASCADE

  - changeSet:
      id: v58.2026-01-12T14:00:23
      author: christruter
      comment: Drop old unique constraint on workspace_input (workspace_id, ref_id, db_id, schema, table)
      changes:
        - dropUniqueConstraint:
            tableName: workspace_input
            constraintName: uq_workspace_input_transform_table
      rollback:
        - addUniqueConstraint:
            tableName: workspace_input
            columnNames: workspace_id, ref_id, db_id, schema, table
            constraintName: uq_workspace_input_transform_table

  - changeSet:
      id: v58.2026-01-12T14:00:24
      author: christruter
      comment: Add unique constraint on workspace_input including transform_version
      changes:
        - addUniqueConstraint:
            tableName: workspace_input
            columnNames: workspace_id, ref_id, db_id, schema, table, transform_version
            constraintName: uq_workspace_input_versioned
      rollback:
        - dropUniqueConstraint:
            tableName: workspace_input
            constraintName: uq_workspace_input_versioned

  - changeSet:
      id: v58.2026-01-12T14:00:25
      author: christruter
      comment: Drop old unique constraint on workspace_output (workspace_id, ref_id)
      changes:
        - dropUniqueConstraint:
            tableName: workspace_output
            constraintName: uq_workspace_output_workspace_ref
      rollback:
        - addUniqueConstraint:
            tableName: workspace_output
            columnNames: workspace_id, ref_id
            constraintName: uq_workspace_output_workspace_ref

  - changeSet:
      id: v58.2026-01-12T14:00:26
      author: christruter
      comment: Add unique constraint on workspace_output including transform_version
      changes:
        - addUniqueConstraint:
            tableName: workspace_output
            columnNames: workspace_id, ref_id, transform_version
            constraintName: uq_workspace_output_versioned
      rollback:
        - dropUniqueConstraint:
            tableName: workspace_output
            constraintName: uq_workspace_output_versioned

  - changeSet:
      id: v58.2026-01-12T14:00:27
      author: christruter
      comment: Drop old unique constraint on workspace_input_external
      changes:
        - dropUniqueConstraint:
            tableName: workspace_input_external
            constraintName: uq_workspace_input_external_logical_table
      rollback:
        - addUniqueConstraint:
            tableName: workspace_input_external
            columnNames: workspace_id, db_id, schema, table
            constraintName: uq_workspace_input_external_logical_table

  - changeSet:
      id: v58.2026-01-12T14:00:28
      author: christruter
      comment: Add unique constraint on workspace_input_external including graph_version
      changes:
        - addUniqueConstraint:
            tableName: workspace_input_external
            columnNames: workspace_id, db_id, schema, table, graph_version
            constraintName: uq_workspace_input_external_versioned
      rollback:
        - dropUniqueConstraint:
            tableName: workspace_input_external
            constraintName: uq_workspace_input_external_versioned

  - changeSet:
      id: v58.2026-01-12T14:00:29
      author: christruter
      comment: Drop old unique constraint on workspace_output_external
      changes:
        - dropUniqueConstraint:
            tableName: workspace_output_external
            constraintName: uq_workspace_output_external_workspace_transform
      rollback:
        - addUniqueConstraint:
            tableName: workspace_output_external
            columnNames: workspace_id, transform_id
            constraintName: uq_workspace_output_external_workspace_transform

  - changeSet:
      id: v58.2026-01-12T14:00:30
      author: christruter
      comment: Add unique constraint on workspace_output_external including graph_version
      changes:
        - addUniqueConstraint:
            tableName: workspace_output_external
            columnNames: workspace_id, transform_id, graph_version
            constraintName: uq_workspace_output_external_versioned
      rollback:
        - dropUniqueConstraint:
            tableName: workspace_output_external
            constraintName: uq_workspace_output_external_versioned

  # Drop legacy analysis_stale columns (replaced by version comparison)
  - changeSet:
      id: v58.2026-01-12T14:00:31
      author: christruter
      comment: Drop analysis_stale column from workspace (replaced by version comparison)
      changes:
        - dropColumn:
            tableName: workspace
            columnName: analysis_stale
      rollback:
        - addColumn:
            tableName: workspace
            columns:
              - column:
                  name: analysis_stale
                  type: ${boolean.type}
                  defaultValueBoolean: true
                  remarks: Whether the graph needs to be recalculated
                  constraints:
                    nullable: false

  - changeSet:
      id: v58.2026-01-12T14:00:32
      author: christruter
      comment: Drop analysis_stale column from workspace_transform (replaced by version comparison)
      changes:
        - dropColumn:
            tableName: workspace_transform
            columnName: analysis_stale
      rollback:
        - addColumn:
            tableName: workspace_transform
            columns:
              - column:
                  name: analysis_stale
                  type: ${boolean.type}
                  defaultValueBoolean: true
                  remarks: Whether dependency analysis needs to be recalculated
                  constraints:
                    nullable: false

  - changeSet:
      id: v58.2026-01-13T10:00:01
      author: qnkhuat
      comment: Add workspace_permissions_status column to metabase_database
      preConditions:
        - onFail: MARK_RAN
        - not:
            - columnExists:
                tableName: metabase_database
                columnName: workspace_permissions_status
      changes:
        - addColumn:
            tableName: metabase_database
            columns:
              - column:
                  name: workspace_permissions_status
                  type: ${text.type}
                  remarks: Status of workspace isolation permission check (JSON)
                  constraints:
                    nullable: true
      rollback:
        - dropColumn:
            tableName: metabase_database
            columnName: workspace_permissions_status

  - changeSet:
      id: v58.2026-01-16T10:00:00
      author: qnkhuat
      comment: Add input_data_changed column to workspace_transform table
      changes:
        - addColumn:
            tableName: workspace_transform
            columns:
              - column:
                  name: input_data_changed
                  type: ${boolean.type}
                  defaultValueBoolean: false
                  remarks: Indicates if upstream data has changed and transform needs re-execution
                  constraints:
                    nullable: false
      rollback:
        - dropColumn:
            tableName: workspace_transform
            columnName: input_data_changed

  - changeSet:
      id: v58.2026-01-31T10:00:00
      author: christruter
      comment: Backfill target_db_id for existing transforms
      changes:
        - customChange:
            class: "metabase.app_db.custom_migrations.BackfillTransformTargetDbId"

  - changeSet:
      id: v58.2026-01-31T10:00:01
      author: christruter
      comment: Add index on transform.target_db_id
      preConditions:
        - onFail: MARK_RAN
        - not:
            - indexExists:
                tableName: transform
                indexName: idx_transform_target_db_id
      changes:
        - createIndex:
            tableName: transform
            indexName: idx_transform_target_db_id
            columns:
              - column:
                  name: target_db_id
      rollback:
        - dropIndex:
            tableName: transform
            indexName: idx_transform_target_db_id

  - changeSet:
      id: v58.2026-01-31T10:00:02
      author: christruter
      comment: Add foreign key constraint from transform.target_db_id to metabase_database
      preConditions:
        - onFail: MARK_RAN
        - not:
            - foreignKeyConstraintExists:
                foreignKeyTableName: transform
                foreignKeyName: fk_transform_target_db_id
      changes:
        - addForeignKeyConstraint:
            baseTableName: transform
            baseColumnNames: target_db_id
            referencedTableName: metabase_database
            referencedColumnNames: id
            constraintName: fk_transform_target_db_id
      rollback:
        - dropForeignKeyConstraint:
            baseTableName: transform
            constraintName: fk_transform_target_db_id

# >>>>>>>>>> DO NOT ADD NEW MIGRATIONS BELOW THIS LINE! ADD THEM ABOVE <<<<<<<<<<

########################################################################################################################
#
# ADVICE:
#
# 1) Think through some of these points when writing a migration, learn from our past mistakes:
#    - Do you really need a migration? Could the feature work without it? Prefer not to if possible.
#      Data in the wild can be vastly different from what you expect, and it's hard to get right.
#    - Make sure your migration is backward compatible: it might not be possible to add a constraint back
#      if you drop it in a migration.
#    - Postgres, MySQL and H2 have their differences. Make sure your migration works for all.
#    - Database encryption is a major issue:
#      - Fields like `metabase_database.details` or `setting.value` can be encrypted, so you need to decrypt them in
#        your migration. See #42617, #44048.
#      - Database could be partially encrypted, see https://www.notion.so/72575933ef2a446bafd16909e05a7387
#    - Custom migrations:
#      - Prefer SQL migrations when possible.
#      - Never use application code: it can change and *will* break your migration.
#      - Do not use Toucan models - refer table names directly.
#      - If it's a big change, consider using Quartz, see #42279
#      - More in `metabase.app_db.custom_migrations` namespace doc.
#    - Never delete a migration: users won't be able to downgrade. If you really need to, see #44908
#    - Migration id (`vXX.<date>`) must match its earliest released version:
#      - Do not backport `v51....` to version 50, Metabase will try to downgrade it.
#      - Instead, write a migration with an oldest target you plan to backport to in mind.
#
# 2) Migrations should go in the ###_update_migrations.yaml file for the target version.
#
# 3) Run mage lint-migrations to run core.spec checks against any changes you make here. Liquibase is pretty
#    forgiving and won't complain if you accidentally mix up things like deleteCascade and onDelete: CASCADE. CI runs
#    this check but it's nicer to know now instead of waiting for CI.
#
# 3) Migration IDs should follow the format
#
#    vMM.TIMESTAMP
#
#    Where
#
#    M         = major version
#    TIMESTAMP = the current timestamp with format `yyyy-MM-dd'T'HH:mm:ss`
#                To get this timestamp, evaluate this in your REPL: `(dev/migration-timestamp)`
#
#    E.g: You're adding a new migration for version 49, And it's 10:30:00AM on April 1, 2023 (UTC),
#    your migration id should be: `v49.2023-04-01T10:30:00`.
#
# PLEASE KEEP THIS MESSAGE AT THE BOTTOM OF THIS FILE!!!!! Add new migrations above the message.
#
########################################################################################################################
