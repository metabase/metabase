#!/usr/bin/env bash

set -euo pipefail

# Load shared utilities
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/utils/all.sh"

# Script-specific print functions
print_found() {
    print_success "$1"
}

print_not_found() {
    print_error "$1"
}

print_optional_tool() {
    local cmd=$1
    local name=$2
    local url=$3
    if command -v "$cmd" &> /dev/null; then
        echo -e "    ${GREEN}âœ“${NC} $name"
    else
        echo -e "    ${RED}âœ—${NC} $name"
    fi
    echo -e "      ${DIM}$url${NC}"
}

# Detection functions
detect_version_managers() {
    local managers=()

    # nvm - Node Version Manager
    if [ -d "$HOME/.nvm" ] || [ -n "${NVM_DIR:-}" ] || command -v nvm &> /dev/null; then
        managers+=("nvm")
    fi

    # fnm - Fast Node Manager
    if command -v fnm &> /dev/null || [ -d "$HOME/.fnm" ]; then
        managers+=("fnm")
    fi

    # n - Node version management (no subcommands)
    if command -v n &> /dev/null || [ -d "/usr/local/n" ]; then
        managers+=("n")
    fi

    # volta - JavaScript Tool Manager
    if command -v volta &> /dev/null || [ -d "$HOME/.volta" ]; then
        managers+=("volta")
    fi

    # asdf - Extendable version manager (multi-language)
    if [ -d "$HOME/.asdf" ] || command -v asdf &> /dev/null; then
        managers+=("asdf")
    fi

    # mise - Dev tools version manager (formerly rtx)
    if command -v mise &> /dev/null || [ -d "$HOME/.local/share/mise" ] || [ -d "$HOME/.mise" ]; then
        managers+=("mise")
    fi

    # jenv - Java version manager
    if [ -d "$HOME/.jenv" ] || command -v jenv &> /dev/null; then
        managers+=("jenv")
    fi

    # SDKMAN! - Software Development Kit Manager (Java, Gradle, Maven, etc.)
    if [ -d "$HOME/.sdkman" ] || [ -n "${SDKMAN_DIR:-}" ]; then
        managers+=("sdkman")
    fi

    echo "${managers[@]}"
}

get_node_version() {
    if command -v node &> /dev/null; then
        node --version
    else
        echo ""
    fi
}

get_yarn_version() {
    if command -v yarn &> /dev/null; then
        yarn --version
    else
        echo ""
    fi
}

get_java_version() {
    if command -v java &> /dev/null; then
        java -version 2>&1 | head -n 1 | awk -F '"' '{print $2}'
    else
        echo ""
    fi
}

get_java_distribution() {
    if command -v java &> /dev/null; then
        local full_version=$(java -version 2>&1)

        # Check for various distributions
        if echo "$full_version" | grep -qi "Temurin"; then
            echo "Eclipse Temurin"
        elif echo "$full_version" | grep -qi "Adoptium"; then
            echo "Eclipse Adoptium"
        elif echo "$full_version" | grep -qi "Oracle"; then
            echo "Oracle"
        elif echo "$full_version" | grep -qi "OpenJDK"; then
            echo "OpenJDK"
        elif echo "$full_version" | grep -qi "Amazon Corretto"; then
            echo "Amazon Corretto"
        elif echo "$full_version" | grep -qi "Azul Zulu"; then
            echo "Azul Zulu"
        elif echo "$full_version" | grep -qi "GraalVM"; then
            echo "GraalVM"
        else
            echo "Unknown"
        fi
    else
        echo ""
    fi
}

check_java_requirements() {
    local version=$1
    local distribution=$2
    local major_version=""

    if [ -n "$version" ]; then
        # Extract major version (handles both "21.0.1" and "1.8.0" formats)
        if [[ $version =~ ^1\. ]]; then
            major_version=$(echo "$version" | cut -d. -f2)
        else
            major_version=$(echo "$version" | cut -d. -f1)
        fi

        # Check version and distribution
        if [ "$major_version" = "21" ] && [[ "$distribution" =~ "Temurin" ]]; then
            echo "correct"
        elif [ "$major_version" = "21" ]; then
            echo "wrong_distribution"
        else
            echo "wrong_version"
        fi
    else
        echo "not_installed"
    fi
}

get_clojure_version() {
    if command -v clojure &> /dev/null; then
        clojure --version 2>&1 | head -n 1
    else
        echo ""
    fi
}

get_required_clojure_version() {
    if [ -f "deps.edn" ]; then
        # Extract org.clojure/clojure version from deps.edn
        grep "org.clojure/clojure" deps.edn | grep ":mvn/version" | sed -E 's/.*"([0-9.]+)".*/\1/' | head -n 1
    else
        echo ""
    fi
}

get_babashka_version() {
    if command -v bb &> /dev/null; then
        bb --version
    else
        echo ""
    fi
}

check_yarn_classic() {
    local version=$1
    if [ -n "$version" ]; then
        local major_version=$(echo "$version" | cut -d. -f1)
        if [ "$major_version" = "1" ]; then
            return 0
        fi
    fi
    return 1
}

main() {
    print_header "Metabase Development Environment Detection"

    echo "This script detects your current development tool setup and provides"
    echo "guidance on how to prepare your environment for Metabase development."
    echo ""
    echo "Note: This script only detects and reports. It will not modify your system."

    print_section "Version Managers Detected"

    managers=($(detect_version_managers))

    if [ ${#managers[@]} -eq 0 ]; then
        print_info "No version managers detected"
        echo "     You may be using system-installed tools or manual installations."
    else
        for manager in "${managers[@]}"; do
            print_found "$manager"
        done

        # Check for conflicts
        if [ ${#managers[@]} -gt 1 ]; then
            echo ""
            print_warning "Multiple version managers detected!"
            echo "     Having multiple version managers can cause conflicts where different"
            echo "     tools compete to manage the same runtime versions. This may lead to:"
            echo "       - Unexpected version switches"
            echo "       - PATH conflicts"
            echo "       - Shell initialization slowdowns"
            echo ""
            echo -e "  ðŸ’¡ ${BOLD}Recommendation:${NC} Use only one version manager (we recommend mise)."
        fi
    fi

    print_section "Installed Development Tools"

    requirements_met=true

    # Node.js
    node_version=$(get_node_version)
    if [ -n "$node_version" ]; then
        node_major=$(echo "$node_version" | sed 's/v//' | cut -d. -f1)
        if [ "$node_major" -ge 22 ]; then
            print_found "Node.js $node_version (meets requirement: >= 22)"
        else
            print_warning "Node.js $node_version (required: >= 22)"
            requirements_met=false
        fi
    else
        print_not_found "Node.js (required: >= 22)"
        requirements_met=false
    fi

    # Yarn
    yarn_version=$(get_yarn_version)
    if [ -n "$yarn_version" ]; then
        if check_yarn_classic "$yarn_version"; then
            print_found "Yarn $yarn_version (Yarn Classic - correct!)"
        else
            print_warning "Yarn $yarn_version (required: Yarn Classic 1.x)"
            requirements_met=false
        fi
    else
        print_not_found "Yarn (required: Yarn Classic 1.x)"
        requirements_met=false
    fi

    # Java
    java_version=$(get_java_version)
    java_distribution=$(get_java_distribution)
    java_status=$(check_java_requirements "$java_version" "$java_distribution")

    case "$java_status" in
        "correct")
            print_found "Java $java_version ($java_distribution) - correct!"
            ;;
        "wrong_distribution")
            print_warning "Java $java_version ($java_distribution)"
            echo "     Required: Java 21 (Eclipse Temurin)"
            requirements_met=false
            ;;
        "wrong_version")
            print_warning "Java $java_version ($java_distribution)"
            echo "     Required: Java 21 (Eclipse Temurin)"
            requirements_met=false
            ;;
        "not_installed")
            print_not_found "Java (required: Java 21 Eclipse Temurin)"
            requirements_met=false
            ;;
    esac

    # Clojure CLI
    clojure_version=$(get_clojure_version)
    required_clojure_version=$(get_required_clojure_version)

    if [ -n "$clojure_version" ]; then
        if [ -n "$required_clojure_version" ]; then
            print_found "Clojure CLI ($clojure_version) - requires Clojure $required_clojure_version"
        else
            print_found "Clojure CLI ($clojure_version)"
        fi
    else
        if [ -n "$required_clojure_version" ]; then
            print_not_found "Clojure CLI (required for Clojure $required_clojure_version)"
        else
            print_not_found "Clojure CLI"
        fi
        requirements_met=false
    fi

    # Babashka
    bb_version=$(get_babashka_version)
    if [ -n "$bb_version" ]; then
        print_found "Babashka $bb_version"
    else
        print_not_found "Babashka (required for mage task automation)"
        requirements_met=false
    fi

    # Show warning if requirements are not met
    if [ "$requirements_met" = false ]; then
        echo ""
        echo -e "  ${BOLD}${RED}âš  REQUIREMENTS NOT MET âš ${NC}"
        echo ""
        echo -e "  ${BOLD}Your current setup does not meet Metabase's requirements.${NC}"
        echo "  The project will not work until the issues above are resolved."
        echo ""
        echo "  Please install or update the missing/incorrect tools listed above."
    fi

    print_section "Metabase Project Requirements"

    required_clojure_version=$(get_required_clojure_version)

    echo -e "  ${BOLD}Required Tools:${NC}"
    echo "    - Node.js >= 22 (currently specified in .nvmrc)"
    echo "    - Yarn Classic 1.x (NOT Yarn 2+, NO Corepack)"
    echo "    - Java 21 with Eclipse Temurin distribution (for Clojure backend)"
    if [ -n "$required_clojure_version" ]; then
        echo "    - Clojure CLI (for Clojure $required_clojure_version specified in deps.edn)"
    else
        echo "    - Clojure CLI"
    fi
    echo "    - Babashka (for mage task automation)"
    echo ""
    echo -e "  ${BOLD}Optional Tools (quality of life):${NC}"
    print_optional_tool bat "bat - A cat clone with syntax highlighting" "https://github.com/sharkdp/bat"
    print_optional_tool fzf "fzf - A fuzzy finder for the terminal" "https://github.com/junegunn/fzf"
    print_optional_tool fd "fd - A fast alternative to find" "https://github.com/sharkdp/fd"
    print_optional_tool rg "ripgrep - A fast alternative to grep" "https://github.com/BurntSushi/ripgrep"
    print_optional_tool gh "gh - GitHub CLI" "https://cli.github.com/"
    print_optional_tool op "op - 1Password CLI" "https://1password.com/downloads/command-line/"
    print_optional_tool aws "aws - AWS CLI" "https://aws.amazon.com/cli/"
    print_optional_tool orb "OrbStack - Fast Docker & Linux on macOS" "https://orbstack.dev/"

    print_section "Recommended Setup"

    echo -e "  ${BOLD}${GREEN}We recommend using 'mise'${NC} for version management because:"
    echo "    - Manages Node.js, Java, and other tools in one place"
    echo "    - Automatically switches versions per-project"
    echo "    - Cross-platform and actively maintained"
    echo ""
    echo "    Learn more: https://mise.jdx.dev/getting-started.html"

    # Footer
    print_header "Detection Complete"

    echo "For detailed development environment setup, see:"
    echo "  docs/developers-guide/devenv.md"
    echo ""
    echo "To re-run this detection script:"
    echo "  ./bin/dev-requirements"
    echo ""
}

main "$@"
