name: Embedding SDK Bundle Build

on:
  workflow_call:
    inputs:
      ref:
        description: "Git ref to check out. Defaults to the current ref."
        required: false
        type: string
        default: ""
      artifact-name:
        description: "Name for the uploaded artifact."
        required: true
        type: string

jobs:
  build-sdk-bundle:
    runs-on: ubuntu-22.04
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref || github.ref }}
      - name: Resolve ref to SHA for cache key
        id: resolve-sha
        run: echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
      - name: Restore SDK bundle from cache
        id: cache-restore
        uses: actions/cache/restore@v4
        with:
          path: resources/frontend_client/app/embedding-sdk.js
          key: sdk-bundle-${{ steps.resolve-sha.outputs.sha }}
      - name: Prepare front-end environment
        if: steps.cache-restore.outputs.cache-hit != 'true'
        uses: ./.github/actions/prepare-frontend
      - name: Prepare back-end environment
        if: steps.cache-restore.outputs.cache-hit != 'true'
        uses: ./.github/actions/prepare-backend
      - name: Build Embedding SDK bundle
        if: steps.cache-restore.outputs.cache-hit != 'true'
        run: bun run build-release:cljs && bun run build-release:embedding-sdk-bundle
      - name: Save SDK bundle to cache
        if: steps.cache-restore.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: resources/frontend_client/app/embedding-sdk.js
          key: sdk-bundle-${{ steps.resolve-sha.outputs.sha }}
      - name: Upload embedding-sdk.js artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact-name }}
          path: resources/frontend_client/app/embedding-sdk.js
          retention-days: 1
