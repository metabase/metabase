(ns metabase-enterprise.metabot-v3.agent.tools-test
  (:require
   [clojure.test :refer :all]
   [metabase-enterprise.metabot-v3.agent.profiles :as profiles]
   [metabase-enterprise.metabot-v3.agent.tools :as agent-tools]
   [metabase-enterprise.metabot-v3.tools.create-chart :as create-chart-tools]
   [metabase-enterprise.metabot-v3.tools.filters :as filter-tools]))

(deftest all-tools-test
  (testing "profile tools are vars with tool metadata"
    (let [tool-vars (mapcat :tools (vals @@#'profiles/*profiles))]
      (is (seq tool-vars))
      (doseq [tool-var tool-vars]
        (let [tool-meta (meta tool-var)]
          (is (var? tool-var))
          (is (some? tool-meta))
          (is (string? (:tool-name tool-meta)))
          (is (some? (:schema tool-meta))))))))

(deftest filter-by-capabilities-test
  (testing "returns tools with no capability requirements when capabilities empty"
    (let [tool-vars [#'agent-tools/search-tool #'agent-tools/create-sql-query-tool]
          capabilities #{}
          result (#'profiles/filter-by-capabilities tool-vars capabilities)]
      (is (= tool-vars result))))

  (testing "filters out tools that require missing capabilities"
    (let [tool-vars [#'agent-tools/search-tool
                     #'agent-tools/navigate-user-tool
                     #'agent-tools/create-autogenerated-dashboard-tool]
          capabilities #{}
          result (#'profiles/filter-by-capabilities tool-vars capabilities)]
      (is (= [#'agent-tools/search-tool] (vec result)))))

  (testing "includes tools when capabilities are provided"
    (let [tool-vars [#'agent-tools/search-tool #'agent-tools/navigate-user-tool #'agent-tools/create-chart-tool]
          capabilities #{:frontend-navigate-user-v1}
          result (#'profiles/filter-by-capabilities tool-vars capabilities)]
      (is (= tool-vars (vec result)))))

  (testing "filters transform tools by capabilities"
    (let [tool-vars [#'agent-tools/write-transform-sql-tool
                     #'agent-tools/write-transform-python-tool
                     #'agent-tools/search-tool]
          capabilities #{:feature-transforms :permission-write-transforms}
          result (#'profiles/filter-by-capabilities tool-vars capabilities)]
      (is (= [#'agent-tools/write-transform-sql-tool #'agent-tools/search-tool] (vec result)))))

  (testing "includes write_transform_python when all capabilities present"
    (let [tool-vars [#'agent-tools/write-transform-python-tool #'agent-tools/search-tool]
          capabilities #{:feature-transforms :feature-transforms-python :permission-write-transforms}
          result (#'profiles/filter-by-capabilities tool-vars capabilities)]
      (is (= tool-vars (vec result)))))

  (testing "filters snippet tools by capabilities"
    (let [tool-vars [#'agent-tools/list-snippets-tool #'agent-tools/get-snippet-details-tool #'agent-tools/search-tool]
          capabilities #{}
          result (#'profiles/filter-by-capabilities tool-vars capabilities)]
      (is (= [#'agent-tools/search-tool] (vec result)))))

  (testing "includes snippet tools when capability present"
    (let [tool-vars [#'agent-tools/list-snippets-tool #'agent-tools/get-snippet-details-tool #'agent-tools/search-tool]
          capabilities #{:feature-snippets}
          result (#'profiles/filter-by-capabilities tool-vars capabilities)]
      (is (= tool-vars (vec result))))))

(deftest get-tools-for-profile-test
  (testing "returns tools for embedding_next profile"
    (let [tools (profiles/get-tools-for-profile :embedding_next #{})]
      (is (map? tools))
      (is (contains? tools "construct_notebook_query"))
      (is (contains? tools "read_resource"))
      (is (contains? tools "list_available_data_sources"))))

  (testing "returns tools for internal profile"
    (let [tools (profiles/get-tools-for-profile :internal #{})]
      (is (map? tools))
      (is (> (count tools) 5))
      (is (contains? tools "search"))
      (is (contains? tools "create_sql_query"))
      (is (contains? tools "create_chart"))))

  (testing "returns tools for transforms_codegen profile"
    (let [tools (profiles/get-tools-for-profile :transforms_codegen #{})]
      (is (map? tools))
      (is (contains? tools "search"))
      (is (contains? tools "get_transform_details"))
      (is (contains? tools "list_available_fields"))
      (is (contains? tools "todo_write"))
      (is (contains? tools "todo_read"))))

  (testing "returns tools for sql profile"
    (let [tools (profiles/get-tools-for-profile :sql #{})]
      (is (map? tools))
      (is (contains? tools "search"))
      (is (contains? tools "create_sql_query"))
      (is (contains? tools "ask_for_sql_clarification"))))

  (testing "returns tools for nlq profile"
    (let [tools (profiles/get-tools-for-profile :nlq #{})]
      (is (map? tools))
      (is (contains? tools "search"))
      (is (contains? tools "construct_notebook_query"))
      (is (contains? tools "create_chart"))))

  (testing "returns empty map for unknown profile"
    (let [tools (profiles/get-tools-for-profile :unknown-profile #{})]
      (is (empty? tools))))

  (testing "returned tools have correct structure"
    (let [tools (profiles/get-tools-for-profile :embedding_next #{})]
      (doseq [[tool-name tool-var] tools]
        (is (var? tool-var))
        (is (string? tool-name))))))

(deftest search-tool-test
  (testing "search-tool exists and is a function"
    (let [tool-var #'agent-tools/search-tool
          tool-meta (meta tool-var)]
      (is (some? tool-meta))
      (is (some? (:tool-name tool-meta)))))

  (testing "search-tool is callable"
    (let [tool-fn @#'agent-tools/search-tool]
      (is (fn? tool-fn)))))

(deftest construct-notebook-query-tool-raw-table-test
  (testing "construct_notebook_query maps raw table query args"
    (let [captured (atom nil)
          chart-called (atom nil)]
      (with-redefs [filter-tools/query-datasource (fn [args]
                                                    (reset! captured args)
                                                    {:structured-output {:query-id "q-1"
                                                                         :query {:database 1}}})
                    create-chart-tools/create-chart (fn [args]
                                                      (reset! chart-called args)
                                                      {:chart-id "c-1"
                                                       :chart-type :table
                                                       :chart-link "metabase://chart/c-1"
                                                       :chart-content "<chart/>"
                                                       :query-id (:query-id args)
                                                       :reactions [{:type :metabot.reaction/redirect
                                                                    :url "/question#hash"}]})]
        (let [result (agent-tools/construct-notebook-query-tool
                      {:reasoning "check seats"
                       :query {:query_type "raw"
                               :source {:table_id 6}
                               :filters [{:filter_type "multi_value"
                                          :field_id "t6-1"
                                          :operation "equals"
                                          :values ["a" "b"]}]
                               :fields [{:field_id "t6-1"}]
                               :order_by [{:field {:field_id "t6-1"} :direction "desc"}]
                               :limit 10}
                       :visualization {:chart_type "table"}})]
          (is (= 6 (:table-id @captured)))
          (is (= "t6-1" (get-in @captured [:fields 0 :field-id])))
          (is (= ["a" "b"] (get-in @captured [:filters 0 :values])))
          (is (= :desc (get-in @captured [:order-by 0 :direction])))
          (is (= "c-1" (get-in result [:structured-output :chart-id])))
          (is (= "q-1" (get-in result [:structured-output :query-id])))
          (is (= :table (get @chart-called :chart-type)))
          (is (seq (:data-parts result))))))))

(deftest state-dependent-tools-test
  (testing "state-dependent-tools set contains expected tools"
    (is (contains? @#'agent-tools/state-dependent-tools "create_chart"))
    (is (contains? @#'agent-tools/state-dependent-tools "edit_chart"))
    (is (contains? @#'agent-tools/state-dependent-tools "create_sql_query"))
    (is (contains? @#'agent-tools/state-dependent-tools "edit_sql_query"))
    (is (contains? @#'agent-tools/state-dependent-tools "replace_sql_query"))
    (is (contains? @#'agent-tools/state-dependent-tools "todo_write"))
    (is (contains? @#'agent-tools/state-dependent-tools "todo_read"))
    (is (contains? @#'agent-tools/state-dependent-tools "navigate_user"))
    (is (contains? @#'agent-tools/state-dependent-tools "write_transform_sql"))
    (is (contains? @#'agent-tools/state-dependent-tools "write_transform_python"))
    (is (contains? @#'agent-tools/state-dependent-tools "create_autogenerated_dashboard"))))

(defn ^{:doc "Test tool"
        :schema [:=> [:cat [:map]] :any]
        :system-instructions "Follow the rules."}
  test-stateful-tool
  [_]
  nil)

(deftest wrap-tools-with-state-test
  (testing "wraps state-dependent tools with state injection"
    (let [memory-atom (atom {:state {:queries {"q1" {:database 1}}
                                     :charts {"c1" {:query-id "q1"}}}})
          base-tools {"create_sql_query" #'agent-tools/create-sql-query-tool
                      "search" #'agent-tools/search-tool}
          wrapped-tools (agent-tools/wrap-tools-with-state base-tools memory-atom)]
      (is (map? (get wrapped-tools "create_sql_query")))
      (is (contains? (get wrapped-tools "create_sql_query") :fn))
      (is (contains? (get wrapped-tools "create_sql_query") :doc))
      (is (contains? (get wrapped-tools "create_sql_query") :schema))
      (is (contains? (get wrapped-tools "create_sql_query") :system-instructions))
      (is (var? (get wrapped-tools "search")))))

  (testing "wrapped tools preserve original metadata"
    (let [memory-atom (atom {:state {:queries {} :charts {}}})
          base-tools {"create_chart" #'agent-tools/create-chart-tool}
          wrapped-tools (agent-tools/wrap-tools-with-state base-tools memory-atom)
          wrapped-tool (get wrapped-tools "create_chart")
          original-meta (meta #'agent-tools/create-chart-tool)]
      (is (= (:doc original-meta) (:doc wrapped-tool)))
      (is (= (:schema original-meta) (:schema wrapped-tool)))))

  (deftest wrap-tools-with-state-preserves-system-instructions-test
    (testing "preserves system instructions for wrapped tools"
      (let [memory-atom (atom {:state {:queries {} :charts {}}})
            base-tools {"create_sql_query" #'test-stateful-tool}
            wrapped-tools (agent-tools/wrap-tools-with-state base-tools memory-atom)]
        (is (= "Follow the rules."
               (get-in wrapped-tools ["create_sql_query" :system-instructions]))))))

  (testing "wrapped function receives augmented args with state"
    (let [seen-memory (atom nil)
          memory-atom (atom {:state {:queries {"test-query" {:db 1}}
                                     :charts {"test-chart" {:type :bar}}}})
          test-stateful-tool
          (with-meta
           (fn [_] (reset! seen-memory @#'agent-tools/*memory-atom*) {:output "ok"})
           {:doc "Test tool"
            :schema [:=> [:cat [:map]] :any]
            :system-instructions "Follow the rules."})
          wrapped (agent-tools/wrap-tools-with-state {"create_sql_query" test-stateful-tool} memory-atom)
          wrapped-fn (get-in wrapped ["create_sql_query" :fn])]
      (wrapped-fn {:database_id 1 :sql_query "SELECT 1"})
      (is (= memory-atom @seen-memory))))

  (testing "non-state-dependent tools are not modified"
    (let [memory-atom (atom {:state {:queries {"q1" {:db 1}} :charts {}}})
          base-tools {"search" #'agent-tools/search-tool
                      "construct_notebook_query" #'agent-tools/construct-notebook-query-tool}
          wrapped-tools (agent-tools/wrap-tools-with-state base-tools memory-atom)]
      (is (var? (get wrapped-tools "search")))
      (is (var? (get wrapped-tools "construct_notebook_query"))))))

(deftest tool-schemas-exclude-state-keys-test
  (testing "create_chart schema does not expose state keys"
    (let [tool-var #'agent-tools/create-chart-tool
          {:keys [schema]} (meta tool-var)
          [_:=> [_:cat params] _out] schema]
      (is (not-any? #(= :charts_state (first %)) (rest params)))))

  (testing "edit_chart schema does not expose state keys"
    (let [tool-var #'agent-tools/edit-chart-tool
          {:keys [schema]} (meta tool-var)
          [_:=> [_:cat params] _out] schema]
      (is (not-any? #(= :queries_state (first %)) (rest params)))))

  (testing "create_sql_query schema does not expose state keys"
    (let [tool-var #'agent-tools/create-sql-query-tool
          {:keys [schema]} (meta tool-var)
          [_:=> [_:cat params] _out] schema]
      (is (not-any? #(= :queries_state (first %)) (rest params)))
      (is (not-any? #(= :charts_state (first %)) (rest params)))
      (is (not-any? #(= :memory_atom (first %)) (rest params)))))

  (testing "edit_sql_query schema does not expose state keys"
    (let [tool-var #'agent-tools/edit-sql-query-tool
          {:keys [schema]} (meta tool-var)
          [_:=> [_:cat params] _out] schema]
      (is (not-any? #(= :queries_state (first %)) (rest params)))
      (is (not-any? #(= :charts_state (first %)) (rest params)))))

  (testing "replace_sql_query schema does not expose state keys"
    (let [tool-var #'agent-tools/replace-sql-query-tool
          {:keys [schema]} (meta tool-var)
          [_:=> [_:cat params] _out] schema]
      (is (not-any? #(= :queries_state (first %)) (rest params)))
      (is (not-any? #(= :charts_state (first %)) (rest params))))))
