name: Backend

on:
  schedule:
    - cron: 0 */2 * * *
  workflow_dispatch: {}

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref && github.ref || github.run_id }}
  cancel-in-progress: true

env:
  CLJ_KONDO_VERSION: "2023.09.07"

jobs:

  be-tests:
    runs-on: [self-hosted, linux, monorepo, x86, 2xlarge]
    name: be-tests-java-${{ matrix.java-version }}-${{ matrix.edition }}
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        edition: [oss, ee]
        java-version: [11, 17, 21]
    steps:
      - uses: actions/checkout@v3

      - name: Prepare front-end environment
        uses: ./.github/actions/prepare-frontend

      - name: Prepare back-end environment
        uses: ./.github/actions/prepare-backend
        with:
          m2-cache-key: be-tests

      - name: Build static-viz frontend
        run: yarn build-static-viz

      - name: Download Static Viz Bundle Artifact
        uses: actions/download-artifact@v3
        with:
          name: static-viz-bundle-${{ github.sha }}
          path: resources/frontend_client/app/dist

      - name: Run tests
        if: matrix.java-version != 21
        run: clojure -X:dev:ci:test:${{ matrix.edition }}:${{ matrix.edition }}-dev

      - name: Run tests using Java 21 on `master` only
        if: matrix.java-version == 21 && github.ref_name == 'master'
        run: clojure -X:dev:ci:test:${{ matrix.edition }}:${{ matrix.edition }}-dev

      - name: Upload results
        uses: ./.github/actions/upload_junit_xml
        with:
          filepaths: target/junit/**/*_test.xml
          trunk_token: ${{ secrets.TRUNK_DEBUGGER_TOKEN }}
