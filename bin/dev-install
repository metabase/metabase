#!/usr/bin/env bash
# Automated Metabase development environment setup using mise.
# This script installs mise, configures shell integration, and sets up all required tools.
#
# Usage: ./bin/dev-install
#
# Safe to run multiple times (idempotent).

set -euo pipefail

# Load shared utilities
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
source "$SCRIPT_DIR/utils/all.sh"

# Lock directory to prevent concurrent runs
LOCK_DIR="$PROJECT_ROOT/logs/dev-install.lock"

acquire_lock() {
    mkdir -p "$(dirname "$LOCK_DIR")"
    # Use mkdir for atomic lock acquisition
    if ! mkdir "$LOCK_DIR" 2>/dev/null; then
        print_error "dev-install is already running"
        echo "      If this is a mistake, run: rm -rf $LOCK_DIR"
        exit 1
    fi
}

release_lock() {
    rm -rf "$LOCK_DIR"
}

trap release_lock EXIT

# =============================================================================
# Environment Detection
# =============================================================================

detect_os() {
    case "$(uname -s)" in
        Darwin) echo "macos" ;;
        Linux)  echo "linux" ;;
        *)      echo "unknown" ;;
    esac
}

detect_arch() {
    case "$(uname -m)" in
        x86_64)  echo "x86_64" ;;
        aarch64) echo "arm64" ;;
        arm64)   echo "arm64" ;;
        *)       echo "unknown" ;;
    esac
}

detect_shell() {
    local shell_name
    shell_name=$(basename "$SHELL")
    case "$shell_name" in
        bash|zsh|fish) echo "$shell_name" ;;
        *) echo "unknown" ;;
    esac
}

get_shell_rc_file() {
    local shell_name=$1
    case "$shell_name" in
        bash)
            # Prefer .bashrc, but use .bash_profile on macOS if .bashrc doesn't exist
            if [ -f "$HOME/.bashrc" ]; then
                echo "$HOME/.bashrc"
            elif [ -f "$HOME/.bash_profile" ]; then
                echo "$HOME/.bash_profile"
            else
                echo "$HOME/.bashrc"
            fi
            ;;
        zsh)  echo "$HOME/.zshrc" ;;
        fish) echo "$HOME/.config/fish/config.fish" ;;
        *)    echo "" ;;
    esac
}

get_mise_activation_line() {
    local shell_name=$1
    case "$shell_name" in
        bash) echo 'eval "$(mise activate bash)"' ;;
        zsh)  echo 'eval "$(mise activate zsh)"' ;;
        fish) echo 'mise activate fish | source' ;;
        *)    echo "" ;;
    esac
}

has_homebrew() {
    command -v brew &> /dev/null
}

has_mise() {
    command -v mise &> /dev/null
}

has_curl() {
    command -v curl &> /dev/null
}

# =============================================================================
# Installation Functions
# =============================================================================

install_mise_homebrew() {
    print_step "Installing mise via Homebrew"
    if brew install mise; then
        print_success "mise installed via Homebrew"
        return 0
    else
        print_warning "Homebrew installation failed, falling back to official installer"
        return 1
    fi
}

install_mise_official() {
    print_step "Installing mise via official installer"

    if ! has_curl; then
        print_error "curl is required but not installed"
        exit 1
    fi

    if curl -fsSL https://mise.run | sh; then
        print_success "mise installed via official installer"

        # Add to PATH for this session
        export PATH="$HOME/.local/bin:$PATH"
        return 0
    else
        print_error "Failed to install mise"
        exit 1
    fi
}

install_mise() {
    if has_mise; then
        print_success "mise is already installed ($(mise --version))"
        return 0
    fi

    local os=$(detect_os)

    case "$os" in
        macos)
            if has_homebrew; then
                install_mise_homebrew || install_mise_official
            else
                install_mise_official
            fi
            ;;
        linux)
            install_mise_official
            ;;
        *)
            print_error "Unsupported operating system: $os"
            exit 1
            ;;
    esac
}

# =============================================================================
# Shell Integration
# =============================================================================

check_shell_integration() {
    local rc_file=$1
    local activation_line=$2

    if [ ! -f "$rc_file" ]; then
        return 1
    fi

    # Check if mise activation is already present
    if grep -q "mise activate" "$rc_file" 2>/dev/null; then
        return 0
    fi

    return 1
}

setup_shell_integration() {
    local shell_name=$(detect_shell)

    if [ "$shell_name" = "unknown" ]; then
        print_warning "Unknown shell: $SHELL"
        echo "      Please manually add mise activation to your shell config."
        echo "      See: https://mise.jdx.dev/getting-started.html#activate-mise"
        return 0
    fi

    local rc_file=$(get_shell_rc_file "$shell_name")
    local activation_line=$(get_mise_activation_line "$shell_name")

    if [ -z "$rc_file" ]; then
        print_warning "Could not determine shell config file"
        return 0
    fi

    if check_shell_integration "$rc_file" "$activation_line"; then
        print_success "Shell integration already configured in $rc_file"
        return 0
    fi

    print_step "Shell integration"
    echo "      mise needs to be activated in your shell to work automatically."
    echo "      This will add the following line to $rc_file:"
    echo ""
    echo "        $activation_line"
    echo ""

    if ask_yes_no "Add mise to your shell config?" "y"; then
        # Create rc file if it doesn't exist
        mkdir -p "$(dirname "$rc_file")"
        touch "$rc_file"

        # Add activation line
        echo "" >> "$rc_file"
        echo "# mise - dev tool version manager" >> "$rc_file"
        echo "$activation_line" >> "$rc_file"

        print_success "Added mise activation to $rc_file"
        print_warning "Run 'source $rc_file' or restart your shell to activate mise"
    else
        print_warning "Skipped shell integration"
        echo "      You'll need to manually activate mise in each session:"
        echo "        $activation_line"
    fi
}

# =============================================================================
# Tool Installation
# =============================================================================

install_tools() {
    print_step "Installing development tools via mise"

    cd "$PROJECT_ROOT"

    # Trust the mise.toml file
    if ! mise trust --all 2>/dev/null; then
        mise trust 2>/dev/null || true
    fi

    # Install all tools
    if mise install; then
        print_success "All tools installed successfully"
    else
        print_error "Failed to install some tools"
        echo "      Try running 'mise install' manually to see detailed errors"
        return 1
    fi
}

# =============================================================================
# Main
# =============================================================================

main() {
    acquire_lock

    print_header "Metabase Development Environment Setup"

    echo "This script will:"
    echo "  1. Install mise (if not already installed)"
    echo "  2. Configure shell integration (with your permission)"
    echo "  3. Install all required development tools"
    echo "  4. Run dev-bootstrap to set up the project"
    echo ""

    # Check prerequisites
    print_step "Checking prerequisites"

    local os=$(detect_os)
    local arch=$(detect_arch)
    local shell_name=$(detect_shell)

    if [ "$os" = "unknown" ]; then
        print_error "Unsupported operating system"
        exit 1
    fi

    print_success "OS: $os ($arch)"
    print_success "Shell: $shell_name"

    if [ "$(id -u)" = "0" ]; then
        print_warning "Running as root is not recommended"
        if ! ask_yes_no "Continue anyway?" "n"; then
            exit 1
        fi
    fi

    if ! has_curl; then
        print_error "curl is required but not installed"
        exit 1
    fi
    print_success "curl is available"

    # Install mise
    install_mise

    # Verify mise is now available
    if ! has_mise; then
        # Try adding common mise locations to PATH
        export PATH="$HOME/.local/bin:$HOME/.mise/bin:$PATH"

        if ! has_mise; then
            print_error "mise installation succeeded but 'mise' command not found"
            echo "      Try restarting your shell and running this script again"
            exit 1
        fi
    fi

    # Setup shell integration
    setup_shell_integration

    # Install tools
    install_tools

    # Run dev-bootstrap
    echo ""
    if ask_yes_no "Run dev-bootstrap to complete setup?" "y"; then
        echo ""
        "$SCRIPT_DIR/dev-bootstrap"
    else
        print_warning "Skipped dev-bootstrap"
        echo "      Run './bin/dev-bootstrap' when you're ready to complete setup"
    fi

    print_header "Setup Complete!"

    echo "Your Metabase development environment is ready."
    echo ""
    echo "If this is a new shell integration, restart your shell or run:"
    local shell_name=$(detect_shell)
    local rc_file=$(get_shell_rc_file "$shell_name")
    if [ -n "$rc_file" ]; then
        echo "  source $rc_file"
    fi
    echo ""
    echo "Then you can start developing:"
    echo "  clojure -M:dev:run    # Start backend"
    echo "  yarn build-hot        # Start frontend"
    echo ""
}

main "$@"
