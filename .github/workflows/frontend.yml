name: Frontend

on:
  push:
  workflow_call:
    inputs:
      skip:
        type: boolean
        default: false
      skip-lint:
        type: boolean
        default: false
  workflow_dispatch:
    inputs:
      skip:
        description: "Skip main frontend jobs (type-check, unit tests, timezone tests)"
        type: boolean
        default: false
      skip-lint:
        description: "Skip linting jobs (prettier, eslint, css variables check)"
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref && github.ref || github.run_id }}-frontend
  cancel-in-progress: true

jobs:
  fe-tests-unit:
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2] # 2 shards for parallel execution
    env:
      SHARDS: 2 # should match matrix above
      JEST_JUNIT_OUTPUT_DIR: ./target/junit
      JEST_JUNIT_OUTPUT_NAME: test-report-frontend-unit.xml
    steps:
      - uses: actions/checkout@v4
      - name: Prepare front-end environment
        uses: ./.github/actions/prepare-frontend
      - name: Prepare back-end environment
        uses: ./.github/actions/prepare-backend
      - name: Run frontend unit tests
        run: bun run test-unit --silent --shard=${{ matrix.shard }}/${{ env.SHARDS }}
        # Trunk Quarantine controls the final state of the run in the CI!
        # Even if this step fails we let it pass, and then `trunk-io/analytics-uploader` determines
        # whether to fail or to pass the whole job, based on the quarantine list.
        continue-on-error: true
      - name: Upload Test Results
        uses: ./.github/actions/upload-test-results
        if: always() && github.event_name != 'workflow_dispatch'
        with:
          input-path: ./target/junit
          output-name: frontend-unit
          bucket: ${{ vars.AWS_S3_TEST_RESULTS_BUCKET }}
          aws-access-key-id: ${{ secrets.AWS_TEST_RESULTS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_TEST_RESULTS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION }}
          trunk-api-token: ${{ secrets.TRUNK_API_TOKEN }}

  fe-tests-timezones:
    if: ${{ !inputs.skip }}
    runs-on: ubuntu-22.04
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      - name: Prepare front-end environment
        uses: ./.github/actions/prepare-frontend
      - name: Prepare back-end environment
        uses: ./.github/actions/prepare-backend
      - name: Run frontend timezones tests
        run: bun run test-timezones
