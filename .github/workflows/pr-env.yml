name: CI for PR Review ENV
run-name: Building Dynamic PR Environment for ${{ github.ref_name }} by @${{ github.actor }}

on:
  workflow_call:
    inputs:
      self_hosting:
        description: 'Deploy self-hosting stack'
        required: false
        type: boolean
        default: false
      analytics_dev_mode:
        description: 'Enable analytics development mode'
        required: false
        type: boolean
        default: false
jobs:
  build:
    runs-on: ubuntu-latest
    if: github.event.pull_request.head.repo.full_name == github.repository
    name: Build Metabase Docker image
    timeout-minutes: 60
    permissions:
      id-token: write
      contents: read
      actions: read
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.PR_ENV_IAM_ROLE }}
          role-session-name: GitHub_to_AWS_via_FederatedOIDC
          aws-region: us-east-1
      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2
        with:
          registries: "${{ secrets.PR_ENV_AWS_ACCOUNT_ID }}"
      - name: Retrieve uberjar artifact for ee
        uses: ./.github/actions/fetch-artifact
        with:
          commit: ${{ github.event.pull_request.head.sha || github.sha }}
          edition: ee
          extract-path: "target/uberjar"
          output-name: "metabase.jar"
      - name: Move uberjar to bin/docker
        run: |
          jar xf target/uberjar/metabase.jar
          mv target/uberjar/metabase.jar bin/docker/metabase.jar
      - name: Build container
        uses: docker/build-push-action@v6
        with:
          context: bin/docker/
          platforms: linux/amd64
          network: host
          tags: ${{ secrets.PR_ENV_AWS_ACCOUNT_ID }}.dkr.ecr.us-east-1.amazonaws.com/metabase-enterprise:pr${{ github.event.number }}
          push: true
  deploy_pr:
    needs: [build]
    runs-on: ubuntu-latest
    name: PR Review ENV
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
      - name: Tailscale
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ secrets.PR_ENV_TAILSCALE_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.PR_ENV_TAILSCALE_OAUTH_SECRET }}
          tags: tag:ci
          version: 1.50.1
          sha256sum: d9fe6b480fb5078f0aa57dace686898dda7e2a768884271159faa74846bfb576
      - name: Create OIDC Token
        id: create-oidc-token
        shell: bash
        run: |
          export OIDC_URL_WITH_AUDIENCE="$ACTIONS_ID_TOKEN_REQUEST_URL&audience=${{ secrets.PR_ENV_K8S_AUDIENCE }}"
          IDTOKEN=$(curl -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" -H "Accept: application/json; api-version=2.0" "$OIDC_URL_WITH_AUDIENCE" | jq -r .value)
          echo "::add-mask::${IDTOKEN}"
          echo "idToken=${IDTOKEN}" >>$GITHUB_OUTPUT
      - name: Setup Kube Context
        uses: azure/k8s-set-context@v2
        with:
          method: kubeconfig
          kubeconfig: |
            kind: Config
            apiVersion: v1
            current-context: default
            clusters:
            - name: default
              cluster:
                certificate-authority-data: ${{ secrets.PR_ENV_K8S_CERTIFICATE_AUTHORITY_DATA }}
                server: ${{ secrets.PR_ENV_K8S_SERVER }}
            users:
            - name: oidc-token
              user:
                token: ${{ steps.create-oidc-token.outputs.IDTOKEN }}
            contexts:
            - name: default
              context:
                cluster: default
                namespace: default
                user: oidc-token
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.PR_ENV_IAM_ROLE }}
          role-session-name: GitHub_to_AWS_via_FederatedOIDC
          aws-region: us-east-1
      - name: Setup psql client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client
      - name: Create app database if not exists
        run: |
          export PGPASSWORD='${{ secrets.PR_ENV_DB_PASSWORD }}'
          export PGUSER=${{ secrets.PR_ENV_DB_USER }}
          export PGHOST=${{ secrets.PR_ENV_DB_HOST }}
          export PGDATABASE=${{ secrets.PR_ENV_DB_NAME }}
          psql -tc "SELECT 1 FROM pg_database WHERE datname = 'hosting_pr${{ github.event.number }}'" \
          | grep -q 1 \
          || psql -c "CREATE DATABASE hosting_pr${{ github.event.number }}"
      - name: Download Deployment YAML template
        if: ${{ !inputs.self_hosting }}
        run: aws s3 cp s3://metabase-pr-env/metabase.yml.tmpl ./metabase.yml.tmpl
      - name: Render Deployment YAML
        if: ${{ !inputs.self_hosting }}
        uses: nowactions/envsubst@v1
        with:
          input: ./metabase.yml.tmpl
          output: ./metabase.yml
        env:
          IMAGE_TAG: pr${{ github.event.number }}
          PR_NUMBER: ${{ github.event.number }}
          MB_PREMIUM_EMBEDDING_TOKEN: ${{ secrets.PR_ENV_MB_PREMIUM_EMBEDDING_TOKEN }}
          SHA: ${{ github.event.pull_request.head.sha || github.sha }}
          MB_ANALYTICS_DEV_MODE: ${{ inputs.analytics_dev_mode && 'true' || 'false' }}
      - name: Deploy PR Review ENV
        if: ${{ !inputs.self_hosting }}
        run: |
          kubectl apply -f ./metabase.yml
      - name: Download Helm values template (self-hosting)
        if: ${{ inputs.self_hosting }}
        run: aws s3 cp s3://metabase-pr-env/values.yaml.tmpl ./values.yaml.tmpl
      - name: Render Helm values (self-hosting)
        if: ${{ inputs.self_hosting }}
        uses: nowactions/envsubst@v1
        with:
          input: ./values.yaml.tmpl
          output: ./values.yaml
        env:
          IMAGE_TAG: pr${{ github.event.number }}
          PR_NUMBER: ${{ github.event.number }}
          MB_PREMIUM_EMBEDDING_TOKEN: ${{ secrets.PR_ENV_MB_PREMIUM_EMBEDDING_TOKEN }}
          SHA: ${{ github.event.pull_request.head.sha || github.sha }}
          QUAY_USERNAME: ${{ secrets.QUAY_USERNAME }}
          QUAY_PASSWORD: ${{ secrets.QUAY_PASSWORD }}
          OPEN_AI_API_KEY: ${{ secrets.OPEN_AI_API_KEY }}
          DB_HOST: ${{ secrets.PR_ENV_DB_HOST }}
          DB_USERNAME: ${{ secrets.PR_ENV_DB_USER }}
          DB_PASSWORD: ${{ secrets.PR_ENV_DB_PASSWORD }}
          CONFIG: ${{ secrets.PR_ENV_CONFIG }}
          MB_ANALYTICS_DEV_MODE: ${{ inputs.analytics_dev_mode && 'true' || 'false' }}

      - name: Setup Helm
        if: ${{ inputs.self_hosting }}
        uses: azure/setup-helm@v4
        with:
          version: 'latest'
      - name: Login to Quay.io
        if: ${{ inputs.self_hosting }}
        run: |
          helm registry login quay.io \
            --username ${{ secrets.QUAY_USERNAME }} \
            --password ${{ secrets.QUAY_PASSWORD }}
      - name: Deploy PR Review ENV (self-hosting)
        if: ${{ inputs.self_hosting }}
        run: |
          helm upgrade --install hosting-pr${{ github.event.number }} \
            oci://quay.io/enterprisemetabase/chart-metabase-stack \
            --namespace hosting-pr${{ github.event.number }} \
            --create-namespace \
            --values ./values.yaml \
            --atomic \
            --timeout 10m
  preview_links:
    runs-on: ubuntu-latest
    needs: [deploy_pr]
    steps:
      - uses: marocchino/sticky-pull-request-comment@v2
        with:
          recreate: true
          message: |
            üëã Deploying a preview environment for commit ${{ github.event.pull_request.head.sha || github.sha }}.
            ‚úÖ Preview:
                https://pr${{ github.event.number }}.coredev.metabase.com
            üóíÔ∏è [login instructions](https://www.notion.so/metabase/Ephemeral-PR-Environments-c74a3710c87a460dbf4fc0007a001458)
            üì¶ Deployment type: ${{ inputs.self_hosting && 'PR-Env-self-hosting' || (inputs.analytics_dev_mode && 'PR-Env-analytics-dev' || 'PR-Env') }}
