name: Conventional commit PR Title Reminder

on:
  pull_request:
    branches:
      - master

jobs:
  files-changed:
    name: Check which files changed
    runs-on: ubuntu-22.04
    timeout-minutes: 3
    outputs:
      frontend_embedding_sources: ${{ steps.changes.outputs.frontend_embedding_sources }}
      frontend_embedding_sdk_package_sources: ${{ steps.changes.outputs.frontend_embedding_sdk_package_sources }}
    steps:
      - uses: actions/checkout@v4
      - name: Test which files changed
        uses: dorny/paths-filter@v3.0.0
        id: changes
        with:
          token: ${{ github.token }}
          filters: .github/file-paths.yaml

  pr-title-reminder:
    runs-on: ubuntu-22.04
    timeout-minutes: 5
    permissions:
      pull-requests: write
    needs: [ files-changed ]
    if: ${{ !cancelled() }}
    steps:
      - name: Check if the PR title is already following Conventional Commits style
        uses: actions/github-script@v7
        id: is-conventional-commit
        with:
          result-encoding: string
          script: | # js
            const pullRequestTitle = context.payload.pull_request.title
            const conventionalCommitRegex = /^(?<type>\w+)\((?<scope>[\w\$\.\-\* ]+)\):/
            const match = pullRequestTitle.match(conventionalCommitRegex)
            if (match) {
              const { type, scope } = match.groups
              return ['feat', 'fix', 'perf', 'docs', 'style', 'refactor', 'test', 'build', 'ci'].includes(type) && !!scope
            }

      - name: Checkout repository so `gh` CLI works
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}

      - name: Remind PR authors to use conventional commit in the title
        if: ${{ steps.is-conventional-commit.outputs.result != 'true' }}
        uses: actions/github-script@v7
        env:
          EMBEDDING_SOURCES_CHANGED: ${{ needs.files-changed.outputs.frontend_embedding_sources }}
          EMBEDDING_SDK_PACKAGE_SOURCES_CHANGED: ${{ needs.files-changed.outputs.frontend_embedding_sdk_package_sources }}
        with:
          script: |
            const { updateCommentForEmbedding, updateCommentForEmbeddingSdkPackage } = require(".github/scripts/conventional-commit-pr-title-reminder/utils.js")

            const embeddingSourcesChanged = process.env.EMBEDDING_SOURCES_CHANGED === 'true';
            const embeddingSdkPackageSourcesChanged = process.env.EMBEDDING_SDK_PACKAGE_SOURCES_CHANGED === 'true';

            if (embeddingSourcesChanged) {
              await updateCommentForEmbedding({github, context})
            } else if (embeddingSdkPackageSourcesChanged) {
              await updateCommentForEmbeddingSdkPackage({github, context})
            }
