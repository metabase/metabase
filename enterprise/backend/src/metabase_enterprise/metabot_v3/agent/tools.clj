(ns metabase-enterprise.metabot-v3.agent.tools
  "Tool registry for the agent loop.
  Provides a unified namespace for tool vars and state-aware wrapping."
  (:require
   [metabase-enterprise.metabot-v3.agent.tools.analytics :as tools.analytics]
   [metabase-enterprise.metabot-v3.agent.tools.autogen-dashboard :as tools.autogen-dashboard]
   [metabase-enterprise.metabot-v3.agent.tools.charts :as tools.charts]
   [metabase-enterprise.metabot-v3.agent.tools.clarification :as tools.clarification]
   [metabase-enterprise.metabot-v3.agent.tools.construct :as tools.construct]
   [metabase-enterprise.metabot-v3.agent.tools.document :as tools.document]
   [metabase-enterprise.metabot-v3.agent.tools.metadata :as tools.metadata]
   [metabase-enterprise.metabot-v3.agent.tools.navigation :as tools.navigation]
   [metabase-enterprise.metabot-v3.agent.tools.resources :as tools.resources]
   [metabase-enterprise.metabot-v3.agent.tools.search :as tools.search]
   [metabase-enterprise.metabot-v3.agent.tools.shared :as shared]
   [metabase-enterprise.metabot-v3.agent.tools.snippets :as tools.snippets]
   [metabase-enterprise.metabot-v3.agent.tools.sql :as tools.sql]
   [metabase-enterprise.metabot-v3.agent.tools.subscriptions :as tools.subscriptions]
   [metabase-enterprise.metabot-v3.agent.tools.todo :as tools.todo]
   [metabase-enterprise.metabot-v3.agent.tools.transforms :as tools.transforms]
   [potemkin :as p]))

(set! *warn-on-reflection* true)

(p/import-vars
 [tools.search search-tool
  sql-search-tool
  nlq-search-tool
  transform-search-tool]
 [tools.construct
  construct-notebook-query-tool]
 [tools.document
  document-schema-collect-tool
  document-construct-sql-chart-tool
  document-construct-model-chart-tool]
 [tools.metadata
  list-available-data-sources-tool
  list-available-fields-tool
  get-field-values-tool]
 [tools.transforms
  get-transform-details-tool
  get-transform-python-library-details-tool
  write-transform-sql-tool
  write-transform-python-tool]
 [tools.sql
  create-sql-query-tool
  create-sql-query-code-edit-tool
  edit-sql-query-tool
  edit-sql-query-code-edit-tool
  replace-sql-query-tool
  replace-sql-query-code-edit-tool]
 [tools.charts
  create-chart-tool
  edit-chart-tool]
 [tools.resources
  read-resource-tool]
 [tools.todo
  todo-write-tool
  todo-read-tool]
 [tools.navigation
  navigate-user-tool]
 [tools.snippets
  list-snippets-tool
  get-snippet-details-tool]
 [tools.clarification
  ask-for-sql-clarification-tool]
 [tools.autogen-dashboard
  create-autogenerated-dashboard-tool]
 [tools.subscriptions
  create-dashboard-subscription-tool]
 [tools.analytics
  find-outliers-tool])

(def ^:dynamic ^:private *memory-atom* nil)

(defn wrap-tools-with-state
  "Wrap tools with access to the memory atom.
  Tools will have access to the memory atom
  via the dynamic `*memory-atom*` binding.

  Returns a new tools map where all tools are wrapped.
  Wrapped tools are returned as maps with :doc, :schema, :prompt, and :fn keys
  to satisfy the Claude API schema validation. Tool-specific instructions are
  loaded from `resources/metabot/prompts/tools/` by `extract-tool-instructions`
  in `prompts.clj`, keyed by `:prompt` metadata or `<tool-name>.md` by default."
  [tools memory-atom]
  (reduce-kv
   (fn [acc tool-name tool-var]
     (let [{:keys [doc schema prompt decode]} (meta tool-var)
           wrapped-fn (fn [args]
                        (binding [shared/*memory-atom* memory-atom
                                  *memory-atom*        memory-atom]
                          (tool-var args)))]
       (assoc acc tool-name (cond-> {:doc doc
                                     :schema schema
                                     :prompt prompt
                                     :fn wrapped-fn}
                              decode (assoc :decode decode)))))
   {}
   tools))
