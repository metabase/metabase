name: Driver Tests

on:
  workflow_call:
    inputs:
      skip:
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref && github.ref || github.run_id }}-drivers
  cancel-in-progress: true

jobs:
  # This job determines which driver tests should run based on PR context.
  # All decision logic is consolidated in mage driver-decisions.
  determine-driver-skips:
    runs-on: ubuntu-latest
    outputs:
      # All driver run decisions (from mage driver-decisions)
      h2-should-run: ${{ steps.driver-decisions.outputs.h2-should-run }}
      athena-should-run: ${{ steps.driver-decisions.outputs.athena-should-run }}
      bigquery-should-run: ${{ steps.driver-decisions.outputs.bigquery-should-run }}
      clickhouse-should-run: ${{ steps.driver-decisions.outputs.clickhouse-should-run }}
      databricks-should-run: ${{ steps.driver-decisions.outputs.databricks-should-run }}
      druid-should-run: ${{ steps.driver-decisions.outputs.druid-should-run }}
      druid-jdbc-should-run: ${{ steps.driver-decisions.outputs.druid-jdbc-should-run }}
      mongo-should-run: ${{ steps.driver-decisions.outputs.mongo-should-run }}
      mongo-ssl-should-run: ${{ steps.driver-decisions.outputs.mongo-ssl-should-run }}
      mongo-sharded-cluster-should-run: ${{ steps.driver-decisions.outputs.mongo-sharded-cluster-should-run }}
      mysql-mariadb-should-run: ${{ steps.driver-decisions.outputs.mysql-mariadb-should-run }}
      oracle-should-run: ${{ steps.driver-decisions.outputs.oracle-should-run }}
      postgres-should-run: ${{ steps.driver-decisions.outputs.postgres-should-run }}
      presto-jdbc-should-run: ${{ steps.driver-decisions.outputs.presto-jdbc-should-run }}
      redshift-should-run: ${{ steps.driver-decisions.outputs.redshift-should-run }}
      snowflake-should-run: ${{ steps.driver-decisions.outputs.snowflake-should-run }}
      sparksql-should-run: ${{ steps.driver-decisions.outputs.sparksql-should-run }}
      sqlite-should-run: ${{ steps.driver-decisions.outputs.sqlite-should-run }}
      sqlserver-should-run: ${{ steps.driver-decisions.outputs.sqlserver-should-run }}
      vertica-should-run: ${{ steps.driver-decisions.outputs.vertica-should-run }}
      # Per-driver quarantine conflict flags (set when driver is quarantined but has file changes)
      athena-quarantine-conflict: ${{ steps.driver-decisions.outputs.athena-quarantine-conflict }}
      bigquery-quarantine-conflict: ${{ steps.driver-decisions.outputs.bigquery-quarantine-conflict }}
      clickhouse-quarantine-conflict: ${{ steps.driver-decisions.outputs.clickhouse-quarantine-conflict }}
      databricks-quarantine-conflict: ${{ steps.driver-decisions.outputs.databricks-quarantine-conflict }}
      druid-quarantine-conflict: ${{ steps.driver-decisions.outputs.druid-quarantine-conflict }}
      druid-jdbc-quarantine-conflict: ${{ steps.driver-decisions.outputs.druid-jdbc-quarantine-conflict }}
      mongo-quarantine-conflict: ${{ steps.driver-decisions.outputs.mongo-quarantine-conflict }}
      mongo-ssl-quarantine-conflict: ${{ steps.driver-decisions.outputs.mongo-ssl-quarantine-conflict }}
      mongo-sharded-cluster-quarantine-conflict: ${{ steps.driver-decisions.outputs.mongo-sharded-cluster-quarantine-conflict }}
      mysql-mariadb-quarantine-conflict: ${{ steps.driver-decisions.outputs.mysql-mariadb-quarantine-conflict }}
      oracle-quarantine-conflict: ${{ steps.driver-decisions.outputs.oracle-quarantine-conflict }}
      postgres-quarantine-conflict: ${{ steps.driver-decisions.outputs.postgres-quarantine-conflict }}
      presto-jdbc-quarantine-conflict: ${{ steps.driver-decisions.outputs.presto-jdbc-quarantine-conflict }}
      redshift-quarantine-conflict: ${{ steps.driver-decisions.outputs.redshift-quarantine-conflict }}
      snowflake-quarantine-conflict: ${{ steps.driver-decisions.outputs.snowflake-quarantine-conflict }}
      sparksql-quarantine-conflict: ${{ steps.driver-decisions.outputs.sparksql-quarantine-conflict }}
      sqlite-quarantine-conflict: ${{ steps.driver-decisions.outputs.sqlite-quarantine-conflict }}
      sqlserver-quarantine-conflict: ${{ steps.driver-decisions.outputs.sqlserver-quarantine-conflict }}
      vertica-quarantine-conflict: ${{ steps.driver-decisions.outputs.vertica-quarantine-conflict }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Fetch base branch
        if: github.event_name == 'pull_request' && github.event.pull_request.base.ref != ''
        run: |
          # Fetch the base branch to ensure its history is available for diffing
          git fetch --depth=1 origin ${{ github.event.pull_request.base.ref }}:${{ github.event.pull_request.base.ref }}
      - name: Determine which drivers should run
        id: driver-decisions
        run: |
          # All decision logic is in mage - it analyzes module dependencies,
          # branch context, labels, and file changes to decide what runs.
          MAGE_ARGS=(
            --git-ref="${{ github.event.pull_request.base.ref || github.ref_name }}"
            --is-master-or-release="${{ github.ref_name == 'master' || startsWith(github.ref_name, 'release-') }}"
            --pr-labels="${{ join(github.event.pull_request.labels.*.name, ',') }}"
            --skip="${{ inputs.skip }}"
          )
          # First call: show human-readable output for debugging
          ./bin/mage -driver-decisions "${MAGE_ARGS[@]}"
          # Second call: output only key=value lines for GITHUB_OUTPUT
          ./bin/mage -driver-decisions "${MAGE_ARGS[@]}" --github-output-only >> $GITHUB_OUTPUT
        shell: bash

  be-tests-athena-ee:
    needs: determine-driver-skips
    if: ${{ needs.determine-driver-skips.outputs.athena-should-run == 'true' || needs.determine-driver-skips.outputs.athena-quarantine-conflict == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 40
    env:
      CI: 'true'
      DRIVERS: athena
      MB_ATHENA_TEST_REGION: us-east-1
      MB_ATHENA_TEST_REGION_ROUTING: us-east-2
      MB_ATHENA_TEST_ACCESS_KEY: ${{ secrets.MB_ATHENA_TEST_ACCESS_KEY }}
      MB_ATHENA_TEST_SECRET_KEY: ${{ secrets.MB_ATHENA_TEST_SECRET_KEY }}
      MB_ATHENA_TEST_S3_STAGING_DIR: ${{ secrets.MB_ATHENA_TEST_S3_STAGING_DIR }}
      MB_ATHENA_TEST_S3_STAGING_DIR_ROUTING: ${{ secrets.MB_ATHENA_TEST_S3_STAGING_DIR_ROUTING }}
      # These credentials are used to test the driver when the user does not have the athena:GetTableMetadata permission
      MB_ATHENA_TEST_WITHOUT_GET_TABLE_METADATA_ACCESS_KEY: ${{ secrets.MB_ATHENA_TEST_WITHOUT_GET_TABLE_METADATA_ACCESS_KEY }}
      MB_ATHENA_TEST_WITHOUT_GET_TABLE_METADATA_SECRET_KEY: ${{ secrets.MB_ATHENA_TEST_WITHOUT_GET_TABLE_METADATA_SECRET_KEY }}
    name: Athena
    steps:
    - name: Fail on quarantine conflict
      if: ${{ needs.determine-driver-skips.outputs.athena-quarantine-conflict == 'true' }}
      run: |
        echo "::error::Athena driver is quarantined but you changed files in modules/drivers/athena/"
        echo ""
        echo "Your changes will NOT be tested because the driver is currently quarantined."
        echo "To run Athena tests, add the label: break-quarantine-athena"
        echo ""
        echo "If you merge without testing, you risk breaking the Athena driver!"
        exit 1
    - uses: actions/checkout@v4
    - name: Test Athena driver
      id: test-driver
      uses: ./.github/actions/test-driver
      with:
        junit-name: 'be-tests-athena-ee'
        test-args: >-
          :only-tags [:mb/driver-tests]
          :exclude-tags [:mb/transforms-python-test]
    - name: Upload Test Results
      uses: ./.github/actions/upload-test-results
      if: always()
      with:
        input-path: ./target/junit/
        output-name: ${{ github.job }}
        bucket: ${{ vars.AWS_S3_TEST_RESULTS_BUCKET }}
        aws-access-key-id: ${{ secrets.AWS_TEST_RESULTS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_TEST_RESULTS_SECRET_ACCESS_KEY }}
        aws-region: ${{ vars.AWS_REGION }}
        trunk-api-token: ${{ secrets.TRUNK_API_TOKEN }}
        previous-step-outcome: ${{ steps.test-driver.outputs.test-outcome }}

  be-tests-bigquery-cloud-sdk-ee:
    needs: determine-driver-skips
    if: ${{ needs.determine-driver-skips.outputs.bigquery-should-run == 'true' || needs.determine-driver-skips.outputs.bigquery-quarantine-conflict == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 40
    strategy:
      fail-fast: false
      matrix:
        job:
          - name: Driver Tests
            test-args: >-
              :only-tags [:mb/driver-tests]
              :exclude-tags [:mb/transforms-python-test]
              :fail-fast? true
# DS 2025-09-26 temporarily disabled while we diagnose flakes
#          - name: Transforms Python Tests
#            test-args: >-
#              :only-tags [:mb/transforms-python-test]
#            needs-python-runner: true
    env:
      CI: 'true'
      DRIVERS: bigquery-cloud-sdk
      MB_BIGQUERY_TEST_PROJECT_ID: ${{ secrets.BIGQUERY_TEST_PROJECT_ID }}
      MB_BIGQUERY_TEST_CLIENT_ID: ${{ secrets.MB_BIGQUERY_TEST_CLIENT_ID }}
      MB_BIGQUERY_TEST_CLIENT_SECRET: ${{ secrets.MB_BIGQUERY_TEST_CLIENT_SECRET }}
      MB_BIGQUERY_TEST_ACCESS_TOKEN: ${{ secrets.MB_BIGQUERY_TEST_ACCESS_TOKEN }}
      MB_BIGQUERY_TEST_REFRESH_TOKEN: ${{ secrets.MB_BIGQUERY_TEST_REFRESH_TOKEN }}
      MB_BIGQUERY_CLOUD_SDK_TEST_SERVICE_ACCOUNT_JSON: ${{ secrets.MB_BIGQUERY_CLOUD_SDK_TEST_SERVICE_ACCOUNT_JSON }}
      MB_BIGQUERY_CLOUD_SDK_TEST_SERVICE_ACCOUNT_JSON_ROUTING: ${{ secrets.MB_BIGQUERY_CLOUD_SDK_TEST_SERVICE_ACCOUNT_JSON_ROUTING }}
    name: BigQuery ${{ matrix.job.name }}
    steps:
    - name: Fail on quarantine conflict
      if: ${{ needs.determine-driver-skips.outputs.bigquery-quarantine-conflict == 'true' }}
      run: |
        echo "::error::BigQuery driver is quarantined but you changed files in modules/drivers/bigquery-cloud-sdk/"
        echo ""
        echo "Your changes will NOT be tested because the driver is currently quarantined."
        echo "To run BigQuery tests, add the label: break-quarantine-bigquery"
        echo ""
        echo "If you merge without testing, you risk breaking the BigQuery driver!"
        exit 1
    - uses: actions/checkout@v4
    - name: Setup python-runner
      if: ${{ matrix.job.needs-python-runner == true }}
      uses: ./.github/actions/setup-python-runner
      with:
        metabase-automation-token: ${{ secrets.METABASE_AUTOMATION_USER_TOKEN }}
    - name: Test BigQuery Cloud SDK driver
      id: test-driver
      uses: ./.github/actions/test-driver
      with:
        junit-name: 'be-tests-bigquery-cloud-sdk-ee'
        test-args: ${{ matrix.job.test-args }}
        logs-artifact-suffix: ${{ matrix.job.name }}
    - name: Upload Test Results
      uses: ./.github/actions/upload-test-results
      if: always()
      with:
        input-path: ./target/junit/
        output-name: ${{ github.job }}
        bucket: ${{ vars.AWS_S3_TEST_RESULTS_BUCKET }}
        aws-access-key-id: ${{ secrets.AWS_TEST_RESULTS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_TEST_RESULTS_SECRET_ACCESS_KEY }}
        aws-region: ${{ vars.AWS_REGION }}
        trunk-api-token: ${{ secrets.TRUNK_API_TOKEN }}
        previous-step-outcome: ${{ steps.test-driver.outputs.test-outcome }}
    - name: Cleanup python-runner
      if: ${{ always() && matrix.job.needs-python-runner == true }}
      uses: ./.github/actions/cleanup-python-runner
      with:
        upload-logs: ${{ steps.test-driver.outcome == 'failure' }}
        logs-artifact-suffix: ${{ matrix.job.name }} ${{ matrix.version.name }}

  be-tests-clickhouse-ee:
    needs: determine-driver-skips
    if: ${{ needs.determine-driver-skips.outputs.clickhouse-should-run == 'true' || needs.determine-driver-skips.outputs.clickhouse-quarantine-conflict == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 40
    strategy:
      fail-fast: false
      matrix:
        job:
          - name: Driver Tests
            test-args: >-
              :only-tags [:mb/driver-tests]
              :exclude-tags [:mb/transforms-python-test]
          - name: Transforms Python Tests
            test-args: >-
              :only-tags [:mb/transforms-python-test]
            needs-python-runner: true
    env:
      CI: 'true'
      DRIVERS: clickhouse
      MB_CLICKHOUSE_TEST_HOST: localhost
      MB_CLICKHOUSE_TEST_PORT: 8123
      MB_CLICKHOUSE_TEST_OLD_PORT: 8124
      MB_CLICKHOUSE_TEST_NGINX_PORT: 8127
    name: Clickhouse ${{ matrix.job.name }}
    steps:
    - name: Fail on quarantine conflict
      if: ${{ needs.determine-driver-skips.outputs.clickhouse-quarantine-conflict == 'true' }}
      run: |
        echo "::error::ClickHouse driver is quarantined but you changed files in modules/drivers/clickhouse/"
        echo ""
        echo "Your changes will NOT be tested because the driver is currently quarantined."
        echo "To run ClickHouse tests, add the label: break-quarantine-clickhouse"
        echo ""
        echo "If you merge without testing, you risk breaking the ClickHouse driver!"
        exit 1
    - uses: actions/checkout@v4
    - name: Setup python-runner
      if: ${{ matrix.job.needs-python-runner == true }}
      uses: ./.github/actions/setup-python-runner
      with:
        metabase-automation-token: ${{ secrets.METABASE_AUTOMATION_USER_TOKEN }}
    - name: Add ClickHouse TLS instance to /etc/hosts
      run: |
        sudo echo "127.0.0.1 server.clickhouseconnect.test" | sudo tee -a /etc/hosts
    - name: Start ClickHouse in Docker
      uses: hoverkraft-tech/compose-action@v2.0.0
      with:
        compose-file: "modules/drivers/clickhouse/docker-compose.yml"
        down-flags: "--volumes"
        services: |
          clickhouse
          clickhouse_tls
          clickhouse_older_version
          clickhouse_cluster_node1
          clickhouse_cluster_node2
          nginx
    - name: Test Clickhouse driver
      id: test-driver
      uses: ./.github/actions/test-driver
      with:
        junit-name: 'be-tests-clickhouse-ee'
        test-args: ${{ matrix.job.test-args }}
        logs-artifact-suffix: ${{ matrix.job.name }}
    - name: Upload Test Results
      uses: ./.github/actions/upload-test-results
      if: always()
      with:
        input-path: ./target/junit/
        output-name: ${{ github.job }}
        bucket: ${{ vars.AWS_S3_TEST_RESULTS_BUCKET }}
        aws-access-key-id: ${{ secrets.AWS_TEST_RESULTS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_TEST_RESULTS_SECRET_ACCESS_KEY }}
        aws-region: ${{ vars.AWS_REGION }}
        trunk-api-token: ${{ secrets.TRUNK_API_TOKEN }}
        previous-step-outcome: ${{ steps.test-driver.outputs.test-outcome }}
    - name: Cleanup python-runner
      if: ${{ always() && matrix.job.needs-python-runner == true }}
      uses: ./.github/actions/cleanup-python-runner
      with:
        upload-logs: ${{ steps.test-driver.outcome == 'failure' }}
        logs-artifact-suffix: ${{ matrix.job.name }} ${{ matrix.version.name }}

  be-tests-druid-ee:
    needs: determine-driver-skips
    if: ${{ needs.determine-driver-skips.outputs.druid-should-run == 'true' || needs.determine-driver-skips.outputs.druid-quarantine-conflict == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 40
    env:
      CI: 'true'
      DRIVERS: druid
    services:
      druid:
        image: metabase/druid:0.20.2
        ports:
          - "8082:8082"
        env:
          CLUSTER_SIZE: nano-quickstart
    name: Druid (Legacy)
    steps:
    - name: Fail on quarantine conflict
      if: ${{ needs.determine-driver-skips.outputs.druid-quarantine-conflict == 'true' }}
      run: |
        echo "::error::Druid driver is quarantined but you changed files in modules/drivers/druid/"
        echo ""
        echo "Your changes will NOT be tested because the driver is currently quarantined."
        echo "To run Druid tests, add the label: break-quarantine-druid"
        echo ""
        echo "If you merge without testing, you risk breaking the Druid driver!"
        exit 1
    - uses: actions/checkout@v4
    - name: Test Druid driver
      id: test-driver
      uses: ./.github/actions/test-driver
      with:
        junit-name: 'be-tests-druid-ee'
        test-args: >-
          :only-tags [:mb/driver-tests]
          :exclude-tags [:mb/transforms-python-test]
    - name: Upload Test Results
      uses: ./.github/actions/upload-test-results
      if: always()
      with:
        input-path: ./target/junit/
        output-name: ${{ github.job }}
        bucket: ${{ vars.AWS_S3_TEST_RESULTS_BUCKET }}
        aws-access-key-id: ${{ secrets.AWS_TEST_RESULTS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_TEST_RESULTS_SECRET_ACCESS_KEY }}
        aws-region: ${{ vars.AWS_REGION }}
        trunk-api-token: ${{ secrets.TRUNK_API_TOKEN }}
        previous-step-outcome: ${{ steps.test-driver.outputs.test-outcome }}

  be-tests-druid-jdbc-ee:
    needs: determine-driver-skips
    if: ${{ needs.determine-driver-skips.outputs.druid-jdbc-should-run == 'true' || needs.determine-driver-skips.outputs.druid-jdbc-quarantine-conflict == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 40
    env:
      CI: 'true'
      DRIVERS: druid-jdbc
    services:
      druid:
        image: metabase/druid:29.0.1-json-no-ingestion
        ports:
          - "8888:8888"
        env:
          CLUSTER_SIZE: nano-quickstart
    name: Druid (JDBC)
    steps:
    - name: Fail on quarantine conflict
      if: ${{ needs.determine-driver-skips.outputs.druid-jdbc-quarantine-conflict == 'true' }}
      run: |
        echo "::error::Druid JDBC driver is quarantined but you changed files in modules/drivers/druid-jdbc/"
        echo ""
        echo "Your changes will NOT be tested because the driver is currently quarantined."
        echo "To run Druid JDBC tests, add the label: break-quarantine-druid-jdbc"
        echo ""
        echo "If you merge without testing, you risk breaking the Druid JDBC driver!"
        exit 1
    - uses: actions/checkout@v4
    - name: Test Druid JDBC driver
      id: test-driver
      uses: ./.github/actions/test-driver
      with:
        junit-name: 'be-tests-druid-jdbc-ee'
        test-args: >-
          :only-tags [:mb/driver-tests]
          :exclude-tags [:mb/transforms-python-test]
    - name: Upload Test Results
      uses: ./.github/actions/upload-test-results
      if: always()
      with:
        input-path: ./target/junit/
        output-name: ${{ github.job }}
        bucket: ${{ vars.AWS_S3_TEST_RESULTS_BUCKET }}
        aws-access-key-id: ${{ secrets.AWS_TEST_RESULTS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_TEST_RESULTS_SECRET_ACCESS_KEY }}
        aws-region: ${{ vars.AWS_REGION }}
        trunk-api-token: ${{ secrets.TRUNK_API_TOKEN }}
        previous-step-outcome: ${{ steps.test-driver.outputs.test-outcome }}

  be-tests-databricks-ee:
    needs: determine-driver-skips
    if: ${{ needs.determine-driver-skips.outputs.databricks-should-run == 'true' || needs.determine-driver-skips.outputs.databricks-quarantine-conflict == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 40
    env:
      CI: 'true'
      DRIVERS: databricks
      MB_DATABRICKS_TEST_HOST: ${{ secrets.MB_DATABRICKS_JDBC_TEST_HOST }}
      MB_DATABRICKS_TEST_HTTP_PATH: ${{ secrets.MB_DATABRICKS_JDBC_TEST_HTTP_PATH }}
      MB_DATABRICKS_TEST_TOKEN: ${{ secrets.MB_DATABRICKS_JDBC_TEST_TOKEN }}
      MB_DATABRICKS_TEST_CATALOG: 'metabase_ci'
      MB_DATABRICKS_TEST_CATALOG_ROUTING: 'metabase_routing_catalog'
      MB_DATABRICKS_TEST_CLIENT_ID: ${{ secrets.MB_DATABRICKS_JDBC_TEST_CLIENT_ID }}
      MB_DATABRICKS_TEST_OAUTH_SECRET: ${{ secrets.MB_DATABRICKS_JDBC_TEST_OAUTH_SECRET }}
    name: Databricks
    steps:
    - name: Fail on quarantine conflict
      if: ${{ needs.determine-driver-skips.outputs.databricks-quarantine-conflict == 'true' }}
      run: |
        echo "::error::Databricks driver is quarantined but you changed files in modules/drivers/databricks/"
        echo ""
        echo "Your changes will NOT be tested because the driver is currently quarantined."
        echo "To run Databricks tests, add the label: break-quarantine-databricks"
        echo ""
        echo "If you merge without testing, you risk breaking the Databricks driver!"
        exit 1
    - uses: actions/checkout@v4
    - name: Test Databricks driver
      id: test-driver
      uses: ./.github/actions/test-driver
      with:
        junit-name: 'be-tests-databricks-ee'
        test-args: >-
          :only-tags [:mb/driver-tests]
          :exclude-tags [:mb/transforms-python-test]
    - name: Upload Test Results
      uses: ./.github/actions/upload-test-results
      if: always()
      with:
        input-path: ./target/junit/
        output-name: ${{ github.job }}
        bucket: ${{ vars.AWS_S3_TEST_RESULTS_BUCKET }}
        aws-access-key-id: ${{ secrets.AWS_TEST_RESULTS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_TEST_RESULTS_SECRET_ACCESS_KEY }}
        aws-region: ${{ vars.AWS_REGION }}
        trunk-api-token: ${{ secrets.TRUNK_API_TOKEN }}
        previous-step-outcome: ${{ steps.test-driver.outputs.test-outcome }}

  be-tests-databricks-multi-catalog-ee:
    needs: determine-driver-skips
    if: ${{ needs.determine-driver-skips.outputs.databricks-should-run == 'true' || needs.determine-driver-skips.outputs.databricks-quarantine-conflict == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 40
    env:
      CI: 'true'
      DRIVERS: databricks
      MB_DATABRICKS_TEST_MULTI_LEVEL_SCHEMA: true
      MB_DATABRICKS_TEST_HOST: ${{ secrets.MB_DATABRICKS_JDBC_TEST_HOST }}
      MB_DATABRICKS_TEST_HTTP_PATH: ${{ secrets.MB_DATABRICKS_JDBC_TEST_HTTP_PATH }}
      MB_DATABRICKS_TEST_TOKEN: ${{ secrets.MB_DATABRICKS_JDBC_TEST_TOKEN }}
      MB_DATABRICKS_TEST_CATALOG: 'metabase_ci'
      MB_DATABRICKS_TEST_CATALOG_ROUTING: 'metabase_routing_catalog'
      MB_DATABRICKS_TEST_CLIENT_ID: ${{ secrets.MB_DATABRICKS_JDBC_TEST_CLIENT_ID }}
      MB_DATABRICKS_TEST_OAUTH_SECRET: ${{ secrets.MB_DATABRICKS_JDBC_TEST_OAUTH_SECRET }}
    name: Databricks (Multi-Catalog)
    steps:
    - name: Fail on quarantine conflict
      if: ${{ needs.determine-driver-skips.outputs.databricks-quarantine-conflict == 'true' }}
      run: |
        echo "::error::Databricks driver is quarantined but you changed files in modules/drivers/databricks/"
        echo ""
        echo "Your changes will NOT be tested because the driver is currently quarantined."
        echo "To run Databricks tests, add the label: break-quarantine-databricks"
        echo ""
        echo "If you merge without testing, you risk breaking the Databricks driver!"
        exit 1
    - uses: actions/checkout@v4
    - name: Test Databricks driver with multi-catalog
      id: test-driver
      uses: ./.github/actions/test-driver
      with:
        junit-name: 'be-tests-databricks-multi-catalog-ee'
        test-args: >-
          :only-tags [:mb/driver-tests]
          :exclude-tags [:mb/transforms-python-test]
    - name: Upload Test Results
      uses: ./.github/actions/upload-test-results
      if: always()
      with:
        input-path: ./target/junit/
        output-name: ${{ github.job }}
        bucket: ${{ vars.AWS_S3_TEST_RESULTS_BUCKET }}
        aws-access-key-id: ${{ secrets.AWS_TEST_RESULTS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_TEST_RESULTS_SECRET_ACCESS_KEY }}
        aws-region: ${{ vars.AWS_REGION }}
        trunk-api-token: ${{ secrets.TRUNK_API_TOKEN }}
        previous-step-outcome: ${{ steps.test-driver.outputs.test-outcome }}

  be-tests-h2:
    needs: determine-driver-skips
    if: ${{ needs.determine-driver-skips.outputs.h2-should-run == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 40
    env:
      CI: 'true'
    name: H2
    steps:
    - uses: actions/checkout@v4
    - name: Test H2 driver
      id: test-driver
      uses: ./.github/actions/test-driver
      with:
        junit-name: 'be-tests-h2'
        test-args: >-
          :only-tags [:mb/driver-tests]
          :exclude-tags [:mb/transforms-python-test]
    - name: Upload Test Results
      uses: ./.github/actions/upload-test-results
      if: always()
      with:
        input-path: ./target/junit/
        output-name: ${{ github.job }}
        bucket: ${{ vars.AWS_S3_TEST_RESULTS_BUCKET }}
        aws-access-key-id: ${{ secrets.AWS_TEST_RESULTS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_TEST_RESULTS_SECRET_ACCESS_KEY }}
        aws-region: ${{ vars.AWS_REGION }}
        trunk-api-token: ${{ secrets.TRUNK_API_TOKEN }}
        previous-step-outcome: ${{ steps.test-driver.outputs.test-outcome }}

  be-tests-h2-oss:
    needs: determine-driver-skips
    if: ${{ needs.determine-driver-skips.outputs.h2-should-run == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 40
    env:
      CI: 'true'
    name: H2 (OSS)
    steps:
    - uses: actions/checkout@v4
    - name: Test H2 driver (OSS)
      id: test-driver
      uses: ./.github/actions/test-driver
      with:
        junit-name: 'be-tests-h2-oss'
        edition: 'oss'
        test-args: >-
          :only-tags [:mb/driver-tests]
          :exclude-tags [:mb/transforms-python-test]
    - name: Upload Test Results
      uses: ./.github/actions/upload-test-results
      if: always()
      with:
        input-path: ./target/junit/
        output-name: ${{ github.job }}
        bucket: ${{ vars.AWS_S3_TEST_RESULTS_BUCKET }}
        aws-access-key-id: ${{ secrets.AWS_TEST_RESULTS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_TEST_RESULTS_SECRET_ACCESS_KEY }}
        aws-region: ${{ vars.AWS_REGION }}
        trunk-api-token: ${{ secrets.TRUNK_API_TOKEN }}
        previous-step-outcome: ${{ steps.test-driver.outputs.test-outcome }}

  be-tests-mysql-mariadb:
    needs: determine-driver-skips
    if: ${{ needs.determine-driver-skips.outputs.mysql-mariadb-should-run == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 40
    strategy:
      fail-fast: false
      matrix:
        version:
          - name: MariaDB 10.2
            junit-name: be-tests-mariadb-10-2-ee
            image: circleci/mariadb:10.2.23
            env:
              enable-ssl-tests: 'false'
              enable-aws-iam-tests: 'false'
          - name: MariaDB Latest
            junit-name: be-tests-mariadb-latest-ee
            image: circleci/mariadb:latest
            env:
              enable-ssl-tests: 'false'
              enable-aws-iam-tests: 'false'
          - name: MySQL 8.0
            junit-name: be-tests-mysql-8-0-ee
            image: mysql:8.0
            env:
              enable-ssl-tests: 'false'
              enable-aws-iam-tests: 'false'
          - name: MySQL Latest
            junit-name: be-tests-mysql-latest-ee
            image: mysql:latest
            env:
              enable-ssl-tests: 'true'
              enable-aws-iam-tests: 'true'
        job:
          - name: Driver Tests
            test-args: >-
              :only-tags [:mb/driver-tests]
            exclude-tag: ':mb/transforms-python-test'
          - name: Transforms Python Tests
            test-args: >-
              :only-tags [:mb/transforms-python-test]
            needs-python-runner: true

    services:
      mysql:
        image: ${{ matrix.version.image }}
        ports:
          - "3306:3306"
        env:
          MYSQL_ALLOW_EMPTY_PASSWORD: true
          MYSQL_DATABASE: circle_test
    env:
      # Only run old migrations tests on pushes to master or release branches. All other branches should skip tests
      # with the tag `mb/old-migrations-test`. `__ADDITIONAL_EXCLUDED_TAG__` is not used anywhere outside of splicing
      # it in to the command below.
      __ADDITIONAL_EXCLUDED_TAG__: >-
        ${{
          (
            github.event_name == 'push' &&
            (
              github.ref_name == 'master' ||
              startsWith(github.ref_name, 'release-')
            ) &&
            ''
          ) ||
          ':mb/old-migrations-test'
        }}
      # actual serious env vars below
      CI: 'true'
      DRIVERS: mysql
      MB_DB_TYPE: mysql
      MB_DB_HOST: localhost
      MB_DB_PORT: 3306
      MB_DB_DBNAME: circle_test
      MB_DB_USER: root
      MB_MYSQL_TEST_USER: root
      #
      # SSL config: only for mysql latest tests.
      #
      # set up env vars for something named "MYSQL_SSL" to run MySQL SSL tests verifying connectivity with PEM cert
      # they are deliberately given a different name to prevent them from affecting the regular test run against
      # the configured MySQL instance, but there is one particular test (mysql-connect-with-ssl-and-pem-cert-test)
      # that overrides the MB_MYSQL_TEST_* values with them
      # the MYSQL_RDS_SSL_INSTANCE vars are defined as secrets and can be altered
      MB_MYSQL_SSL_TEST_SSL: ${{ matrix.version.env.enable-ssl-tests }}
      MB_MYSQL_SSL_TEST_HOST: ${{ secrets.MYSQL_RDS_SSL_INSTANCE_HOST }}
      MB_MYSQL_SSL_TEST_ADDITIONAL_OPTIONS: 'verifyServerCertificate=true'
      # the contents of the ./resources/certificates/rds-combined-ca-bundle.pem file
      MB_MYSQL_SSL_TEST_SSL_CERT: ${{ secrets.MB_MYSQL_SSL_TEST_SSL_CERT }}
      MB_MYSQL_SSL_TEST_USER: metabase
      MB_MYSQL_SSL_TEST_PASSWORD: ${{ secrets.MYSQL_RDS_SSL_INSTANCE_PASSWORD }}
      MB_MYSQL_AWS_IAM_TEST: ${{ matrix.version.env.enable-aws-iam-tests }}
      MB_MYSQL_AWS_IAM_TEST_HOST: ${{ secrets.MYSQL_AURORA_IAM_INSTANCE_HOST }}
      MB_MYSQL_AWS_IAM_TEST_PORT: 3306
      MB_MYSQL_AWS_IAM_TEST_USER: my_iam_user
      MB_MYSQL_AWS_IAM_TEST_DBNAME: test_db
      MB_MYSQL_AWS_IAM_TEST_SSL_CERT: trust
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_AURORA_IAM_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_AURORA_IAM_SECRET_ACCESS_KEY }}
    # for historic reasons (I don't want to mess around with required jobs) the job name should be something like
    # "be-tests-mariadb-10-2-ee (0)"
    name: "${{ matrix.version.name }} ${{ matrix.job.name }}"
    steps:
      - uses: actions/checkout@v4
      - name: Setup python-runner
        if: ${{ matrix.job.needs-python-runner == true }}
        uses: ./.github/actions/setup-python-runner
        with:
          metabase-automation-token: ${{ secrets.METABASE_AUTOMATION_USER_TOKEN }}
      - name: Test ${{ matrix.version.name }}
        id: test-driver
        uses: ./.github/actions/test-driver
        with:
          junit-name: ${{ matrix.version.junit-name }}
          logs-artifact-suffix: ${{ matrix.version.name }}
          test-args: >-
            ${{ matrix.job.test-args }}
            :exclude-tags '[ ${{ matrix.job.exclude-tag }} ${{ env.__ADDITIONAL_EXCLUDED_TAG__ }}]'
      - name: Upload Test Results
        uses: ./.github/actions/upload-test-results
        if: always()
        with:
          input-path: ./target/junit/
          output-name: ${{ github.job }}
          bucket: ${{ vars.AWS_S3_TEST_RESULTS_BUCKET }}
          aws-access-key-id: ${{ secrets.AWS_TEST_RESULTS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_TEST_RESULTS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION }}
          trunk-api-token: ${{ secrets.TRUNK_API_TOKEN }}
          previous-step-outcome: ${{ steps.test-driver.outputs.test-outcome }}
      - name: Cleanup python-runner
        if: always()
        uses: ./.github/actions/cleanup-python-runner
        with:
          upload-logs: ${{ steps.test-driver.outcome == 'failure' }}
          logs-artifact-suffix: ${{ matrix.job.name }} ${{ matrix.version.name }}

  be-tests-mongo:
    needs: determine-driver-skips
    if: ${{ needs.determine-driver-skips.outputs.mongo-should-run == 'true' || needs.determine-driver-skips.outputs.mongo-quarantine-conflict == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 40
    strategy:
      fail-fast: false
      matrix:
        version:
          - name: MongoDB 6.0
            junit-name: be-tests-mongo-6-0-ee
            image: metabase/qa-databases:mongo-sample-6
          - name: MongoDB Latest
            junit-name: be-tests-mongo-latest-ee
            image: mongo:latest
        job:
          - name: Driver Tests
            test-args: >-
              :exclude-tags '[:mongo-sharded-cluster-tests :mb/transforms-python-test]'
              :only-tags [:mb/driver-tests]
          - name: Transforms Python Tests
            test-args: >-
              :only-tags [:mb/transforms-python-test]
            needs-python-runner: true
    env:
      CI: 'true'
      DRIVERS: mongo
      MB_MONGO_TEST_USER: metabase
      MB_MONGO_TEST_PASSWORD: metasample123
    services:
      mongodb:
        image: ${{ matrix.version.image }}
        ports:
          - "27017:27017"
        env:
          MONGO_INITDB_ROOT_USERNAME: metabase
          MONGO_INITDB_ROOT_PASSWORD: metasample123
    name: ${{ matrix.version.name }} ${{ matrix.job.name }}
    steps:
    - name: Fail on quarantine conflict
      if: ${{ needs.determine-driver-skips.outputs.mongo-quarantine-conflict == 'true' }}
      run: |
        echo "::error::MongoDB driver is quarantined but you changed files in modules/drivers/mongo/"
        echo ""
        echo "Your changes will NOT be tested because the driver is currently quarantined."
        echo "To run MongoDB tests, add the label: break-quarantine-mongo"
        echo ""
        echo "If you merge without testing, you risk breaking the MongoDB driver!"
        exit 1
    - uses: actions/checkout@v4
    - name: Setup python-runner
      if: ${{ matrix.job.needs-python-runner == true }}
      uses: ./.github/actions/setup-python-runner
      with:
        metabase-automation-token: ${{ secrets.METABASE_AUTOMATION_USER_TOKEN }}
    - name: Test ${{ matrix.version.name }}
      id: test-driver
      uses: ./.github/actions/test-driver
      with:
        junit-name: ${{ matrix.version.junit-name }}
        test-args: ${{ matrix.job.test-args }}
        logs-artifact-suffix: ${{ matrix.job.name }}
    - name: Upload Test Results
      uses: ./.github/actions/upload-test-results
      if: always()
      with:
        input-path: ./target/junit/
        output-name: ${{ github.job }}
        bucket: ${{ vars.AWS_S3_TEST_RESULTS_BUCKET }}
        aws-access-key-id: ${{ secrets.AWS_TEST_RESULTS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_TEST_RESULTS_SECRET_ACCESS_KEY }}
        aws-region: ${{ vars.AWS_REGION }}
        trunk-api-token: ${{ secrets.TRUNK_API_TOKEN }}
        previous-step-outcome: ${{ steps.test-driver.outputs.test-outcome }}
    - name: Cleanup python-runner
      if: ${{ always() && matrix.job.needs-python-runner == true }}
      uses: ./.github/actions/cleanup-python-runner
      with:
        upload-logs: ${{ steps.test-driver.outcome == 'failure' }}
        logs-artifact-suffix: ${{ matrix.job.name }} ${{ matrix.version.name }}

  be-tests-mongo-ssl:
    needs: determine-driver-skips
    if: ${{ needs.determine-driver-skips.outputs.mongo-ssl-should-run == 'true' || needs.determine-driver-skips.outputs.mongo-ssl-quarantine-conflict == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 40
    strategy:
      fail-fast: false
      matrix:
        version:
          - name: MongoDB 6.0
            junit-name: be-tests-mongo-6-0-ssl-ee
            image: metabase/qa-databases:mongo-sample-6
    env:
      CI: 'true'
      DRIVERS: mongo
      MB_MONGO_TEST_USER: metabase
      MB_MONGO_TEST_PASSWORD: metasample123
      MB_TEST_MONGO_REQUIRES_SSL: true
    name: "${{ matrix.version.name }} (SSL)"
    steps:
      - name: Fail on quarantine conflict
        if: ${{ needs.determine-driver-skips.outputs.mongo-ssl-quarantine-conflict == 'true' }}
        run: |
          echo "::error::MongoDB SSL driver is quarantined but you changed files in modules/drivers/mongo/"
          echo ""
          echo "Your changes will NOT be tested because the driver is currently quarantined."
          echo "To run MongoDB SSL tests, add the label: break-quarantine-mongo-ssl"
          echo ""
          echo "If you merge without testing, you risk breaking the MongoDB SSL driver!"
          exit 1
      - uses: actions/checkout@v4
      - name: Spin up Mongo docker container
        run: >-
          docker run -d
          -p 27017:27017
          --name metamongo
          ${{ matrix.version.image }}
          mongod
          --dbpath /data/db2/
          --tlsMode requireTLS
          --tlsCertificateKeyFile /etc/mongo/metamongo.pem
          --tlsCAFile /etc/mongo/metaca.crt
      - uses: ./.github/actions/await-port
        with:
          port: 27017
        timeout-minutes: 5
      - name: Make SSL certificates for Mongo available
        run: |
          curl https://raw.githubusercontent.com/metabase/metabase-qa/master/dbs/mongo/certificates/metabase.crt \
          -o ./test_resources/ssl/mongo/metabase.crt

          curl https://raw.githubusercontent.com/metabase/metabase-qa/master/dbs/mongo/certificates/metabase.key \
          -o ./test_resources/ssl/mongo/metabase.key

          curl https://raw.githubusercontent.com/metabase/metabase-qa/master/dbs/mongo/certificates/metaca.crt \
          -o ./test_resources/ssl/mongo/metaca.crt
      - name: Test ${{ matrix.version.name }}
        id: test-driver
        uses: ./.github/actions/test-driver
        with:
          junit-name: ${{ matrix.version.junit-name }}
          test-args: >-
            :exclude-tags '[:mongo-sharded-cluster-tests :mb/transforms-python-test]'
            :only-tags [:mb/driver-tests]
      - name: Upload Test Results
        uses: ./.github/actions/upload-test-results
        if: always()
        with:
          input-path: ./target/junit/
          output-name: ${{ github.job }}
          bucket: ${{ vars.AWS_S3_TEST_RESULTS_BUCKET }}
          aws-access-key-id: ${{ secrets.AWS_TEST_RESULTS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_TEST_RESULTS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION }}
          trunk-api-token: ${{ secrets.TRUNK_API_TOKEN }}
          previous-step-outcome: ${{ steps.test-driver.outputs.test-outcome }}

  be-tests-mongo-sharded-cluster-ee:
    needs: determine-driver-skips
    if: ${{ needs.determine-driver-skips.outputs.mongo-sharded-cluster-should-run == 'true' || needs.determine-driver-skips.outputs.mongo-sharded-cluster-quarantine-conflict == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 40
    env:
      CI: 'true'
      DRIVERS: mongo
    services:
      mongodb:
        image: metabase/mongo-sharded-cluster:6
        ports:
          - "27017:17017"
    name: MongoDB Sharded Cluster
    steps:
    - name: Fail on quarantine conflict
      if: ${{ needs.determine-driver-skips.outputs.mongo-sharded-cluster-quarantine-conflict == 'true' }}
      run: |
        echo "::error::MongoDB Sharded Cluster driver is quarantined but you changed files in modules/drivers/mongo/"
        echo ""
        echo "Your changes will NOT be tested because the driver is currently quarantined."
        echo "To run MongoDB Sharded Cluster tests, add the label: break-quarantine-mongo-sharded-cluster"
        echo ""
        echo "If you merge without testing, you risk breaking the MongoDB Sharded Cluster driver!"
        exit 1
    - uses: actions/checkout@v4
    - name: Test MongoDB driver (Sharded cluster)
      id: test-driver
      uses: ./.github/actions/test-driver
      with:
        junit-name: 'be-tests-mongo-sharded-cluster-ee'
        test-args: >-
          :only metabase.driver.mongo.sharded-cluster-test
    - name: Upload Test Results
      uses: ./.github/actions/upload-test-results
      if: always()
      with:
        input-path: ./target/junit/
        output-name: ${{ github.job }}
        bucket: ${{ vars.AWS_S3_TEST_RESULTS_BUCKET }}
        aws-access-key-id: ${{ secrets.AWS_TEST_RESULTS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_TEST_RESULTS_SECRET_ACCESS_KEY }}
        aws-region: ${{ vars.AWS_REGION }}
        trunk-api-token: ${{ secrets.TRUNK_API_TOKEN }}
        previous-step-outcome: ${{ steps.test-driver.outputs.test-outcome }}

  be-tests-oracle:
    needs: determine-driver-skips
    if: ${{ needs.determine-driver-skips.outputs.oracle-should-run == 'true' || needs.determine-driver-skips.outputs.oracle-quarantine-conflict == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 40
    strategy:
      fail-fast: false
      matrix:
        version:
          - name: Oracle 18.4
            junit-name: be-tests-oracle-18-4-ee
            image: gvenzl/oracle-xe:18.4.0-slim
            port: 1521
            env:
              user: system
              password: 'password'
              enable-ssl-tests: false
          - name: Oracle 21.3
            junit-name: be-tests-oracle-21-3-ee
            image: metabase/qa-databases:oracle-xe-21.3
            port: 2484
            env:
              user: ''
              password: ''
              enable-ssl-tests: true
    env:
      CI: 'true'
      DRIVERS: oracle
      MB_ORACLE_TEST_HOST: localhost
      MB_ORACLE_TEST_USER: '${{ matrix.version.env.user }}'
      MB_ORACLE_TEST_SERVICE_NAME: XEPDB1
      # Only the non-SSL 18.4 tests specify password as an env var; the SSL 21.3 tests get it from the keystore I guess
      MB_ORACLE_TEST_PASSWORD: '${{ matrix.version.env.password }}'
      # These are ignored for the 18.4 tests which do not test SSL
      MB_ORACLE_TEST_SSL: ${{ matrix.version.env.enable-ssl-tests }}
      MB_ORACLE_SSL_TEST_SSL: ${{ matrix.version.env.enable-ssl-tests }}
      MB_ORACLE_TEST_SSL_USE_TRUSTSTORE: ${{ matrix.version.env.enable-ssl-tests }}
      MB_ORACLE_TEST_SSL_TRUSTSTORE_PATH: './test_resources/ssl/oracle/truststore.p12'
      MB_ORACLE_TEST_SSL_TRUSTSTORE_OPTIONS: local
      MB_ORACLE_TEST_SSL_TRUSTSTORE_PASSWORD_VALUE: 'PassworD_#1234'
      MB_ORACLE_TEST_SSL_USE_KEYSTORE: ${{ matrix.version.env.enable-ssl-tests }}
      MB_ORACLE_TEST_SSL_KEYSTORE_PATH: './test_resources/ssl/oracle/keystore.p12'
      MB_ORACLE_TEST_SSL_KEYSTORE_OPTIONS: local
      MB_ORACLE_TEST_SSL_KEYSTORE_PASSWORD_VALUE: 'PassworD_#1234'
    services:
      oracle:
        image: ${{ matrix.version.image }}
        env:
          ORACLE_PASSWORD: password
        ports:
          - "1521:${{ matrix.version.port }}"
    name: ${{ matrix.version.name }}
    steps:
    - name: Fail on quarantine conflict
      if: ${{ needs.determine-driver-skips.outputs.oracle-quarantine-conflict == 'true' }}
      run: |
        echo "::error::Oracle driver is quarantined but you changed files in modules/drivers/oracle/"
        echo ""
        echo "Your changes will NOT be tested because the driver is currently quarantined."
        echo "To run Oracle tests, add the label: break-quarantine-oracle"
        echo ""
        echo "If you merge without testing, you risk breaking the Oracle driver!"
        exit 1
    - uses: actions/checkout@v4
    - name: Test ${{ matrix.version.name }}
      id: test-driver
      uses: ./.github/actions/test-driver
      with:
        junit-name: ${{ matrix.version.junit-name }}
        logs-artifact-suffix: ${{ matrix.version.name }}
        test-args: >-
          :only-tags [:mb/driver-tests]
          :exclude-tags [:mb/transforms-python-test]
    - name: Upload Test Results
      uses: ./.github/actions/upload-test-results
      if: always()
      with:
        input-path: ./target/junit/
        output-name: ${{ github.job }}
        bucket: ${{ vars.AWS_S3_TEST_RESULTS_BUCKET }}
        aws-access-key-id: ${{ secrets.AWS_TEST_RESULTS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_TEST_RESULTS_SECRET_ACCESS_KEY }}
        aws-region: ${{ vars.AWS_REGION }}
        trunk-api-token: ${{ secrets.TRUNK_API_TOKEN }}
        previous-step-outcome: ${{ steps.test-driver.outputs.test-outcome }}

  be-tests-postgres:
    needs: determine-driver-skips
    if: ${{ needs.determine-driver-skips.outputs.postgres-should-run == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 40
    strategy:
      fail-fast: false
      matrix:
        version:
          - name: Postgres 12.x
            junit-name: postgres-ee
            docker-image: postgres:12-alpine
            env:
              enable-ssl-tests: 'false'
              enable-aws-iam-tests: 'false'
          - name: Postgres Latest
            junit-name: postgres-latest-ee
            docker-image: postgres:latest
            env:
              enable-ssl-tests: 'true'
              enable-aws-iam-tests: 'true'
        job:
          - name: Driver Tests
            test-args: >-
              :only-tags [:mb/driver-tests]
            exclude-tag: ':mb/transforms-python-test'
          - name: Transforms Python Tests
            test-args: >-
              :only-tags [:mb/transforms-python-test]
            needs-python-runner: true
    name: "${{ matrix.version.name }} ${{ matrix.job.name }}"
    env:
      # Only run old migrations tests on pushes to master or release branches. All other branches should skip tests
      # with the tag `mb/old-migrations-test`. `__ADDITIONAL_EXCLUDED_TAG__` is not used anywhere outside of splicing
      # it in to the command below.
      __ADDITIONAL_EXCLUDED_TAG__: >-
        ${{
          (
            github.event_name == 'push' &&
            (
              github.ref_name == 'master' ||
              startsWith(github.ref_name, 'release-')
            ) &&
            ''
          ) ||
          ':mb/old-migrations-test'
        }}
      # actual serious env vars below
      CI: 'true'
      DRIVERS: postgres
      MB_DB_TYPE: postgres
      MB_DB_PORT: 5432
      MB_DB_HOST: localhost
      MB_DB_DBNAME: mb_test
      MB_DB_USER: mb_test
      MB_POSTGRESQL_TEST_USER: mb_test
      # SSL tests are only enabled for the postgres-latest job.
      MB_POSTGRES_SSL_TEST_SSL: ${{ matrix.version.env.enable-ssl-tests }}
      MB_POSTGRES_SSL_TEST_SSL_MODE: verify-full
      MB_POSTGRES_SSL_TEST_SSL_ROOT_CERT_PATH: 'test-resources/certificates/us-east-2-bundle.pem'
      MB_POSTGRES_AWS_IAM_TEST: ${{ matrix.version.env.enable-aws-iam-tests }}
      MB_POSTGRES_AWS_IAM_TEST_HOST: ${{ secrets.POSTGRES_AURORA_IAM_INSTANCE_HOST }}
      MB_POSTGRES_AWS_IAM_TEST_PORT: 5432
      MB_POSTGRES_AWS_IAM_TEST_USER: my_iam_user
      MB_POSTGRES_AWS_IAM_TEST_DBNAME: test_db
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_AURORA_IAM_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_AURORA_IAM_SECRET_ACCESS_KEY }}
    services:
      postgres:
        image: ${{ matrix.version.docker-image }}
        ports:
          - "5432:5432"
        env:
          POSTGRES_USER: mb_test
          POSTGRES_DB: mb_test
          POSTGRES_HOST_AUTH_METHOD: trust
    steps:
      - uses: actions/checkout@v4
      - name: Setup python-runner
        if: ${{ matrix.job.needs-python-runner == true }}
        uses: ./.github/actions/setup-python-runner
        with:
          metabase-automation-token: ${{ secrets.METABASE_AUTOMATION_USER_TOKEN }}
      - name: Test ${{ matrix.version.name }} (${{ matrix.job.name }})
        id: test-driver
        uses: ./.github/actions/test-driver
        with:
          junit-name: 'be-tests-${{ matrix.version.junit-name }}'
          logs-artifact-suffix: ${{ matrix.version.name }}-${{ matrix.job.name }}
          test-args: >-
            ${{ matrix.job.test-args }}
            :exclude-tags '[ ${{ matrix.job.exclude-tag }} ${{ env.__ADDITIONAL_EXCLUDED_TAG__ }}]'
      - name: Upload Test Results
        uses: ./.github/actions/upload-test-results
        if: always()
        with:
          input-path: ./target/junit/
          output-name: ${{ github.job }}
          bucket: ${{ vars.AWS_S3_TEST_RESULTS_BUCKET }}
          aws-access-key-id: ${{ secrets.AWS_TEST_RESULTS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_TEST_RESULTS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION }}
          trunk-api-token: ${{ secrets.TRUNK_API_TOKEN }}
          previous-step-outcome: ${{ steps.test-driver.outputs.test-outcome }}
      - name: Cleanup python-runner
        if: always()
        uses: ./.github/actions/cleanup-python-runner
        with:
          upload-logs: ${{ steps.test-driver.outcome == 'failure' }}
          logs-artifact-suffix: ${{ matrix.job.name }} ${{ matrix.version.name }}

  be-tests-presto-jdbc-ee:
    needs: determine-driver-skips
    if: ${{ needs.determine-driver-skips.outputs.presto-jdbc-should-run == 'true' || needs.determine-driver-skips.outputs.presto-jdbc-quarantine-conflict == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 40
    env:
      CI: 'true'
      DRIVERS: presto-jdbc
      MB_PRESTO_JDBC_TEST_CATALOG: test_data
      MB_PRESTO_JDBC_TEST_HOST: localhost
      MB_PRESTO_JDBC_TEST_PORT: 8443
      MB_PRESTO_JDBC_TEST_SSL: true
      MB_PRESTO_JDBC_TEST_USER: metabase
      MB_PRESTO_JDBC_TEST_PASSWORD: metabase
      MB_ENABLE_PRESTO_JDBC_DRIVER: true
      MB_PRESTO_JDBC_TEST_ADDITIONAL_OPTIONS: 'SSLTrustStorePath=/tmp/cacerts-with-presto-ssl.jks&SSLTrustStorePassword=changeit'
    name: Presto
    services:
      presto:
        image: metabase/presto-mb-ci:latest # version 0.254
        ports:
          - "8443:8443"
        env:
          JAVA_TOOL_OPTIONS: "-Xmx2g"
    steps:
    - name: Fail on quarantine conflict
      if: ${{ needs.determine-driver-skips.outputs.presto-jdbc-quarantine-conflict == 'true' }}
      run: |
        echo "::error::Presto JDBC driver is quarantined but you changed files in modules/drivers/presto-jdbc/"
        echo ""
        echo "Your changes will NOT be tested because the driver is currently quarantined."
        echo "To run Presto JDBC tests, add the label: break-quarantine-presto-jdbc"
        echo ""
        echo "If you merge without testing, you risk breaking the Presto JDBC driver!"
        exit 1
    - uses: actions/checkout@v4
    - uses: ./.github/actions/await-port
      with:
         port: ${{ env.MB_PRESTO_JDBC_TEST_PORT }}
      timeout-minutes: 5
    - name: Create temp cacerts file based on bundled JDK one
      run: cp $JAVA_HOME/lib/security/cacerts /tmp/cacerts-with-presto-ssl.jks
    - name: Capture Presto server self signed CA
      run: |
          while [[ ! -s /tmp/presto-ssl-ca.pem ]]; do
            echo "Waiting to capture SSL CA" \
              && openssl s_client -connect localhost:8443 2>/dev/null </dev/null | sed -ne '/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p' > /tmp/presto-ssl-ca.pem \
              && sleep 1;
          done
    - name: Convert Presto CA from PEM to DER
      run: openssl x509 -outform der -in /tmp/presto-ssl-ca.pem -out /tmp/presto-ssl-ca.der
    - name: Add write permission on cacerts file
      run: chmod u+w /tmp/cacerts-with-presto-ssl.jks
    - name: Import Presto CA into temp cacerts file
      run: >-
        keytool -noprompt -import
        -alias presto
        -keystore /tmp/cacerts-with-presto-ssl.jks
        -storepass changeit
        -file /tmp/presto-ssl-ca.der
        -trustcacerts
    - name: Test Presto JDBC driver
      id: test-driver
      uses: ./.github/actions/test-driver
      with:
        junit-name: 'be-tests-presto-jdbc-ee'
        test-args: >-
          :only-tags [:mb/driver-tests]
          :exclude-tags [:mb/transforms-python-test]
    - name: Upload Test Results
      uses: ./.github/actions/upload-test-results
      if: always()
      with:
        input-path: ./target/junit/
        output-name: ${{ github.job }}
        bucket: ${{ vars.AWS_S3_TEST_RESULTS_BUCKET }}
        aws-access-key-id: ${{ secrets.AWS_TEST_RESULTS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_TEST_RESULTS_SECRET_ACCESS_KEY }}
        aws-region: ${{ vars.AWS_REGION }}
        trunk-api-token: ${{ secrets.TRUNK_API_TOKEN }}
        previous-step-outcome: ${{ steps.test-driver.outputs.test-outcome }}

  be-tests-redshift-ee:
    needs: determine-driver-skips
    if: ${{ needs.determine-driver-skips.outputs.redshift-should-run == 'true' || needs.determine-driver-skips.outputs.redshift-quarantine-conflict == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 40
    strategy:
      fail-fast: false
      matrix:
        job:
          - name: Redshift Upload Tests
            skip: ${{ github.event_name == 'pull_request' }} # FIXME: temporary to alleviate pressure on redshift instances
            test-args: >-
              :only-tags [:mb/upload-tests]
              :fail-fast? true
          - name: Redshift (Excluding Upload Tests) Part 1
            skip: false
            test-args: >-
              :only-tags [:mb/driver-tests]
              :exclude-tags '[:mb/upload-tests :mb/transforms-python-test]'
              :fail-fast? true
              :partition/total 2
              :partition/index 0
          - name: Redshift (Excluding Upload Tests) Part 2
            skip: false
            test-args: >-
              :only-tags [:mb/driver-tests]
              :exclude-tags '[:mb/upload-tests :mb/transforms-python-test]'
              :fail-fast? true
              :partition/total 2
              :partition/index 1
          - name: Redshift Transforms Python Tests
            skip: false
            test-args: >-
              :only-tags [:mb/transforms-python-test]
              :fail-fast? true
            needs-python-runner: true

    env:
      CI: 'true'
      DRIVERS: redshift
      MB_REDSHIFT_TEST_USER: metabase_ci
      MB_REDSHIFT_TEST_DB: testdb
      MB_REDSHIFT_TEST_DB_ROUTING: dev
      MB_REDSHIFT_TEST_HOST: ${{ secrets.MB_REDSHIFT_TEST_HOST }}
      MB_REDSHIFT_TEST_PASSWORD: ${{ secrets.MB_REDSHIFT_TEST_PASSWORD }}
    name: ${{ matrix.job.name }}
    steps:
    - name: Fail on quarantine conflict
      if: ${{ needs.determine-driver-skips.outputs.redshift-quarantine-conflict == 'true' }}
      run: |
        echo "::error::Redshift driver is quarantined but you changed files in modules/drivers/redshift/"
        echo ""
        echo "Your changes will NOT be tested because the driver is currently quarantined."
        echo "To run Redshift tests, add the label: break-quarantine-redshift"
        echo ""
        echo "If you merge without testing, you risk breaking the Redshift driver!"
        exit 1
    - uses: actions/checkout@v4
    - name: Setup python-runner
      if: ${{ matrix.job.needs-python-runner == true }}
      uses: ./.github/actions/setup-python-runner
      with:
        metabase-automation-token: ${{ secrets.METABASE_AUTOMATION_USER_TOKEN }}
    - name: Test ${{ matrix.job.name }}
      id: test-driver
      if: ${{ !matrix.job.skip }}
      uses: ./.github/actions/test-driver
      with:
        junit-name: 'be-tests-redshift-ee'
        test-args: >-
          ${{ matrix.job.test-args }}
        logs-artifact-suffix: ${{ matrix.job.name }}
    - name: Upload Test Results
      uses: ./.github/actions/upload-test-results
      if: ${{ !matrix.job.skip && !cancelled() }}
      with:
        input-path: ./target/junit/
        output-name: ${{ github.job }}
        bucket: ${{ vars.AWS_S3_TEST_RESULTS_BUCKET }}
        aws-access-key-id: ${{ secrets.AWS_TEST_RESULTS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_TEST_RESULTS_SECRET_ACCESS_KEY }}
        aws-region: ${{ vars.AWS_REGION }}
        trunk-api-token: ${{ secrets.TRUNK_API_TOKEN }}
        previous-step-outcome: ${{ steps.test-driver.outputs.test-outcome }}
    - name: Cleanup python-runner
      if: ${{ always() && matrix.job.needs-python-runner == true }}
      uses: ./.github/actions/cleanup-python-runner
      with:
        upload-logs: ${{ steps.test-driver.outcome == 'failure' }}
        logs-artifact-suffix: ${{ matrix.job.name }} ${{ matrix.version.name }}

  be-tests-snowflake-ee:
    needs: determine-driver-skips
    if: ${{ needs.determine-driver-skips.outputs.snowflake-should-run == 'true' || needs.determine-driver-skips.outputs.snowflake-quarantine-conflict == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 40
    strategy:
      fail-fast: false
      matrix:
        job:
          - name: Driver Tests
            test-args: >-
              :only-tags [:mb/driver-tests]
              :exclude-tags [:mb/transforms-python-test]
              :fail-fast? true

# DS 2025-09-26 temporarily disabled while we diagnose flakes
#          - name: Transforms Python Tests
#            test-args: >-
#              :only-tags [:mb/transforms-python-test]
#            needs-python-runner: true
    env:
      CI: 'true'
      DRIVERS: snowflake
      MB_SNOWFLAKE_TEST_USER: METABASE CI
      MB_SNOWFLAKE_TEST_ACCOUNT: ${{ secrets.MB_SNOWFLAKE_TEST_ACCOUNT }}
      MB_SNOWFLAKE_TEST_PASSWORD: ${{ secrets.MB_SNOWFLAKE_TEST_PASSWORD }}
      MB_SNOWFLAKE_TEST_PRIVATE_KEY: ${{ secrets.MB_SNOWFLAKE_TEST_PRIVATE_KEY }}
      MB_SNOWFLAKE_TEST_WAREHOUSE: ${{ secrets.MB_SNOWFLAKE_TEST_WAREHOUSE }}
      MB_SNOWFLAKE_TEST_PK_USER: METABASE PK
      MB_SNOWFLAKE_TEST_PK_PRIVATE_KEY: ${{ secrets.MB_SNOWFLAKE_TEST_PK_PRIVATE_KEY }}
      MB_SNOWFLAKE_TEST_PK_PRIVATE_KEY_2: ${{ secrets.MB_SNOWFLAKE_TEST_PK_PRIVATE_KEY_2 }}
      MB_SNOWFLAKE_TEST_PK_PUBLIC_KEY: ${{ secrets.MB_SNOWFLAKE_TEST_PK_PUBLIC_KEY }}
      MB_SNOWFLAKE_TEST_PK_PUBLIC_KEY_2: ${{ secrets.MB_SNOWFLAKE_TEST_PK_PUBLIC_KEY_2 }}

      # RSA Role testing:
      MB_SNOWFLAKE_TEST_RSA_ROLE_TEST_DEFAULT_USER: RSA_ROLE_TEST_DEFAULT_USER
      MB_SNOWFLAKE_TEST_RSA_ROLE_TEST_CUSTOM_USER: RSA_ROLE_TEST_CUSTOM_USER
      MB_SNOWFLAKE_TEST_RSA_ROLE_TEST_ROLE: RSA_ROLE_TEST_ROLE
      MB_SNOWFLAKE_TEST_RSA_ROLE_TEST_DB: RSA_ROLE_TEST_DB
    name: Snowflake ${{ matrix.job.name }}
    steps:
    - name: Fail on quarantine conflict
      if: ${{ needs.determine-driver-skips.outputs.snowflake-quarantine-conflict == 'true' }}
      run: |
        echo "::error::Snowflake driver is quarantined but you changed files in modules/drivers/snowflake/"
        echo ""
        echo "Your changes will NOT be tested because the driver is currently quarantined."
        echo "To run Snowflake tests, add the label: break-quarantine-snowflake"
        echo ""
        echo "If you merge without testing, you risk breaking the Snowflake driver!"
        exit 1
    - uses: actions/checkout@v4
    - name: Setup python-runner
      if: ${{ matrix.job.needs-python-runner == true }}
      uses: ./.github/actions/setup-python-runner
      with:
        metabase-automation-token: ${{ secrets.METABASE_AUTOMATION_USER_TOKEN }}
    - name: Test Snowflake driver
      id: test-driver
      uses: ./.github/actions/test-driver
      with:
        junit-name: 'be-tests-snowflake-ee'
        test-args: ${{ matrix.job.test-args }}
        logs-artifact-suffix: ${{ matrix.job.name }}
    - name: Upload Test Results
      uses: ./.github/actions/upload-test-results
      if: always()
      with:
        input-path: ./target/junit/
        output-name: ${{ github.job }}
        bucket: ${{ vars.AWS_S3_TEST_RESULTS_BUCKET }}
        aws-access-key-id: ${{ secrets.AWS_TEST_RESULTS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_TEST_RESULTS_SECRET_ACCESS_KEY }}
        aws-region: ${{ vars.AWS_REGION }}
        trunk-api-token: ${{ secrets.TRUNK_API_TOKEN }}
        previous-step-outcome: ${{ steps.test-driver.outputs.test-outcome }}
    - name: Cleanup python-runner
      if: ${{ always() && matrix.job.needs-python-runner == true }}
      uses: ./.github/actions/cleanup-python-runner
      with:
        upload-logs: ${{ steps.test-driver.outcome == 'failure' }}
        logs-artifact-suffix: ${{ matrix.job.name }} ${{ matrix.version.name }}

  be-tests-sparksql-ee:
    needs: determine-driver-skips
    if: ${{ needs.determine-driver-skips.outputs.sparksql-should-run == 'true' || needs.determine-driver-skips.outputs.sparksql-quarantine-conflict == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 40
    env:
      CI: 'true'
      DRIVERS: sparksql
    services:
      sparksql:
        image: metabase/spark:3.2.1
        ports:
          - "10000:10000"
    name: Spark SQL
    steps:
    - name: Fail on quarantine conflict
      if: ${{ needs.determine-driver-skips.outputs.sparksql-quarantine-conflict == 'true' }}
      run: |
        echo "::error::SparkSQL driver is quarantined but you changed files in modules/drivers/sparksql/"
        echo ""
        echo "Your changes will NOT be tested because the driver is currently quarantined."
        echo "To run SparkSQL tests, add the label: break-quarantine-sparksql"
        echo ""
        echo "If you merge without testing, you risk breaking the SparkSQL driver!"
        exit 1
    - uses: actions/checkout@v4
    - name: Test Spark driver
      id: test-driver
      uses: ./.github/actions/test-driver
      with:
        junit-name: 'be-tests-sparksql-ee'
        test-args: >-
          :only-tags [:mb/driver-tests]
          :exclude-tags [:mb/transforms-python-test]
    - name: Upload Test Results
      uses: ./.github/actions/upload-test-results
      if: always()
      with:
        input-path: ./target/junit/
        output-name: ${{ github.job }}
        bucket: ${{ vars.AWS_S3_TEST_RESULTS_BUCKET }}
        aws-access-key-id: ${{ secrets.AWS_TEST_RESULTS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_TEST_RESULTS_SECRET_ACCESS_KEY }}
        aws-region: ${{ vars.AWS_REGION }}
        trunk-api-token: ${{ secrets.TRUNK_API_TOKEN }}
        previous-step-outcome: ${{ steps.test-driver.outputs.test-outcome }}

  be-tests-sqlite-ee:
    needs: determine-driver-skips
    if: ${{ needs.determine-driver-skips.outputs.sqlite-should-run == 'true' || needs.determine-driver-skips.outputs.sqlite-quarantine-conflict == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 40
    env:
      CI: 'true'
      DRIVERS: sqlite
    name: SQLite
    steps:
    - name: Fail on quarantine conflict
      if: ${{ needs.determine-driver-skips.outputs.sqlite-quarantine-conflict == 'true' }}
      run: |
        echo "::error::SQLite driver is quarantined but you changed files in modules/drivers/sqlite/"
        echo ""
        echo "Your changes will NOT be tested because the driver is currently quarantined."
        echo "To run SQLite tests, add the label: break-quarantine-sqlite"
        echo ""
        echo "If you merge without testing, you risk breaking the SQLite driver!"
        exit 1
    - uses: actions/checkout@v4
    - name: Test SQLite driver
      id: test-driver
      uses: ./.github/actions/test-driver
      with:
        junit-name: 'be-tests-sqlite-ee'
        test-args: >-
          :only-tags [:mb/driver-tests]
          :exclude-tags [:mb/transforms-python-test]
    - name: Upload Test Results
      uses: ./.github/actions/upload-test-results
      if: always()
      with:
        input-path: ./target/junit/
        output-name: ${{ github.job }}
        bucket: ${{ vars.AWS_S3_TEST_RESULTS_BUCKET }}
        aws-access-key-id: ${{ secrets.AWS_TEST_RESULTS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_TEST_RESULTS_SECRET_ACCESS_KEY }}
        aws-region: ${{ vars.AWS_REGION }}
        trunk-api-token: ${{ secrets.TRUNK_API_TOKEN }}
        previous-step-outcome: ${{ steps.test-driver.outputs.test-outcome }}

  be-tests-sqlserver:
    needs: determine-driver-skips
    if: ${{ needs.determine-driver-skips.outputs.sqlserver-should-run == 'true' || needs.determine-driver-skips.outputs.sqlserver-quarantine-conflict == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        version:
          # - name: SQL Server 2017
          #   junit-name: be-tests-sqlserver-2017-ee
          #   image: mcr.microsoft.com/mssql/server:2017-latest
          - name: SQL Server 2022
            junit-name: be-tests-sqlserver-2022-ee
            image: mcr.microsoft.com/mssql/server:2022-latest
        job:
          - name: Driver Tests
            test-args: >-
              :only-tags [:mb/driver-tests]
              :exclude-tags [:mb/transforms-python-test]
          - name: Transforms Python Tests
            test-args: >-
              :only-tags [:mb/transforms-python-test]
            needs-python-runner: true
    env:
      CI: 'true'
      DRIVERS: sqlserver
      MB_SQLSERVER_TEST_HOST: localhost
      MB_SQLSERVER_TEST_PASSWORD: 'P@ssw0rd'
      MB_SQLSERVER_TEST_USER: SA
    services:
      sqlserver:
        image: ${{ matrix.version.image }}
        ports:
          - "1433:1433"
        env:
          ACCEPT_EULA: Y
          SA_PASSWORD: 'P@ssw0rd'
          MSSQL_MEMORY_LIMIT_MB: 1024
    name: ${{ matrix.version.name }} ${{ matrix.job.name }}
    steps:
    - name: Fail on quarantine conflict
      if: ${{ needs.determine-driver-skips.outputs.sqlserver-quarantine-conflict == 'true' }}
      run: |
        echo "::error::SQL Server driver is quarantined but you changed files in modules/drivers/sqlserver/"
        echo ""
        echo "Your changes will NOT be tested because the driver is currently quarantined."
        echo "To run SQL Server tests, add the label: break-quarantine-sqlserver"
        echo ""
        echo "If you merge without testing, you risk breaking the SQL Server driver!"
        exit 1
    - uses: actions/checkout@v4
    - name: Setup python-runner
      if: ${{ matrix.job.needs-python-runner == true }}
      uses: ./.github/actions/setup-python-runner
      with:
        metabase-automation-token: ${{ secrets.METABASE_AUTOMATION_USER_TOKEN }}
    - name: Test ${{ matrix.version.name }}
      id: test-driver
      uses: ./.github/actions/test-driver
      with:
        junit-name: ${{ matrix.version.junit-name }}
        test-args: ${{ matrix.job.test-args }}
        logs-artifact-suffix: ${{ matrix.version.name }}
    - name: Upload Test Results
      uses: ./.github/actions/upload-test-results
      if: always()
      with:
        input-path: ./target/junit/
        output-name: ${{ github.job }}
        bucket: ${{ vars.AWS_S3_TEST_RESULTS_BUCKET }}
        aws-access-key-id: ${{ secrets.AWS_TEST_RESULTS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_TEST_RESULTS_SECRET_ACCESS_KEY }}
        aws-region: ${{ vars.AWS_REGION }}
        trunk-api-token: ${{ secrets.TRUNK_API_TOKEN }}
        previous-step-outcome: ${{ steps.test-driver.outputs.test-outcome }}
    - name: Cleanup python-runner
      if: ${{ always() && matrix.job.needs-python-runner == true }}
      uses: ./.github/actions/cleanup-python-runner
      with:
        upload-logs: ${{ steps.test-driver.outcome == 'failure' }}
        logs-artifact-suffix: ${{ matrix.job.name }} ${{ matrix.version.name }}

  # TODO(dpsutton, 2025-08-20): Re-enable starburst when we figure out why it randomly dies in CI
  # be-tests-starburst-ee:
  #   needs: determine-driver-skips
  #   if: ${{ !inputs.skip && !(needs.determine-driver-skips.outputs.skip == 'true') }}
  #   runs-on: ubuntu-latest
  #   timeout-minutes: 40
  #   env:
  #     CI: 'true'
  #     DRIVERS: starburst
  #   services:
  #     starburst:
  #       image: trinodb/trino:latest
  #       env:
  #         CATALOG_MANAGEMENT: dynamic
  #       ports:
  #         - "8080:8080"
  #   name: Starburst
  #   steps:
  #   - uses: actions/checkout@v4
  #   - name: Make plugins directory
  #     run: mkdir plugins
  #   - name: Test Starburst driver
  #     uses: ./.github/actions/test-driver
  #     with:
  #       junit-name: 'be-tests-starburst-ee'
  #       test-args: >-
  #         :only-tags [:mb/driver-tests]
  #   - name: Upload Test Results
  #     uses: ./.github/actions/upload-test-results
  #     if: always()
  #     with:
  #       input-path: ./target/junit/
  #       output-name: ${{ github.job }}
  #       bucket: ${{ vars.AWS_S3_TEST_RESULTS_BUCKET }}
  #       aws-access-key-id: ${{ secrets.AWS_TEST_RESULTS_ACCESS_KEY_ID }}
  #       aws-secret-access-key: ${{ secrets.AWS_TEST_RESULTS_SECRET_ACCESS_KEY }}
  #       aws-region: ${{ vars.AWS_REGION }}
  #       trunk-api-token: ${{ secrets.TRUNK_API_TOKEN }}

  login-to-ecr:
    needs: determine-driver-skips
    if: ${{ needs.determine-driver-skips.outputs.vertica-should-run == 'true' || needs.determine-driver-skips.outputs.vertica-quarantine-conflict == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      id-token: write
      contents: read
    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.CI_IAM_ROLE }}
        role-session-name: GitHub_to_AWS_via_FederatedOIDC
        aws-region: us-east-1
    - name: Get ECR password
      id: login-ecr
      run: |
        PASSWORD=$(aws ecr get-login-password --region us-east-1)

        REGISTRY="$(aws sts get-caller-identity --query Account --output text).dkr.ecr.us-east-1.amazonaws.com"

        echo "docker_username=AWS" >> $GITHUB_OUTPUT
        echo "docker_password=$PASSWORD" >> $GITHUB_OUTPUT
        echo "registry=$REGISTRY" >> $GITHUB_OUTPUT
    outputs:
      registry: ${{ steps.login-ecr.outputs.registry }}
      docker_username: ${{ steps.login-ecr.outputs.docker_username }}
      docker_password: ${{ steps.login-ecr.outputs.docker_password }}

  be-tests-vertica-ee:
    needs: [determine-driver-skips, login-to-ecr]
    if: ${{ needs.determine-driver-skips.outputs.vertica-should-run == 'true' || needs.determine-driver-skips.outputs.vertica-quarantine-conflict == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 40
    env:
      CI: 'true'
      DRIVERS: vertica
    services:
      vertica:
        image: ${{ needs.login-to-ecr.outputs.registry }}/vertica-ce:25.3.0-0
        ports:
          - "5433:5433"
        credentials:
          username: ${{ needs.login-to-ecr.outputs.docker_username }}
          password: ${{ needs.login-to-ecr.outputs.docker_password }}
    name: Vertica
    steps:
    - name: Fail on quarantine conflict
      if: ${{ needs.determine-driver-skips.outputs.vertica-quarantine-conflict == 'true' }}
      run: |
        echo "::error::Vertica driver is quarantined but you changed files in modules/drivers/vertica/"
        echo ""
        echo "Your changes will NOT be tested because the driver is currently quarantined."
        echo "To run Vertica tests, add the label: break-quarantine-vertica"
        echo ""
        echo "If you merge without testing, you risk breaking the Vertica driver!"
        exit 1
    - uses: actions/checkout@v4
    - name: Make plugins directory
      run: mkdir plugins
    - name: Test Vertica driver
      id: test-driver
      uses: ./.github/actions/test-driver
      with:
        junit-name: 'be-tests-vertica-ee'
        test-args: >-
          :only-tags [:mb/driver-tests]
          :exclude-tags [:mb/transforms-python-test]
    - name: Upload Test Results
      uses: ./.github/actions/upload-test-results
      if: always()
      with:
        input-path: ./target/junit/
        output-name: ${{ github.job }}
        bucket: ${{ vars.AWS_S3_TEST_RESULTS_BUCKET }}
        aws-access-key-id: ${{ secrets.AWS_TEST_RESULTS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_TEST_RESULTS_SECRET_ACCESS_KEY }}
        aws-region: ${{ vars.AWS_REGION }}
        trunk-api-token: ${{ secrets.TRUNK_API_TOKEN }}
        previous-step-outcome: ${{ steps.test-driver.outputs.test-outcome }}

  drivers-tests-result:
    needs:
      # if you add a driver job, you must add it to this list for it to be a required check
      - be-tests-h2
      - be-tests-athena-ee
      - be-tests-bigquery-cloud-sdk-ee
      - be-tests-druid-ee
      - be-tests-databricks-ee
      - be-tests-druid-jdbc-ee
      - be-tests-mysql-mariadb
      - be-tests-mongo
      - be-tests-mongo-ssl
      - be-tests-mongo-sharded-cluster-ee
      - be-tests-oracle
      - be-tests-postgres
      - be-tests-presto-jdbc-ee
      - be-tests-redshift-ee
      - be-tests-snowflake-ee
      - be-tests-sparksql-ee
      - be-tests-sqlite-ee
      - be-tests-sqlserver
      # - be-tests-starburst-ee
      # TODO(rileythomp, 2025-08-20): Re-enable vertica tests once the docker image is updated
      # - be-tests-vertica-ee
      - be-tests-clickhouse-ee
    runs-on: ubuntu-latest
    timeout-minutes: 5
    name: drivers-tests-result
    if: always() && !cancelled()
    steps:
      - name: Check job status
        uses: actions/github-script@v7
        env:
          needs: ${{ toJson(needs) }}
        with:
          script: | # js
            const needs = JSON.parse(process.env.needs);

            const jobs = Object.entries(needs).map(
              ([jobName, jobValues]) => ({
                name: jobName,
                result: jobValues.result
              }));

            // are all jobs skipped or successful?
            if (jobs.every(job => (job.result === 'skipped' || job.result === 'success' || job.name == 'be-tests-starburst-ee'))) {
                console.log("");
                console.log("        _------.        ");
                console.log("       /  ,     \_      ");
                console.log("     /   /  /{}\ |o\_   ");
                console.log("    /    \  `--' /-' \  ");
                console.log("   |      \      \    | ");
                console.log("  |              |`-, | ");
                console.log("  /              /__/)/ ");
                console.log(" |              |       ");
                console.log("");
                console.log("All driver tests have passed (or have been skipped). Cam is very proud of you.");
              process.exit(0);
            }

            // otherwise, something failed
            console.log("");
            console.log("       .::::::::::.                          .::::::::::.       ");
            console.log("     .::::''''''::::.                      .::::''''''::::.     ");
            console.log("   .:::'          `::::....          ....::::'          `:::.   ");
            console.log("  .::'             `:::::::|        |:::::::'             `::.  ");
            console.log(" .::|               |::::::|_ ___ __|::::::|               |::. ");
            console.log(" `--'               |::::::|_()__()_|::::::|               `--' ");
            console.log("  :::               |::-o::|        |::o-::|               :::  ");
            console.log("  `::.             .|::::::|        |::::::|.             .::'  ");
            console.log("   `:::.          .::\-----'        `-----/::.          .:::'   ");
            console.log("     `::::......::::'                      `::::......::::'     ");
            console.log("       `::::::::::'                          `::::::::::'       ");
            console.log("");
            console.log("Driver tests have failed. You have been sentenced to MetaJail.");

            jobs.forEach((job) => {
              if (job.result !== 'success') {
                console.log(`${job.name} - ${job.result}`);
              }
            });

            process.exit(1);
