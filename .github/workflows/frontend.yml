name: Frontend

on:
  workflow_call:
    inputs:
      skip:
        type: boolean
        default: false
      skip-lint:
        type: boolean
        default: false
  workflow_dispatch:
    inputs:
      skip:
        description: "Skip main frontend jobs (type-check, unit tests, timezone tests)"
        type: boolean
        default: false
      skip-lint:
        description: "Skip linting jobs (prettier, eslint, css variables check)"
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref && github.ref || github.run_id }}-frontend
  cancel-in-progress: true

jobs:
  fe-lint:
    if: ${{ !inputs.skip-lint }}
    runs-on: ubuntu-22.04
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      - name: Prepare front-end environment
        uses: ./.github/actions/prepare-frontend
      - name: Prepare back-end environment
        uses: ./.github/actions/prepare-backend

      - name: Get Eslint cache key
        uses: ./.github/actions/get-cache-keys
        id: get-cache-keys
      - name: Restore ESLint cache
        uses: actions/cache/restore@v4
        with:
          path: ${{ github.workspace}}/.eslintcache
          key: ${{ steps.get-cache-keys.outputs.eslint-cache-key }}

      - name: Compile CLJS
        run: bun run build-pure:cljs
      - name: Find CSS variables that are used but never defined
        run: bun run find-never-defined-css-variables
      - name: Run Prettier formatting linter
        run: bun run lint-prettier-pure
      - name: Run ESLint linter
        run: bun run lint-eslint-pure
      - name: Run CSS linter
        run: bun run lint-css

  fe-type-check:
    if: ${{ !inputs.skip }}
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - name: Prepare front-end environment
        uses: ./.github/actions/prepare-frontend
      - name: Prepare back-end environment
        uses: ./.github/actions/prepare-backend
      - run: bun run build-pure:cljs
        name: Compile CLJS
      - run: bun run type-check-pure
        name: Check types

  fe-tests-unit-core:
    if: ${{ !inputs.skip }}
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2] # 2 shards for parallel execution
    env:
      SHARDS: 2 # should match matrix above
      JEST_JUNIT_OUTPUT_DIR: ./target/junit
      JEST_JUNIT_OUTPUT_NAME: test-report-frontend-unit.xml
    steps:
      - uses: actions/checkout@v4
      - name: Prepare front-end environment
        uses: ./.github/actions/prepare-frontend
      - name: Prepare back-end environment
        uses: ./.github/actions/prepare-backend
      - name: Run frontend unit tests
        id: fe-tests-core
        run: |
          bun run test-unit --silent --selectProjects core --shard=${{ matrix.shard }}/${{ env.SHARDS }}
        # Trunk Quarantine controls the final state of the run in the CI!
        # Even if this step fails we let it pass, and then `trunk-io/analytics-uploader` determines
        # whether to fail or to pass the whole job, based on the quarantine list.
        continue-on-error: true
      - name: Upload Test Results
        uses: ./.github/actions/upload-test-results
        if: always() && github.event_name != 'workflow_dispatch'
        with:
          input-path: ./target/junit
          output-name: frontend-unit
          bucket: ${{ vars.AWS_S3_TEST_RESULTS_BUCKET }}
          aws-access-key-id: ${{ secrets.AWS_TEST_RESULTS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_TEST_RESULTS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION }}
          trunk-api-token: ${{ secrets.TRUNK_API_TOKEN }}
          previous-step-outcome: ${{ steps.fe-tests-core.outcome }}

  fe-tests-unit-sdk:
    if: ${{ !inputs.skip }}
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    env:
      JEST_JUNIT_OUTPUT_DIR: ./target/junit
      JEST_JUNIT_OUTPUT_NAME: test-report-frontend-unit.xml
    steps:
      - uses: actions/checkout@v4
      - name: Prepare front-end environment
        uses: ./.github/actions/prepare-frontend
      - name: Prepare back-end environment
        uses: ./.github/actions/prepare-backend
      - name: Run frontend SDK unit tests
        id: fe-tests-sdk
        run: |
          bun run test-unit --silent --selectProjects sdk
        # Trunk Quarantine controls the final state of the run in the CI!
        # Even if this step fails we let it pass, and then `trunk-io/analytics-uploader` determines
        # whether to fail or to pass the whole job, based on the quarantine list.
        continue-on-error: true
      - name: Upload Test Results
        uses: ./.github/actions/upload-test-results
        if: always() && github.event_name != 'workflow_dispatch'
        with:
          input-path: ./target/junit
          output-name: frontend-unit
          bucket: ${{ vars.AWS_S3_TEST_RESULTS_BUCKET }}
          aws-access-key-id: ${{ secrets.AWS_TEST_RESULTS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_TEST_RESULTS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION }}
          trunk-api-token: ${{ secrets.TRUNK_API_TOKEN }}
          previous-step-outcome: ${{ steps.fe-tests-sdk.outcome }}

  fe-tests-unit-lint-rules:
    if: ${{ !inputs.skip }}
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    env:
      JEST_JUNIT_OUTPUT_DIR: ./target/junit
      JEST_JUNIT_OUTPUT_NAME: test-report-frontend-unit.xml
    steps:
      - uses: actions/checkout@v4
      - name: Prepare front-end environment
        uses: ./.github/actions/prepare-frontend
      - name: Run frontend (lint-rules) unit tests
        id: fe-tests-lint-rules
        run: |
          bun run jest --silent --selectProjects lint-rules
        # Trunk Quarantine controls the final state of the run in the CI!
        # Even if this step fails we let it pass, and then `trunk-io/analytics-uploader` determines
        # whether to fail or to pass the whole job, based on the quarantine list.
        continue-on-error: true
      - name: Upload Test Results
        uses: ./.github/actions/upload-test-results
        if: always() && github.event_name != 'workflow_dispatch'
        with:
          input-path: ./target/junit
          output-name: frontend-unit
          bucket: ${{ vars.AWS_S3_TEST_RESULTS_BUCKET }}
          aws-access-key-id: ${{ secrets.AWS_TEST_RESULTS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_TEST_RESULTS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION }}
          trunk-api-token: ${{ secrets.TRUNK_API_TOKEN }}
          previous-step-outcome: ${{ steps.fe-tests-lint-rules.outcome }}

  fe-tests-timezones:
    if: ${{ !inputs.skip }}
    runs-on: ubuntu-22.04
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      - name: Prepare front-end environment
        uses: ./.github/actions/prepare-frontend
      - name: Prepare back-end environment
        uses: ./.github/actions/prepare-backend
      - name: Run frontend timezones tests
        run: bun run test-timezones

  fe-tests-result:
    needs:
      - fe-lint
      - fe-type-check
      - fe-tests-unit-core
      - fe-tests-unit-sdk
      - fe-tests-unit-lint-rules
      - fe-tests-timezones
    if: always() && !cancelled()
    runs-on: ubuntu-latest
    timeout-minutes: 5
    env:
      needs: ${{ toJson(needs) }}
    steps:
      - name: Check frontend job status
        uses: actions/github-script@v7
        env:
          needs: ${{ toJson(needs) }}
        with:
          script: | # js
            const needs = JSON.parse(process.env.needs);
            const jobs = Object.entries(needs).map(
              ([jobName, jobValues]) => ({
                name: jobName,
                result: jobValues.result
              }));

            // are all jobs skipped or successful?
            if (jobs.every(job => (job.result === 'skipped' || job.result === 'success'))) {
              console.log('All jobs are skipped or successful');
              process.exit(0);
            }

            // otherwise, something failed
            console.log('Some frontend jobs failed');
            jobs.forEach((job) => {
              if (job.result !== 'success') {
                console.log(`${job.name} - ${job.result}`);
              }
            });
            process.exit(1);
