import { useMemo } from "react";
import { jt, t } from "ttag";

import { useGetSlackManifestQuery } from "metabase/api";
import {
  ButtonLink,
  ExternalLink,
} from "metabase/common/components/ExternalLink";
import { Markdown } from "metabase/common/components/Markdown";
import { useDocsUrl, useSetting } from "metabase/common/hooks";
import { Box, Badge, Flex, Icon, Stack, Text, Divider } from "metabase/ui";

import { SlackSetupForm } from "./SlackSetupForm";
import S from "./slack.module.css";

export const SlackSetup = () => {
  const slackAppToken = useSetting("slack-app-token");
  const hasCompletedSetup = !!slackAppToken;
  const isValid = useSetting("slack-token-valid?") ?? false;
  const { url: docsUrl } = useDocsUrl("configuring-metabase/slack");

  const { data: manifest } = useGetSlackManifestQuery();

  const link = useMemo(() => {
    if (!manifest) {
      return "/apps";
    }
    const encodedManifest = encodeURIComponent(JSON.stringify(manifest));
    return `/apps?new_app=1&manifest_json=${encodedManifest}`;
  }, [manifest]);

  return (
    <Stack gap="md">
      {hasCompletedSetup ? (
        <Box>
          <Flex justify="space-between" align="center">
            <Flex align="center" gap="sm">
              <Badge
                circle
                size="12"
                bg={isValid ? "success" : "error"}
                style={{ flexShrink: 0 }}
              />
              <Text>
                {isValid
                  ? t`Slack app is working`
                  : t`Slack app is not working.`}
              </Text>
            </Flex>

            {!isValid && (
              <Text ml="sm" inline>
                {jt`Need help? ${(<ExternalLink key="link" href={docsUrl}>{t`See our docs`}</ExternalLink>)}.`}
              </Text>
            )}
          </Flex>
          <Divider w="calc(100% + 4rem)" ml="-2rem" my="lg" />
        </Box>
      ) : (
        <>
          <Markdown>
            {t`First, **click the button below to create your Slack App** using the Metabase configuration. Once created, click "**Install to workspace**" to authorize it.`}
          </Markdown>
          <Box>
            <ButtonLink href={`https://api.slack.com${link}`}>
              <span>{t`Create Slack App`}</span>
              <Icon name="external" opacity={0.7} ml="md" />
            </ButtonLink>
          </Box>
          <Markdown>
            {t`Once installed, copy the **Bot User OAuth Token** and paste it here.`}
          </Markdown>
        </>
      )}

      <SlackSetupForm
        initialValues={{
          "slack-app-token": slackAppToken ?? "",
        }}
      />
    </Stack>
  );
};
