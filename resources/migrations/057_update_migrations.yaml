databaseChangeLog:
  - objectQuotingStrategy: QUOTE_ALL_OBJECTS

  - changeSet:
      id: v57.2025-07-08T11:37:29
      author: lbrdnk
      comment: Add transform_view table
      changes:
        - createTable:
            tableName: transform_view
            remarks: Metabase managed views in user databases
            columns:
              - column:
                  name: id
                  type: int
                  remarks: Transform view id
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: creator_id
                  type: int
                  remarks: Id of user who created or updated the transform
              - column:
                  name: database_id
                  type: int
                  remarks: Id of metabase_database the view is created in
              - column:
                  name: status
                  type: varchar(16)
                  remarks: Status of the entity the table represents, useful eg. for error handling
              - column:
                  name: view_schema
                  type: varchar(256)
                  remarks: The schema view is created in
              - column:
                  name: view_name
                  type: varchar(256)
                  remarks: Name of the view, unique per database and schema
              - column:
                  name: dataset_query
                  type: ${text.type}
                  remarks: Query as stored in report_card.dataset_query
              - column:
                  name: dataset_query_schema
                  type: int
                  remarks: Schema version similar to report_card.card_schema
              - column:
                  name: dataset_query_type
                  type: varchar(16)
                  remarks: Type of dataset_query
              - column:
                  name: created_at
                  type: ${timestamp_type}
                  remarks: Timestamp of transform view creation
                  defaultValueComputed: current_timestamp
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: ${timestamp_type}
                  remarks: Timestamp of transform view update
                  defaultValueComputed: current_timestamp
                  constraints:
                    nullable: false

  - changeSet:
      id: v57.2025-07-08T17:13:13
      author: lbrdnk
      comment: Add unique constraint onto transform_view table
      changes:
        - addUniqueConstraint:
            tableName: transform_view
            columnNames: database_id, view_schema, view_name
            constraintName: unique_transform_view_database_id_view_schema_view_name

  - changeSet:
      id: v57.2025-07-09T15:18:37
      author: lbrdnk
      comment: Create index for database_id of transform_view table
      preConditions:
        - onFail: MARK_RAN
        - not:
            - indexExists:
                tableName: transform_view
                indexName: idx_transform_view_database_id
      changes:
        - createIndex:
            tableName: transform_view
            indexName: idx_transform_view_database_id
            columns:
              - column:
                  name: database_id
      rollback: # Handled in rollback of "Add transform_view table" changeset

  - changeSet:
      id: v57.2025-07-10T16:56:27
      author: lbrdnk
      comment: Create index for creator_id of transform_view table
      preConditions:
        - onFail: MARK_RAN
        - not:
            - indexExists:
                tableName: transform_view
                indexName: idx_transform_view_creator_id
      changes:
        - createIndex:
            tableName: transform_view
            indexName: idx_transform_view_creator_id
            columns:
              - column:
                  name: creator_id
      rollback: # Handled in rollback of "Add transform_view table" changeset

  - changeSet:
      id: v57.2025-07-10T16:58:14
      author: lbrdnk
      comment: Create fk constraint on core_user.id
      changes:
        - addForeignKeyConstraint:
            constraintName: fk_transform_view_creator_id
            baseTableName: transform_view
            baseColumnNames: creator_id
            referencedTableName: core_user
            referencedColumnNames: id
            onDelete: SET NULL

  - changeSet:
      id: v57.2025-07-10T16:59:51
      author: lbrdnk
      comment: Create fk constraint on metabase_database.id
      changes:
        - addForeignKeyConstraint:
            constraintName: fk_transform_view_database_id
            baseTableName: transform_view
            baseColumnNames: database_id
            referencedTableName: metabase_database
            referencedColumnNames: id
            onDelete: SET NULL

  - changeSet:
      id: v57.2025-07-13T12:30:21
      author: lbrdnk
      comment: Add transform_id to metabase_table to reference transform_view.id
      changes:
        - addColumn:
            tableName: metabase_table
            columns:
              - column:
                  name: transform_id
                  type: int
                  remarks: fk to tranform_view table

  - changeSet:
      id: v57.2025-07-13T12:35:09
      author: lbrdnk
      comment: Index metabase_table.transform_id
      changes:
        - createIndex:
            tableName: metabase_table
            indexName: idx_metabase_table_transform_id
            columns:
              - column:
                  name: transform_id

  - changeSet:
      id: v57.2025-07-13T12:39:22
      author: lbrdnk
      comment: Add metabase_table.transform_id fk constraint
      changes:
        - addForeignKeyConstraint:
            constraintName: fk_metabase_table_transform_id
            baseTableName: metabase_table
            baseColumnNames: transform_id
            referencedTableName: transform_view
            referencedColumnNames: id
            onDelete: CASCADE

  # >>>>>>>>>> DO NOT ADD NEW MIGRATIONS BELOW THIS LINE! ADD THEM ABOVE <<<<<<<<<<

########################################################################################################################
#
# ADVICE:
#
# 1) Think through some of these points when writing a migration, learn from our past mistakes:
#    - Do you really need a migration? Could the feature work without it? Prefer not to if possible.
#      Data in the wild can be vastly different from what you expect, and it's hard to get right.
#    - Make sure your migration is backward compatible: it might not be possible to add a constraint back
#      if you drop it in a migration.
#    - Postgres, MySQL and H2 have their differences. Make sure your migration works for all.
#    - Database encryption is a major issue:
#      - Fields like `metabase_database.details` or `setting.value` can be encrypted, so you need to decrypt them in
#        your migration. See #42617, #44048.
#      - Database could be partially encrypted, see https://www.notion.so/72575933ef2a446bafd16909e05a7387
#    - Custom migrations:
#      - Prefer SQL migrations when possible.
#      - Never use application code: it can change and *will* break your migration.
#      - Do not use Toucan models - refer table names directly.
#      - If it's a big change, consider using Quartz, see #42279
#      - More in `metabase.app_db.custom_migrations` namespace doc.
#    - Never delete a migration: users won't be able to downgrade. If you really need to, see #44908
#    - Migration id (`vXX.<date>`) must match its earliest released version:
#      - Do not backport `v51....` to version 50, Metabase will try to downgrade it.
#      - Instead, write a migration with an oldest target you plan to backport to in mind.
#
# 2) Migrations should go in the ###_update_migrations.yaml file for the target version.
#
# 3) Run mage lint-migrations-file to run core.spec checks against any changes you make here. Liquibase is pretty
#    forgiving and won't complain if you accidentally mix up things like deleteCascade and onDelete: CASCADE. CI runs
#    this check but it's nicer to know now instead of waiting for CI.
#
# 3) Migration IDs should follow the format
#
#    vMM.TIMESTAMP
#
#    Where
#
#    M         = major version
#    TIMESTAMP = the current timestamp with format `yyyy-MM-dd'T'HH:mm:ss`
#                To get this timestamp, evaluate this in your REPL: `(dev/migration-timestamp)`
#
#    E.g: You're adding a new migration for version 49, And it's 10:30:00AM on April 1, 2023 (UTC),
#    your migration id should be: `v49.2023-04-01T10:30:00`.
#
# PLEASE KEEP THIS MESSAGE AT THE BOTTOM OF THIS FILE!!!!! Add new migrations above the message.
#
########################################################################################################################
