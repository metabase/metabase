name: Security Overview Report

on:
  schedule:
    # Run every Tuesday at 3:00 PM ET (20:00 UTC)
    - cron: "0 20 * * 2"
  workflow_dispatch:
    inputs:
      since_date:
        description: "Fetch events from this date (YYYY-MM-DD). Defaults to 7 days ago."
        required: false
        type: string

jobs:
  generate-report:
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    permissions:
      security-events: read
      contents: read

    steps:
      - uses: actions/checkout@v4
        with:
          sparse-checkout: |
            release
            .github

      - name: Prepare release scripts
        uses: ./.github/actions/prepare-release-scripts

      - name: Generate Security Report
        uses: actions/github-script@v7
        id: generate_report
        with:
          script: | # js
            const { getSecurityReport, getTodayDate } = require('${{ github.workspace }}/release/dist/index.cjs');

            const sinceDate = '${{ inputs.since_date }}' || undefined;

            const report = await getSecurityReport({
              github,
              owner: context.repo.owner,
              repo: context.repo.repo,
              sinceDate,
            });

            const fs = require('fs');
            fs.writeFileSync('security-report.md', report);

            console.log(report);

            core.setOutput('report', report);
            core.setOutput('reportDate', getTodayDate());

      - name: Upload Report as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: security-report.md
          retention-days: 14

      - name: Dispatch to Website Repo
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.METABASE_AUTOMATION_USER_TOKEN }}
          script: | # js
            const reportDate = '${{ steps.generate_report.outputs.reportDate }}';
            const report = `${{ steps.generate_report.outputs.report }}`;

            await github.rest.repos.createDispatchEvent({
              owner: context.repo.owner,
              repo: '${{ vars.WEBSITE_REPO }}',
              event_type: 'update-security-report',
              client_payload: {
                reportDate,
                text: report,
              }
            }).catch(console.warn);
