(ns metabase.automagic-dashboards.populate
  "Create and save models that make up automagic dashboards."
  (:require [clojure.string :as str]
            [clojure.tools.logging :as log]
            [metabase.api
             [common :as api]
             [card :as card.api]]
            [metabase.events :as events]
            [metabase.models.dashboard :as dashboard]
            [toucan
             [db :as db]
             [hydrate :refer [hydrate]]]))

(def ^Integer grid-width
  "Total grid width."
  18)
(def ^Integer default-card-width
  "Default card width."
  6)
(def ^Integer default-card-height
  "Default card height"
  4)

(defn- create-collection!
  [title color description]
  (when api/*is-superuser?*
    (db/insert! 'Collection
      :name        title
      :color       color
      :description description)))

(def ^:private automagic-collection
  "Get or create collection used to store all autogenerated cards.
   Value is wrapped in a delay so that we don't hit the DB out of order."
  (delay
   (or (db/select-one 'Collection
                      :name "Automatically Generated Questions")
       (create-collection! "Automatically Generated Questions"
                           "#000000"
                           "Cards used in automatically generated dashboards."))))

(defn- create-card!
  [{:keys [visualization title description query]}]
  (let [[display visualization-settings] visualization
        card (db/insert! 'Card
               :creator_id             api/*current-user-id*
               :dataset_query          query
               :description            description
               :display                display
               :name                   title
               :visualization_settings visualization-settings
               :result_metadata        (card.api/result-metadata-for-query query)
               :collection_id          (-> automagic-collection deref :id))]
    (events/publish-event! :card-create card)
    (hydrate card :creator :dashboard_count :labels :can_write :collection)
    card))

(defn- add-to-dashboard!
  [dashboard card [x y]]
  (dashboard/add-dashcard! dashboard (create-card! card)
    {:col   y
     :row   x
     :sizeX (:width card)
     :sizeY (:height card)}))

(def ^:private ^Integer max-cards 9)

(defn- make-grid
  [width height]
  (vec (repeat height (vec (repeat width false)))))

(defn- fill-grid
  "Mark a rectangular area starting at [`x`, `y`] of size [`width`, `height`] as
   occupied."
  [grid [x y] {:keys [width height]}]
  (reduce (fn [grid xy]
            (assoc-in grid xy true))
          grid
          (for [x (range x (+ x height))
                y (range y (+ y width))]
            [x y])))

(defn- accomodates?
  "Can we place card on grid starting at [x y] (top left corner)?
   Since we are filling the grid top to bottom and the cards are rectangulard,
   it suffices to check just the first (top) row."
  [grid [x y] {:keys [width height]}]
  (and (<= (+ x height) (count grid))
       (<= (+ y width) (-> grid first count))
       (every? false? (subvec (grid x) y (+ y width)))))

(defn- place-card
  "Place card on grid.
   We use the dumbest possible algorithm (the grid size is relatively small, so
   we should be fine): startting at top left move along the grid from left to
   right, row by row and try to place the card at each position until we find an
   unoccupied area. Mark the area as occupied."
  [grid card]
  (reduce (fn [grid xy]
            (if (accomodates? grid xy card)
              (reduced [xy (fill-grid grid xy card)])
              grid))
          grid
          (for [x (range (count grid))
                y (range (count (first grid)))]
            [x y])))

(defn create-dashboard!
  "Create dashboard and populate it with cards."
  [{:keys [title description]} cards]
  (let [dashboard (db/insert! 'Dashboard
                    :name        title
                    :description description
                    :creator_id  api/*current-user-id*
                    :parameters  [])
        cards     (->> cards
                       (sort-by :score >)
                       (take max-cards))]
    (events/publish-event! :dashboard-create dashboard)
    (log/info (format "Adding %s cards to dashboard %s:\n%s"
                      (count cards)
                      (:id dashboard)
                      (str/join "; " (map :title cards))))
    (reduce (fn [grid card]
              (let [[xy grid] (place-card grid card)]
                (add-to-dashboard! dashboard card xy)
                grid))
            ;; Height doesn't need to be a precise number, just a safe max.
            (make-grid grid-width (* max-cards grid-width))
            cards)
    dashboard))
