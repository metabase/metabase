name: Loki Visual Stress Test Flake Fix

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'frontend/**/*.stories.tsx'
      - 'enterprise/frontend/**/*.stories.tsx'
  workflow_dispatch:
    inputs:
      stories_filter:
        description: "Regex pattern to filter stories (leave empty for auto-detection from changed files)"
        type: string
        required: false
        default: ""
      burn_in:
        description: "Number of times to run the test (e.g. 50)"
        type: string
        required: true
        default: "50"

jobs:
  detect-stories-filter:
    name: Detect changed stories
    runs-on: ubuntu-22.04
    timeout-minutes: 5
    outputs:
      stories_filter: ${{ steps.detect.outputs.stories_filter }}
      should_run: ${{ steps.detect.outputs.should_run }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed story files
        id: detect
        run: |
          # If manual trigger with filter provided, use it directly
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ inputs.stories_filter }}" ]]; then
            echo "Using manually provided filter: ${{ inputs.stories_filter }}"
            echo "stories_filter=${{ inputs.stories_filter }}" >> $GITHUB_OUTPUT
            echo "should_run=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Determine the base ref for comparison
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE_REF="origin/${{ github.base_ref }}"
          else
            BASE_REF="origin/${{ github.event.repository.default_branch }}"
          fi

          echo "Comparing against: $BASE_REF"

          # Extract component names from changed story filenames (e.g., Button.stories.tsx -> Button)
          FILTER=$(git diff --name-only "$BASE_REF"...HEAD -- '*.stories.tsx' 2>/dev/null \
            || git diff --name-only "$BASE_REF" HEAD -- '*.stories.tsx' 2>/dev/null \
            | xargs -n1 basename 2>/dev/null \
            | sed 's/\.stories\.tsx$//' \
            | sort -u \
            | paste -sd'|')

          echo "Generated stories filter: $FILTER"
          echo "stories_filter=${FILTER:-}" >> $GITHUB_OUTPUT
          echo "should_run=$([[ -n "$FILTER" ]] && echo true || echo false)" >> $GITHUB_OUTPUT

  workflow-summary:
    name: Stress test inputs
    needs: detect-stories-filter
    if: needs.detect-stories-filter.outputs.should_run == 'true'
    runs-on: ubuntu-22.04
    timeout-minutes: 5
    steps:
      - name: Generate workflow summary
        run: |
          echo '**Inputs:**' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          echo '- `branch`: ${{ github.ref_name }}' >> $GITHUB_STEP_SUMMARY
          echo '- `stories_filter`: ${{ needs.detect-stories-filter.outputs.stories_filter }}' >> $GITHUB_STEP_SUMMARY
          echo '- `burn_in`: ${{ inputs.burn_in || '50' }}' >> $GITHUB_STEP_SUMMARY
          echo '- `trigger`: ${{ github.event_name }}' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo 'triggered by: PR #${{ github.event.pull_request.number }} from @${{ github.event.pull_request.user.login }}' >> $GITHUB_STEP_SUMMARY
          else
            echo 'triggered by: @${{ github.event.sender.login }}' >> $GITHUB_STEP_SUMMARY
          fi

  stress-test-loki:
    needs: detect-stories-filter
    if: needs.detect-stories-filter.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    name: Stress test Loki visual tests
    services:
      docker:
        image: docker:19.03.12
        options: --privileged
        ports:
          - 2376:2376
        env:
          DOCKER_TLS_CERTDIR: /certs
        volumes:
          - /var/run/docker.sock:/var/run/docker.sock
          - /tmp/docker-certs:/certs/client

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Prepare frontend environment
        uses: ./.github/actions/prepare-frontend

      - name: Prepare back-end environment
        uses: ./.github/actions/prepare-backend

      - name: Compile CLJS
        run: NODE_ENV=development yarn build-pure:cljs

      - name: Build Storybook (once)
        run: yarn build-storybook

      - name: Stress-test Loki "${{ needs.detect-stories-filter.outputs.stories_filter }}" ${{ inputs.burn_in || '50' }} times
        run: |
          BURN_IN=${{ inputs.burn_in || '50' }}
          STORIES_FILTER='${{ needs.detect-stories-filter.outputs.stories_filter }}'

          echo "Running Loki visual tests $BURN_IN times for stories matching: $STORIES_FILTER"
          echo ""

          FAILED=0
          for i in $(seq 1 $BURN_IN); do
            echo "=========================================="
            echo "Run $i of $BURN_IN"
            echo "=========================================="

            if yarn test-visual:loki \
              --reactUri file:./storybook-static \
              --verboseRenderer \
              --storiesFilter "$STORIES_FILTER"; then
              echo "✅ Run $i passed"
            else
              echo "❌ Run $i FAILED"
              FAILED=$((FAILED + 1))

              mkdir -p .loki/failures/run-$i
              cp -r .loki/difference/* .loki/failures/run-$i/ 2>/dev/null || true
            fi
            echo ""
          done

          echo "=========================================="
          echo "Summary: $((BURN_IN - FAILED))/$BURN_IN passed, $FAILED failed"
          echo "=========================================="

          if [ $FAILED -gt 0 ]; then
            echo "::error::$FAILED out of $BURN_IN runs failed"
            exit 1
          fi

      - name: Generate Visual Report on Failure
        if: failure()
        run: yarn test-visual:loki-report

      - name: Upload Artifact
        id: artifact-upload-step
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: loki-stress-test-report
          include-hidden-files: true
          path: .loki/
          if-no-files-found: ignore
