name: Embedding SDK Bundle Size Check
description: |
  Downloads the current branch's uberjar and the base ref's uberjar,
  extracts embedding-sdk.js from both, compares their sizes,
  and sets output if the size change exceeds the threshold.

inputs:
  uberjar-artifact-name:
    description: 'Name of the uberjar artifact for the current commit'
    required: true
  base-ref-commit:
    description: 'Commit SHA of the base ref (e.g. merge base).'
    required: true
  max-bundle-size-diff-percent:
    description: 'Percent threshold for bundle size change'
    required: false
    default: '5'

outputs:
  size_increased:
    description: "true if bundle size increase is above threshold"
    value: ${{ steps.compare.outputs.size_increased }}
  size_decreased:
    description: "true if bundle size decrease is above threshold"
    value: ${{ steps.compare.outputs.size_decreased }}
  size_change_percent:
    description: "size change percent (positive = increase, negative = decrease)"
    value: ${{ steps.compare.outputs.size_change_percent }}

runs:
  using: "composite"
  steps:
    - name: Download uberjar artifact (current)
      uses: actions/download-artifact@v4
      with:
        name: ${{ inputs.uberjar-artifact-name }}
        path: temp/uberjar-current
    - name: Extract embedding-sdk.js from current uberjar
      shell: bash
      run: unzip -j temp/uberjar-current/target/uberjar/metabase.jar frontend_client/app/embedding-sdk.js -d temp/current
    - name: Fetch base ref uberjar
      uses: ./.github/actions/fetch-artifact
      with:
        commit: ${{ inputs.base-ref-commit }}
        edition: ee
        extract-path: temp/uberjar-base-ref
    - name: Extract embedding-sdk.js from base ref uberjar
      shell: bash
      run: unzip -j temp/uberjar-base-ref/metabase.jar frontend_client/app/embedding-sdk.js -d temp/base-ref
    - name: Compare sizes and set output
      id: compare
      shell: bash
      run: |
        current_size=$(wc -c < temp/current/embedding-sdk.js)
        base_ref_size=$(wc -c < temp/base-ref/embedding-sdk.js)

        diff=$((current_size - base_ref_size))
        percent=$(( diff * 100 / base_ref_size ))

        echo "Current size: $current_size bytes"
        echo "Base ref size: $base_ref_size bytes"
        echo "Difference: $diff bytes ($percent%)"

        max_percent="${{ inputs.max-bundle-size-diff-percent }}"
        if [ "$percent" -gt "$max_percent" ]; then
          echo "size_increased=true" >> $GITHUB_OUTPUT
        else
          echo "size_increased=false" >> $GITHUB_OUTPUT
        fi

        neg_threshold=$(( -max_percent ))
        if [ "$percent" -lt "$neg_threshold" ]; then
          echo "size_decreased=true" >> $GITHUB_OUTPUT
        else
          echo "size_decreased=false" >> $GITHUB_OUTPUT
        fi
        echo "size_change_percent=$percent" >> $GITHUB_OUTPUT
