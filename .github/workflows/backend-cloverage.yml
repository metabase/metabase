name: Backend-Cloverage

# Module lists are generated dynamically by listing source directories.
# The setup-oss and setup-ee jobs list folders in src/metabase/ and
# enterprise/backend/src/metabase_enterprise/ respectively, convert
# underscores to dashes (for Clojure namespace convention), and output
# as JSON arrays for the matrix jobs to consume.
#
# jq flags: -R (raw string input), -s (slurp all lines into one string),
# -c (compact single-line output for GitHub Actions).

on:
  workflow_dispatch:
  schedule:
    - cron: '0 10 * * 1-5' # every weekday at 5am US eastern time

jobs:
  setup-oss:
    runs-on: ubuntu-22.04
    outputs:
      modules: ${{ steps.get-modules.outputs.modules }}
    steps:
      - uses: actions/checkout@v4
      - id: get-modules
        run: |
          modules=$(ls -1d src/metabase/*/ | xargs -n1 basename | tr '_' '-' | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "modules=$modules" >> $GITHUB_OUTPUT

  be-linter-cloverage:
    needs: setup-oss
    # don't run this workflow on a cron for forks
    if: ${{ github.event_name != 'schedule' || github.repository == 'metabase/metabase' }}
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        modules: ${{ fromJson(needs.setup-oss.outputs.modules) }}
    steps:
      - uses: actions/checkout@v4
      - name: Prepare front-end environment
        uses: ./.github/actions/prepare-frontend
      - name: Prepare back-end environment
        uses: ./.github/actions/prepare-backend

      - name: Build static viz frontend
        run: yarn build-static-viz
        env:
          MB_EDITION: ee
      - name: Collect the test coverage
        run: |
          clojure -X:dev:ci:ee:ee-dev:test:cloverage \
            :ns-regex     '["^metabase\\.${{ matrix.modules }}\\..*"]' \
            :test-ns-path '["test/metabase/${{ matrix.modules }}"]'
        continue-on-error: true

      - name: Upload coverage to codecov.io
        if: always()
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./target/coverage/codecov.json
          flags: back-end

  setup-ee:
    runs-on: ubuntu-22.04
    outputs:
      modules: ${{ steps.get-modules.outputs.modules }}
    steps:
      - uses: actions/checkout@v4
      - id: get-modules
        run: |
          modules=$(ls -1d enterprise/backend/src/metabase_enterprise/*/ | xargs -n1 basename | tr '_' '-' | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "modules=$modules" >> $GITHUB_OUTPUT

  be-linter-cloverage-enterprise:
    needs: setup-ee
    # don't run this workflow on a cron for forks
    if: ${{ github.event_name != 'schedule' || github.repository == 'metabase/metabase' }}
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        modules: ${{ fromJson(needs.setup-ee.outputs.modules) }}
    steps:
      - uses: actions/checkout@v4
      - name: Prepare front-end environment
        uses: ./.github/actions/prepare-frontend
      - name: Prepare back-end environment
        uses: ./.github/actions/prepare-backend

      - name: Build static viz frontend
        run: yarn build-static-viz
        env:
          MB_EDITION: ee
      - name: Collect the test coverage
        run: |
          clojure -X:dev:ci:ee:ee-dev:test:cloverage \
            :ns-regex     '["^metabase-enterprise\\.${{ matrix.modules }}\\..*"]' \
            :test-ns-path '["enterprise/backend/test/metabase/${{ matrix.modules }}"]'
        continue-on-error: true

      - name: Upload coverage to codecov.io
        if: always()
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./target/coverage/codecov.json
          flags: back-end
