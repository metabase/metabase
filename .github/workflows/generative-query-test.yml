name: Generative Query Test

on:
  workflow_dispatch:
    inputs:
      seed:
        description: 'Seed value (empty = random)'
        type: number
      iterations:
        description: 'Number of test iterations (empty = 100)'
        type: number
      ref:
        description: 'Ref to run generative tests on'
        default: master

jobs:
  generative-query-test:
    runs-on: ubuntu-22.04
    timeout-minutes: 90
    name: Generative Query Test
    env:
      CI: 'true'
      MB_TEST_QGEN_SEED: ${{ inputs.seed }}
      MB_TEST_QGEN_ITERATIONS: ${{ inputs.iterations }}
      # TODO: Will probably remove next line in favor of new cp root.
      MB_TEST_QGEN_RUN: true
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}
      # is fe needed? is that lib related?
      - name: Prepare front-end environment
        uses: ./.github/actions/prepare-frontend
      - name: Prepare back-end environment
        uses: ./.github/actions/prepare-backend
        with:
          m2-cache-key: generative-query-test

      - name: Run test
        run: clojure -X:dev:ci:test:ee:ee-dev :only 'metabase.query-processor-test.generative-test'

      - name: Publish Test Report (JUnit)
        uses: dorny/test-reporter@v1
        if: failure()
        with:
          path: "target/junit/**/*_test.xml"
          name: JUnit Test Report (Generative Query test)
          reporter: java-junit
          list-suites: failed
          list-tests: failed
          fail-on-error: false
