name: Setup Python Runner
description: Setup python-runner for tests
inputs:
  dockerhub-username:
    description: Docker Hub username for accessing private images
    required: true
  dockerhub-token:
    description: Docker Hub token for accessing private images
    required: true
  python-runner-version:
    description: Version of the python-runner Docker image to use
    required: false
    default: '0.0.1'
runs:
  using: composite
  steps:
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ inputs.dockerhub-username }}
        password: ${{ inputs.dockerhub-token }}

    - name: Pull and run python-runner
      run: |
        echo "Pulling python-runner image version ${{ inputs.python-runner-version }}..."
        docker pull metabase/python-runner:${{ inputs.python-runner-version }}

        echo "Starting python-runner container..."
        docker run -d \
          --name python-runner \
          -p 5001:5001 \
          metabase/python-runner:${{ inputs.python-runner-version }}

        # Wait for container to be ready
        echo "Waiting for python-runner to be ready..."
        for i in {1..30}; do
          if docker ps --filter name=python-runner --filter status=running | grep -q python-runner; then
            echo "Container is running"
            if curl -s --max-time 2 http://localhost:5001/health > /dev/null 2>&1 || curl -s --max-time 2 http://localhost:5001/ > /dev/null 2>&1; then
              echo "Python runner is ready and responding"
              break
            fi
          fi
          echo "Waiting for python-runner to be ready... (attempt $i/30)"
          sleep 2
        done

        # Stream logs to files in the background
        docker logs -f python-runner > python-runner.out.log 2> python-runner.err.log &
      shell: bash
