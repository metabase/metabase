(ns metabase-enterprise.metabot-v3.tools.create-autogenerated-dashboard-test
  (:require
   [clojure.test :refer :all]
   [metabase-enterprise.metabot-v3.tools.create-autogenerated-dashboard :as autogen-dashboard]
   [metabase.test :as mt]))

;;; Source Resolution Tests (without database)

(deftest resolve-source-validation-test
  (testing "fails when no source specified"
    (let [memory-atom (atom {:state {:queries {} :charts {}}})]
      (is (thrown-with-msg?
           clojure.lang.ExceptionInfo
           #"Invalid source"
           (autogen-dashboard/create-autogenerated-dashboard
            {:source {}
             :memory-atom memory-atom})))))

  (testing "fails when query_id not found in memory"
    (let [memory-atom (atom {:state {:queries {}}})]
      (is (thrown-with-msg?
           clojure.lang.ExceptionInfo
           #"Query not found in memory"
           (autogen-dashboard/create-autogenerated-dashboard
            {:source {:query_id "nonexistent"}
             :memory-atom memory-atom}))))))

;;; Response Structure Tests

(deftest response-structure-test
  (testing "returns final-response? flag"
    ;; We need to test the structure without actually hitting the database
    ;; Using mt/with-temp for table creation
    (mt/with-temp [:model/Table table {:name "test_table" :db_id (mt/id)}]
      (let [result (autogen-dashboard/create-autogenerated-dashboard
                    {:source {:table_id (:id table)}
                     :memory-atom (atom {:state {}})})]
        (is (true? (:final-response? result))))))

  (testing "returns redirect reaction"
    (mt/with-temp [:model/Table table {:name "test_table" :db_id (mt/id)}]
      (let [result (autogen-dashboard/create-autogenerated-dashboard
                    {:source {:table_id (:id table)}
                     :memory-atom (atom {:state {}})})]
        (is (contains? result :reactions))
        (is (= :metabot.reaction/redirect (:type (first (:reactions result)))))
        (is (clojure.string/starts-with? (:url (first (:reactions result))) "/auto/dashboard/")))))

  (testing "returns user-friendly message"
    (mt/with-temp [:model/Table table {:name "test_table" :db_id (mt/id)}]
      (let [result (autogen-dashboard/create-autogenerated-dashboard
                    {:source {:table_id (:id table)}
                     :memory-atom (atom {:state {}})})]
        (is (string? (get-in result [:structured-output :message])))
        (is (clojure.string/includes? (get-in result [:structured-output :message]) "dashboard")))))

  (testing "returns path in structured output"
    (mt/with-temp [:model/Table table {:name "test_table" :db_id (mt/id)}]
      (let [result (autogen-dashboard/create-autogenerated-dashboard
                    {:source {:table_id (:id table)}
                     :memory-atom (atom {:state {}})})]
        (is (string? (get-in result [:structured-output :path])))))))

;;; Path Generation Tests

(deftest path-generation-test
  (testing "table source generates correct path"
    (mt/with-temp [:model/Table table {:name "test_table" :db_id (mt/id)}]
      (let [result (autogen-dashboard/create-autogenerated-dashboard
                    {:source {:table_id (:id table)}
                     :memory-atom (atom {:state {}})})]
        (is (= (str "/auto/dashboard/table/" (:id table))
               (get-in result [:structured-output :path]))))))

  (testing "model source generates correct path"
    (mt/with-temp [:model/Card model {:type :model :name "test_model"}]
      (let [result (autogen-dashboard/create-autogenerated-dashboard
                    {:source {:model_id (:id model)}
                     :memory-atom (atom {:state {}})})]
        (is (= (str "/auto/dashboard/model/" (:id model))
               (get-in result [:structured-output :path]))))))

  (testing "metric source generates correct path"
    (mt/with-temp [:model/Card metric {:type :metric :name "test_metric"}]
      (let [result (autogen-dashboard/create-autogenerated-dashboard
                    {:source {:metric_id (:id metric)}
                     :memory-atom (atom {:state {}})})]
        (is (= (str "/auto/dashboard/metric/" (:id metric))
               (get-in result [:structured-output :path]))))))

  (testing "report source generates correct path"
    (mt/with-temp [:model/Card report {:type :question :name "test_report"}]
      (let [result (autogen-dashboard/create-autogenerated-dashboard
                    {:source {:report_id (:id report)}
                     :memory-atom (atom {:state {}})})]
        (is (= (str "/auto/dashboard/question/" (:id report))
               (get-in result [:structured-output :path]))))))

  (testing "query source generates correct path"
    (let [query {:lib/type :mbql/query :database 1 :stages []}
          memory-atom (atom {:state {:queries {"q123" query}}})]
      (let [result (autogen-dashboard/create-autogenerated-dashboard
                    {:source {:query_id "q123"}
                     :memory-atom memory-atom})]
        (is (= "/auto/dashboard/adhoc/q123"
               (get-in result [:structured-output :path])))))))

;;; Entity Not Found Tests

(deftest entity-not-found-test
  (testing "fails for nonexistent table"
    (is (thrown-with-msg?
         clojure.lang.ExceptionInfo
         #"Table not found"
         (autogen-dashboard/create-autogenerated-dashboard
          {:source {:table_id 999999}
           :memory-atom (atom {:state {}})}))))

  (testing "fails for nonexistent model"
    (is (thrown-with-msg?
         clojure.lang.ExceptionInfo
         #"Model not found"
         (autogen-dashboard/create-autogenerated-dashboard
          {:source {:model_id 999999}
           :memory-atom (atom {:state {}})}))))

  (testing "fails for nonexistent metric"
    (is (thrown-with-msg?
         clojure.lang.ExceptionInfo
         #"Metric not found"
         (autogen-dashboard/create-autogenerated-dashboard
          {:source {:metric_id 999999}
           :memory-atom (atom {:state {}})}))))

  (testing "fails for nonexistent report"
    (is (thrown-with-msg?
         clojure.lang.ExceptionInfo
         #"Report/Question not found"
         (autogen-dashboard/create-autogenerated-dashboard
          {:source {:report_id 999999}
           :memory-atom (atom {:state {}})})))))

;;; Tool Handler Tests

(deftest create-autogenerated-dashboard-tool-test
  (testing "catches exceptions and returns error output"
    (let [result (autogen-dashboard/create-autogenerated-dashboard-tool
                  {:source {:table_id 999999}
                   :memory-atom (atom {:state {}})})]
      (is (contains? result :output))
      (is (string? (:output result)))))

  (testing "returns structured output on success"
    (mt/with-temp [:model/Table table {:name "test_table" :db_id (mt/id)}]
      (let [result (autogen-dashboard/create-autogenerated-dashboard-tool
                    {:source {:table_id (:id table)}
                     :memory-atom (atom {:state {}})})]
        (is (contains? result :structured-output))
        (is (contains? result :reactions))
        (is (true? (:final-response? result)))))))
