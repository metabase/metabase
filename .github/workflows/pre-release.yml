name: Pre-release [WIP]

on:
  workflow_dispatch:
    inputs:
      commit:
        description: 'A commit hash'
        required: true

env:
  MAX_HASH_LENGTH: 8

jobs:
  build:
    name: Build Metabase ${{ matrix.edition }} @${{ github.event.inputs.commit }}
    runs-on: ubuntu-20.04
    timeout-minutes: 40
    strategy:
      matrix:
        edition: [oss, ee]
    env:
      MB_EDITION: ${{ matrix.edition }}
      INTERACTIVE: false
    steps:
    - name: Check out the code
      uses: actions/checkout@v3
    - name: Switch to commit ${{ github.event.inputs.commit }}
      run: git checkout ${{ github.event.inputs.commit }}
    - name: Prepare front-end environment
      uses: ./.github/actions/prepare-frontend
    - name: Prepare back-end environment
      uses: ./.github/actions/prepare-backend
    - name: Build
      run: ./bin/build
    - name: Prepare uberjar artifact
      uses: ./.github/actions/prepare-uberjar-artifact

  check-uberjar-health:
    runs-on: ubuntu-20.04
    name: Is ${{ matrix.edition }} (java ${{ matrix.java-version }}) healthy?
    needs: build
    timeout-minutes: 10
    strategy:
      matrix:
        edition: [oss, ee]
        java-version: [11, 17]
    steps:
    - name: Prepare JRE (Java Run-time Environment)
      uses: actions/setup-java@v3
      with:
        java-package: jre
        java-version: ${{ matrix.java-version }}
        distribution: 'temurin'
    - run: java -version
    - uses: actions/download-artifact@v3
      name: Retrieve uberjar artifact
      with:
        name: metabase-${{ matrix.edition }}-uberjar
    - name: Launch uberjar (and keep it running)
      run: java -jar ./target/uberjar/metabase.jar &
    - name: Wait for Metabase to start
      run: while ! curl -s 'http://localhost:3000/api/health' | grep '{"status":"ok"}'; do sleep 1; done

  containerize:
    runs-on: ubuntu-20.04
    needs: check-uberjar-health
    timeout-minutes: 15
    strategy:
      matrix:
        edition: [oss, ee]
    services:
      registry:
        image: registry:2
        ports:
          - 5000:5000
    steps:
    - name: Check out the code
      uses: actions/checkout@v3
    - name: Switch to commit ${{ github.event.inputs.commit }}
      run: git checkout ${{ github.event.inputs.commit }}
    - name: Truncate commit hash
      run: |
        commit_id=${{ github.event.inputs.commit }}
        truncated_hash=${commit_id:0:${{ env.MAX_HASH_LENGTH }}}

        echo "COMMMIT_IDENTIFIER=$truncated_hash" >> $GITHUB_ENV
      shell: bash
    - uses: actions/download-artifact@v3
      name: Retrieve uberjar artifact
      with:
        name: metabase-${{ matrix.edition }}-uberjar
    - name: Move the Uberjar to the context dir
      run: mv ./target/uberjar/metabase.jar bin/docker/.
    - name: Set up Docker Buildx
      id: buildx
      uses: docker/setup-buildx-action@v2
      with:
        driver-opts: network=host
    - name: Build ${{ matrix.edition }} container
      uses: docker/build-push-action@v3
      with:
        context: bin/docker/.
        platforms: linux/amd64
        network: host
        tags: localhost:5000/local-metabase:${{ env.COMMIT_IDENTIFIER }}
        no-cache: true
        push: true

    - name: Launch container
      run: docker run --rm -dp 3000:3000 localhost:5000/local-metabase:${{ env.COMMIT_IDENTIFIER }}
      timeout-minutes: 5
    - name: Wait for Metabase to start
      run: while ! curl -s 'http://localhost:3000/api/health' | grep '{"status":"ok"}'; do sleep 1; done
      timeout-minutes: 3

    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_RELEASE_USERNAME }}
        password: ${{ secrets.DOCKERHUB_RELEASE_TOKEN }}
    - name: Determine the target Docker Hub repository
      run: |
        if [[ ${{ matrix.edition }} == ee ]]; then
          docker_image="metabase_enterprise:${{ env.COMMIT_IDENTIFIER }}"
        else
          docker_image="metabase:${{ env.COMMIT_IDENTIFIER }}"
        fi

        if [[ ${{ github.repository }} == 'metabase/metabase' ]]; then
          echo "Metabase ${{ matrix.edition }}: image is going to be pushed to metabase/$docker_image"
          echo "DOCKERHUB_REPO=metabase/$docker_image" >> $GITHUB_ENV
        else
          echo "DOCKERHUB_REPO=${{ github.repository_owner }}/${{ secrets.CUSTOM_RELEASE_REPO }}:${{ env.COMMIT_IDENTIFIER }}-${{ matrix-edition }}" >> $GITHUB_ENV
        fi
    - name: Retag and push container image to Docker Hub
      run: |
        echo "Pushing container image ${{ env.DOCKERHUB_REPO }} ..."
        docker tag localhost:5000/local-metabase:${{ env.COMMIT_IDENTIFIER }} ${{ env.DOCKERHUB_REPO }}
        docker push ${{ env.DOCKERHUB_REPO }}
        echo "Finished!"

  verify-docker-pull:
    runs-on: ubuntu-20.04
    needs: containerize
    timeout-minutes: 15
    strategy:
      matrix:
        edition: [oss, ee]
    steps:
    - name: Truncate commit hash
      run: |
        commit_id=${{ github.event.inputs.commit }}
        truncated_hash=${commit_id:0:${{ env.MAX_HASH_LENGTH }}}

        echo "COMMMIT_IDENTIFIER=$truncated_hash" >> $GITHUB_ENV
      shell: bash
    - name: Login to Docker Hub # authenticated, to avoid being rate-throttled
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_RELEASE_USERNAME }}
        password: ${{ secrets.DOCKERHUB_RELEASE_TOKEN }}
    - name: Determine the container image to pull
      run: |
        if [[ ${{ matrix.edition }} == ee ]]; then
          docker_image="metabase_enterprise:${{ env.COMMIT_IDENTIFIER }}"
        else
          docker_image="metabase:${{ env.COMMIT_IDENTIFIER }}"
        fi

        if [[ ${{ github.repository }} == 'metabase/metabase' ]]; then
          echo "DOCKERHUB_REPO=metabase/$docker_image" >> $GITHUB_ENV
        else
          echo "DOCKERHUB_REPO=${{ github.repository_owner }}/${{ secrets.CUSTOM_RELEASE_REPO }}:${{ env.COMMIT_IDENTIFIER }}-${{ matrix-edition }}" >> $GITHUB_ENV
        fi
    - name: Pull the container image
      run: |
        echo "Pulling container image ${{ env.DOCKERHUB_REPO }} ..."
        docker pull ${{ env.DOCKERHUB_REPO }}
        echo "Successful!"
    - name: Launch container
      run: docker run --rm -dp 3000:3000 ${{ env.DOCKERHUB_REPO }}
      timeout-minutes: 5
    - name: Wait for Metabase to start
      run: while ! curl -s 'http://localhost:3000/api/health' | grep '{"status":"ok"}'; do sleep 1; done
      timeout-minutes: 3
