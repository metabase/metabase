name: Generate llms.txt file

on:
  schedule:
    # Every 3 days at 03:00 UTC
    - cron: "0 3 */3 * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  determine-branches:
    name: Determine target branches
    runs-on: ubuntu-22.04
    timeout-minutes: 5
    outputs:
      branches: ${{ steps.branches.outputs.branches }}
    steps:
      - name: Get target branches
        id: branches
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # For workflow_dispatch, use the branch the workflow is running on
            BRANCHES="[\"${{ github.ref_name }}\"]"
          else
            # For scheduled runs, target all release branches >= v57 and master.
            RELEASE_BRANCHES=$(git ls-remote --heads https://github.com/metabase/metabase.git "refs/heads/release-*.x" \
              | awk '{gsub("refs/heads/", "", $2); print $2}' \
              | awk -F. '$2 >= 57 {print $0}')

            # Build JSON array e.g. ["master", "release-x.57.x", "release-x.58.x"]
            BRANCHES=$(printf '%s\n' "master" $RELEASE_BRANCHES | jq -R -s -c 'split("\n") | map(select(length > 0))')
          fi

          echo "branches=$BRANCHES" >> $GITHUB_OUTPUT
          echo "Target branches: $BRANCHES"

  generate-llms-txt:
    name: Generate llms.txt for ${{ matrix.branch }}
    needs: determine-branches
    runs-on: ubuntu-22.04
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        branch: ${{ fromJson(needs.determine-branches.outputs.branches) }}
    steps:
      - name: Set target branch
        id: determine_branch
        run: |
          echo "target_branch=${{ matrix.branch }}" >> $GITHUB_OUTPUT
          echo "Target branch: ${{ matrix.branch }}"

      - name: Checkout workflow branch for generate-llms-txt.js script
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.METABASE_AUTOMATION_USER_TOKEN }}
          ref: ${{ github.ref }}
          sparse-checkout: |
            .github/scripts
          path: workflow-scripts

      - name: Checkout target branch for docs
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.METABASE_AUTOMATION_USER_TOKEN }}
          ref: ${{ steps.determine_branch.outputs.target_branch }}
          path: docs-repo

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Generate llms.txt
        id: generate
        run: |
          node workflow-scripts/.github/scripts/generate-llms-txt.js docs-repo/docs llms.txt ${{ steps.determine_branch.outputs.target_branch }}

      - name: Sanity check generated files
        run: |
          if [ ! -f "llms.txt" ]; then
            echo "âŒ Error: llms.txt was not generated"
            exit 1
          fi

          if [ ! -f "llms-embedding-full.txt" ]; then
            echo "âŒ Error: llms-embedding-full.txt was not generated"
            exit 1
          fi

          # Check that llms.txt contains URLs with the expected GitHub raw URL prefix
          URL_COUNT=$(grep -o "https://raw.githubusercontent.com/metabase/metabase/refs/heads/${{ steps.determine_branch.outputs.target_branch }}/docs" llms.txt | wc -l)
          if [ "$URL_COUNT" -lt 10 ]; then
            echo "âŒ Error: llms.txt appears to be malformed. Found only $URL_COUNT URLs (expected at least 10)"
            exit 1
          fi

          echo "âœ… Both llms.txt and llms-embedding-full.txt were generated successfully"
          echo "âœ… llms.txt contains $URL_COUNT documentation URLs"

      - name: Set up git configuration
        working-directory: docs-repo
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          BRANCH_NAME="llms-txt/auto-update-${{ steps.determine_branch.outputs.target_branch }}-$(date +%Y%m%d-%H%M%S)"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          echo "Branch name will be: $BRANCH_NAME"

      - name: Copy generated files to docs repo
        run: |
          cp llms.txt docs-repo/
          cp llms-embedding-full.txt docs-repo/

      - name: Create Pull Request
        id: create_pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.METABASE_AUTOMATION_USER_TOKEN }}
          path: docs-repo
          branch: ${{ env.BRANCH_NAME }}
          base: ${{ steps.determine_branch.outputs.target_branch }}
          commit-message: |
            Update llms.txt and llms-full.txt (${{ steps.determine_branch.outputs.target_branch }})

            Regenerated llms.txt to include all markdown files from the docs/ directory.
            Also generated llms-full.txt files for the embedding section.

            ðŸ¤– Generated automatically by llms-txt-generate workflow

            Co-Authored-By: GitHub Actions <actions@github.com>
          committer: "github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>"
          author: "github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>"
          title: "[chore] Update llms.txt for ${{ steps.determine_branch.outputs.target_branch }}"
          body: |
            ## Summary
            This PR contains automatically generated updates to `llms.txt` and `llms-embedding-full.txt` files.

            ## Changes
            - The `llms.txt` file has been regenerated to include all markdown files from the `docs/` directory.
            - The `llms-embedding-full.txt` file has been generated for the embedding section (concatenated documentation for RAG).

            ## Generation
            These files were generated using:
            - Script: `.github/scripts/generate-llms-txt.js`
            - Branch: `${{ steps.determine_branch.outputs.target_branch }}`
            - Base URL: `https://raw.githubusercontent.com/metabase/metabase/refs/heads/${{ steps.determine_branch.outputs.target_branch }}`

            Please review the changes and merge if they look correct.

            ðŸ¤– Generated automatically by the `llms-txt-generate` workflow.

            Co-Authored-By: GitHub Actions <actions@github.com>
          labels: |
            Type:Documentation
            no-backport
          add-paths: |
            llms.txt
            llms-embedding-full.txt

      - name: Auto approve PR
        if: steps.create_pr.outputs.pull-request-number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr review "${{ steps.create_pr.outputs.pull-request-number }}" --approve --body "Auto-approved by llms-txt-generate workflow"

      - name: Auto merge PR
        if: steps.create_pr.outputs.pull-request-number != ''
        env:
          GH_TOKEN: ${{ secrets.METABASE_AUTOMATION_USER_TOKEN }}
        run: |
          gh pr merge "${{ steps.create_pr.outputs.pull-request-number }}" --auto --squash
