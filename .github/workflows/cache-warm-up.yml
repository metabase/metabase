name: Cache Generator

on:
  push: # temp
  schedule:
    - cron: '0 3 * * 1'   # Mondays at 03:00 UTC
  workflow_dispatch:      # manually update the cache

env:
  M2_CACHE_KEY: M2-${{ runner.os }}-$(/bin/date "+%G-%V")

jobs:
  warm-m2-cache:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - name: Get current week of year
        run: |
          WEEK_OF_YEAR=$(/bin/date "+%G-%V")
          echo "m2-cache-key=m2-${{ runner.os }}-$WEEK_OF_YEAR" >> $GITHUB_ENV
        shell: bash

      - name: Prepare backend
        uses: ./.github/actions/prepare-backend
        with:
          java-version: 21
      - name: Pre-resolve dependencies
        run: clojure -A:build:dev:ee:ee-dev:drivers:drivers-dev:cljs -P

      - name: Check if the cache entry exists
        id: cache-lookup
        uses: actions/cache/restore@v4
        with:
          path: |
            ~/.m2
            ~/.gitlibs 
          key: ${{ env.m2-cache-key }}
          lookup-only: true
      - name: Delete the cache entry if it exists
        if: ${{ steps.cache-lookup.outputs.cache-hit == 'true' }}
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh api \
            --method DELETE \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/actions/caches?key=${{ env.m2-cache-key }}
      - name: Update M2 cache
        uses: actions/cache/save@v4
        with:
          path: |
            ~/.m2
            ~/.gitlibs
          key: ${{ env.m2-cache-key }}
