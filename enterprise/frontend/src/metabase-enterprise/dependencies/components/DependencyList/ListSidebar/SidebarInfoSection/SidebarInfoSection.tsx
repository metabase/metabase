import type { ReactNode } from "react";
import { Link } from "react-router";
import { t } from "ttag";

import { DateTime } from "metabase/common/components/DateTime";
import { Ellipsified } from "metabase/common/components/Ellipsified";
import CS from "metabase/css/core/index.css";
import * as Urls from "metabase/lib/urls";
import { getUserName } from "metabase/lib/user";
import { Anchor, Box, Card, FixedSizeIcon, Group, Stack } from "metabase/ui";
import type { DependencyNode } from "metabase-types/api";

import {
  getNodeCreatedAt,
  getNodeCreatedBy,
  getNodeLastEditedAt,
  getNodeLastEditedBy,
  getNodeTransform,
} from "../../../../utils";
import S from "../ListSidebar.module.css";

type SidebarInfoSectionProps = {
  node: DependencyNode;
};

export function SidebarInfoSection({ node }: SidebarInfoSectionProps) {
  const createdBy = getNodeCreatedBy(node);
  const createdAt = getNodeCreatedAt(node);
  const editedBy = getNodeLastEditedBy(node);
  const editedAt = getNodeLastEditedAt(node);
  const hasCreatedInfo = createdBy != null && createdAt != null;
  const hasEditedInfo = editedBy != null && editedAt != null;
  const transform = getNodeTransform(node);

  if (!hasCreatedInfo && !hasEditedInfo && transform == null) {
    return null;
  }

  return (
    <Card
      p={0}
      shadow="none"
      withBorder
      role="region"
      aria-label={t`Creator and last editor`}
    >
      {createdBy != null && createdAt != null && (
        <InfoSection label={t`Created by`} date={createdAt}>
          <Ellipsified>{getUserName(createdBy)}</Ellipsified>
        </InfoSection>
      )}
      {editedBy != null && editedAt != null && (
        <InfoSection label={t`Last edited by`} date={editedAt}>
          <Ellipsified>{getUserName(editedBy)}</Ellipsified>
        </InfoSection>
      )}
      {transform != null && (
        <InfoSection label={t`Generated by`}>
          <Anchor
            component={Link}
            to={Urls.transform(transform.id)}
            target="_blank"
          >
            <Group gap="sm" wrap="nowrap">
              <FixedSizeIcon name="transform" />
              <Ellipsified>{transform.name}</Ellipsified>
            </Group>
          </Anchor>
        </InfoSection>
      )}
    </Card>
  );
}

type InfoSectionProps = {
  label: string;
  date?: string;
  children?: ReactNode;
};

function InfoSection({ label, date, children }: InfoSectionProps) {
  return (
    <Stack className={S.section} p="md" gap="xs">
      <Box className={CS.textWrap} c="text-secondary" fz="sm" lh="h5">
        {label}
      </Box>
      <Group lh="h4" justify="space-between" wrap="nowrap">
        {children}
        {date != null && (
          <Box c="text-secondary">
            <DateTime className={CS.textNoWrap} value={date} unit="day" />
          </Box>
        )}
      </Group>
    </Stack>
  );
}
