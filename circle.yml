machine:
  timezone:
    America/Los_Angeles
  java:
    version:
      oraclejdk8
dependencies:
  override:
    - lein deps
    - pip install awscli==1.7.3
database:
  post:
    # Just load timezone info for the America/Los_Angeles timezone since that's all we use in the tests. Trying to load all timezones makes CI barf because of duplicates (?)
    - mysql_tzinfo_to_sql /usr/share/zoneinfo/America/Los_Angeles America/Los_Angeles | mysql -u ubuntu mysql
    - sudo service mysql restart
test:
  override:
    # 0) runs unit tests w/ H2 local DB. Runs against H2, BigQuery
    # 1) runs unit tests w/ Postgres local DB. Runs against H2, SQL Server, Mongo, MySQL
    # 2) runs unit tests w/ MySQL local DB. Runs against H2, Postgres, SQLite
    # 3) runs unit tests w/ H2 local DB. Runs against H2, Redshift, Druid
    # 4) runs Eastwood linter, Bikeshed linter, docstring-checker & ./bin/reflection-linter
    # 5) runs JS linter + JS test
    # 6) runs lein uberjar. (We don't run bin/build because we're not really concerned about `npm install` (etc) in this test, which runs elsewhere)
    - case $CIRCLE_NODE_INDEX in 0) ENGINES=h2,bigquery lein test ;; 1) ENGINES=h2,sqlserver,mongo,mysql MB_DB_TYPE=postgres MB_DB_DBNAME=circle_test MB_DB_PORT=5432 MB_DB_USER=ubuntu MB_DB_HOST=localhost lein test ;; 2) ENGINES=h2,postgres,sqlite MB_DB_TYPE=mysql MB_DB_DBNAME=circle_test MB_DB_PORT=3306 MB_DB_USER=ubuntu MB_DB_HOST=localhost lein test ;; 3) ENGINES=h2,redshift,druid lein test ;; 4) lein eastwood && lein bikeshed && lein docstring-checker && ./bin/reflection-linter ;; 5) npm install && npm run lint && npm run build && npm run test ;; 6) lein uberjar ;; esac:
        parallel: true
deployment:
  master:
    branch: master
    commands:
      - ./bin/deploy-webhook $DEPLOY_WEBHOOK
