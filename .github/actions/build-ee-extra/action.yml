name: Build ee-extra
description: Build Metabase Enterprise Edition with extra features

inputs:
  java-version:
    required: true
    default: 21
  iam-role:
    description: "The IAM role to assume"
    required: true

runs:
  using: composite
  steps:
    - name: Prepare Java
      uses: actions/setup-java@v3
      with:
        java-version: ${{ inputs.java-version }}
        distribution: 'temurin'
    - name: Reveal its original version.properties
      run: jar xf ./bin/docker/metabase.jar version.properties && cat version.properties
      shell: bash
    - name: Launch uberjar
      run: >-
        java --add-opens java.base/java.nio=ALL-UNNAMED -jar ./bin/docker/metabase.jar &
      shell: bash
    - name: Wait for Metabase to start
      run: while ! curl 'http://localhost:3000/api/health' | grep '{"status":"ok"}'; do sleep 1; done
      shell: bash
    - name: Kill the java process
      run: pkill -f metabase.jar
      shell: bash
    - name: configure aws credentials
      if: ${{ github.ref_name == 'master' }}
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ inputs.iam-role }}
        role-session-name: GitHub_to_AWS_via_FederatedOIDC
        aws-region: us-east-1
    - name: Login to Amazon ECR
      if: ${{ github.ref_name == 'master' }}
      uses: aws-actions/amazon-ecr-login@v2
