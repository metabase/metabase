(ns metabase-enterprise.metabot-v3.agent.profiles-test
  (:require
   [clojure.test :refer :all]
   [metabase-enterprise.metabot-v3.agent.profiles :as profiles]))

(deftest get-profile-test
  (letfn [(tool-names [profile]
            (set (map (comp :tool-name meta) (:tools profile))))]
    (testing "retrieves embedding_next profile"
      (let [profile (profiles/get-profile :embedding_next)]
        (is (some? profile))
        (is (= "claude-haiku-4-5" (:model profile)))
        (is (= 10 (:max-iterations profile)))
        (is (= 0.3 (:temperature profile)))
        (is (vector? (:tools profile)))
        (is (contains? (tool-names profile) "construct_notebook_query"))
        (is (contains? (tool-names profile) "list_available_data_sources"))))

    (testing "retrieves internal profile"
      (let [profile (profiles/get-profile :internal)]
        (is (some? profile))
        (is (= "claude-haiku-4-5" (:model profile)))
        (is (= 10 (:max-iterations profile)))
        (is (= 0.3 (:temperature profile)))
        (is (vector? (:tools profile)))
      ;; Should have more tools than embedding_next profile
        (is (> (count (:tools profile)) 5))
        (is (contains? (tool-names profile) "search"))
        (is (contains? (tool-names profile) "create_sql_query"))
        (is (contains? (tool-names profile) "create_chart"))))

    (testing "retrieves transforms_codegen profile"
      (let [profile (profiles/get-profile :transforms_codegen)]
        (is (some? profile))
        (is (= "claude-haiku-4-5" (:model profile)))
        (is (= 30 (:max-iterations profile)))
        (is (= 0.3 (:temperature profile)))
        (is (vector? (:tools profile)))
        (is (contains? (tool-names profile) "search"))
        (is (contains? (tool-names profile) "get_transform_details"))
        (is (contains? (tool-names profile) "list_available_fields"))))

    (testing "retrieves sql profile"
      (let [profile (profiles/get-profile :sql)]
        (is (some? profile))
        (is (= "claude-haiku-4-5" (:model profile)))
        (is (= 10 (:max-iterations profile)))
        (is (= 0.3 (:temperature profile)))
        (is (contains? (tool-names profile) "search"))
        (is (contains? (tool-names profile) "create_sql_query"))))

    (testing "retrieves nlq profile"
      (let [profile (profiles/get-profile :nlq)]
        (is (some? profile))
        (is (= "claude-haiku-4-5" (:model profile)))
        (is (= 10 (:max-iterations profile)))
        (is (= 0.3 (:temperature profile)))
        (is (contains? (tool-names profile) "search"))
        (is (contains? (tool-names profile) "construct_notebook_query"))))

    (testing "returns nil for unknown profile"
      (is (nil? (profiles/get-profile :unknown-profile))))

    (testing "all profiles have required keys"
      (doseq [profile-id [:embedding_next :internal :transforms_codegen :sql :nlq]]
        (let [profile (profiles/get-profile profile-id)]
          (is (contains? profile :model))
          (is (contains? profile :max-iterations))
          (is (contains? profile :temperature))
          (is (contains? profile :tools))
          (is (every? var? (:tools profile))))))))

(deftest get-tools-for-profile-capabilities-test
  (testing "filters tools by capabilities"
    (testing "empty capabilities excludes capability-gated tools"
      (let [tools (profiles/get-tools-for-profile :internal [])]
        (is (contains? tools "search"))
        (is (not (contains? tools "navigate_user")))
        (is (not (contains? tools "create_autogenerated_dashboard")))))

    (testing "partial capabilities includes matching tools"
      (let [tools (profiles/get-tools-for-profile :internal [:frontend-navigate-user-v1])]
        (is (contains? tools "navigate_user"))
        (is (not (contains? tools "create_autogenerated_dashboard")))))

    (testing "full capabilities includes all tools"
      (let [tools (profiles/get-tools-for-profile :internal [:frontend-navigate-user-v1 :automagic-dashboards])]
        (is (contains? tools "navigate_user"))
        (is (contains? tools "create_autogenerated_dashboard"))))))

(deftest get-tools-for-profile-string-capabilities-test
  (testing "capabilities as strings (as sent by the API / benchmark client)"
    (testing "NLQ-only capabilities should exclude SQL tools and include navigate_user"
      (let [;; This is what the NLQ benchmark actually sends via the API:
            nlq-capabilities ["frontend:navigate_user_v1"
                              "permission:save_questions"]
            tools (profiles/get-tools-for-profile :internal nlq-capabilities)]
        (is (contains? tools "search") "search should always be available")
        (is (contains? tools "construct_notebook_query") "notebook queries should be available")
        (is (contains? tools "read_resource") "read_resource should always be available")
        (is (contains? tools "navigate_user")
            "navigate_user should be available when frontend:navigate_user_v1 is in capabilities")
        (is (not (contains? tools "create_sql_query"))
            "create_sql_query should NOT be available without permission:write_sql_queries")
        (is (not (contains? tools "edit_sql_query"))
            "edit_sql_query should NOT be available without permission:write_sql_queries")
        (is (not (contains? tools "replace_sql_query"))
            "replace_sql_query should NOT be available without permission:write_sql_queries")))

    (testing "full capabilities including SQL write permission should include SQL tools"
      (let [full-capabilities ["frontend:navigate_user_v1"
                               "permission:save_questions"
                               "permission:write_sql_queries"]
            tools (profiles/get-tools-for-profile :internal full-capabilities)]
        (is (contains? tools "search"))
        (is (contains? tools "construct_notebook_query"))
        (is (contains? tools "navigate_user")
            "navigate_user should be available with frontend:navigate_user_v1")
        (is (contains? tools "create_sql_query")
            "create_sql_query should be available with permission:write_sql_queries")
        (is (contains? tools "edit_sql_query")
            "edit_sql_query should be available with permission:write_sql_queries")
        (is (contains? tools "replace_sql_query")
            "replace_sql_query should be available with permission:write_sql_queries")))

    (testing "empty capabilities should exclude all capability-gated tools"
      (let [tools (profiles/get-tools-for-profile :internal [])]
        (is (contains? tools "search") "ungated tools should remain")
        (is (not (contains? tools "navigate_user")))
        (is (not (contains? tools "create_sql_query"))
            "SQL tools should be gated by permission:write_sql_queries")
        (is (not (contains? tools "create_autogenerated_dashboard")))))))
