name: Cross-branch migration test

inputs:
  base-ref:
    required: true

runs:
  using: "composite"
  steps:
    - name: Check out master request branch
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.base-ref }}

    - name: Prepare backend environment
      uses: ./.github/actions/prepare-backend
      with:
        m2-cache-key: cross-branch-migrations

    - name: Run backend on master
      run: nohup clojure -M:run:ee & echo $! > metabase_pid
      shell: bash

    - name: Wait for Metabase to start
      run: |
        while ! curl 'http://localhost:3000/api/health' | grep '{"status":"ok"}'; do
          if ! kill -0 $(cat metabase_pid) 2>/dev/null; then
            echo "Metabase process has exited."
            exit 1
          fi
          sleep 1
        done
      shell: bash

    - name: Stop Metabase on master
      run: kill $(cat metabase_pid)
      shell: bash

    - name: Check out pull request branch
      uses: actions/checkout@v4
      with:
        ref: ${{ github.head_ref }}

    - name: Run backend on pull request branch
      run: nohup clojure -M:run:ee & echo $! > metabase_pid
      shell: bash

    - name: Wait for Metabase to start
      run: |
        while ! curl 'http://localhost:3000/api/health' | grep '{"status":"ok"}'; do
          if ! kill -0 $(cat metabase_pid) 2>/dev/null; then
            echo "Metabase process has exited. Check that your migration changes work on an instance that has been previously initialized on ${{ inputs.base_ref }}."
            exit 1
          fi
          sleep 1
        done
      shell: bash

    - name: Stop Metabase on pull request branch
      run: kill $(cat metabase_pid)
      shell: bash
