#!/usr/bin/env bash

set -euo pipefail

# Load shared utilities
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/utils/all.sh"

# Script-specific print functions
print_found() {
    print_success "$1"
}

print_not_found() {
    print_error "$1"
}

print_optional_tool() {
    local cmd=$1
    local name=$2
    local url=$3
    if has_tool "$cmd"; then
        echo -e "    ${GREEN}âœ“${NC} $name"
    else
        echo -e "    ${RED}âœ—${NC} $name"
    fi
    echo -e "      ${DIM}$url${NC}"
}

main() {
    print_header "Metabase Development Environment Detection"

    echo "This script detects your current development tool setup and provides"
    echo "guidance on how to prepare your environment for Metabase development."
    echo ""
    echo "Note: This script only detects and reports. It will not modify your system."

    print_section "Version Managers Detected"

    managers=($(detect_version_managers))

    if [ ${#managers[@]} -eq 0 ]; then
        print_info "No version managers detected"
        echo "     You may be using system-installed tools or manual installations."
    else
        for manager in "${managers[@]}"; do
            print_found "$manager"
        done

        # Check for conflicts
        if [ ${#managers[@]} -gt 1 ]; then
            echo ""
            print_warning "Multiple version managers detected!"
            echo "     Having multiple version managers can cause conflicts where different"
            echo "     tools compete to manage the same runtime versions. This may lead to:"
            echo "       - Unexpected version switches"
            echo "       - PATH conflicts"
            echo "       - Shell initialization slowdowns"
            echo ""
            echo -e "  ðŸ’¡ ${BOLD}Recommendation:${NC} Use only one version manager (we recommend mise)."
        fi
    fi

    print_section "Installed Development Tools"

    # Track issues for final summary
    issues=()

    # Node.js
    node_version=$(get_node_version)
    if [ -n "$node_version" ]; then
        node_major=$(echo "$node_version" | sed 's/v//' | cut -d. -f1)
        if [ "$node_major" -ge 22 ]; then
            print_found "Node.js $node_version (meets requirement: >= 22)"
        else
            print_warning "Node.js $node_version (required: >= 22)"
            issues+=("Node.js: version $node_version is too old (need >= 22)")
        fi
    else
        print_not_found "Node.js (required: >= 22)"
        issues+=("Node.js: not installed (need >= 22)")
    fi

    # pnpm
    pnpm_version=$(get_pnpm_version)
    if [ -n "$pnpm_version" ]; then
        if check_pnpm_version "$pnpm_version"; then
            print_found "pnpm $pnpm_version (meets requirement: >= 9)"
        else
            print_warning "pnpm $pnpm_version (required: >= 9)"
            issues+=("pnpm: version $pnpm_version is not >= 9")
        fi
    else
        print_not_found "pnpm (required: >= 9)"
        issues+=("pnpm: not installed (need pnpm >= 9)")
    fi

    # Java
    java_version=$(get_java_version)
    java_distribution=$(get_java_distribution)
    java_status=$(check_java_requirements "$java_version" "$java_distribution")

    case "$java_status" in
        "correct")
            print_found "Java $java_version ($java_distribution) - correct!"
            ;;
        "wrong_distribution")
            print_warning "Java $java_version ($java_distribution)"
            echo "     Required: Java 21 (Eclipse Temurin)"
            issues+=("Java: wrong distribution '$java_distribution' (need Eclipse Temurin)")
            ;;
        "wrong_version")
            print_warning "Java $java_version ($java_distribution)"
            echo "     Required: Java 21 (Eclipse Temurin)"
            issues+=("Java: version $java_version is incorrect (need Java 21)")
            ;;
        "not_installed")
            print_not_found "Java (required: Java 21 Eclipse Temurin)"
            issues+=("Java: not installed (need Java 21 Eclipse Temurin)")
            ;;
    esac

    # Clojure CLI
    clojure_version=$(get_clojure_version)
    required_clojure_version=$(get_required_clojure_version)

    if [ -n "$clojure_version" ]; then
        if [ -n "$required_clojure_version" ]; then
            print_found "Clojure CLI ($clojure_version) - requires Clojure $required_clojure_version"
        else
            print_found "Clojure CLI ($clojure_version)"
        fi
    else
        if [ -n "$required_clojure_version" ]; then
            print_not_found "Clojure CLI (required for Clojure $required_clojure_version)"
            issues+=("Clojure CLI: not installed (need for Clojure $required_clojure_version)")
        else
            print_not_found "Clojure CLI"
            issues+=("Clojure CLI: not installed")
        fi
    fi

    # Babashka
    bb_version=$(get_babashka_version)
    if [ -n "$bb_version" ]; then
        print_found "Babashka $bb_version"
    else
        print_not_found "Babashka (required for mage task automation)"
        issues+=("Babashka: not installed (needed for mage)")
    fi

    print_section "Metabase Project Requirements"

    required_clojure_version=$(get_required_clojure_version)

    echo -e "  ${BOLD}Required Tools:${NC}"
    echo "    - Node.js >= 22 (currently specified in .nvmrc)"
    echo "    - pnpm >= 9"
    echo "    - Java 21 with Eclipse Temurin distribution (for Clojure backend)"
    if [ -n "$required_clojure_version" ]; then
        echo "    - Clojure CLI (for Clojure $required_clojure_version specified in deps.edn)"
    else
        echo "    - Clojure CLI"
    fi
    echo "    - Babashka (for mage task automation)"
    echo ""
    echo -e "  ${BOLD}Optional Tools (quality of life):${NC}"
    print_optional_tool bat "bat - A cat clone with syntax highlighting" "https://github.com/sharkdp/bat"
    print_optional_tool fzf "fzf - A fuzzy finder for the terminal" "https://github.com/junegunn/fzf"
    print_optional_tool fd "fd - A fast alternative to find" "https://github.com/sharkdp/fd"
    print_optional_tool rg "ripgrep - A fast alternative to grep" "https://github.com/BurntSushi/ripgrep"
    print_optional_tool gh "gh - GitHub CLI" "https://cli.github.com/"
    print_optional_tool op "op - 1Password CLI" "https://1password.com/downloads/command-line/"
    print_optional_tool aws "aws - AWS CLI" "https://aws.amazon.com/cli/"
    print_optional_tool orb "OrbStack - Fast Docker & Linux on macOS" "https://orbstack.dev/"

    print_section "Recommended Setup"

    echo ""
    echo -e "  ${BOLD}${GREEN}We recommend using 'mise'${NC} for version management because:"
    echo "    - Manages Node.js, Java, and other tools in one place"
    echo "    - Automatically switches versions per-project"
    echo "    - Cross-platform and actively maintained"
    echo ""
    echo "    Learn more: https://mise.jdx.dev/getting-started.html"

    if has_tool mise; then
        echo ""
        echo -e "  ${BOLD}${GREEN}Good news!${NC} You have mise installed."
        echo "  If you haven't already, consider configuring Metabase to use mise via 'bin/dev-install'."
        echo ""
        
        echo "Running 'mise doctor' to check your mise setup..."
        if mise doctor &>/dev/null; then
            print_success "${BOLD}mise doctor${NC} gives you a clean bill of health ðŸ©º"
        else
            print_error "mise doctor found some issues:"
            echo ""
            mise doctor
        fi
    else
        echo ""
        echo -e "  ${BOLD}Next Steps:${NC}"
        echo "    - Run './bin/dev-install' to set up your development environment automatically."
    fi

    # Final Verdict
    print_header "Verdict"

    if [ ${#issues[@]} -eq 0 ]; then
        echo ""
        echo -e "  ${BOLD}${GREEN}âœ“ You're good to go!${NC} All requirements met."
        echo "  Your dev environment is ready to build Metabase. ðŸš€"
        echo ""
        echo ""
    else
        echo ""
        echo -e "  ${BOLD}${RED}âœ— Not quite there yet.${NC} Found ${#issues[@]} issue(s):"
        echo ""
        for issue in "${issues[@]}"; do
            echo -e "    ${RED}â€¢${NC} $issue"
        done
        echo ""
        echo -e "  ${BOLD}Tip:${NC} Run ${GREEN}${BOLD}./bin/dev-install${NC} to fix these automatically."
        echo ""
        echo ""
    fi

    echo "For detailed development environment setup, see:"
    echo "  docs/developers-guide/devenv.md"
    echo ""
    echo "To re-run this detection script:"
    echo "  ./bin/dev-requirements"
    echo ""
}

main "$@"
