databaseChangeLog:
  - objectQuotingStrategy: QUOTE_ALL_OBJECTS
  - changeSet:
      id: v59.2025-12-04T12:00:00
      author: metabase
      comment: Create measure table for saved aggregation expressions
      changes:
        - createTable:
            tableName: measure
            remarks: Stores saved aggregation expressions tied to tables
            columns:
              - column:
                  name: id
                  type: int
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: table_id
                  type: int
                  remarks: Foreign key to metabase_table
                  constraints:
                    nullable: false
              - column:
                  name: creator_id
                  type: int
                  remarks: Foreign key to core_user who created this measure
                  constraints:
                    nullable: false
              - column:
                  name: name
                  type: varchar(254)
                  remarks: Name of the measure
                  constraints:
                    nullable: false
              - column:
                  name: description
                  type: ${text.type}
                  remarks: Optional description of the measure
                  constraints:
                    nullable: true
              - column:
                  name: archived
                  type: ${boolean.type}
                  defaultValueBoolean: false
                  remarks: Whether the measure has been archived
                  constraints:
                    nullable: false
              - column:
                  name: definition
                  type: ${text.type}
                  remarks: JSON MBQL query containing the aggregation definition
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: ${timestamp_type}
                  remarks: Timestamp when this measure was created
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: ${timestamp_type}
                  remarks: Timestamp when this measure was last updated
                  constraints:
                    nullable: false
              - column:
                  name: entity_id
                  type: char(21)
                  remarks: Random NanoID tag for unique identity
                  constraints:
                    nullable: true
                    unique: true
              - column:
                  name: dependency_analysis_version
                  type: integer
                  defaultValueNumeric: 0
                  remarks: Version number for dependency analysis to track when dependencies need recalculation
                  constraints:
                    nullable: false
      rollback:
        - dropTable:
            tableName: measure

  - changeSet:
      id: v59.2025-12-04T12:00:01
      author: metabase
      comment: Add index on measure.table_id
      changes:
        - createIndex:
            tableName: measure
            indexName: idx_measure_table_id
            columns:
              - column:
                  name: table_id
      rollback:
        - dropIndex:
            tableName: measure
            indexName: idx_measure_table_id

  - changeSet:
      id: v59.2025-12-04T12:00:02
      author: metabase
      comment: Add foreign key from measure to metabase_table
      changes:
        - addForeignKeyConstraint:
            baseTableName: measure
            baseColumnNames: table_id
            referencedTableName: metabase_table
            referencedColumnNames: id
            constraintName: fk_measure_ref_table_id
            onDelete: CASCADE
      rollback:
        - dropForeignKeyConstraint:
            baseTableName: measure
            constraintName: fk_measure_ref_table_id

  - changeSet:
      id: v59.2025-12-04T12:00:03
      author: metabase
      comment: Add index on measure.creator_id
      changes:
        - createIndex:
            tableName: measure
            indexName: idx_measure_creator_id
            columns:
              - column:
                  name: creator_id
      rollback:
        - dropIndex:
            tableName: measure
            indexName: idx_measure_creator_id

  - changeSet:
      id: v59.2025-12-04T12:00:04
      author: metabase
      comment: Add foreign key from measure to core_user
      changes:
        - addForeignKeyConstraint:
            baseTableName: measure
            baseColumnNames: creator_id
            referencedTableName: core_user
            referencedColumnNames: id
            constraintName: fk_measure_ref_creator_id
            onDelete: CASCADE
      rollback:
        - dropForeignKeyConstraint:
            baseTableName: measure
            constraintName: fk_measure_ref_creator_id

  - changeSet:
      id: v59.2026-01-07T00:00:01
      author: bshepherdson
      comment: Create analysis finding table
      changes:
        - createTable:
            tableName: analysis_finding
            remarks: Findings from analysis of cards, transforms, dashboards, etc.
            columns:
              - column:
                  name: id
                  remarks: Unique ID
                  type: int
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: analyzed_entity_type
                  type: varchar(254)
                  remarks: The type of the analyzed entity
                  constraints:
                    nullable: false
              - column:
                  name: analyzed_entity_id
                  type: int
                  remarks: The ID of the analyzed entity
                  constraints:
                    nullable: false
              - column:
                  name: analysis_version
                  remarks: The version of the analysis that was performed
                  type: int
                  constraints:
                    nullable: false
              - column:
                  name: analyzed_at
                  remarks: The timestamp of when the analysis was performed
                  type: ${timestamp_type}
                  defaultValueComputed: current_timestamp
                  constraints:
                    nullable: false
              - column:
                  name: result
                  type: ${boolean.type}
                  remarks: The result of the analysis - true for passed, false for failed
                  constraints:
                    nullable: false
              - column:
                  name: finding_details
                  type: ${text.type}
                  remarks: Arbitrary EDN text of the findings
                  constraints:
                    nullable: true

  - changeSet:
      id: v59.2026-01-07T00:00:02
      author: bshepherdson
      comment: Unique constraint to prevent duplicate analyses
      changes:
        - addUniqueConstraint:
            tableName: analysis_finding
            columnNames: analyzed_entity_type, analyzed_entity_id
            constraintName: idx_unique_analysis_finding

  - changeSet:
      id: v59.2026-01-07T00:00:03
      author: bshepherdson
      comment: Index for analysis_finding by analyzed entity
      changes:
        - createIndex:
            tableName: analysis_finding
            indexName: idx_analyzed_entity
            columns:
              - column:
                  name: analyzed_entity_type
              - column:
                  name: analyzed_entity_id

  - changeSet:
      id: v59.2026-01-07T00:00:04
      author: bshepherdson
      comment: Index for analysis_finding by analysis result
      changes:
        - createIndex:
            tableName: analysis_finding
            indexName: idx_analysis_result
            columns:
              - column:
                  name: result

  - changeSet:
      id: v59.2026-01-12T15:30:00
      author: bronsa
      comment: Create task_run table for grouping related tasks
      changes:
        - createTable:
            tableName: task_run
            remarks: Groups related tasks from a single operation (subscription, alert, sync, fingerprint)
            columns:
              - column:
                  name: id
                  type: int
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: run_type
                  type: varchar(32)
                  remarks: "Type of run: subscription, alert, sync, fingerprint"
                  constraints:
                    nullable: false
              - column:
                  name: entity_type
                  type: varchar(32)
                  remarks: "Type of associated entity: database, card, dashboard"
                  constraints:
                    nullable: false
              - column:
                  name: entity_id
                  type: int
                  remarks: ID of associated entity
                  constraints:
                    nullable: false
              - column:
                  name: started_at
                  type: ${timestamp_type}
                  remarks: When the run started
                  defaultValueComputed: current_timestamp
                  constraints:
                    nullable: false
              - column:
                  name: ended_at
                  type: ${timestamp_type}
                  remarks: When the run completed (null if still running)
                  constraints:
                    nullable: true
              - column:
                  name: status
                  type: varchar(21)
                  remarks: "Overall status: started, success, failed"
                  constraints:
                    nullable: false
      rollback:
        - dropTable:
            tableName: task_run

  - changeSet:
      id: v59.2026-01-12T15:30:01
      author: bronsa
      comment: Add composite index on task_run for type/entity queries
      changes:
        - createIndex:
            tableName: task_run
            indexName: idx_task_run_type_entity
            columns:
              - column:
                  name: run_type
              - column:
                  name: entity_type
              - column:
                  name: entity_id
      rollback:
        - dropIndex:
            tableName: task_run
            indexName: idx_task_run_type_entity

  - changeSet:
      id: v59.2026-01-12T15:30:02
      author: bronsa
      comment: Add index on task_run.started_at for ordering
      changes:
        - createIndex:
            tableName: task_run
            indexName: idx_task_run_started_at
            columns:
              - column:
                  name: started_at
                  descending: true
      rollback:
        - dropIndex:
            tableName: task_run
            indexName: idx_task_run_started_at

  - changeSet:
      id: v59.2026-01-12T15:30:03
      author: bronsa
      comment: Add run_id column to task_history
      changes:
        - addColumn:
            tableName: task_history
            columns:
              - column:
                  name: run_id
                  type: int
                  remarks: FK to task_run - groups tasks belonging to the same run
                  constraints:
                    nullable: true
      rollback:
        - dropColumn:
            tableName: task_history
            columnName: run_id

  - changeSet:
      id: v59.2026-01-12T15:30:04
      author: bronsa
      comment: Add index on task_history.run_id
      changes:
        - createIndex:
            tableName: task_history
            indexName: idx_task_history_run_id
            columns:
              - column:
                  name: run_id
      rollback:
        - dropIndex:
            tableName: task_history
            indexName: idx_task_history_run_id

  - changeSet:
      id: v59.2026-01-12T15:30:05
      author: bronsa
      comment: Add foreign key from task_history.run_id to task_run
      changes:
        - addForeignKeyConstraint:
            baseTableName: task_history
            baseColumnNames: run_id
            referencedTableName: task_run
            referencedColumnNames: id
            constraintName: fk_task_history_run_id
            onDelete: CASCADE
      rollback:
        - dropForeignKeyConstraint:
            baseTableName: task_history
            constraintName: fk_task_history_run_id

  - changeSet:
      id: v59.2026-01-12T15:30:06
      author: bronsa
      comment: Add logs column to task_history for captured execution logs
      changes:
        - addColumn:
            tableName: task_history
            columns:
              - column:
                  name: logs
                  type: ${text.type}
                  remarks: JSON array of captured log messages during task execution
                  constraints:
                    nullable: true
      rollback:
        - dropColumn:
            tableName: task_history
            columnName: logs

  - changeSet:
      id: v59.2026-01-15T10:00:00
      author: bronsa
      comment: Add process_uuid to task_run for orphan detection
      changes:
        - addColumn:
            tableName: task_run
            columns:
              - column:
                  name: process_uuid
                  type: varchar(36)
                  remarks: UUID of the Metabase instance that created this run
                  constraints:
                    nullable: true
      rollback:
        - dropColumn:
            tableName: task_run
            columnName: process_uuid

  - changeSet:
      id: v59.2026-01-15T10:00:01
      author: bronsa
      comment: Add updated_at to task_run for heartbeat tracking
      changes:
        - addColumn:
            tableName: task_run
            columns:
              - column:
                  name: updated_at
                  type: ${timestamp_type}
                  remarks: Last heartbeat timestamp - updated hourly for running tasks
                  constraints:
                    nullable: true
      rollback:
        - dropColumn:
            tableName: task_run
            columnName: updated_at

# >>>>>>>>>> DO NOT ADD NEW MIGRATIONS BELOW THIS LINE! ADD THEM ABOVE <<<<<<<<<<

########################################################################################################################
#
# ADVICE:
#
# 1) Think through some of these points when writing a migration, learn from our past mistakes:
#    - Do you really need a migration? Could the feature work without it? Prefer not to if possible.
#      Data in the wild can be vastly different from what you expect, and it's hard to get right.
#    - Make sure your migration is backward compatible: it might not be possible to add a constraint back
#      if you drop it in a migration.
#    - Postgres, MySQL and H2 have their differences. Make sure your migration works for all.
#    - Database encryption is a major issue:
#      - Fields like `metabase_database.details` or `setting.value` can be encrypted, so you need to decrypt them in
#        your migration. See #42617, #44048.
#      - Database could be partially encrypted, see https://www.notion.so/72575933ef2a446bafd16909e05a7387
#    - Custom migrations:
#      - Prefer SQL migrations when possible.
#      - Never use application code: it can change and *will* break your migration.
#      - Do not use Toucan models - refer table names directly.
#      - If it's a big change, consider using Quartz, see #42279
#      - More in `metabase.app_db.custom_migrations` namespace doc.
#    - Never delete a migration: users won't be able to downgrade. If you really need to, see #44908
#    - Migration id (`vXX.<date>`) must match its earliest released version:
#      - Do not backport `v51....` to version 50, Metabase will try to downgrade it.
#      - Instead, write a migration with an oldest target you plan to backport to in mind.
#
# 2) Migrations should go in the ###_update_migrations.yaml file for the target version.
#
# 3) Run mage lint-migrations to run core.spec checks against any changes you make here. Liquibase is pretty
#    forgiving and won't complain if you accidentally mix up things like deleteCascade and onDelete: CASCADE. CI runs
#    this check but it's nicer to know now instead of waiting for CI.
#
# 3) Migration IDs should follow the format
#
#    vMM.TIMESTAMP
#
#    Where
#
#    M         = major version
#    TIMESTAMP = the current timestamp with format `yyyy-MM-dd'T'HH:mm:ss`
#                To get this timestamp, evaluate this in your REPL: `(dev/migration-timestamp)`
#
#    E.g: You're adding a new migration for version 49, And it's 10:30:00AM on April 1, 2023 (UTC),
#    your migration id should be: `v49.2023-04-01T10:30:00`.
#
# PLEASE KEEP THIS MESSAGE AT THE BOTTOM OF THIS FILE!!!!! Add new migrations above the message.
#
########################################################################################################################
