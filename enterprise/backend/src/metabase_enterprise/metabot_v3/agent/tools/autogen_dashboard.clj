(ns metabase-enterprise.metabot-v3.agent.tools.autogen-dashboard
  "Autogenerated dashboard tool wrappers."
  (:require
   [metabase-enterprise.metabot-v3.agent.tools.shared :as shared]
   [metabase-enterprise.metabot-v3.tools.create-autogenerated-dashboard :as autogen-dashboard-tools]
   [metabase.util.log :as log]
   [metabase.util.malli :as mu]))

(set! *warn-on-reflection* true)

(mu/defn ^{:tool-name "create_autogenerated_dashboard"
           :capabilities #{:automagic-dashboards}}
  create-autogenerated-dashboard-tool
  "Create an automatically generated dashboard using Metabase's X-ray feature.

  X-ray builds complete dashboards with multiple visualizations that showcase
  different aspects of your data - distributions, breakdowns by categories,
  trends over time, and relationships between fields.

  Specify one source type:
  - table_id: Create dashboard for a table
  - model_id: Create dashboard for a model
  - metric_id: Create dashboard for a metric
  - query_id: Create dashboard for query results from this conversation
  - report_id: Create dashboard for an existing report/question"
  [{:keys [source]}
   :- [:map {:closed true}
       [:source [:map
                 [:table_id {:optional true} [:maybe :int]]
                 [:model_id {:optional true} [:maybe :int]]
                 [:metric_id {:optional true} [:maybe :int]]
                 [:query_id {:optional true} [:maybe :string]]
                 [:report_id {:optional true} [:maybe :int]]]]]]
  (try
    (let [result (autogen-dashboard-tools/create-autogenerated-dashboard
                  {:source source
                   :memory-atom shared/*memory-atom*})
          reactions (:reactions result)]
      (cond-> {:structured-output (:structured-output result)
               :final-response? (:final-response? result)
               :instructions (:instructions result)}
        (seq reactions) (assoc :reactions reactions)))
    (catch Exception e
      (log/error e "Error creating autogenerated dashboard")
      (if (:agent-error? (ex-data e))
        {:output (ex-message e)}
        {:output (str "Failed to create autogenerated dashboard: " (or (ex-message e) "Unknown error"))}))))
