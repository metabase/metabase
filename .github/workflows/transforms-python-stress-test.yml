name: Transforms Python Stress Test

on:
  push:
    branches:
      # Temporary: remove this after merging to master
      - 'wotbrew/GDGT-1661-transform-stress-test2'
  workflow_dispatch:
    inputs:
      ref:
        description: 'Branch name or commit SHA to checkout'
        type: string
        required: false
        default: ''
      driver:
        description: 'Which driver(s) to test'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - bigquery
          - clickhouse
          - mongo
          - mysql
          - postgres
          - redshift
          - snowflake
          - sqlserver

jobs:

  be-tests-bigquery-transforms:
    # inputs.driver is empty on push triggers, so treat '' as 'all'
    if: ${{ inputs.driver == 'all' || inputs.driver == '' || inputs.driver == 'bigquery' }}
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      CI: 'true'
      DRIVERS: bigquery-cloud-sdk
      MB_BIGQUERY_TEST_PROJECT_ID: ${{ secrets.BIGQUERY_TEST_PROJECT_ID }}
      MB_BIGQUERY_TEST_CLIENT_ID: ${{ secrets.MB_BIGQUERY_TEST_CLIENT_ID }}
      MB_BIGQUERY_TEST_CLIENT_SECRET: ${{ secrets.MB_BIGQUERY_TEST_CLIENT_SECRET }}
      MB_BIGQUERY_TEST_ACCESS_TOKEN: ${{ secrets.MB_BIGQUERY_TEST_ACCESS_TOKEN }}
      MB_BIGQUERY_TEST_REFRESH_TOKEN: ${{ secrets.MB_BIGQUERY_TEST_REFRESH_TOKEN }}
      MB_BIGQUERY_CLOUD_SDK_TEST_SERVICE_ACCOUNT_JSON: ${{ secrets.MB_BIGQUERY_CLOUD_SDK_TEST_SERVICE_ACCOUNT_JSON }}
      MB_BIGQUERY_CLOUD_SDK_TEST_SERVICE_ACCOUNT_JSON_ROUTING: ${{ secrets.MB_BIGQUERY_CLOUD_SDK_TEST_SERVICE_ACCOUNT_JSON_ROUTING }}
    name: BigQuery Transforms
    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ inputs.ref || github.ref }}
    - name: Setup python-runner
      uses: ./.github/actions/setup-python-runner
      with:
        metabase-automation-token: ${{ secrets.METABASE_AUTOMATION_USER_TOKEN }}
    - name: Test BigQuery transforms
      id: test-driver
      uses: ./.github/actions/test-driver
      with:
        junit-name: 'be-tests-bigquery-transforms'
        test-args: >-
          :only-tags [:mb/transforms-python-test]
    - name: Upload Test Results
      uses: ./.github/actions/upload-test-results
      if: always()
      with:
        input-path: ./target/junit/
        output-name: ${{ github.job }}
        bucket: ${{ vars.AWS_S3_TEST_RESULTS_BUCKET }}
        aws-access-key-id: ${{ secrets.AWS_TEST_RESULTS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_TEST_RESULTS_SECRET_ACCESS_KEY }}
        aws-region: ${{ vars.AWS_REGION }}
        trunk-api-token: ${{ secrets.TRUNK_API_TOKEN }}
    - name: Cleanup python-runner
      if: always()
      uses: ./.github/actions/cleanup-python-runner
      with:
        upload-logs: ${{ steps.test-driver.outcome == 'failure' }}
        logs-artifact-suffix: BigQuery Transforms

  be-tests-clickhouse-transforms:
    if: ${{ inputs.driver == 'all' || inputs.driver == '' || inputs.driver == 'clickhouse' }}
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      CI: 'true'
      DRIVERS: clickhouse
      MB_CLICKHOUSE_TEST_HOST: localhost
      MB_CLICKHOUSE_TEST_PORT: 8123
      MB_CLICKHOUSE_TEST_OLD_PORT: 8124
      MB_CLICKHOUSE_TEST_NGINX_PORT: 8127
    name: ClickHouse Transforms
    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ inputs.ref || github.ref }}
    - name: Setup python-runner
      uses: ./.github/actions/setup-python-runner
      with:
        metabase-automation-token: ${{ secrets.METABASE_AUTOMATION_USER_TOKEN }}
    - name: Add ClickHouse TLS instance to /etc/hosts
      run: |
        sudo echo "127.0.0.1 server.clickhouseconnect.test" | sudo tee -a /etc/hosts
    - name: Start ClickHouse in Docker
      uses: hoverkraft-tech/compose-action@v2.0.0
      with:
        compose-file: "modules/drivers/clickhouse/docker-compose.yml"
        down-flags: "--volumes"
        services: |
          clickhouse
          clickhouse_tls
          clickhouse_older_version
          clickhouse_cluster_node1
          clickhouse_cluster_node2
          nginx
    - name: Test ClickHouse transforms
      id: test-driver
      uses: ./.github/actions/test-driver
      with:
        junit-name: 'be-tests-clickhouse-transforms'
        test-args: >-
          :only-tags [:mb/transforms-python-test]
    - name: Upload Test Results
      uses: ./.github/actions/upload-test-results
      if: always()
      with:
        input-path: ./target/junit/
        output-name: ${{ github.job }}
        bucket: ${{ vars.AWS_S3_TEST_RESULTS_BUCKET }}
        aws-access-key-id: ${{ secrets.AWS_TEST_RESULTS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_TEST_RESULTS_SECRET_ACCESS_KEY }}
        aws-region: ${{ vars.AWS_REGION }}
        trunk-api-token: ${{ secrets.TRUNK_API_TOKEN }}
    - name: Cleanup python-runner
      if: always()
      uses: ./.github/actions/cleanup-python-runner
      with:
        upload-logs: ${{ steps.test-driver.outcome == 'failure' }}
        logs-artifact-suffix: ClickHouse Transforms

  be-tests-mongo-transforms:
    if: ${{ inputs.driver == 'all' || inputs.driver == '' || inputs.driver == 'mongo' }}
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      CI: 'true'
      DRIVERS: mongo
      MB_MONGO_TEST_USER: metabase
      MB_MONGO_TEST_PASSWORD: metasample123
    services:
      mongodb:
        image: mongo:latest
        ports:
          - "27017:27017"
        env:
          MONGO_INITDB_ROOT_USERNAME: metabase
          MONGO_INITDB_ROOT_PASSWORD: metasample123
    name: MongoDB Transforms
    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ inputs.ref || github.ref }}
    - name: Setup python-runner
      uses: ./.github/actions/setup-python-runner
      with:
        metabase-automation-token: ${{ secrets.METABASE_AUTOMATION_USER_TOKEN }}
    - name: Test MongoDB transforms
      id: test-driver
      uses: ./.github/actions/test-driver
      with:
        junit-name: 'be-tests-mongo-transforms'
        test-args: >-
          :only-tags [:mb/transforms-python-test]
    - name: Upload Test Results
      uses: ./.github/actions/upload-test-results
      if: always()
      with:
        input-path: ./target/junit/
        output-name: ${{ github.job }}
        bucket: ${{ vars.AWS_S3_TEST_RESULTS_BUCKET }}
        aws-access-key-id: ${{ secrets.AWS_TEST_RESULTS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_TEST_RESULTS_SECRET_ACCESS_KEY }}
        aws-region: ${{ vars.AWS_REGION }}
        trunk-api-token: ${{ secrets.TRUNK_API_TOKEN }}
    - name: Cleanup python-runner
      if: always()
      uses: ./.github/actions/cleanup-python-runner
      with:
        upload-logs: ${{ steps.test-driver.outcome == 'failure' }}
        logs-artifact-suffix: MongoDB Transforms

  be-tests-mysql-transforms:
    if: ${{ inputs.driver == 'all' || inputs.driver == '' || inputs.driver == 'mysql' }}
    runs-on: ubuntu-latest
    timeout-minutes: 60
    services:
      mysql:
        image: mysql:latest
        ports:
          - "3306:3306"
        env:
          MYSQL_ALLOW_EMPTY_PASSWORD: true
          MYSQL_DATABASE: circle_test
    env:
      CI: 'true'
      DRIVERS: mysql
      MB_DB_TYPE: mysql
      MB_DB_HOST: localhost
      MB_DB_PORT: 3306
      MB_DB_DBNAME: circle_test
      MB_DB_USER: root
      MB_MYSQL_TEST_USER: root
    name: MySQL Transforms
    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ inputs.ref || github.ref }}
    - name: Setup python-runner
      uses: ./.github/actions/setup-python-runner
      with:
        metabase-automation-token: ${{ secrets.METABASE_AUTOMATION_USER_TOKEN }}
    - name: Test MySQL transforms
      id: test-driver
      uses: ./.github/actions/test-driver
      with:
        junit-name: 'be-tests-mysql-transforms'
        test-args: >-
          :only-tags [:mb/transforms-python-test]
    - name: Upload Test Results
      uses: ./.github/actions/upload-test-results
      if: always()
      with:
        input-path: ./target/junit/
        output-name: ${{ github.job }}
        bucket: ${{ vars.AWS_S3_TEST_RESULTS_BUCKET }}
        aws-access-key-id: ${{ secrets.AWS_TEST_RESULTS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_TEST_RESULTS_SECRET_ACCESS_KEY }}
        aws-region: ${{ vars.AWS_REGION }}
        trunk-api-token: ${{ secrets.TRUNK_API_TOKEN }}
    - name: Cleanup python-runner
      if: always()
      uses: ./.github/actions/cleanup-python-runner
      with:
        upload-logs: ${{ steps.test-driver.outcome == 'failure' }}
        logs-artifact-suffix: MySQL Transforms

  be-tests-postgres-transforms:
    if: ${{ inputs.driver == 'all' || inputs.driver == '' || inputs.driver == 'postgres' }}
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      CI: 'true'
      DRIVERS: postgres
      MB_DB_TYPE: postgres
      MB_DB_PORT: 5432
      MB_DB_HOST: localhost
      MB_DB_DBNAME: mb_test
      MB_DB_USER: mb_test
      MB_POSTGRESQL_TEST_USER: mb_test
    services:
      postgres:
        image: postgres:latest
        ports:
          - "5432:5432"
        env:
          POSTGRES_USER: mb_test
          POSTGRES_DB: mb_test
          POSTGRES_HOST_AUTH_METHOD: trust
    name: Postgres Transforms
    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ inputs.ref || github.ref }}
    - name: Setup python-runner
      uses: ./.github/actions/setup-python-runner
      with:
        metabase-automation-token: ${{ secrets.METABASE_AUTOMATION_USER_TOKEN }}
    - name: Test Postgres transforms
      id: test-driver
      uses: ./.github/actions/test-driver
      with:
        junit-name: 'be-tests-postgres-transforms'
        test-args: >-
          :only-tags [:mb/transforms-python-test]
    - name: Upload Test Results
      uses: ./.github/actions/upload-test-results
      if: always()
      with:
        input-path: ./target/junit/
        output-name: ${{ github.job }}
        bucket: ${{ vars.AWS_S3_TEST_RESULTS_BUCKET }}
        aws-access-key-id: ${{ secrets.AWS_TEST_RESULTS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_TEST_RESULTS_SECRET_ACCESS_KEY }}
        aws-region: ${{ vars.AWS_REGION }}
        trunk-api-token: ${{ secrets.TRUNK_API_TOKEN }}
    - name: Cleanup python-runner
      if: always()
      uses: ./.github/actions/cleanup-python-runner
      with:
        upload-logs: ${{ steps.test-driver.outcome == 'failure' }}
        logs-artifact-suffix: Postgres Transforms

  be-tests-redshift-transforms:
    if: ${{ inputs.driver == 'all' || inputs.driver == '' || inputs.driver == 'redshift' }}
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      CI: 'true'
      DRIVERS: redshift
      MB_REDSHIFT_TEST_USER: metabase_ci
      MB_REDSHIFT_TEST_DB: testdb
      MB_REDSHIFT_TEST_DB_ROUTING: dev
      MB_REDSHIFT_TEST_HOST: ${{ secrets.MB_REDSHIFT_TEST_HOST }}
      MB_REDSHIFT_TEST_PASSWORD: ${{ secrets.MB_REDSHIFT_TEST_PASSWORD }}
    name: Redshift Transforms
    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ inputs.ref || github.ref }}
    - name: Setup python-runner
      uses: ./.github/actions/setup-python-runner
      with:
        metabase-automation-token: ${{ secrets.METABASE_AUTOMATION_USER_TOKEN }}
    - name: Test Redshift transforms
      id: test-driver
      uses: ./.github/actions/test-driver
      with:
        junit-name: 'be-tests-redshift-transforms'
        test-args: >-
          :only-tags [:mb/transforms-python-test]
    - name: Upload Test Results
      uses: ./.github/actions/upload-test-results
      if: always()
      with:
        input-path: ./target/junit/
        output-name: ${{ github.job }}
        bucket: ${{ vars.AWS_S3_TEST_RESULTS_BUCKET }}
        aws-access-key-id: ${{ secrets.AWS_TEST_RESULTS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_TEST_RESULTS_SECRET_ACCESS_KEY }}
        aws-region: ${{ vars.AWS_REGION }}
        trunk-api-token: ${{ secrets.TRUNK_API_TOKEN }}
    - name: Cleanup python-runner
      if: always()
      uses: ./.github/actions/cleanup-python-runner
      with:
        upload-logs: ${{ steps.test-driver.outcome == 'failure' }}
        logs-artifact-suffix: Redshift Transforms

  be-tests-snowflake-transforms:
    if: ${{ inputs.driver == 'all' || inputs.driver == '' || inputs.driver == 'snowflake' }}
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      CI: 'true'
      DRIVERS: snowflake
      MB_SNOWFLAKE_TEST_USER: METABASE CI
      MB_SNOWFLAKE_TEST_ACCOUNT: ${{ secrets.MB_SNOWFLAKE_TEST_ACCOUNT }}
      MB_SNOWFLAKE_TEST_PASSWORD: ${{ secrets.MB_SNOWFLAKE_TEST_PASSWORD }}
      MB_SNOWFLAKE_TEST_PRIVATE_KEY: ${{ secrets.MB_SNOWFLAKE_TEST_PRIVATE_KEY }}
      MB_SNOWFLAKE_TEST_WAREHOUSE: ${{ secrets.MB_SNOWFLAKE_TEST_WAREHOUSE }}
      MB_SNOWFLAKE_TEST_PK_USER: METABASE PK
      MB_SNOWFLAKE_TEST_PK_PRIVATE_KEY: ${{ secrets.MB_SNOWFLAKE_TEST_PK_PRIVATE_KEY }}
      MB_SNOWFLAKE_TEST_PK_PRIVATE_KEY_2: ${{ secrets.MB_SNOWFLAKE_TEST_PK_PRIVATE_KEY_2 }}
      MB_SNOWFLAKE_TEST_PK_PUBLIC_KEY: ${{ secrets.MB_SNOWFLAKE_TEST_PK_PUBLIC_KEY }}
      MB_SNOWFLAKE_TEST_PK_PUBLIC_KEY_2: ${{ secrets.MB_SNOWFLAKE_TEST_PK_PUBLIC_KEY_2 }}
      MB_SNOWFLAKE_TEST_RSA_ROLE_TEST_DEFAULT_USER: RSA_ROLE_TEST_DEFAULT_USER
      MB_SNOWFLAKE_TEST_RSA_ROLE_TEST_CUSTOM_USER: RSA_ROLE_TEST_CUSTOM_USER
      MB_SNOWFLAKE_TEST_RSA_ROLE_TEST_ROLE: RSA_ROLE_TEST_ROLE
      MB_SNOWFLAKE_TEST_RSA_ROLE_TEST_DB: RSA_ROLE_TEST_DB
    name: Snowflake Transforms
    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ inputs.ref || github.ref }}
    - name: Setup python-runner
      uses: ./.github/actions/setup-python-runner
      with:
        metabase-automation-token: ${{ secrets.METABASE_AUTOMATION_USER_TOKEN }}
    - name: Test Snowflake transforms
      id: test-driver
      uses: ./.github/actions/test-driver
      with:
        junit-name: 'be-tests-snowflake-transforms'
        test-args: >-
          :only-tags [:mb/transforms-python-test]
    - name: Upload Test Results
      uses: ./.github/actions/upload-test-results
      if: always()
      with:
        input-path: ./target/junit/
        output-name: ${{ github.job }}
        bucket: ${{ vars.AWS_S3_TEST_RESULTS_BUCKET }}
        aws-access-key-id: ${{ secrets.AWS_TEST_RESULTS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_TEST_RESULTS_SECRET_ACCESS_KEY }}
        aws-region: ${{ vars.AWS_REGION }}
        trunk-api-token: ${{ secrets.TRUNK_API_TOKEN }}
    - name: Cleanup python-runner
      if: always()
      uses: ./.github/actions/cleanup-python-runner
      with:
        upload-logs: ${{ steps.test-driver.outcome == 'failure' }}
        logs-artifact-suffix: Snowflake Transforms

  be-tests-sqlserver-transforms:
    if: ${{ inputs.driver == 'all' || inputs.driver == '' || inputs.driver == 'sqlserver' }}
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      CI: 'true'
      DRIVERS: sqlserver
      MB_SQLSERVER_TEST_HOST: localhost
      MB_SQLSERVER_TEST_PASSWORD: 'P@ssw0rd'
      MB_SQLSERVER_TEST_USER: SA
    services:
      sqlserver:
        image: mcr.microsoft.com/mssql/server:2022-latest
        ports:
          - "1433:1433"
        env:
          ACCEPT_EULA: Y
          SA_PASSWORD: 'P@ssw0rd'
          MSSQL_MEMORY_LIMIT_MB: 1024
    name: SQL Server Transforms
    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ inputs.ref || github.ref }}
    - name: Setup python-runner
      uses: ./.github/actions/setup-python-runner
      with:
        metabase-automation-token: ${{ secrets.METABASE_AUTOMATION_USER_TOKEN }}
    - name: Test SQL Server transforms
      id: test-driver
      uses: ./.github/actions/test-driver
      with:
        junit-name: 'be-tests-sqlserver-transforms'
        test-args: >-
          :only-tags [:mb/transforms-python-test]
    - name: Upload Test Results
      uses: ./.github/actions/upload-test-results
      if: always()
      with:
        input-path: ./target/junit/
        output-name: ${{ github.job }}
        bucket: ${{ vars.AWS_S3_TEST_RESULTS_BUCKET }}
        aws-access-key-id: ${{ secrets.AWS_TEST_RESULTS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_TEST_RESULTS_SECRET_ACCESS_KEY }}
        aws-region: ${{ vars.AWS_REGION }}
        trunk-api-token: ${{ secrets.TRUNK_API_TOKEN }}
    - name: Cleanup python-runner
      if: always()
      uses: ./.github/actions/cleanup-python-runner
      with:
        upload-logs: ${{ steps.test-driver.outcome == 'failure' }}
        logs-artifact-suffix: SQL Server Transforms

  transforms-stress-test-result:
    needs:
      - be-tests-bigquery-transforms
      - be-tests-clickhouse-transforms
      - be-tests-mongo-transforms
      - be-tests-mysql-transforms
      - be-tests-postgres-transforms
      - be-tests-redshift-transforms
      - be-tests-snowflake-transforms
      - be-tests-sqlserver-transforms
    runs-on: ubuntu-latest
    timeout-minutes: 5
    name: transforms-stress-test-result
    if: always() && !cancelled()
    steps:
      - name: Check job status
        uses: actions/github-script@v7
        env:
          needs: ${{ toJson(needs) }}
        with:
          script: |
            const needs = JSON.parse(process.env.needs);

            const jobs = Object.entries(needs).map(
              ([jobName, jobValues]) => ({
                name: jobName,
                result: jobValues.result
              }));

            if (jobs.every(job => (job.result === 'skipped' || job.result === 'success'))) {
              console.log("All transforms tests have passed (or been skipped).");
              process.exit(0);
            }

            console.log("Some transforms tests have failed:");
            jobs.forEach((job) => {
              if (job.result !== 'success' && job.result !== 'skipped') {
                console.log(`  ${job.name} - ${job.result}`);
              }
            });

            process.exit(1);
